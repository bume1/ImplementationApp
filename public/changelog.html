<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Changelog - Thrive 365 Labs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eff6ff', 500: '#045E9F', 600: '#0353a4', 700: '#00205A' },
            accent: '#00205A'
          },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%); }
    .input-modern { border: 1.5px solid #e4e4e7; border-radius: 0.75rem; transition: all 0.2s; }
    .input-modern:focus { border-color: #045E9F; box-shadow: 0 0 0 3px rgba(4, 94, 159, 0.1); outline: none; }
  </style>
</head>
<body class="min-h-screen py-8 px-4">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Static changelog entries (fallback and legacy)
    const staticChangelog = [
      {
        id: 'static-261',
        version: '2.6.1',
        date: 'January 19, 2026',
        isCurrent: true,
        sections: [
          { title: 'Navigation Improvements', color: 'primary', items: [
            'Added "Portal Hub" navigation button to Admin Hub sidebar for quick access to main portal',
            'Added "Portal Hub" navigation button to Service Portal sidebar',
            'Added "Portal Hub" navigation button to Client Portal Admin sidebar (admin users only)',
            'Added "Portal Hub" link to Launch Portal header'
          ]},
          { title: 'Bug Fixes', color: 'red', items: [
            'Fixed sign-out button in Admin Hub not redirecting to universal login',
            'Fixed sign-out button in Service Portal not redirecting to universal login',
            'Fixed sign-out button in Client Portal not redirecting to universal login',
            'Fixed sign-out button in Launch Portal not redirecting to universal login',
            'Sign-out now properly clears all authentication tokens across portals',
            'Fixed Client Portal Admin access for users with hasClientPortalAdminAccess permission'
          ]}
        ]
      },
      {
        id: 'static-260',
        version: '2.6.0',
        date: 'January 19, 2026',
        sections: [
          { title: 'Customer Support Center', color: 'primary', items: [
            'HubSpot ticket history integration - clients can view their support tickets',
            'Three-tab interface: Ticket History, Submit Ticket, Live Chat',
            'Service reports now visible as tickets with file attachments',
            'Ticket status and pipeline stage tracking from HubSpot'
          ]},
          { title: 'Service Report HubSpot Integration', color: 'primary', items: [
            'All service reports auto-push to HubSpot Ticket, Company, and Deal records',
            'PDF attachments uploaded to HubSpot Files and linked to tickets',
            'Enhanced tracking across CRM with full audit trail'
          ]},
          { title: 'Admin Hub Improvements', color: 'primary', items: [
            'New "Inbox" page for bug reports, feature requests, and password resets',
            'Dashboard metrics updated: "New Launches" shows active projects, "Open Tickets" shows pending feedback',
            'Personalized welcome messages using practice name'
          ]},
          { title: 'Client Portal Updates', color: 'primary', items: [
            'Inventory view simplified to show current stock levels only',
            'Removed "Top Consumed Items" and "View History" from client view',
            'Weekly inventory submission tracking with flags for overdue submissions'
          ]},
          { title: 'Feedback System', color: 'primary', items: [
            '"Report Bug or Request Feature" link added to Portal Hub footer',
            'Bug report and feature request form with type selection',
            'Admin inbox for reviewing and resolving submitted feedback'
          ]},
          { title: 'Bug Fixes', color: 'red', items: [
            'Fixed client portal crash caused by missing SVG icons',
            'Fixed changelog button link (route was not configured)',
            'Fixed main login footer branding text'
          ]}
        ]
      },
      {
        id: 'static-250',
        version: '2.5.0',
        date: 'January 2026',
        sections: [
          { title: 'UI Modernization & Branding Update', color: 'primary', items: [
            'Modern Design System with Inter font, refined color palette, glass-card effects',
            'Dynamic Banner Headers on Admin Hub, Service Portal, and Client Portal dashboards',
            'Streamlined Login Pages featuring only Thrive 365 Labs logo',
            'Consistent Heroicons v2 with 1.75 stroke weight across all portals'
          ]},
          { title: 'Permission System Overhaul', color: 'primary', items: [
            'Granular access flags: hasServicePortalAccess, hasAdminHubAccess, hasImplementationsAccess',
            'Client Portal admin flag: hasClientPortalAdminAccess',
            'Vendor role with assignedClients array for external service providers'
          ]},
          { title: 'Unified Login Portal', color: 'primary', items: [
            'Central authentication at /login route',
            'Portal Hub showing all accessible portals after login',
            'Role-based access automatically determines available portals'
          ]}
        ]
      },
      {
        id: 'static-240',
        version: '2.4.0',
        date: 'January 2026',
        sections: [
          { title: 'Service Portal Updates', color: 'primary', items: [
            'Support categories for service type classification',
            'HubSpot integration for service report syncing',
            'Enhanced report filtering and search capabilities'
          ]},
          { title: 'Validation Reports', color: 'primary', items: [
            'Phase 3 validation service report functionality',
            'Training report submissions for technical users',
            'Improved server-side signature verification'
          ]}
        ]
      },
      {
        id: 'static-230',
        version: '2.3.0',
        date: 'December 2025',
        sections: [
          { title: 'Central Admin Hub', color: 'primary', items: [
            'New dedicated admin interface at /admin-hub',
            'Dashboard with user counts, project stats, service reports overview',
            'Streamlined admin workflows with quick actions'
          ]},
          { title: 'Service Portal Launch', color: 'primary', items: [
            'Dedicated portal for Field Service Engineers',
            'Clinical Application Specialist workflow support',
            'Comprehensive service report forms with digital signatures'
          ]}
        ]
      },
      {
        id: 'static-220',
        version: '2.2.0',
        date: 'December 2025',
        sections: [
          { title: 'User Management', color: 'primary', items: [
            'Floating modal form for user creation/editing',
            'Client selection restricted to system clients only',
            'Implementation badge shows active for users with assigned projects'
          ]}
        ]
      },
      {
        id: 'static-200',
        version: '2.0.0',
        date: 'Initial Release',
        sections: [
          { title: 'Core Features', color: 'primary', items: [
            'Multi-project launch tracker with template system',
            'HubSpot CRM integration for projects and clients',
            'Google Drive integration for document management',
            'Individual client portals with unique slugs',
            'Task management with status tracking',
            'Client inventory submission system'
          ]}
        ]
      }
    ];

    const App = () => {
      const [changelog, setChangelog] = useState([]);
      const [loading, setLoading] = useState(true);
      const [isAdmin, setIsAdmin] = useState(false);
      const [token, setToken] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [newVersion, setNewVersion] = useState({ version: '', date: '', sections: [{ title: '', items: [''], color: 'primary' }] });

      useEffect(() => {
        // Check for admin token
        const adminToken = localStorage.getItem('admin_token') || localStorage.getItem('unified_token');
        if (adminToken) {
          try {
            const userData = localStorage.getItem('admin_user') || localStorage.getItem('unified_user');
            const user = userData ? JSON.parse(userData) : null;
            if (user && user.role === 'admin') {
              setIsAdmin(true);
              setToken(adminToken);
            }
          } catch (e) {}
        }

        // Load changelog
        loadChangelog();
      }, []);

      const loadChangelog = async () => {
        try {
          const response = await fetch('/api/changelog');
          const dynamicEntries = await response.json();

          // Merge dynamic entries with static (dynamic takes priority)
          const dynamicVersions = new Set(dynamicEntries.map(e => e.version));
          const filteredStatic = staticChangelog.filter(s => !dynamicVersions.has(s.version));

          // Combine and sort by version (newest first)
          const combined = [...dynamicEntries, ...filteredStatic];

          // Mark the first one as current if none marked
          if (combined.length > 0 && !combined.some(c => c.isCurrent)) {
            combined[0].isCurrent = true;
          }

          setChangelog(combined);
        } catch (err) {
          setChangelog(staticChangelog);
        }
        setLoading(false);
      };

      const addSection = () => {
        setNewVersion(prev => ({
          ...prev,
          sections: [...prev.sections, { title: '', items: [''], color: 'primary' }]
        }));
      };

      const updateSection = (idx, field, value) => {
        setNewVersion(prev => {
          const sections = [...prev.sections];
          sections[idx] = { ...sections[idx], [field]: value };
          return { ...prev, sections };
        });
      };

      const addItemToSection = (sectionIdx) => {
        setNewVersion(prev => {
          const sections = [...prev.sections];
          sections[sectionIdx].items = [...sections[sectionIdx].items, ''];
          return { ...prev, sections };
        });
      };

      const updateItem = (sectionIdx, itemIdx, value) => {
        setNewVersion(prev => {
          const sections = [...prev.sections];
          sections[sectionIdx].items[itemIdx] = value;
          return { ...prev, sections };
        });
      };

      const removeSection = (idx) => {
        setNewVersion(prev => ({
          ...prev,
          sections: prev.sections.filter((_, i) => i !== idx)
        }));
      };

      const submitNewVersion = async () => {
        if (!newVersion.version || !newVersion.sections.some(s => s.title && s.items.some(i => i))) {
          alert('Please fill in version and at least one section with items');
          return;
        }

        // Clean up empty items
        const cleanedSections = newVersion.sections
          .filter(s => s.title)
          .map(s => ({
            ...s,
            items: s.items.filter(i => i.trim())
          }));

        try {
          const response = await fetch('/api/changelog', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              version: newVersion.version,
              date: newVersion.date || new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
              sections: cleanedSections
            })
          });

          if (response.ok) {
            setShowAddForm(false);
            setNewVersion({ version: '', date: '', sections: [{ title: '', items: [''], color: 'primary' }] });
            loadChangelog();
          }
        } catch (err) {
          console.error('Error adding changelog:', err);
        }
      };

      // State for git generation
      const [showGitPreview, setShowGitPreview] = useState(false);
      const [gitPreview, setGitPreview] = useState(null);
      const [generating, setGenerating] = useState(false);
      const [gitVersion, setGitVersion] = useState('');

      // Preview changelog from git commits
      const previewFromGit = async () => {
        setGenerating(true);
        try {
          const response = await fetch('/api/changelog/preview?maxCommits=50', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          setGitPreview(data);
          setShowGitPreview(true);

          // Auto-suggest next version number
          const current = changelog.find(c => c.isCurrent);
          if (current && current.version) {
            const parts = current.version.replace('Version ', '').split('.');
            parts[2] = (parseInt(parts[2] || 0) + 1).toString();
            setGitVersion(`Version ${parts.join('.')}`);
          } else {
            setGitVersion('Version 2.7.0');
          }
        } catch (err) {
          console.error('Error previewing git changes:', err);
          alert('Failed to load git commits');
        }
        setGenerating(false);
      };

      // Generate changelog from git
      const generateFromGit = async () => {
        if (!gitVersion) {
          alert('Please enter a version number');
          return;
        }

        setGenerating(true);
        try {
          const response = await fetch('/api/changelog/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ version: gitVersion })
          });

          if (response.ok) {
            const result = await response.json();
            alert(`Changelog generated successfully for ${result.entry.version}!`);
            setShowGitPreview(false);
            setGitPreview(null);
            loadChangelog();
          } else {
            const err = await response.json();
            alert('Error: ' + (err.error || 'Failed to generate changelog'));
          }
        } catch (err) {
          console.error('Error generating changelog:', err);
          alert('Failed to generate changelog');
        }
        setGenerating(false);
      };

      const currentVersion = changelog.find(c => c.isCurrent);

      return (
        <div className="max-w-4xl mx-auto">
          {/* Header */}
          <div className="bg-gradient-to-r from-primary-500 to-primary-700 text-white p-8 rounded-2xl shadow-lg mb-8">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h1 className="text-3xl font-bold">App Changelog</h1>
                <p className="mt-2 text-white/80">Complete update history & release notes</p>
                {currentVersion && (
                  <p className="mt-1 text-white/60 text-sm">Current: v{currentVersion.version}</p>
                )}
              </div>
              <div className="flex gap-3">
                {isAdmin && (
                  <>
                    <button onClick={previewFromGit} disabled={generating}
                      className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium text-sm transition flex items-center gap-2 disabled:opacity-50">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                      </svg>
                      {generating ? 'Loading...' : 'Generate from Git'}
                    </button>
                    <button onClick={() => setShowAddForm(true)}
                      className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium text-sm transition flex items-center gap-2">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/>
                      </svg>
                      Manual
                    </button>
                  </>
                )}
                <a href="/login" className="bg-white text-primary-600 px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-100 transition">
                  Back to App
                </a>
              </div>
            </div>
          </div>

          {/* Git Preview Modal */}
          {showGitPreview && gitPreview && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl my-8">
                <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                  <div>
                    <h2 className="text-xl font-bold text-accent">Generate from Git Commits</h2>
                    <p className="text-sm text-gray-500 mt-1">{gitPreview.commitCount} commits found</p>
                  </div>
                  <button onClick={() => setShowGitPreview(false)} className="text-gray-400 hover:text-gray-600">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
                <div className="p-6 max-h-[60vh] overflow-y-auto space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Version Number</label>
                    <input type="text" value={gitVersion} onChange={(e) => setGitVersion(e.target.value)}
                      className="input-modern w-full px-4 py-2" placeholder="e.g., Version 2.7.0" />
                  </div>

                  <div className="border border-gray-200 rounded-xl p-4">
                    <h3 className="font-semibold text-gray-800 mb-3">Preview Sections</h3>
                    {gitPreview.sections && gitPreview.sections.length > 0 ? (
                      <div className="space-y-3">
                        {gitPreview.sections.map((section) => (
                          <div key={section.label} className="bg-gray-50 rounded-lg p-3">
                            <div className="flex items-center gap-2 mb-2">
                              <span className={`w-3 h-3 rounded-full ${section.color === 'success' ? 'bg-green-500' : section.color === 'purple' ? 'bg-purple-500' : 'bg-primary-500'}`}></span>
                              <span className="font-medium text-sm">{section.label}</span>
                              <span className="text-xs text-gray-500">({section.itemCount} items)</span>
                            </div>
                            <ul className="text-sm text-gray-600 ml-5 space-y-1">
                              {section.items.slice(0, 5).map((item, i) => (
                                <li key={`${section.label}-${i}`}>• {item}</li>
                              ))}
                              {section.items.length > 5 && (
                                <li className="text-gray-400 italic">...and {section.items.length - 5} more</li>
                              )}
                            </ul>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-500 text-sm">No categorizable changes found in recent commits.</p>
                    )}
                  </div>
                </div>
                <div className="p-6 border-t border-gray-100 flex gap-3">
                  <button onClick={() => setShowGitPreview(false)} className="flex-1 py-2.5 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50">
                    Cancel
                  </button>
                  <button onClick={generateFromGit} disabled={generating || !gitPreview.sections?.length}
                    className="flex-1 py-2.5 px-4 rounded-xl bg-primary-500 text-white font-medium hover:bg-primary-600 disabled:opacity-50">
                    {generating ? 'Generating...' : 'Generate Changelog'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Add Version Form */}
          {showAddForm && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl my-8">
                <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                  <h2 className="text-xl font-bold text-accent">Add New Version</h2>
                  <button onClick={() => setShowAddForm(false)} className="text-gray-400 hover:text-gray-600">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
                <div className="p-6 max-h-[70vh] overflow-y-auto space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Version</label>
                      <input type="text" value={newVersion.version} onChange={(e) => setNewVersion(prev => ({ ...prev, version: e.target.value }))}
                        className="input-modern w-full px-4 py-2" placeholder="e.g., 2.7.0" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                      <input type="text" value={newVersion.date} onChange={(e) => setNewVersion(prev => ({ ...prev, date: e.target.value }))}
                        className="input-modern w-full px-4 py-2" placeholder="e.g., January 20, 2026" />
                    </div>
                  </div>

                  {newVersion.sections.map((section, sIdx) => (
                    <div key={sIdx} className="border border-gray-200 rounded-xl p-4">
                      <div className="flex gap-3 mb-3">
                        <input type="text" value={section.title} onChange={(e) => updateSection(sIdx, 'title', e.target.value)}
                          className="input-modern flex-1 px-3 py-2 text-sm" placeholder="Section title (e.g., New Features)" />
                        <select value={section.color} onChange={(e) => updateSection(sIdx, 'color', e.target.value)}
                          className="input-modern px-3 py-2 text-sm">
                          <option value="primary">Blue</option>
                          <option value="red">Red (Bug Fixes)</option>
                          <option value="green">Green</option>
                        </select>
                        {newVersion.sections.length > 1 && (
                          <button onClick={() => removeSection(sIdx)} className="text-red-500 hover:text-red-700 px-2">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                          </button>
                        )}
                      </div>
                      <div className="space-y-2">
                        {section.items.map((item, iIdx) => (
                          <input key={iIdx} type="text" value={item} onChange={(e) => updateItem(sIdx, iIdx, e.target.value)}
                            className="input-modern w-full px-3 py-2 text-sm" placeholder="Changelog item..." />
                        ))}
                        <button onClick={() => addItemToSection(sIdx)} className="text-primary-500 text-sm hover:underline">
                          + Add item
                        </button>
                      </div>
                    </div>
                  ))}

                  <button onClick={addSection} className="w-full py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary-500 hover:text-primary-500 transition">
                    + Add Section
                  </button>
                </div>
                <div className="p-6 border-t border-gray-100 flex gap-3">
                  <button onClick={() => setShowAddForm(false)} className="flex-1 py-2.5 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50">
                    Cancel
                  </button>
                  <button onClick={submitNewVersion} className="flex-1 py-2.5 px-4 rounded-xl bg-primary-500 text-white font-medium hover:bg-primary-600">
                    Publish Version
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Loading */}
          {loading ? (
            <div className="flex items-center justify-center py-20">
              <div className="animate-spin rounded-full h-10 w-10 border-[3px] border-primary-500 border-t-transparent"></div>
            </div>
          ) : (
            <>
              {/* Changelog Entries */}
              {changelog.map((entry, idx) => (
                <div key={entry.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                  <div className="flex items-center gap-3 mb-4">
                    {entry.isCurrent && (
                      <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-semibold">Current</span>
                    )}
                    <h2 className="text-xl font-bold text-gray-900">Version {entry.version} - {entry.date}</h2>
                  </div>

                  <div className="space-y-4">
                    {entry.sections.map((section, sIdx) => (
                      <div key={sIdx}>
                        <h3 className={`font-semibold mb-2 ${section.color === 'red' ? 'text-red-600' : section.color === 'green' ? 'text-green-600' : 'text-primary-600'}`}>
                          {section.title}
                        </h3>
                        <ul className="text-gray-600 text-sm space-y-1 ml-4">
                          {section.items.map((item, iIdx) => (
                            <li key={iIdx}>• {item}</li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </>
          )}

          {/* Footer */}
          <div className="text-center text-gray-500 text-sm py-4">
            <p>Last Updated: {currentVersion ? `${currentVersion.date} - v${currentVersion.version}` : 'January 19, 2026'}</p>
            <p className="mt-1">&copy; 2026 Thrive 365 Labs. All rights reserved.</p>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
