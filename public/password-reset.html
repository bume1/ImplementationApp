<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password Reset – Thrive 365 Labs</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#045E9F',
            accent: '#00205A'
          },
          fontFamily: {
            sans: ['Inter', 'Open Sans', 'sans-serif']
          }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body class="bg-gray-50 font-sans min-h-screen flex flex-col">
  <div id="root"></div>

  <script type="text/babel">
    function PasswordResetPage() {
      const [state, setState] = React.useState('loading'); // loading | ready | expired | error
      const [userData, setUserData] = React.useState(null);
      const [copied, setCopied] = React.useState(false);
      const [errorMsg, setErrorMsg] = React.useState('');

      // Extract token from URL path: /password-reset-{token}
      const token = React.useMemo(() => {
        const match = window.location.pathname.match(/\/password-reset-(.+)$/);
        return match ? match[1] : null;
      }, []);

      React.useEffect(() => {
        if (!token) {
          setState('error');
          setErrorMsg('Invalid reset link. No token found in the URL.');
          return;
        }

        fetch(`/api/auth/password-reset-link/${token}`)
          .then(async (res) => {
            const data = await res.json();
            if (res.status === 410) {
              setState('expired');
            } else if (!res.ok) {
              setState('error');
              setErrorMsg(data.error || 'This reset link is invalid or has already been used.');
            } else {
              setUserData(data);
              setState('ready');
            }
          })
          .catch(() => {
            setState('error');
            setErrorMsg('Unable to reach the server. Please try again later.');
          });
      }, [token]);

      function copyPassword() {
        navigator.clipboard.writeText(userData.tempPassword).then(() => {
          setCopied(true);
          setTimeout(() => setCopied(false), 2500);
        });
      }

      return (
        <div className="min-h-screen flex flex-col">
          {/* Header */}
          <header className="bg-primary shadow-md">
            <div className="max-w-4xl mx-auto px-6 py-4 flex items-center justify-between">
              <div>
                <h1 className="text-white text-xl font-bold tracking-tight">Thrive 365 Labs</h1>
                <p className="text-blue-200 text-xs mt-0.5">Implementation Platform</p>
              </div>
              <span className="text-blue-200 text-sm hidden sm:block">(888) 365-8378</span>
            </div>
          </header>

          {/* Main content */}
          <main className="flex-1 flex items-center justify-center px-4 py-12">
            <div className="w-full max-w-md">

              {/* Loading */}
              {state === 'loading' && (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                  <div className="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                  <p className="text-gray-500 text-sm">Loading your reset link…</p>
                </div>
              )}

              {/* Ready — show the temp password */}
              {state === 'ready' && userData && (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                  <div className="bg-primary px-6 py-5">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                      </div>
                      <div>
                        <h2 className="text-white font-semibold text-lg leading-tight">Your Temporary Password</h2>
                        <p className="text-blue-200 text-sm">Hi, {userData.name}</p>
                      </div>
                    </div>
                  </div>

                  <div className="px-6 py-6 space-y-5">
                    <p className="text-gray-600 text-sm">
                      An administrator has reset your password. Use the temporary password below to log in — you'll be asked to create a new one immediately after.
                    </p>

                    {/* Password display */}
                    <div>
                      <label className="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">Temporary Password</label>
                      <div className="flex items-center gap-2">
                        <div className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 font-mono text-gray-900 text-base tracking-widest select-all">
                          {userData.tempPassword}
                        </div>
                        <button
                          onClick={copyPassword}
                          className={`flex-shrink-0 px-3 py-3 rounded-lg border text-sm font-medium transition-colors ${
                            copied
                              ? 'bg-green-50 border-green-300 text-green-700'
                              : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300'
                          }`}
                          title="Copy to clipboard"
                        >
                          {copied ? (
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                          ) : (
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                          )}
                        </button>
                      </div>
                      {copied && <p className="text-green-600 text-xs mt-1.5">Copied to clipboard!</p>}
                    </div>

                    {/* Account info */}
                    <div className="bg-gray-50 rounded-lg px-4 py-3 text-sm text-gray-500">
                      <span className="font-medium text-gray-700">Account: </span>{userData.email}
                    </div>

                    {/* Login button */}
                    <a
                      href="/login"
                      className="block w-full text-center bg-primary text-white py-3 rounded-lg font-semibold text-sm hover:opacity-90 transition-opacity"
                    >
                      Go to Login
                    </a>

                    <p className="text-center text-xs text-gray-400">
                      This link is valid for 24 hours from when the reset was triggered.
                    </p>
                  </div>
                </div>
              )}

              {/* Expired */}
              {state === 'expired' && (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                  <div className="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg className="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <h2 className="text-gray-900 font-semibold text-lg mb-2">Link Expired</h2>
                  <p className="text-gray-500 text-sm mb-6">This password reset link has expired (links are valid for 24 hours). Please contact your administrator to issue a new reset.</p>
                  <a href="/login" className="inline-block bg-primary text-white px-6 py-2.5 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                    Back to Login
                  </a>
                </div>
              )}

              {/* Error */}
              {state === 'error' && (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                  <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg className="w-6 h-6 text-red-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                  </div>
                  <h2 className="text-gray-900 font-semibold text-lg mb-2">Invalid Reset Link</h2>
                  <p className="text-gray-500 text-sm mb-6">{errorMsg}</p>
                  <a href="/login" className="inline-block bg-primary text-white px-6 py-2.5 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                    Back to Login
                  </a>
                </div>
              )}

            </div>
          </main>

          <footer className="text-center py-4 text-xs text-gray-400">
            &copy; {new Date().getFullYear()} Thrive 365 Labs. All rights reserved.
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PasswordResetPage />);
  </script>
</body>
</html>
