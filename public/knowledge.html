<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knowledge Hub - Thrive 365 Labs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#E6F0F7', 100: '#CCE1EF', 500: '#045E9F', 600: '#034D82', 700: '#033C66', 800: '#022B49' },
            accent: '#1B2D4F',
            success: { 50: '#E6F7F1', 500: '#10B981', 600: '#059669' },
            warning: { 50: '#FEF9E7', 500: '#F59E0B', 600: '#D97706' }
          }
        }
      }
    };
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%); min-height: 100vh; }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
    .guide-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .guide-content.open { max-height: 5000px; transition: max-height 0.5s ease-in; }
    .sidebar-link { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0.75rem; }
    .sidebar-link:hover { background: linear-gradient(135deg, rgba(4, 94, 159, 0.08) 0%, rgba(4, 94, 159, 0.12) 100%); }
    .sidebar-link.active { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); color: white; box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.4); }
    .gradient-header { background: linear-gradient(135deg, #045E9F 0%, #00205A 100%); }
    .search-input:focus { box-shadow: 0 0 0 3px rgba(4,94,159,0.15); outline: none; }
    .search-dropdown { max-height: 400px; overflow-y: auto; }
    .search-item { transition: background 0.15s ease; }
    .search-item:hover { background: #f0f7ff; }
    mark.active-match { background: #f97316; color: white; box-shadow: 0 0 0 2px #f97316, 0 0 8px rgba(249,115,22,0.4); border-radius: 2px; }
    @keyframes match-pulse { 0%,100% { box-shadow: 0 0 0 2px #f97316, 0 0 8px rgba(249,115,22,0.4); } 50% { box-shadow: 0 0 0 4px #f97316, 0 0 16px rgba(249,115,22,0.6); } }
    mark.active-match { animation: match-pulse 1s ease-in-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;

    // Icons
    const Icons = {
      back: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>,
      book: <svg className="w-8 h-8" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>,
      admin: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      launch: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>,
      service: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z"/></svg>,
      client: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>,
      hub: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>,
      chevronDown: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7"/></svg>,
      chevronRight: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7"/></svg>,
      link: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/></svg>,
      inventory: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>,
      support: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>,
      files: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
      users: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>,
      milestone: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
      external: <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>,
      code: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5"/></svg>,
      lock: <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>
    };

    // ============== 5-TIER PERMISSION SYSTEM ==============
    const USER_TIERS = {
      SUPER_ADMIN: 'super_admin',
      MANAGER: 'manager',
      TEAM_MEMBER: 'team_member',
      VENDOR: 'vendor',
      CLIENT: 'client'
    };

    const TIER_LABELS = {
      super_admin: 'Super Admin',
      manager: 'Manager',
      team_member: 'Team Member',
      vendor: 'Vendor Technician',
      client: 'Client'
    };

    const PORTAL_SECTIONS = {
      GENERAL: 'general',
      ADMIN_HUB: 'admin_hub',
      LAUNCH_PORTAL: 'launch_portal',
      SERVICE_PORTAL: 'service_portal',
      CLIENT_PORTAL: 'client_portal',
      CLIENT_PORTAL_ADMIN: 'client_portal_admin'
    };

    const PORTAL_SECTION_LABELS = {
      general: 'General',
      admin_hub: 'Admin Hub',
      launch_portal: 'Implementations',
      service_portal: 'Service Portal',
      client_portal: 'Client Portal',
      client_portal_admin: 'Client Portal Admin'
    };

    function getUserTier(user) {
      if (!user) return null;
      if (user.role === 'admin') return USER_TIERS.SUPER_ADMIN;
      if (user.isManager) return USER_TIERS.MANAGER;
      if (user.role === 'vendor') return USER_TIERS.VENDOR;
      if (user.role === 'client') return USER_TIERS.CLIENT;
      return USER_TIERS.TEAM_MEMBER;
    }

    function canUserSeeGuide(userTier, user, guide) {
      if (guide.hidden) return false;
      const visibleTo = guide.visibleTo || [];
      if (visibleTo.length === 0) return true;
      if (!visibleTo.includes(userTier)) return false;
      if (userTier === 'team_member' && guide.portalSection) {
        switch (guide.portalSection) {
          case 'admin_hub': return !!user.hasAdminHubAccess;
          case 'launch_portal': return !!user.hasImplementationsAccess || (user.assignedProjects && user.assignedProjects.length > 0);
          case 'service_portal': return !!user.hasServicePortalAccess;
          case 'client_portal_admin': return !!user.hasClientPortalAdminAccess;
          case 'client_portal': return false;
          default: return true;
        }
      }
      return true;
    }

    // ============== WORKFLOW WALKTHROUGHS ==============
    const WORKFLOW_WALKTHROUGHS = {
      super_admin: {
        title: 'Super Admin Daily Workflow',
        subtitle: 'Your end-to-end daily routine as system administrator',
        steps: [
          { step: 1, title: 'Check Admin Hub Inbox', description: 'Process password resets (urgent - users are blocked), review bug reports, triage feature requests.', link: 'admin-hub' },
          { step: 2, title: 'Review Dashboard Stats', description: 'Check active launch count, open tickets, and look for any anomalies in the numbers.', link: 'admin-hub' },
          { step: 3, title: 'Monitor Implementations', description: 'Review project progress across all active launches, check for overdue tasks, follow up with project managers.', link: 'launch-app' },
          { step: 4, title: 'Oversee Service Operations', description: 'Check pending service assignments, review completed reports for quality, monitor active validations.', link: 'service-portal' },
          { step: 5, title: 'Client Portal Oversight', description: 'Review inventory compliance, update announcements, ensure client documents are current.', link: 'client-portal-admin' }
        ]
      },
      manager: {
        title: 'Manager Daily Workflow',
        subtitle: 'Your workflow for overseeing teams and service operations',
        steps: [
          { step: 1, title: 'Review Service Assignments', description: 'Check pending service visits in the Service Portal. Assign new work to available technicians.', link: 'service-portal' },
          { step: 2, title: 'Monitor Completed Reports', description: 'Review submitted service and validation reports for completeness and quality.', link: 'service-portal' },
          { step: 3, title: 'Check Client Portal', description: 'Review inventory submissions, update client-facing announcements, ensure documents are current.', link: 'client-portal-admin' },
          { step: 4, title: 'Dashboard Overview', description: 'Check Admin Hub dashboard for team performance metrics and any pending items.', link: 'admin-hub' }
        ]
      },
      team_member: {
        title: 'Team Member Daily Workflow',
        subtitle: 'Your daily routine for implementations and project tasks',
        steps: [
          { step: 1, title: 'Check Your Assigned Projects', description: 'Open the Launch App to see your current projects, pending tasks, and upcoming milestones.', link: 'launch-app' },
          { step: 2, title: 'Update Task Progress', description: 'Mark completed tasks, add notes for updates, upload any required documentation.', link: 'launch-app' },
          { step: 3, title: 'Submit Service Reports', description: 'If you completed service work today, file reports within 24 hours in the Service Portal.', link: 'service-portal' },
          { step: 4, title: 'Review Client Documents', description: 'Ensure client-facing documents are current and accurate in the Client Portal Admin.', link: 'client-portal-admin' }
        ]
      },
      vendor: {
        title: 'Vendor Technician Workflow',
        subtitle: 'Your workflow for assigned service visits and report submission',
        steps: [
          { step: 1, title: 'Check Dashboard for Assignments', description: 'Look for the red notification box on the Service Portal dashboard with pending service assignments.', link: 'service-portal' },
          { step: 2, title: 'Review Assignment Details', description: 'Read manager notes, check attached photos and files, understand the scope of work before visiting.', link: 'service-portal' },
          { step: 3, title: 'Complete Service Visit', description: 'Perform the work on-site, gather customer signatures, note materials used and any outstanding issues.', link: 'service-portal' },
          { step: 4, title: 'Submit Report', description: 'Fill in findings, attach photos, get customer signature, and submit within 24 hours of completing the visit.', link: 'service-portal' }
        ]
      },
      client: {
        title: 'Client Portal Walkthrough',
        subtitle: 'How to get the most out of your client portal',
        steps: [
          { step: 1, title: 'Check Announcements', description: 'View the home dashboard for important updates, pinned announcements, and recent activity.', link: 'client-portal' },
          { step: 2, title: 'Submit Weekly Inventory', description: 'Navigate to Inventory Management and enter your current stock levels for all required items.', link: 'inventory' },
          { step: 3, title: 'Review Documents', description: 'Check the Files & Documents section for new certificates, contracts, or package inserts.', link: 'files-documents' },
          { step: 4, title: 'Get Support', description: 'Use the Customer Support Center to create tickets for any issues or questions.', link: 'customer-support' }
        ]
      }
    };

    // ============== GUIDE DATA ==============
    // Comprehensive Guide Data - Expert Level How-Tos for Internal Users
    const guides = {
      'portal-hub': {
        title: 'Portal Hub',
        description: 'Your central navigation point for all Thrive 365 Labs services',
        icon: Icons.hub,
        color: 'bg-primary-500',
        visibleTo: [],
        portalSection: 'general',
        articles: [
          {
            title: 'Getting Started with Portal Hub',
            content: `Welcome to the Thrive 365 Labs Portal Hub. This is your command center after logging in. Here's everything you need to know to navigate the system effectively.

**STEP 1: Logging In**
1. Open your web browser (Chrome or Firefox recommended)
2. Navigate to the login page URL provided by your administrator
3. Enter your email address exactly as it was registered (this is case-sensitive)
4. Enter your password
5. Click "Sign In"

**IMPORTANT:** If this is your first login after a password reset, you'll be prompted to create a new password. Choose something with at least 8 characters mixing letters and numbers.

**STEP 2: Understanding the Dashboard**
After login, you'll see colored tiles representing different portals. Each tile you see means you have access to that area:

• **Admin Hub** (Blue tile) - System administration and user management
• **Implementations** (Purple tile) - Client project tracking and launch management
• **Service Portal** (Green tile) - Submit service reports and validation documentation
• **Client Portal Admin** (Orange tile) - Manage client-facing content and documents
• **Knowledge Hub** (Teal tile) - You're here! Documentation and guides

**STEP 3: Navigating Between Portals**
- Click any tile to enter that portal
- Use the "Portal Hub" link in the sidebar (or bottom of page) to return here
- You can have multiple browser tabs open for different portals

**PRO TIP:** Bookmark the Portal Hub URL for quick access each morning.

**TROUBLESHOOTING:**
- If a tile is missing, you don't have permission for that portal - contact your administrator
- If the page won't load, try clearing your browser cache (Ctrl+Shift+Delete)
- If you're logged out unexpectedly, your session expired after 24 hours - just log in again`
          },
          {
            title: 'Understanding Your Permissions',
            content: `Your access within the system is controlled by permission flags. Understanding these helps you know what you can and cannot do.

**PERMISSION TYPES EXPLAINED:**

1. **Admin Hub Access**
   - View system dashboard with statistics
   - Manage user accounts (create, edit, delete)
   - Process password reset requests
   - View bug reports and feature requests
   - WHO NEEDS THIS: System administrators, IT staff, operations managers

2. **Implementations Access**
   - View and manage client launch projects
   - Track task completion across implementation phases
   - Access project boards and timelines
   - Generate reports and checklists
   - WHO NEEDS THIS: Project managers, implementation specialists, account managers

3. **Service Portal Access**
   - Submit service reports for client visits
   - Submit validation reports for equipment
   - View your submitted reports
   - Access assigned service tasks
   - WHO NEEDS THIS: Field Service Engineers (FSE), Clinical Application Specialists (CAS), service technicians

4. **Client Portal Admin Access**
   - Manage client portal announcements
   - Upload documents for specific clients
   - View client inventory submissions
   - Manage client portal settings
   - WHO NEEDS THIS: Account managers, client success team, operations

**THE MANAGER FLAG:**
If you have the "Is Manager" designation, you get limited Admin Hub access without full admin privileges. This allows you to:
- View dashboard statistics
- Manage Service Portal assignments
- See team activity

**HOW TO REQUEST ADDITIONAL ACCESS:**
1. Identify which portal(s) you need access to
2. Document why you need this access (what tasks require it)
3. Contact your system administrator or supervisor
4. They will update your permissions in Admin Hub > User Management

**SECURITY NOTE:** We follow the principle of "least privilege" - you should only have access to what you need for your job. This protects client data and system integrity.`
          },
          {
            title: 'Daily Workflow Best Practices',
            content: `Here's a recommended daily workflow for getting the most out of the system.

**MORNING ROUTINE (5-10 minutes):**

1. **Log into Portal Hub**
   - Check which portals show notifications or alerts
   - Red badges indicate items needing attention

2. **Check Admin Hub (if you have access)**
   - Review the Inbox for new bug reports or password reset requests
   - Note any urgent items that need immediate attention
   - Check dashboard stats for any anomalies

3. **Check Implementations (if managing projects)**
   - Review your assigned projects
   - Check for any overdue tasks
   - Note upcoming milestones for the week

4. **Check Service Portal (if you're FSE/CAS)**
   - Review any assigned service visits
   - Check for incomplete report drafts
   - Note any pending tasks from managers

**THROUGHOUT THE DAY:**
- Submit service reports within 24 hours of completing service calls
- Update project task status as you complete work
- Respond to assigned items promptly

**END OF DAY:**
- Ensure all service reports from the day are submitted (not left as drafts)
- Update any project tasks completed
- Log out if using a shared computer

**WEEKLY:**
- Review all your submitted reports for completeness
- Check for any stale tasks or projects
- Ensure client documents are up to date

**PRO TIPS:**
- Keep the Portal Hub open in a browser tab all day
- Use browser bookmarks for frequently accessed pages
- Take screenshots of any errors to help with troubleshooting
- When in doubt, save as draft before navigating away`
          }
        ]
      },
      'admin-hub': {
        title: 'Admin Hub',
        description: 'User management, permissions, and administration',
        icon: Icons.admin,
        color: 'bg-blue-600',
        visibleTo: ['super_admin', 'manager', 'team_member'],
        portalSection: 'admin_hub',
        articles: [
          {
            title: 'Admin Dashboard Overview',
            content: `The Admin Hub is the control center for system administration. Here's a complete walkthrough of every feature.

**ACCESSING ADMIN HUB:**
1. From Portal Hub, click the "Admin Hub" tile
2. Or navigate directly to /admin-hub in your browser
3. You must have Admin Hub Access permission to enter

**DASHBOARD COMPONENTS:**

**1. Quick Stats Cards (Top Section)**
These give you an at-a-glance view of system status:

• **New Launches** - Shows count of active implementation projects
  - Click to jump directly to the Launch App
  - Projects in "Complete" status are not counted

• **Open Tickets** - Total pending items in your inbox
  - Includes bug reports, feature requests, and password resets
  - Click to jump to the Inbox

**2. Navigation Sidebar (Left Side)**
The sidebar contains links to all Admin Hub sections:
• Dashboard (home)
• Inbox (pending requests)
• User Management (all user accounts)
• Service Portal (service report management)
• Plus navigation back to Portal Hub

**3. Inbox Preview (Main Area)**
Shows the most recent inbox items without needing to navigate to the full inbox.

**DAILY ADMIN CHECKLIST:**
□ Check inbox for password reset requests (urgent - users are blocked)
□ Review any new bug reports
□ Check dashboard stats for unusual numbers
□ Process any pending feature requests

**WARNING:** Password reset requests should be handled same-day. Users cannot access the system until their password is reset.`
          },
          {
            title: 'Creating New User Accounts',
            content: `Complete step-by-step guide for creating new user accounts in the system.

**BEFORE YOU START:**
Gather this information about the new user:
- Full name
- Email address (this will be their username)
- What role they need (see role descriptions below)
- Which portals they need access to
- For clients: which practice/organization they belong to
- For vendors: which clients they should access

**STEP-BY-STEP PROCESS:**

**Step 1: Navigate to User Management**
1. Click "User Management" in the Admin Hub sidebar
2. You'll see a list of all existing users

**Step 2: Open the Add User Form**
1. Click the "+ Add User" button (top right)
2. A form will appear with all the fields

**Step 3: Fill in Basic Information**
• **Name**: Full name as it should appear in the system
• **Email**: Their email address (becomes their login username)
  - IMPORTANT: Double-check spelling - cannot be easily changed later
• **Password**: Create a temporary password for them
  - Minimum 8 characters
  - They will change this on first login

**Step 4: Select the Appropriate Role**

• **Admin** - ONLY for IT/system administrators
  - Full access to everything
  - Can manage all users and settings
  - Use sparingly

• **Team Member** - Most internal Thrive 365 employees
  - Access controlled by permission toggles (see Step 5)
  - Can have Manager designation for additional capabilities

• **Client** - External client users
  - Access only to their specific client portal
  - Must be assigned to a practice (see Step 6)

• **Vendor** - External service providers
  - Limited access to assigned client accounts only
  - Must have Service Portal Access enabled
  - Must have assigned clients specified (see Step 6)

**Step 5: Configure Permissions (Team Members)**
Toggle ON the permissions they need:

□ **Has Admin Hub Access** - View dashboard, manage users, handle inbox
□ **Has Implementations Access** - Use the Launch App for project tracking
□ **Has Service Portal Access** - Submit service and validation reports
□ **Has Client Portal Admin** - Manage client announcements and documents
□ **Is Manager** - Limited admin access without full admin privileges

**Step 6: Assign Practice/Clients (Client and Vendor roles)**
• For Clients: Select their practice from the dropdown
• For Vendors: Select which client accounts they can access

**Step 7: Save the User**
1. Review all fields for accuracy
2. Click "Save" or "Create User"
3. The user will appear in the user list

**Step 8: Communicate Login Details**
Send the new user:
- Their email address (username)
- The temporary password you created
- The login URL
- Instruct them to change their password on first login

**COMMON MISTAKES TO AVOID:**
❌ Typos in email addresses - user won't be able to log in
❌ Giving too many permissions - follow least-privilege principle
❌ Forgetting to assign practice for client users
❌ Not communicating the temporary password securely`
          },
          {
            title: 'Editing and Managing Existing Users',
            content: `How to modify existing user accounts, reset passwords, and manage access.

**FINDING A USER:**
1. Go to User Management
2. Use the search box to find users by name or email
3. Scroll through the list if needed
4. Click on a user to view/edit their details

**EDITING USER INFORMATION:**

**Step 1: Open the User**
Click on the user's row in the list to open their details

**Step 2: Make Changes**
You can modify:
• Name
• Email (be careful - this changes their login)
• Role
• All permission toggles
• Practice/client assignments
• Manager designation

**Step 3: Save Changes**
Click "Save" to apply your changes immediately

**RESETTING A SINGLE USER'S PASSWORD:**
1. Find and open the user
2. Enter a new temporary password in the password field
3. Save the user
4. Communicate the new password to the user
5. User will be prompted to change it on next login

**BULK PASSWORD RESET:**
Use this when you need to reset passwords for multiple users at once:
1. In the user list, check the boxes next to users who need reset
2. Click the "Reset Passwords" button at the top
3. Confirm the action
4. System generates temporary passwords for all selected users
5. Users receive notification and must change password on next login

**DEACTIVATING A USER:**
When an employee leaves or a client relationship ends:
1. Find the user in the list
2. You can either:
   - Delete the user entirely (removes all history)
   - Remove all permissions (preserves audit trail)
3. For compliance, we recommend removing permissions rather than deleting

**TRANSFERRING RESPONSIBILITIES:**
When someone leaves and another takes over:
1. Create the new user account first
2. Transfer any project assignments in Launch App
3. Update any client portal admin responsibilities
4. Then deactivate the old user

**AUDIT CHECKLIST (Quarterly):**
□ Review all Admin role users - still appropriate?
□ Check for inactive users (no recent login)
□ Verify vendor access is still needed
□ Confirm client users match active client relationships
□ Remove access for any departed employees`
          },
          {
            title: 'Processing Inbox Items',
            content: `The Inbox is where all system requests collect. Here's how to handle each type efficiently.

**ACCESSING THE INBOX:**
1. Click "Inbox" in the Admin Hub sidebar
2. Or click the "Open Tickets" stat on the dashboard
3. Items are sorted by date (newest first)

**INBOX ITEM TYPES:**

**1. PASSWORD RESET REQUESTS** (Highest Priority)
These are from users who forgot their password and cannot log in.

How to Process:
1. Click on the password reset request to view details
2. Note the user's email address
3. Go to User Management
4. Find and open that user's account
5. Enter a new temporary password
6. Save the user
7. Return to Inbox and mark the request as "Resolved"
8. Contact the user with their new temporary password

⚠️ URGENT: Process these same-day. Users are completely blocked until resolved.

**2. BUG REPORTS** (High Priority)
Issues reported by users through the feedback form.

How to Process:
1. Click to view the full bug report details
2. Try to reproduce the issue yourself
3. Document the steps to reproduce and any error messages
4. Either:
   - Fix the issue if you can
   - Escalate to technical team with details
5. Mark as "Resolved" once fixed
6. Optionally notify the reporter that it's fixed

Look For Patterns:
- Multiple reports about the same issue = system-wide problem
- Specific user having many issues = possible training need or account problem

**3. FEATURE REQUESTS** (Lower Priority)
Suggestions from users for new functionality.

How to Process:
1. Review the request
2. Determine if it's feasible/valuable
3. Either:
   - Add to development backlog
   - Mark as "Won't Do" with explanation
   - Mark as "Duplicate" if already requested
4. You can leave these open for tracking

**INBOX BEST PRACTICES:**

✓ Check inbox first thing every morning
✓ Process password resets immediately
✓ Respond to bug reports within 24 hours
✓ Keep notes on recurring issues
✓ Clear resolved items regularly to keep inbox manageable

**KEYBOARD SHORTCUTS:**
- R = Mark as Resolved
- D = Delete item
- N = View next item`
          },
          {
            title: 'Service Portal Management',
            content: `Administrators and managers can oversee service reports and assignments from Admin Hub.

**ACCESSING SERVICE PORTAL ADMIN:**
1. Click "Service Portal" in the Admin Hub sidebar
2. You'll see tabs for different functions

**AVAILABLE TABS:**

**1. Service Reports Tab**
View all submitted service reports across the organization.

Features:
• Search by client name, service type, or technician
• Filter by date range
• View report details by clicking "View"
• See report status (Assigned vs Submitted)

Report Statuses Explained:
• **Assigned** - Task given to technician, not yet completed
• **Submitted** - Technician has completed and submitted the report

**2. Validation Reports Tab**
View all validation reports submitted.

Features:
• See validation dates and duration
• View analyzers validated
• Download validation documentation
• Filter by client

**3. Vendors Tab (Admin only)**
Manage vendor accounts and their client assignments.

Features:
• View all vendor users
• See which clients each vendor is assigned to
• Add/remove vendor client assignments

**ASSIGNING SERVICE VISITS:**
As an admin or manager, you can assign service visits to technicians:
1. This feature is available in the Service Portal directly
2. Select a technician/vendor from the dropdown
3. Fill in client information, service type, dates
4. Add manager notes to give context
5. Attach photos or reference files
6. Submit the assignment

The technician will then:
- See the assignment in their Service Portal dashboard
- See a red notification banner
- Be able to click "Complete Report" to fill in their findings
- Submit the completed report

**MONITORING ASSIGNED WORK:**
- Check the Service Reports tab for "Assigned" status items
- These are pending completion by technicians
- Follow up if assignments aren't completed timely`
          }
        ]
      },
      'launch-app': {
        title: 'Launch App (Implementations)',
        description: 'Project tracking, client onboarding, and implementations',
        icon: Icons.launch,
        color: 'bg-purple-600',
        visibleTo: ['super_admin', 'manager', 'team_member'],
        portalSection: 'launch_portal',
        articles: [
          {
            title: 'Understanding the Project Board',
            content: `The Launch App is your central tool for tracking client implementation projects from start to finish.

**ACCESSING THE LAUNCH APP:**
1. From Portal Hub, click the "Implementations" tile
2. Or navigate directly to /launch/home
3. Requires "Has Implementations Access" permission

**THE PROJECT BOARD:**

When you first enter, you'll see the Kanban-style project board with columns for each status:

**Column 1: New/Pending**
- Projects that have been created but not started
- May be waiting for contracts, scheduling, or resources

**Column 2: In Progress**
- Active projects currently being worked on
- This is where most of your attention should be

**Column 3: On Hold**
- Projects paused for various reasons
- Hover over the project to see notes about why it's on hold

**Column 4: Complete**
- Finished projects
- Kept for reference and reporting

**PROJECT CARDS:**
Each project appears as a card showing:
• Client name (large, bold text)
• Current phase (e.g., "Installation", "Validation")
• Progress bar showing % complete
• Team member avatars (who's assigned)
• Due date indicator

**SWITCHING VIEWS:**
- Click "Board View" for Kanban columns
- Click "List View" for a traditional table format
- Use the search box to find specific projects

**FILTERING AND SORTING:**
- Search by client name
- Filter by status
- Filter by assigned team member
- Sort by due date or progress`
          },
          {
            title: 'Creating a New Project',
            content: `Step-by-step instructions for creating a new implementation project.

**BEFORE YOU START:**
Gather this information:
- Client/practice name
- HubSpot Deal ID (if syncing with HubSpot)
- Target start and completion dates
- Which team members will be assigned
- Which template to use (typically Biolis AU480 CLIA)

**STEP-BY-STEP PROCESS:**

**Step 1: Click "New Project"**
1. Click the "+ New Project" button (top right of the board)
2. A form will open

**Step 2: Enter Basic Information**
• **Project Name**: Usually the client/practice name
• **Client/Practice Name**: The organization name
• **Description**: Brief description of the implementation scope

**Step 3: Select a Template**
Choose from available templates:
• **Biolis AU480 CLIA** - Standard 102-task template for CLIA lab implementations
• Other templates as available

The template determines which tasks are automatically created for the project.

**Step 4: Link to HubSpot (Optional but Recommended)**
• **HubSpot Deal ID**: Enter the Deal ID from HubSpot
• This enables automatic syncing of progress
• Files can be uploaded directly to the deal record

**Step 5: Set Target Dates**
• **Start Date**: When work begins
• **Target Completion Date**: Expected finish date

**Step 6: Assign Team Members**
• Click to add team members
• Each member can be notified of task assignments
• You can assign multiple people

**Step 7: Save the Project**
1. Review all information
2. Click "Create Project"
3. The project will appear in the "New/Pending" column

**WHAT HAPPENS AFTER CREATION:**
- All template tasks are generated
- Project appears on the board
- Team members can start working on tasks
- Progress tracking begins

**PRO TIP:** Always link to HubSpot when possible - this ensures all documentation flows to the CRM automatically.`
          },
          {
            title: 'Working with Project Tasks',
            content: `How to manage tasks within a project - viewing, completing, adding notes, and uploading files.

**OPENING A PROJECT:**
Click on any project card to open the detailed view.

**UNDERSTANDING THE TASK VIEW:**

Tasks are organized by **Stages** (phases of the implementation):
1. Planning & Preparation
2. Site Assessment
3. Equipment Installation
4. Validation & Testing
5. Training
6. Go-Live
7. Post-Launch Support

Each stage contains multiple tasks that must be completed.

**TASK INFORMATION:**
Each task shows:
• Task name and description
• Assigned owner
• Due date
• Completion status (checkbox)
• Subtasks (if any)
• Attachments

**COMPLETING A TASK:**

**Step 1: Find the task**
Scroll through stages or use search to find your task

**Step 2: Review requirements**
Click on the task to expand details. Make sure you understand what's needed.

**Step 3: Do the work**
Complete whatever the task requires in the real world

**Step 4: Add documentation**
Before marking complete, add any relevant:
• Notes about what was done
• Files (reports, photos, documents)
• Updated information

**Step 5: Check the box**
Click the checkbox to mark the task complete

⚠️ **WARNING:** Some tasks have subtasks that must ALL be completed before the main task can be marked done.

**ADDING NOTES TO A TASK:**
1. Click on the task to expand it
2. Find the "Notes" section
3. Click "Add Note"
4. Type your note (be specific and include dates/details)
5. Save

**UPLOADING FILES TO A TASK:**
1. Expand the task
2. Find the "Attachments" section
3. Click "Upload" or drag and drop files
4. Supported formats: PDF, Word, Excel, images
5. Files are automatically stored and accessible to all team members

**REASSIGNING A TASK:**
If a task needs to be handled by someone else:
1. Expand the task
2. Click on the current owner
3. Select a new owner from the dropdown
4. Save

**PRO TIPS:**
- Complete tasks as you go, don't batch them up
- Add notes explaining any deviations from standard process
- Upload photos as documentation for installation tasks
- Check task dependencies - some tasks can't start until others are done`
          },
          {
            title: 'Project Progress and Reporting',
            content: `Understanding project progress metrics and generating reports.

**PROGRESS TRACKING:**

**Project Progress Bar:**
Shows overall completion percentage calculated as:
(Completed Tasks / Total Tasks) × 100

**Stage Progress:**
Each stage has its own progress indicator showing completion within that phase.

**UNDERSTANDING THE METRICS:**

• **Green** = On track or ahead
• **Yellow** = Slightly behind but recoverable
• **Red** = Significantly behind, needs attention

**GENERATING THE SOFT-PILOT CHECKLIST:**

The Soft-Pilot Checklist is a comprehensive document summarizing project readiness for go-live.

**To Generate:**
1. Open the project
2. Click "Generate Soft-Pilot Checklist"
3. The system compiles all task completions and notes
4. A PDF is generated
5. If HubSpot is linked, it's automatically uploaded to the deal

**WHAT'S INCLUDED:**
- All completed tasks with timestamps
- Task notes and documentation
- Completion status by stage
- Overall readiness assessment

**HUBSPOT SYNC:**

If your project is linked to a HubSpot deal:
- Progress updates can sync to deal stage
- Documents upload to deal files
- Notes sync to deal activity
- Stage mapping is configurable

**To Manually Sync:**
1. Open the project
2. Click "Sync to HubSpot"
3. Current progress pushes to the deal record

**VIEWING PROJECT HISTORY:**
- All changes are logged
- Click "Activity Log" to see what changed and when
- Useful for auditing and troubleshooting

**EXPORTING PROJECT DATA:**
1. Open the project
2. Click "Export"
3. Choose format (CSV or PDF)
4. Download for external reporting or records`
          },
          {
            title: 'What Clients See: Launch Milestones',
            content: `Understanding how clients view their implementation progress in their portal.

**CLIENT VISIBILITY:**

Clients with active implementation projects see a "Launch Milestones" section in their portal showing:

• Current phase name (e.g., "Validation & Testing")
• Visual progress bar
• List of completed milestones
• Upcoming milestones
• Overall percentage complete

**WHAT CLIENTS CAN DO:**
- View progress (read-only)
- See which tasks are complete
- Understand what's coming next
- Cannot edit tasks or mark complete

**WHAT CLIENTS CANNOT SEE:**
- Internal notes
- Team member details
- Detailed task descriptions
- File attachments (unless specifically shared)

**CONTROLLING CLIENT VISIBILITY:**

By default, major milestones (stage completions) are visible. Internal tasks within stages may not be.

To manage what clients see:
- Use stage-level tasks for client visibility
- Keep granular tasks internal
- Share progress updates verbally for sensitive items

**WHEN CLIENTS ASK QUESTIONS:**

If a client asks about progress:
1. Open their project in Launch App
2. Review current status
3. Note any blockers or dependencies
4. Provide accurate update based on actual completion

**PRO TIP:** Review project progress before client calls so you can speak confidently about status.

**COMPLETION:**
When a project is marked "Complete":
- Launch Milestones section no longer appears in client portal
- Project moves to Complete column in your board
- Historical data remains for reference`
          }
        ]
      },
      'service-portal': {
        title: 'Service Portal',
        description: 'Service reports, field operations, and vendor management',
        icon: Icons.service,
        color: 'bg-emerald-600',
        visibleTo: ['super_admin', 'manager', 'team_member', 'vendor'],
        portalSection: 'service_portal',
        articles: [
          {
            title: 'Service Portal Overview',
            content: `The Service Portal is the dedicated workspace for Field Service Engineers (FSE), Clinical Application Specialists (CAS), and service technicians to document all service activities.

**ACCESSING THE SERVICE PORTAL:**
1. From Portal Hub, click the "Service Portal" tile
2. Or navigate directly to /service-portal
3. Requires "Has Service Portal Access" permission

**YOUR DASHBOARD:**

When you log in, you'll see your personalized dashboard with:

**1. Welcome Banner**
Shows your name and role (Vendor, Technician, or Super Admin)

**2. Assigned Service Visits (Red Alert Box)**
If managers have assigned work to you, you'll see a red notification box showing:
- Number of pending assignments
- Client names
- Due dates
- "Complete Report" buttons

⚠️ **IMPORTANT:** Red notification = work assigned to YOU that needs attention

**3. Quick Action Cards**
- **New Service Report** - Create a new report from scratch
- **Service Reports** - View all your submitted reports
- **My Reports Count** - Total reports you've submitted

**4. Recent Service Reports**
Shows your 5 most recent submissions for quick reference

**THE SIDEBAR MENU:**
- Dashboard - Return to home
- New Service Report - Start a new report
- Service Reports - View all reports

**TWO WAYS TO CREATE REPORTS:**

1. **Self-Initiated Reports**
   When you complete a service call, you create the report yourself with all details

2. **Assigned Reports**
   A manager assigns a service visit to you with pre-filled client info. You complete it after the visit.`
          },
          {
            title: 'Creating a New Service Report (Self-Initiated)',
            content: `Complete step-by-step guide for creating a service report when you initiate the work yourself.

**WHEN TO USE:**
- You completed a service call not pre-assigned to you
- You're documenting service work you initiated
- Ad-hoc service visits

**STEP-BY-STEP PROCESS:**

**Step 1: Start a New Report**
1. Click "New Service Report" in the sidebar
2. Or click the "New Service Report" card on dashboard

**Step 2: Select the Client**
• Click the "Client/Facility" dropdown
• Search or scroll to find your client
• Select the client

The system may auto-fill some fields based on the client record.

**Step 3: Fill in Client Information**
• **Customer Name**: Contact person you worked with
• **Address**: Service location (may auto-fill)
• **Service Completion Date**: Date you performed the service

**Step 4: Select Service Type** (Required)
Choose from:
- Analyzer Hardware
- Inventory
- LIS/EMR
- Billing & Fees
- Compliance
- Training
- Validations (triggers additional fields)

**Step 5: Enter Equipment Details**
• **Analyzer Model**: Equipment model serviced
• **Analyzer Serial Number**: S/N of the unit
• **HubSpot Ticket #**: If this relates to a support ticket

**Step 6: Document Your Work** (Required)
• **Description of Work Performed**: Detailed description of what you did
  - Be specific: "Replaced reagent tubing, calibrated analyzer, verified results"
  - Include any issues found and how they were resolved

• **Materials Used**: List any parts or supplies used
  - Include part numbers if available
  - Note quantities

• **Solution Provided**: What was the outcome/fix?

• **Outstanding Issues/Recommendations**: Note anything that still needs attention

**Step 7: For Validation Service Type**
If you selected "Validations", additional fields appear:
• Start Date / End Date
• Days On-Site (auto-calculated)
• Analyzers Validated (model, serial, pass/fail)
• Training Provided
• Test Procedures (detailed testing protocol)
• Validation Results
• Optional: Upload validation report file

**Step 8: Capture Signatures** (Required)

**Technician Signature:**
1. Click in the signature box
2. Use your mouse/finger to sign
3. Click "Save" to lock it in
4. Click "Clear" if you need to redo

**Customer Signature:**
1. Hand device to customer
2. Have them sign in the box
3. Click "Save"
4. IMPORTANT: Get this before leaving the site!

**Step 9: Review and Submit**
1. Scroll through and verify all information
2. Click "Submit Report"
3. Wait for confirmation message

**AFTER SUBMISSION:**
- Report is saved permanently
- PDF is generated automatically
- If client has HubSpot record, a ticket is created
- PDF is attached to HubSpot company record
- Client can view in their support ticket history

**SAVING DRAFTS:**
Click "Save as Draft" if you need to:
- Step away and return later
- Gather more information
- Wait for customer signature

Drafts are saved to your browser and restored when you return.

**PRO TIPS:**
✓ Complete reports same-day while details are fresh
✓ Take photos during service for reference
✓ Be specific in descriptions - they become permanent records
✓ Always get customer signature before leaving`
          },
          {
            title: 'Completing Assigned Service Visits',
            content: `How to complete service reports that were assigned to you by a manager.

**UNDERSTANDING ASSIGNED WORK:**

When a manager assigns a service visit to you:
1. They pre-fill client information, service type, and notes
2. You receive the assignment in your dashboard
3. You perform the service visit
4. You complete the report with your findings and signatures

**FINDING YOUR ASSIGNMENTS:**

**On Dashboard:**
- Red alert box at top shows pending assignments
- Each shows client name, service type, due date

**What's Pre-Filled for You:**
- Client/Facility name
- Customer contact
- Address
- Service type
- Equipment details
- Manager notes (context for the visit)
- Reference photos (if provided)
- Client files (documents you might need)

**STEP-BY-STEP COMPLETION:**

**Step 1: Review the Assignment**
1. Click "Complete Report" on the assignment
2. Read the Assignment Details section carefully
3. Note any manager instructions
4. Review attached photos and files

**Step 2: Perform the Service Visit**
Do your work based on the assignment details.

**Step 3: Return to Complete the Report**
After the visit, you fill in:

• **Service Date**: Actual date of service (may differ from scheduled)

• **Description of Work Performed**: What you actually did
  - Be thorough - this is your documentation

• **Materials Used**: Parts/supplies consumed

• **Solution Provided**: How you resolved the issue

• **Outstanding Issues**: Anything still needing attention

**Step 4: Validation Fields (if applicable)**
If it's a validation-type service:
• Validation Start/End dates
• Training provided
• Test procedures used
• Validation results

**Step 5: Signatures**
Same as self-initiated reports:
1. Your technician signature
2. Customer signature

**Step 6: Submit**
Click "Submit Service Report" to complete.

**WHAT HAPPENS AFTER:**
- Assignment is marked complete
- Report appears in Service Reports list
- Manager can see the completed report
- PDF generated and synced to HubSpot

**IMPORTANT NOTES:**

⚠️ You cannot change the pre-filled client information - that's set by the manager

⚠️ If something is wrong with the assignment, contact your manager before starting

⚠️ Complete assignments promptly - they show as pending until done`
          },
          {
            title: 'Validation Reports: Complete Guide',
            content: `Detailed guide for creating comprehensive validation reports.

**WHEN TO CREATE A VALIDATION REPORT:**
- Initial equipment validation after installation
- Annual revalidation requirements
- Post-repair validation
- Method validation for new tests
- CLIA compliance documentation

**SELECTING VALIDATIONS SERVICE TYPE:**

When you choose "Validations" as your service type, additional fields appear that are specific to validation work.

**VALIDATION-SPECIFIC FIELDS:**

**1. Start Date / End Date**
- Enter the actual dates of validation activities
- System calculates "Days On-Site" automatically

**2. Analyzers Validated**
Click "+ Add Analyzer" for each unit validated:
• Model number
• Serial number
• Status: Passed, Failed, or Conditional

You can add multiple analyzers if validating several units.

**3. Training Provided**
Document any training given to client staff:
- What topics were covered
- Who was trained
- Duration and format

**4. Test Procedures** (Required)
This is a critical field. Document exactly what procedures you performed:
- Precision testing (how many levels, how many runs)
- Accuracy testing (comparison method)
- Linearity (range tested)
- Reportable range verification
- Reference interval verification
- Carry-over testing
- Any other tests performed

Example:
"Precision: 3 levels × 5 runs over 3 days. Accuracy: 40 patient samples compared to reference lab method. Linearity: Tested across manufacturer-stated range. Reference intervals verified against published values."

**5. Validation Results** (Required)
Document the outcomes:
- Which tests passed/failed
- Any values outside expected ranges
- Correlation coefficients
- Summary of performance

**6. Validation Report File**
Upload your detailed validation document:
- Click "Upload" or drag and drop
- Accepted formats: PDF, Word, Excel
- This is attached to the final report

**SIGNATURES:**
Both signatures are especially important for validation reports as they serve as official approval of the validation.

**BEST PRACTICES:**
✓ Document everything in detail - validations are regulatory records
✓ Include specific numbers and results, not just "passed"
✓ Attach the full validation report file
✓ Ensure customer understands what they're signing
✓ Keep copies of raw data if needed

**COMMON MISTAKES TO AVOID:**
❌ Vague descriptions ("did validation testing")
❌ Missing test procedure details
❌ Forgetting to upload the validation report file
❌ Not getting customer signature
❌ Wrong dates (must be actual dates, not submission date)`
          },
          {
            title: 'Viewing Your Service Report History',
            content: `How to find, view, and manage your submitted service reports.

**ACCESSING REPORT HISTORY:**
1. Click "Service Reports" in the sidebar
2. Or click the "Service Reports" card on dashboard

**THE REPORTS LIST:**

You'll see a table with all your submitted reports showing:
• Status (Submitted, Assigned)
• Date
• Client name
• Service type
• Actions (View)

**SEARCHING AND FILTERING:**

**Search Box:**
Type to search by:
- Client name
- Service type
- Technician name

**VIEWING A REPORT:**
1. Find the report in the list
2. Click the "View" button
3. Full report details display

**REPORT DETAIL VIEW:**

The view shows all information from your submission:
- Client information
- Service details
- Description of work
- Materials and solutions
- Signatures (displayed as images)
- For validations: all validation-specific data

**WHAT YOU CANNOT DO:**
- Edit submitted reports (they're permanent records)
- Delete reports
- Change signatures

If you made an error:
- Contact your administrator
- They may be able to add a correction note
- A new report may be needed for significant errors

**PDF GENERATION:**
Each submitted report generates a PDF that:
- Is stored in the system
- Syncs to HubSpot (if client has record)
- Can be downloaded for reference
- Is attached to the client's support ticket history

**PRO TIP:** Regularly review your recent reports to ensure accuracy while details are still fresh in memory.`
          },
          {
            title: 'Managing Vendors and Service Assignments (Managers)',
            content: `This guide is for Managers who need to manage vendors, assign service visits, and oversee service operations.

**ACCESSING SERVICE PORTAL ADMIN FEATURES:**

Managers with "Service Portal" access enabled can access full admin features:
1. Go to Admin Hub → Service Portal section
2. You'll see three tabs: Service Reports, Validation Reports, and Vendors

**REQUIRED PERMISSION:**
• You must be a Manager (isManager = true)
• AND have "Service Portal" checkbox enabled in your user settings
• Super Admins automatically have full access

---

**MANAGING EXTERNAL VENDORS:**

The Vendors tab allows you to add and manage external service technicians.

**Adding a New Vendor:**
1. Click "Add Vendor" button
2. Fill in required fields:
   • **Name**: Vendor's full name
   • **Email**: Their login email
   • **Password**: Temporary password (they'll reset on first login)
3. Select "Assigned Clients" - which clients this vendor can service
4. Click "Create Vendor"

**What Vendors Can Do:**
• Submit service reports for their assigned clients
• View reports they've created
• Access the Service Portal

**Editing a Vendor:**
1. Find the vendor in the list
2. Click the edit (pencil) icon
3. Update their information or assigned clients
4. Click "Update Vendor"

**Deleting a Vendor:**
1. Click the delete (trash) icon next to the vendor
2. Confirm the deletion
3. NOTE: This removes their access but keeps their submitted reports

---

**ASSIGNING SERVICE VISITS:**

You can pre-assign service work to technicians or vendors with all client details filled in.

**Creating an Assignment:**
1. Go to Admin Hub → Service Portal → Service Reports tab
2. Click "Assign New Service" button
3. Fill in the assignment form:

**Required Fields:**
• **Assign To**: Select the technician/vendor
• **Client/Facility**: Select the client
• **Service Type**: Choose the service category

**Pre-fill Fields:**
• **Customer Name**: Contact person at the client
• **Address**: Service location
• **Analyzer Model/Serial**: Equipment details
• **HubSpot Ticket #**: Reference ticket
• **Service Completion Date**: Expected/scheduled date

**Manager Notes:**
Add instructions or context for the technician. They'll see this when they view the assignment.

**Uploading Photos:**
1. Click "Upload Photos"
2. Select photos showing the issue or location
3. Photos appear in the assignment for the technician to reference

**Uploading Client Files:**
1. Click "Upload Files"
2. Select documents (manuals, previous reports, etc.)
3. Files are attached for technician reference

**Submit the Assignment:**
Click "Create Assignment" - the technician will see it in their dashboard.

---

**TRACKING ASSIGNMENTS:**

**In the Service Reports Tab:**
• **Status: Assigned** (yellow) = Pending technician completion
• **Status: Submitted** (green) = Technician has completed the report

**Viewing Assignment Details:**
1. Click "View" on any report
2. See all pre-filled information
3. Once completed, see technician's work documentation

**Editing Manager Notes:**
1. Open a report/assignment
2. Find the "Manager Notes" section
3. Update notes as needed
4. Click "Save Notes"

---

**BEST PRACTICES FOR MANAGERS:**

✓ **Assign work promptly** - Technicians see assignments in real-time

✓ **Provide clear notes** - Include specific instructions and context

✓ **Upload reference materials** - Photos and files help technicians prepare

✓ **Set realistic dates** - Consider travel and complexity

✓ **Follow up on overdue assignments** - Check the reports list regularly

✓ **Review completed reports** - Ensure quality and completeness

---

**VENDOR ASSIGNMENT WORKFLOW:**

1. **Create vendor account** (Vendors tab)
2. **Assign clients** to the vendor
3. **Create service assignments** for specific client visits
4. **Monitor completion** in Service Reports tab
5. **Review submitted reports** for quality

**TROUBLESHOOTING:**

**Can't see Vendors tab?**
• Ensure you're a Manager with Service Portal access
• Log out and back in after permissions change

**Vendor can't log in?**
• Verify their email is correct
• Reset their password if needed

**Assignment not showing for technician?**
• Verify you selected the correct assignee
• Check the technician has Service Portal access`
          }
        ]
      },
      'client-portal': {
        title: 'Client Portal Admin',
        description: 'Managing client portals, content, and communications',
        icon: Icons.client,
        color: 'bg-amber-500',
        visibleTo: ['super_admin', 'manager'],
        portalSection: 'client_portal_admin',
        articles: [
          {
            title: 'Understanding Client Portals',
            content: `Each client organization has their own dedicated portal where they can access services, documents, and support.

**CLIENT PORTAL ARCHITECTURE:**

Each client portal is accessed at:
/portal/{client-slug}

Where {client-slug} is a unique identifier like "dallas-urology" or "austin-medical"

**WHAT CLIENTS SEE IN THEIR PORTAL:**

**1. Home Dashboard**
- Welcome message with their practice name
- Announcements from Thrive 365
- Quick links to other sections

**2. Launch Milestones** (only for active implementation projects)
- Progress through implementation phases
- Completed and upcoming milestones

**3. Inventory Management**
- Weekly inventory submission
- Stock level reports and alerts
- Expiring item warnings

**4. Customer Support Center**
- Support ticket history
- Submit new tickets
- Live chat access

**5. Files & Documents**
- Contracts and agreements
- Product inserts and documentation
- Certificates of analysis
- Their own uploads

**YOUR ROLE AS ADMIN:**
Using Client Portal Admin, you manage what clients see and access:
- Create/edit announcements
- Upload documents
- Monitor their activity
- Configure portal settings

**ACCESSING CLIENT PORTAL ADMIN:**
1. From Portal Hub, click "Client Portal" tile
2. Requires "Has Client Portal Admin Access" permission
3. Select which client you want to manage`
          },
          {
            title: 'Creating and Managing Announcements',
            content: `Announcements appear prominently on the client's home dashboard. Use them to communicate important information.

**WHEN TO USE ANNOUNCEMENTS:**
- New product information
- Service schedule changes
- Important compliance updates
- Holiday schedule notifications
- Upcoming visits or events

**CREATING AN ANNOUNCEMENT:**

**Step 1: Navigate to Announcements**
1. Go to Client Portal Admin
2. Select the client
3. Click "Announcements" tab

**Step 2: Click "New Announcement"**

**Step 3: Fill in the Details**

• **Title** (Required)
  - Keep it clear and concise
  - Example: "New Reagent Lot Now Available"

• **Content** (Required)
  - Full message text
  - Can include multiple paragraphs
  - Be specific with dates and actions needed

• **Type** - Choose the appropriate color coding:
  - **Info** (Blue) - General information, updates
  - **Warning** (Yellow/Orange) - Important notices, deadlines
  - **Success** (Green) - Good news, completions

**Step 4: Optional Settings**

• **Pinned** - Toggle ON to keep this announcement at the top
  - Use for critical, ongoing information
  - Only pin one or two announcements at a time

• **Priority** - Toggle ON for highlighted styling
  - Draws extra attention
  - Use sparingly for truly urgent items

• **Attachment** - Upload a related file
  - Client can download directly from announcement
  - Good for: schedules, guides, forms

**Step 5: Save**
Click "Create" to publish immediately

**EDITING ANNOUNCEMENTS:**
1. Find the announcement in the list
2. Click "Edit"
3. Make changes
4. Save

**DELETING ANNOUNCEMENTS:**
1. Find the announcement
2. Click "Delete"
3. Confirm

⚠️ Deleted announcements cannot be recovered

**BEST PRACTICES:**
✓ Keep announcements current - delete outdated ones
✓ Use appropriate type colors (don't make everything a "warning")
✓ Pin only critical items
✓ Include action items and deadlines clearly
✓ Review announcements monthly for relevance`
          },
          {
            title: 'Uploading and Organizing Client Documents',
            content: `The Files section allows you to share documents with clients and receive their uploads.

**DOCUMENT CATEGORIES:**

Documents are organized into categories:
• **Contracts** - Agreements, MSAs, SOWs
• **Onboarding** - Setup guides, welcome materials
• **Inserts** - Product package inserts
• **Certificates of Analysis** - COAs for reagents/supplies
• **Analyzer** - Equipment manuals, specs
• **Other** - Anything else

**UPLOADING A DOCUMENT:**

**Step 1: Navigate to Documents**
1. Go to Client Portal Admin
2. Select the client
3. Click "Documents" tab

**Step 2: Click "Upload Document"**

**Step 3: Select Your File**
Click to browse or drag and drop

**Supported Formats:**
- PDF (recommended)
- Word documents (.doc, .docx)
- Excel spreadsheets (.xls, .xlsx)
- Images (.jpg, .png)
- Text files (.txt)

**Step 4: Select Category**
Choose the appropriate category from the dropdown

**Step 5: Add Notes** (Optional)
Include context like:
- What the document is for
- Expiration date if applicable
- Version number

**Step 6: Upload**
Click "Upload" to save

**WHAT CLIENTS SEE:**
- Documents grouped by category
- File name and upload date
- Your notes (if added)
- Download button for each file

**CLIENT UPLOADS:**

Clients can also upload documents from their Files page.

**Viewing Client Uploads:**
1. Go to Documents tab
2. Look for "Client Uploads" section
3. Review uploaded files
4. These are NOT visible to the client in the main files list

**Why Clients Upload:**
- Returning signed contracts
- Submitting required documentation
- Sharing compliance records

**MANAGING DOCUMENTS:**

**Deleting a Document:**
1. Find the document in the list
2. Click "Delete"
3. Confirm

⚠️ Deleted documents are removed from client view immediately

**Updating a Document:**
There's no "edit" - instead:
1. Upload the new version
2. Delete the old version
3. Or add a note indicating which is current

**BEST PRACTICES:**
✓ Use clear, descriptive file names
✓ Include dates in file names for versioned documents
✓ Keep COAs current - delete expired ones
✓ Review client uploads promptly
✓ Organize by category consistently`
          },
          {
            title: 'Client Portal Settings and Customization',
            content: `Configure portal appearance and settings for individual clients.

**ACCESSING SETTINGS:**
1. Go to Client Portal Admin
2. Select the client
3. Click "Settings" tab

**AVAILABLE CUSTOMIZATIONS:**

**1. Practice/Organization Name**
The name displayed throughout the portal
- Appears in welcome messages
- Shows in headers
- Used in generated documents

**2. Logo**
Upload the client's logo:
- Displayed in their portal header
- Should be PNG or JPG
- Recommended size: 200×60 pixels
- Transparent background works best

**3. Banner Image**
Custom banner for their dashboard:
- Appears at top of home page
- Adds visual branding
- Recommended size: 1200×300 pixels

**4. Contact Information**
Set who they should contact:
- Primary contact name
- Email address
- Phone number
- Shows in portal footer/support sections

**APPLYING CHANGES:**
1. Make your changes
2. Click "Save Settings"
3. Changes appear immediately for the client

**PREVIEWING:**
After saving, you can view the client portal to see how it looks:
1. Note the client's portal URL
2. Open in a new tab (or incognito window)
3. Log in as a test client user (or ask client)

**BEST PRACTICES:**
✓ Get client logo before portal goes live
✓ Use professional, high-quality images
✓ Keep branding consistent with client's identity
✓ Update contact info when personnel changes
✓ Test changes after applying`
          },
          {
            title: 'Monitoring Client Activity',
            content: `How to track what clients are doing in their portal.

**WHAT YOU CAN MONITOR:**

**1. Inventory Submissions**
From Client Portal Admin > Inventory:
- See submission history
- Check last submission date
- View submitted quantities
- Identify clients who haven't submitted recently

**Warning Indicators:**
- Red banner if no submission in 7+ days
- Low stock alerts
- Expiring inventory warnings

**2. Support Tickets**
Tickets submitted by clients appear in HubSpot:
- View open tickets
- Track resolution status
- See ticket history

**3. Document Downloads**
While not directly logged, you can infer activity by:
- Checking if client references documents in support tickets
- Asking during regular communications

**4. Portal Logins**
Full login tracking is in Admin Hub:
- User Management shows last login date
- Identify inactive users

**FOLLOWING UP WITH CLIENTS:**

**Inactive Inventory Submissions:**
If a client hasn't submitted inventory in over a week:
1. Contact them to remind about weekly submission
2. Check if they're having access issues
3. Offer training if needed

**Open Support Issues:**
Regularly review tickets to ensure:
- Tickets aren't sitting unresolved
- Escalations are handled
- Client satisfaction

**PRO TIP:** Set a weekly calendar reminder to:
- Check inventory submission compliance
- Review open support tickets
- Follow up with inactive clients`
          }
        ]
      },
      'inventory': {
        title: 'Inventory Management',
        description: 'Weekly inventory updates, reports, and alerts',
        icon: Icons.inventory,
        color: 'bg-teal-600',
        visibleTo: ['super_admin', 'manager', 'client'],
        portalSection: 'client_portal',
        articles: [
          {
            title: 'Inventory System Overview (For Internal Staff)',
            content: `The inventory system allows clients to track their reagent and supply levels. As internal staff, you need to understand how it works to support clients and monitor compliance.

**HOW THE SYSTEM WORKS:**

**1. Inventory Template**
Each client has an inventory template containing:
- List of products they use
- Expected reorder levels
- Categories for organization

**2. Weekly Submissions**
Clients are expected to submit inventory counts weekly:
- They log in to their portal
- Navigate to Inventory > Weekly Update
- Enter current quantities (open and closed)
- Add expiration dates where applicable
- Submit

**3. Automated Alerts**
The system generates alerts for:
- **Low Stock** (≤2 units): Red alerts, needs immediate reorder
- **Expiring Soon** (within 30 days): Orange alerts, use first

**YOUR RESPONSIBILITIES AS INTERNAL STAFF:**

**Monitoring Compliance:**
- Check that clients submit weekly
- Follow up if submissions are overdue (>7 days)
- Watch for patterns in low stock

**Supporting Clients:**
- Help them understand the submission process
- Assist with inventory template questions
- Explain alert thresholds

**Responding to Alerts:**
- Low stock alerts may trigger proactive outreach
- Expiring inventory may require guidance on usage priority

**ACCESSING CLIENT INVENTORY (Admin):**
1. Go to Client Portal Admin
2. Select the client
3. Click "Inventory" tab
4. View their submissions and current levels`
          },
          {
            title: 'Reading Inventory Reports',
            content: `How to interpret client inventory data and reports.

**REPORTS & ALERTS PAGE:**

This page (visible to both clients and admins) shows current inventory status.

**UNDERSTANDING THE SECTIONS:**

**1. Low Stock Alerts (Red)**
- Items where Open Qty + Closed Qty ≤ 2
- These are CRITICAL - risk of stockout
- Action: Contact client about reordering
- Example: If a client has 1 open and 1 closed of a reagent, they'll stockout soon

**2. Expiring Soon (Orange)**
- Items with expiration within 30 days
- These should be used first
- Action: Remind client to use before expiration
- May need to plan replacement orders

**3. Current Stock Levels (Blue)**
- All items with current quantities
- Shows breakdown: Open vs Closed
- Filter by category
- Search for specific items

**READING THE DATA:**

For each item you'll see:
• **Item Name**: Product name
• **Category**: Type of product
• **Open Qty**: Units currently in use/opened
• **Closed Qty**: Sealed, unopened units
• **Expiration Date**: If reported
• **Total**: Open + Closed combined

**INTERPRETING PATTERNS:**

High Open, Low Closed:
- Client is using product but not stocking replacement
- May need to reorder soon

High Closed, Low Open:
- Well-stocked but may indicate slow usage
- Watch expiration dates

Consistently Low Totals:
- Client may be ordering just-in-time
- Higher risk of stockout

No Recent Submissions:
- Client may have forgotten
- Could indicate access issues
- Follow up needed

**EXPORTING DATA:**
Click "Download CSV" to export inventory data:
- Use for analysis
- Share with account teams
- Create reports`
          },
          {
            title: 'Managing Inventory Templates',
            content: `How inventory templates work and how to modify them for clients.

**WHAT IS AN INVENTORY TEMPLATE?**

The template defines which items appear in a client's inventory submission form:
- Product names
- Categories
- Expected items for their account

**DEFAULT TEMPLATE:**
New clients start with a standard template. You can customize it for each client.

**VIEWING A CLIENT'S TEMPLATE:**
1. Go to Admin Hub
2. Navigate to inventory settings
3. Select the client
4. View their item list

**ADDING ITEMS TO A TEMPLATE:**

**Step 1: Navigate to Template Management**
1. Find the client's template
2. Click "Add Item"

**Step 2: Enter Item Details**
• **Item Name**: Exact product name
• **Category**: Select or create category
• **Notes**: Optional additional info

**Step 3: Save**
Item appears in client's submission form

**REMOVING ITEMS:**
1. Find the item in the template
2. Click "Remove"
3. Item no longer appears for submission
4. Historical data is preserved

**CUSTOM ITEMS:**
Clients can add their own items:
- They click "Add Custom Item" in their portal
- These are specific to that client
- You can see them in admin view

**CATEGORIES:**
Items are grouped by category:
- Reagents
- Calibrators
- Controls
- Consumables
- Etc.

Keep categories consistent across clients when possible.

**BEST PRACTICES:**
✓ Set up templates before client goes live
✓ Include all products client uses
✓ Use consistent naming
✓ Review templates annually for accuracy
✓ Remove discontinued products`
          },
          {
            title: 'Troubleshooting Inventory Issues',
            content: `Common inventory problems and how to resolve them.

**PROBLEM: Client Says Form Is Empty**
Cause: No inventory template set up
Solution:
1. Check if template exists in admin
2. Create template if missing
3. Add all appropriate items

**PROBLEM: Client Can't Submit**
Causes & Solutions:
1. Check they're logged in correctly
2. Verify inventory section is enabled
3. Ensure all required fields are filled
4. Try different browser/clear cache

**PROBLEM: Submission Shows Old Data**
Cause: Client viewing cached page
Solution: Client should refresh browser (Ctrl+F5)

**PROBLEM: Alerts Not Accurate**
Causes:
1. Old submission data (client hasn't submitted recently)
2. Expiration dates not entered
3. Quantities entered incorrectly

Solution:
1. Confirm client is submitting weekly
2. Ask them to verify and resubmit

**PROBLEM: Missing Items**
Cause: Item not in template
Solution: Add item to client's template

**PROBLEM: Duplicate Items**
Cause: Item added multiple times
Solution:
1. Identify duplicates
2. Remove the duplicate entries
3. Ask client to resubmit

**PROBLEM: Client Can't Find Submission History**
Solution: Guide them to:
1. Inventory section
2. "History" or "Past Submissions" tab
3. Filter by date if needed

**GETTING HELP:**
For technical issues beyond these solutions:
1. Document the exact error
2. Note the client and steps to reproduce
3. Submit bug report through Admin Hub inbox`
          }
        ]
      },
      'customer-support': {
        title: 'Customer Support Center',
        description: 'Tickets, live chat, and support resources',
        icon: Icons.support,
        color: 'bg-sky-600',
        visibleTo: ['super_admin', 'manager', 'client'],
        portalSection: 'client_portal',
        articles: [
          {
            title: 'Support Center Overview',
            content: `The Customer Support Center provides multiple ways to get help.

**Three Support Options:**
1. **Ticket History**: View your past and current support tickets
2. **Submit a Ticket**: Create a new support request
3. **Live Chat**: Chat with support agents in real time

**Accessing Support:**
Navigate to Customer Support from the sidebar menu.`
          },
          {
            title: 'Viewing Ticket History',
            content: `See all your support tickets in one place.

**Ticket Information:**
- Subject/title
- Creation date
- Current status
- Resolution notes (when resolved)

**Ticket Statuses:**
- **New**: Just submitted
- **In Progress**: Being worked on
- **Assigned**: Assigned to a specific agent
- **Vendor Escalation**: Escalated to vendor support
- **Resolved**: Issue resolved
- **Closed**: Ticket closed

**Viewing Details:**
Click on any ticket to expand and see:
- Full description
- Resolution notes
- Attached files (including service reports)

**Attachments:**
Service reports submitted by technicians appear as downloadable attachments on related tickets.`
          },
          {
            title: 'Submitting a Ticket',
            content: `Create a new support request for any issues or questions.

**How to Submit:**
1. Click the "Submit a Ticket" tab
2. Fill out the support form with:
   - Subject
   - Description of your issue
   - Priority level
   - Any relevant attachments
3. Submit the form

**Response Time:**
Expect a response within 24-48 hours for standard requests.

**Alternative Contact:**
You can also email support directly at support@thrive365labs.com`
          },
          {
            title: 'Using Live Chat',
            content: `Get real-time help from support agents.

**Starting a Chat:**
1. Click the "Live Chat" tab
2. Click "Start Chat Now" button
3. Or use the chat icon in the bottom-right corner

**Chat Availability:**
Support agents are available during business hours. The green indicator shows when agents are online.

**Best For:**
- Quick questions
- Urgent issues
- Real-time troubleshooting`
          }
        ]
      },
      'files': {
        title: 'Files & Documents',
        description: 'Document management and file uploads',
        icon: Icons.files,
        color: 'bg-violet-600',
        visibleTo: ['super_admin', 'manager', 'client'],
        portalSection: 'client_portal',
        articles: [
          {
            title: 'Accessing Documents',
            content: `The Files page shows all documents shared with you.

**Document Categories:**
- Contracts
- Onboarding
- Inserts
- Certificates of Analysis
- Analyzer
- Other

**Downloading Files:**
Click on any document to download it to your device.`
          },
          {
            title: 'Uploading Documents',
            content: `Clients can upload documents for admin review.

**How to Upload:**
1. Navigate to Files
2. Click "Upload File"
3. Select your file
4. Choose a category
5. Add optional notes
6. Upload

**Supported Files:**
Most common file types are supported including PDF, Word, Excel, and images.

**Where Files Go:**
Uploaded files appear in the "Your Uploads" section and are also visible to administrators.

**HubSpot Integration:**
If configured, uploaded files are automatically attached to your HubSpot company/deal record.`
          }
        ]
      },
      'technical-docs': {
        title: 'Technical Documentation',
        description: 'System architecture, API reference, and developer resources',
        icon: Icons.code,
        color: 'bg-slate-700',
        ownerOnly: true,
        visibleTo: ['super_admin'],
        portalSection: 'general',
        articles: [
          {
            title: 'System Overview',
            content: `Thrive 365 Labs Web App is a comprehensive multi-project launch tracker designed for managing complex clinical laboratory equipment installations.

**Key Features:**
- 102-task template for Biolis AU480 CLIA lab setups
- Robust admin controls and team member accounts
- Embeddable, authenticated client portals for external stakeholders
- Service Portal for field service engineers and clinical application specialists
- HubSpot CRM integration for seamless deal tracking and file management
- Google Drive integration for document storage

**Technology Stack:**
- Backend: Express.js REST API
- Frontend: React 18 (CDN-loaded), Babel standalone for JSX
- Styling: Tailwind CSS (CDN)
- Database: Replit Database (key-value store)
- Authentication: JWT tokens, bcryptjs password hashing
- PDF Generation: PDFKit, PDFMake

**System Design Principles:**
- Modularity: Clear separation of frontend and backend concerns
- Scalability: CDN-based frontend delivery and flexible key-value data storage
- Security: JWT-based authentication, bcrypt password hashing, role-based access control
- User Experience: Streamlined workflows, intuitive reporting, and client-facing transparency`
          },
          {
            title: 'Application Portals',
            content: `The application consists of multiple interconnected portals, each serving different user roles:

**1. Unified Login Portal (/login)**
Central authentication hub where users log in once and access all portals they have permissions for.

**2. Admin Hub (/admin)**
Administrative dashboard for system management:
- User management with granular permissions
- Dashboard statistics and quick actions
- Feedback/bug report inbox
- Bulk password reset functionality
- Activity logging and system settings

**3. Launch App (/launch/home)**
Project implementation tracking for internal teams:
- Project boards with task management
- 102-task template system
- HubSpot synchronization
- Soft-pilot checklist generation
- Launch reports and analytics
- Implementations calendar

**4. Client Portal (/portal/{slug})**
Authenticated client-facing portal:
- Home dashboard with announcements
- Launch milestones and progress tracking
- Inventory management with weekly updates
- Customer support with HubSpot ticket integration
- Files and documents section

**5. Service Portal (/service-portal)**
Dedicated portal for field service engineers and CAS:
- Service report creation and management
- Validation reports (Phase 3)
- Digital signature capture
- PDF generation and export
- HubSpot ticket auto-creation

**6. Knowledge Hub (/knowledge)**
Resource center with how-to guides, documentation, and link directory.

**7. Changelog (/changelog)**
Version history and release notes for the application.`
          },
          {
            title: 'User Management & Permissions',
            content: `The application uses a role-based access control system with granular permission flags.

**User Roles:**
- Admin: Full system access
- Team Member: Internal staff with configurable permissions
- Client: Client portal users tied to a specific practice
- Vendor: External service providers with limited, client-specific access

**Permission Flags:**
- hasServicePortalAccess: Service Portal access
- hasAdminHubAccess: Admin Hub access
- hasImplementationsAccess: Implementation App access
- hasClientPortalAdminAccess: Client Portal admin features
- assignedClients: Array for vendor client assignments

**Authentication Features:**
- JWT-based authentication with secure token management
- Password reset system with admin approval workflow
- Bulk password reset with first-login change prompt
- Forgot password request system`
          },
          {
            title: 'Project & Task Management',
            content: `The Launch App provides comprehensive project and task management.

**102-Task Biolis AU480 CLIA Template:**
Industry-standard workflow for clinical laboratory equipment installations.

**Task Features:**
- Per-stage task addition
- Email-based owner assignment
- Subtasks with completion enforcement
- Task descriptions and notes
- Due dates with timeline sorting
- Task reordering within stages
- File attachments (PDF, images, Word, Excel, text)
- Tagging system with global tag library
- Bulk operations (update, delete)

**Additional Features:**
- Project cloning for rapid duplication
- CSV import/export for bulk task management
- Template system for reusable project structures
- Project notes log with aggregated view`
          },
          {
            title: 'API Reference - Authentication',
            content: `Authentication API endpoints for user login and management.

**POST /api/auth/login**
User login - returns JWT token and user data

**POST /api/auth/signup**
User registration - creates new user account

**POST /api/auth/client-login**
Client portal login - authenticates client users

**POST /api/auth/service-login**
Service portal login - authenticates service personnel

**POST /api/auth/admin-login**
Admin hub login - authenticates admin users

**POST /api/auth/forgot-password**
Password reset request - sends reset notification to admin

**POST /api/auth/change-password**
Change user password - updates password for authenticated user`
          },
          {
            title: 'API Reference - Projects & Tasks',
            content: `Project and task management API endpoints.

**Projects:**
- GET /api/projects - List all projects
- POST /api/projects - Create new project
- GET /api/projects/:id - Get project details
- PUT /api/projects/:id - Update project
- DELETE /api/projects/:id - Delete project
- POST /api/projects/:id/clone - Clone project
- GET /api/projects/:id/export - Export project data

**Tasks:**
- GET /api/projects/:id/tasks - List project tasks
- POST /api/projects/:id/tasks - Create task
- PUT /api/projects/:projectId/tasks/:taskId - Update task
- DELETE /api/projects/:projectId/tasks/:taskId - Delete task
- POST /api/projects/:projectId/tasks/:taskId/reorder - Reorder task
- PUT /api/projects/:projectId/tasks/bulk-update - Bulk update tasks
- POST /api/projects/:projectId/tasks/bulk-delete - Bulk delete tasks

**Subtasks:**
- POST /api/projects/:projectId/tasks/:taskId/subtasks - Create subtask
- PUT /api/projects/:projectId/tasks/:taskId/subtasks/:subtaskId - Update subtask
- DELETE /api/projects/:projectId/tasks/:taskId/subtasks/:subtaskId - Delete subtask

**Notes & Files:**
- POST /api/projects/:projectId/tasks/:taskId/notes - Add note
- PUT /api/projects/:projectId/tasks/:taskId/notes/:noteId - Update note
- DELETE /api/projects/:projectId/tasks/:taskId/notes/:noteId - Delete note
- POST /api/projects/:projectId/tasks/:taskId/files - Upload file
- DELETE /api/projects/:projectId/tasks/:taskId/files/:fileId - Delete file`
          },
          {
            title: 'API Reference - Users & Templates',
            content: `User management and template API endpoints.

**User Management (Admin):**
- GET /api/users - List all users
- POST /api/users - Create user
- PUT /api/users/:userId - Update user
- DELETE /api/users/:userId - Delete user
- GET /api/team-members - List team members
- POST /api/admin/bulk-password-reset - Bulk password reset

**Templates:**
- GET /api/templates - List templates
- POST /api/templates - Create template
- GET /api/templates/:id - Get template
- PUT /api/templates/:id - Update template
- DELETE /api/templates/:id - Delete template
- POST /api/templates/:id/clone - Clone template
- POST /api/templates/:id/import-csv - Import CSV to template
- PUT /api/templates/:id/set-default - Set as default template`
          },
          {
            title: 'API Reference - Inventory & Service Portal',
            content: `Inventory management and service portal API endpoints.

**Inventory:**
- GET /api/inventory/template - Get inventory template
- PUT /api/inventory/template - Update inventory template
- GET /api/inventory/submissions/:slug - Get submissions history
- GET /api/inventory/latest/:slug - Get latest submission
- POST /api/inventory/submit - Submit inventory update
- GET /api/inventory/report/:slug - Get inventory report
- GET /api/inventory/export/:slug - Export inventory CSV
- GET /api/inventory/custom-items/:slug - Get custom items
- POST /api/inventory/custom-items/:slug - Add custom item
- DELETE /api/inventory/custom-items/:slug/:itemId - Delete custom item

**Service Portal:**
- GET /api/service-portal/data - Get portal data
- GET /api/service-portal/clients - Get assigned clients
- POST /api/service-reports - Create service report
- GET /api/service-reports - List service reports
- GET /api/service-reports/:id - Get service report
- PUT /api/service-reports/:id - Update service report
- DELETE /api/service-reports/:id - Delete service report
- POST /api/validation-reports - Create validation report
- GET /api/validation-reports - List validation reports
- GET /api/validation-reports/:id - Get validation report
- PUT /api/validation-reports/:id - Update validation report`
          },
          {
            title: 'API Reference - HubSpot Integration',
            content: `HubSpot CRM integration API endpoints.

**HubSpot Endpoints:**
- GET /api/hubspot/test - Test HubSpot connection
- GET /api/hubspot/pipelines - Get deal pipelines
- GET /api/hubspot/deals - Get deals
- GET /api/hubspot/record/:recordId - Get HubSpot record
- GET /api/hubspot/stage-mapping - Get stage mapping
- PUT /api/hubspot/stage-mapping - Update stage mapping
- POST /api/hubspot/upload-to-deal - Upload file to deal
- POST /api/projects/:id/hubspot-sync - Sync project to HubSpot
- POST /api/projects/:id/soft-pilot-checklist - Generate soft-pilot checklist

**Integration Features:**
- OAuth-based configuration for secure authentication
- Deal pipeline sync with stage mapping
- Task completion notes sync
- Stage progression tracking
- File uploads to Company, Deal, Contact records
- HubSpot ticket integration for customer support
- Chatbot embed for live chat support
- Webhook endpoint for form submissions
- Idempotent sync with stored HubSpot IDs to prevent duplicates`
          },
          {
            title: 'External Dependencies & Environment',
            content: `Third-party services and configuration requirements.

**Third-Party Services:**
- HubSpot: CRM integration for deal pipeline, client profiles, ticket management, and file storage
- Google Drive: Storage for soft-pilot checklist uploads and document management
- Replit Database: Primary data persistence (key-value store)

**NPM Packages:**
- @hubspot/api-client: ^13.4.0
- @replit/database: ^2.0.5
- axios: ^1.13.2
- bcryptjs: ^2.4.3
- body-parser: ^1.20.2
- cors: ^2.8.5
- express: ^4.18.2
- form-data: ^4.0.5
- googleapis: ^169.0.0
- jsonwebtoken: ^9.0.2
- multer: ^2.0.2
- pdfkit: ^0.17.2
- pdfmake: ^0.3.3
- uuid: ^9.0.0

**CDN Dependencies (Frontend):**
- React 18 / ReactDOM 18
- Babel standalone (JSX transpilation)
- Tailwind CSS
- Heroicons v2

**Environment Variables:**
- PORT: Server port (default: 3000) - Optional
- JWT_SECRET: Secret key for JWT token signing - Required
- HUBSPOT_WEBHOOK_SECRET: Secret for HubSpot webhook validation - Optional
- HUBSPOT_PRIVATE_APP_TOKEN: HubSpot private app token for API access - Required
- GOOGLE_SERVICE_ACCOUNT_KEY: Google service account credentials (JSON) - Optional`
          },
          {
            title: 'Project Structure',
            content: `File organization and directory structure.

**Root Directory:**
- server.js: Main Express server with API routes
- hubspot.js: HubSpot integration module
- googledrive.js: Google Drive integration module
- pdf-generator.js: PDF generation utilities
- changelog-generator.js: Automated changelog generation
- package.json: Dependencies and scripts
- template-biolis-au480-clia.json: Default task template

**Public Directory (/public):**
- index.html: Root HTML
- login.html: Unified login portal
- admin-hub.html: Admin dashboard
- app.js: Main React application
- portal.html: Client portal
- service-portal.html: Service portal
- client.html: Legacy client view
- knowledge.html: Knowledge hub
- link-directory.html: Resource links
- changelog.html: Version history viewer
- changelog.md: Markdown changelog

**Static Assets:**
- attached_assets/: Static assets directory
- banners/: Banner images
- thrive365-logo.webp: Logo file

**Deployment:**
1. Import the project to Replit
2. Configure environment secrets in Replit Secrets
3. Click "Run" to start the application
4. Configure custom domain if needed

The application supports custom domains for main application access and client portal URLs (e.g., launch.yourdomain.com/{slug}).`
          }
        ]
      },
      'admin-guide': {
        title: 'Admin Guide',
        description: 'Key tips, best practices, and advanced features for system administrators',
        icon: Icons.admin,
        color: 'bg-rose-600',
        adminOnly: true,
        visibleTo: ['super_admin', 'manager'],
        portalSection: 'general',
        articles: [
          {
            title: 'Admin Hub Best Practices',
            content: `Essential tips for effectively managing the Admin Hub.

**Dashboard Overview:**
The Admin Hub dashboard is your command center. Use the quick stats section to monitor:
- Active implementation projects (New Launches count)
- Pending items requiring attention (Open Tickets)

**Inbox Management Tips:**
1. Check the inbox at least once daily
2. Prioritize password reset requests - users are blocked until resolved
3. Track bug reports for patterns that may indicate system issues
4. Use feature requests to inform development priorities

**Quick Actions:**
- Navigate directly to User Management from the dashboard
- Access system statistics for a high-level overview
- View the changelog to stay informed about updates

**Best Practice:** Set a daily routine to review the inbox first thing in the morning.`
          },
          {
            title: 'User Management Deep Dive',
            content: `Advanced user management techniques and strategies.

**User Role Selection Guide:**
- **Admin**: Reserve for system owners and IT administrators only
- **Team Member**: Most internal staff - use permission toggles for fine-grained control
- **Client**: Always assign to a specific practice/client
- **Vendor**: External service providers - limit to assigned clients only

**Permission Strategy:**
Think about least-privilege access:
1. Start with minimal permissions
2. Add access as needed based on job function
3. Review permissions quarterly

**Manager Flag:**
The "Is Manager" toggle gives limited Admin Hub access without full admin privileges. Use for:
- Team leads who need to view dashboard stats
- Supervisors who need to manage service portal

**Bulk Operations Tips:**
1. Use search to filter users first
2. Select multiple users with checkboxes
3. Bulk password reset sends emails with temporary passwords
4. Users will be prompted to change password on first login

**Security Tip:** Always verify email addresses before creating accounts to prevent unauthorized access.`
          },
          {
            title: 'Reporting & Analytics',
            content: `Understanding and using reports effectively across the system.

**Admin Hub Dashboard Stats:**
- **New Launches**: Count of active (non-complete) implementation projects
- **Open Tickets**: Sum of unresolved feedback, bugs, and password reset requests

**Service Portal Reports:**
Service reports are automatically synced to HubSpot:
1. PDF generated on submission
2. Ticket created in HubSpot
3. Attached to client's company record
4. Visible in client's Customer Support Center

**Launch App Reports:**
From the Launch App, you can:
- Export soft-pilot checklists to Google Drive
- Generate project status reports
- View task completion analytics

**Inventory Reports (Client Portal):**
Monitor client inventory through:
- Low stock alerts (2 or fewer items)
- Expiring soon warnings (30 days)
- Weekly submission compliance
- CSV export for external analysis

**Pro Tip:** Set up regular report reviews (weekly for inventory, monthly for projects) to catch issues early.`
          },
          {
            title: 'HubSpot Integration Management',
            content: `Managing the HubSpot CRM integration effectively.

**What Syncs Automatically:**
1. Service reports create HubSpot tickets
2. Files uploaded sync to company/deal records
3. Support tickets from portal appear in HubSpot
4. Deal pipeline stages can be mapped to project stages

**Troubleshooting Sync Issues:**
- Check the HUBSPOT_PRIVATE_APP_TOKEN is valid
- Verify the HubSpot company/deal record exists
- Review server logs for API errors
- Test connection using /api/hubspot/test endpoint

**Best Practices:**
1. Keep HubSpot company records up to date
2. Use consistent naming conventions
3. Map project stages to deal stages for accurate pipeline views
4. Review sync status after major updates

**Important:** Changes made directly in HubSpot may not reflect in the portal. Always make primary changes in the portal.`
          },
          {
            title: 'Troubleshooting Common Issues',
            content: `Quick solutions for frequently encountered problems.

**User Can't Login:**
1. Verify email is correct (case-sensitive)
2. Check if password reset is needed
3. Confirm user account exists and is active
4. Clear browser cache/cookies

**Service Portal Issues:**
1. Ensure user has "Has Service Portal Access" permission
2. Verify they're using the correct login
3. Check if they have assigned clients (for vendors)

**Client Portal Issues:**
1. Confirm client user is assigned to correct practice
2. Verify the practice slug is correct
3. Check if the client portal is enabled

**Inventory Not Showing:**
1. Ensure inventory template exists for the client
2. Verify client has submitted at least one update
3. Check browser console for JavaScript errors

**HubSpot Not Syncing:**
1. Verify HubSpot API token is valid
2. Check server logs for error messages
3. Confirm company/deal record exists in HubSpot
4. Test API connection

**General Tips:**
- Always check browser console (F12) for JavaScript errors
- Clear browser cache when experiencing display issues
- Verify user permissions are correctly assigned
- Check server logs for API errors`
          },
          {
            title: 'Security & Access Control',
            content: `Security best practices for system administrators.

**Password Policies:**
- Minimum 8 characters required
- Encourage mix of letters, numbers, symbols
- Force password change on first login for new users
- Process password reset requests promptly

**Session Management:**
- JWT tokens expire after 24 hours
- Users must re-authenticate after token expiry
- Tokens stored in browser localStorage
- Logout clears all stored tokens

**Permission Auditing:**
Regularly review:
1. Who has Admin access
2. Which vendors have client access
3. Team member permission levels
4. Inactive user accounts

**Security Checklist:**
- [ ] Review admin accounts quarterly
- [ ] Audit vendor access monthly
- [ ] Remove access for departed employees immediately
- [ ] Monitor for unusual login patterns
- [ ] Keep environment variables secure

**Emergency Procedures:**
If you suspect unauthorized access:
1. Change affected user passwords immediately
2. Review recent activity in the system
3. Check HubSpot for unexpected changes
4. Update JWT_SECRET if token compromise suspected
5. Notify affected clients if their data was accessed`
          }
        ]
      },
      'notifications': {
        title: 'Email Notifications',
        description: 'When you\'ll receive emails and what triggers each notification',
        icon: Icons.milestone,
        color: 'bg-primary-500',
        visibleTo: [],
        portalSection: 'general',
        articles: [
          {
            title: 'How Notifications Work',
            content: `The system sends automated email notifications based on activity and scheduled checks. Notifications are processed every 15 minutes and delivered to the email address on your account.

**Key things to know:**
- All emails come from Thrive 365 Labs (no-reply@thrive365labs.live)
- Duplicate notifications are suppressed — you won't receive the same alert twice for the same event
- Notifications can be enabled or disabled by an admin from the Admin Hub
- Up to 500 emails can be sent per day across the entire system`
          },
          {
            title: 'Task Deadline Warnings (Team Members & Admins)',
            content: `You will receive a deadline warning email when a task assigned to you is approaching its due date.

**When emails are sent:**
- 7 days before the due date
- 3 days before the due date
- 1 day before the due date

**Subject line:** Task due [timeframe]: [Task Title] — [Project Name]

**Who receives it:** The task owner (the email address in the "Owner" field of the task).

**Note:** If a task has no due date set, no deadline email is sent.`
          },
          {
            title: 'Task Overdue Alerts (Team Members & Admins)',
            content: `If a task passes its due date without being marked complete, overdue alerts are sent.

**Two separate emails:**

**1. Owner alert** — sent to the task's assigned owner as soon as the task becomes overdue, then periodically as it remains overdue.

**2. Admin escalation** — sent to admin accounts after a task has been overdue for 7 days.

**Subject lines:**
- Owner: OVERDUE (Xd): [Task Title] — [Project Name]
- Admin: ESCALATION: Task Xd overdue — [Task Title] ([Project Name])

**Who receives it:** Task owner for the first email; admins for the escalation.`
          },
          {
            title: 'Service Report — Signature Request (Admins & Managers)',
            content: `When a service technician submits a report that requires a signature, the designated signatory receives an email notification automatically.

**Trigger:** Service report status changes to "Signature Needed"

**Subject line:** Action needed: Service report for [Facility Name] awaits your signature

**Who receives it:** The admin or manager responsible for signing off on service reports.

**Contains:** Direct link to the report in the Service Portal.`
          },
          {
            title: 'Service Report — Admin Review Reminder (Admins)',
            content: `If a submitted service report has been sitting without admin review, a reminder is sent.

**Trigger:** A service report has been pending review for 3 days without action.

**Subject line:** Service report pending review: [Facility Name]

**Who receives it:** Admin accounts.

**Purpose:** Prevents reports from going unreviewed and ensures timely sign-off for client records.`
          },
          {
            title: 'Inventory Submission Reminder (Clients)',
            content: `Clients are reminded to submit their weekly inventory update if they haven't done so recently.

**Trigger:** No inventory submission received in the past 7 days.

**Subject line:** Reminder: Your weekly inventory update is due — [Practice Name]

**Who receives it:** The client account associated with the practice.

**Contains:** Direct link to the inventory section of your client portal.

**Tip:** Submit your inventory update each week to avoid receiving this reminder.`
          },
          {
            title: 'Milestone Reached (Admins & Project Team)',
            content: `A notification is sent when a project reaches key completion milestones.

**Trigger:** Project task completion crosses one of these thresholds:
- 25% complete
- 50% complete
- 75% complete
- 100% complete

**Subject line:** Milestone reached: [Project Name] is X% complete!

**Who receives it:** Admins and team members assigned to the project.

**Note:** Each threshold triggers only once per project — you won't receive repeat emails at the same percentage.`
          },
          {
            title: 'Go-Live Countdown Reminders (Admins & Project Team)',
            content: `As a project's go-live date approaches, reminder emails are sent to keep the team on track.

**When emails are sent:**
- 30 days before go-live
- 14 days before go-live
- 7 days before go-live

**Subject line:** Go-live in X days: [Project Name]

**Who receives it:** Admins and team members assigned to the project.

**Contains:** Current completion percentage and a link to the project.

**Note:** A go-live date must be set on the project for these reminders to send.`
          },
          {
            title: 'Announcements (Clients)',
            content: `When an admin publishes an announcement to the Client Portal, an email notification is sent to the relevant client(s).

**Trigger:** Admin publishes a new announcement in the Client Portal Admin section.

**Subject line:** New Announcement: [Announcement Title] (or [PRIORITY] New Announcement: ... for priority items)

**Who receives it:** The client account(s) the announcement is directed to.

**Contains:** Full announcement content and any attached document links.`
          }
        ]
      },
      'known-issues': {
        title: 'Known Issues',
        description: 'Current known issues, workarounds, and status updates',
        icon: Icons.lock,
        color: 'bg-red-600',
        isKnownIssue: true,
        hidden: true,
        visibleTo: ['super_admin', 'manager'],
        portalSection: 'general',
        articles: [
          {
            title: 'Task ID Type Coercion',
            content: `**Status:** Active (by design)
**Severity:** Low
**Affected:** Launch App task operations

Tasks can have numeric OR string IDs depending on whether they were created from templates or via the UI. When comparing task IDs, always normalize to strings. If you notice a task update "not saving," this is likely the cause.

**Workaround:** The system normalizes IDs in most operations, but edge cases exist in CSV import and dependency linking. Report any instances where task operations silently fail.`
          },
          {
            title: 'Slug Changes Break Client Portal URLs',
            content: `**Status:** Resolved
**Severity:** N/A
**Affected:** Client Portal access

When a client's practice name is changed, the system regenerates their portal slug but now stores the old slug(s) in a \`previousSlugs\` list. Requests to old portal URLs are automatically redirected (302) to the new URL, so existing bookmarks and shared links continue to work.

**No action needed.** Old URLs self-redirect. If a client reports a broken portal link, verify the redirect is resolving correctly by checking their \`previousSlugs\` field in the database.`
          },
          {
            title: 'Activity Log Truncates at 500 Entries',
            content: `**Status:** Active (by design)
**Severity:** Low
**Affected:** Admin Hub activity tracking

The activity log permanently deletes entries beyond 500. There is no archive mechanism.

**Workaround:** If you need long-term audit trails, periodically export activity data before it reaches 500 entries.`
          },
          {
            title: 'HubSpot Token Lost on Server Restart',
            content: `**Status:** Active (by design)
**Severity:** Low
**Affected:** HubSpot integration

HubSpot OAuth tokens are cached in-memory only. When the server restarts, a new token handshake is required automatically, but the first request after restart may be slow.

**Workaround:** No action needed. The system re-authenticates automatically. If HubSpot operations fail after a restart, wait 30 seconds and retry.`
          },
          {
            title: 'Bulk Operations Not Atomic',
            content: `**Status:** Partially resolved
**Severity:** Low
**Affected:** Launch App bulk task operations

Bulk task updates and deletes have no transaction support. If a bulk operation fails midway, some tasks may be updated while others are not.

The previous all-or-nothing permission behavior for bulk delete has been resolved — the system now uses partial success, deleting tasks the user has access to and skipping unauthorized ones, with a summary returned in the response.

**Workaround:** For large bulk updates (not deletes), consider doing them in smaller batches of 10–20 tasks to limit exposure if a mid-operation failure occurs.`
          }
        ]
      },
      'hidden-features': {
        title: 'Hidden Features & Internal Notes',
        description: 'Internal-only reference: undocumented behaviors, power-user features, and known issues',
        icon: Icons.lock,
        color: 'bg-gray-700',
        visibleTo: ['super_admin', 'manager'],
        portalSection: 'general',
        articles: [
          {
            title: 'Multi-User Client Portals',
            content: `Multiple users can share the same client portal (same URL slug and project access). When creating a client user in the Client Portal Admin Hub, use the **"Add to Existing Portal"** toggle to link a new login to an existing practice instead of creating a new one.

The new user inherits the portal slug, assigned projects, logo, and HubSpot IDs from the primary account. Both users log in with their own credentials and see the same portal data.

**Use case:** A practice has a lab director and an office manager who both need portal access.`
          },
          {
            title: 'Old Portal URLs Auto-Redirect',
            content: `When a client's practice name is changed, the system generates a new portal slug but preserves the old one in a \`previousSlugs\` list on the user record. Any request to an old portal URL (\`/portal/old-slug\`) is automatically redirected (302) to the current URL.

This means shared links and bookmarks continue to work transparently across practice name changes. No manual outreach to clients is needed.`
          },
          {
            title: 'Token Keys by Portal (localStorage)',
            content: `Each portal stores its auth token under a different localStorage key. Useful when debugging login or session issues:

| Portal | Token key | User key |
|--------|-----------|----------|
| Main app (Launch) | \`token\` | \`user\` |
| Login hub | \`unified_token\` | \`unified_user\` |
| Admin Hub | \`admin_token\` | \`admin_user\` |
| Client Portal | \`portal_token\` | \`portal_user\` |

The login hub sets all four simultaneously on login. Sign-out from any portal now clears all keys to prevent phantom sessions.`
          },
          {
            title: 'Known Issue: Task ID Type Coercion',
            content: `**Status:** Active (by design)
**Severity:** Low
**Affected:** Launch App task operations

Tasks can have numeric OR string IDs depending on whether they were created from templates or via the UI. The server normalizes IDs in most operations using double comparison (\`t.id === parseInt(taskId) || String(t.id) === String(taskId)\`), but edge cases exist in CSV import and dependency linking.

**If you see:** A task update that silently does nothing, or a dependency link that doesn't resolve — ID type mismatch is the likely cause. Report it so it can be patched.`
          },
          {
            title: 'Known Issue: Activity Log Truncates at 500 Entries',
            content: `**Status:** Active (by design)
**Severity:** Low
**Affected:** Admin Hub activity tracking

The activity log permanently drops the oldest entries once it exceeds 500 records. The limit is configurable via the \`ACTIVITY_LOG_MAX_ENTRIES\` environment variable but defaults to 500.

**Workaround:** If long-term audit trails are needed, export activity data periodically before the limit is hit. There is no built-in archive mechanism.`
          },
          {
            title: 'Known Issue: HubSpot Token Lost on Server Restart',
            content: `**Status:** Active (by design)
**Severity:** Low
**Affected:** HubSpot integration

HubSpot OAuth tokens are cached in-memory with a 60-second refresh buffer. Tokens are lost on server restart and require a fresh handshake, meaning the first HubSpot operation after a restart may be slow.

**Workaround:** No manual action needed — the system re-authenticates automatically. If HubSpot operations fail immediately after a restart, wait 30 seconds and retry.`
          },
          {
            title: 'Known Issue: Bulk Operations Not Atomic',
            content: `**Status:** Partially resolved
**Severity:** Low
**Affected:** Launch App bulk task operations

Bulk task operations have no transaction support. If a bulk update fails midway, some tasks may be modified while others are not.

Bulk delete now uses partial success — tasks the user can't delete are skipped and reported in the response rather than blocking the entire batch.

**Workaround:** For large bulk updates, do them in smaller batches of 10–20 tasks to limit exposure to mid-operation failures.`
          }
        ]
      },
      'developer-docs': {
        title: 'Developer Guide: Knowledge Hub',
        description: 'How to add, edit, and manage Knowledge Hub content',
        icon: Icons.code,
        color: 'bg-slate-700',
        visibleTo: ['super_admin'],
        portalSection: 'general',
        articles: [
          {
            title: 'Adding a New Guide Section',
            content: `**How to add a new section to the Knowledge Hub via Admin Hub:**

**STEP 1: Navigate to Knowledge Hub Management**
1. Go to Admin Hub
2. Click "Knowledge Hub" in the sidebar
3. Click "New Guide" button

**STEP 2: Fill in Guide Details**
- **Key**: URL-safe identifier (e.g., "new-feature-docs"). Cannot be changed later.
- **Title**: Display name shown in sidebar and header
- **Description**: Brief summary shown below the title
- **Portal Section**: Which portal this guide relates to (determines sidebar grouping)
- **Visible To**: Select which user tiers can see this guide
- **Color**: Badge color for the guide icon
- **Is Known Issue**: Toggle if this is an internal-only known issues entry

**STEP 3: Save and Add Articles**
1. Save the guide first
2. Then click into the guide to add articles
3. Each article needs a title and content

**Content Formatting Syntax:**
- **Bold text**: Wrap in double asterisks: \`**bold text**\`
- **Section headers**: Start a line with \`**HEADER TEXT:**\` (all caps with colon)
- **Numbered lists**: Start lines with \`1.\`, \`2.\`, etc.
- **Bullet points**: Start lines with \`-\` or a bullet character
- **Checkboxes**: Start lines with \`- [ ]\` (unchecked) or \`- [x]\` (checked)

**Structured Format (Optional):**
Articles can use a structured format with 6 fields:
- What It Is, Who Uses It, When to Use, How to Use, What Happens Next, Common Mistakes
This renders as color-coded sections with distinct visual styling.`
          },
          {
            title: 'Permission Tiers Reference',
            content: `**The 5 user tiers and their Knowledge Hub access:**

**1. Super Admin** (role = admin)
- Sees everything including Known Issues, Technical Docs, and Developer Guide
- Can manage all Knowledge Hub content via Admin Hub

**2. Manager** (isManager = true)
- Sees most internal content + Known Issues section
- Sees Admin Hub, Service Portal, Client Portal Admin guides
- Cannot see Technical Docs or Developer Guide

**3. Team Member** (role = user, not manager)
- Sees guides only for portals they have access to
- Access is filtered by their permission flags:
  - hasAdminHubAccess -> Admin Hub guides
  - hasImplementationsAccess -> Launch App guides
  - hasServicePortalAccess -> Service Portal guides
  - hasClientPortalAdminAccess -> Client Portal Admin guides
- Does NOT see client-facing Client Portal guides

**4. Vendor Technician** (role = vendor)
- Sees only Service Portal documentation
- Plus the general Portal Hub guide

**5. Client** (role = client)
- Sees only Client Portal documentation
- Inventory, Customer Support, Files & Documents
- Plus the general Portal Hub guide`
          },
          {
            title: 'API Endpoints for Knowledge Hub',
            content: `**Backend API endpoints for programmatic access:**

**Read Operations:**
- \`GET /api/knowledge/guides\` - Fetch all visible guides (filtered by user permissions)
- \`GET /api/knowledge/guides/:guideId\` - Fetch a single guide with articles

**Write Operations (Admin only):**
- \`POST /api/knowledge/guides\` - Create a new guide
- \`PUT /api/knowledge/guides/:guideId\` - Update guide metadata
- \`DELETE /api/knowledge/guides/:guideId\` - Delete a guide
- \`POST /api/knowledge/guides/:guideId/articles\` - Add an article
- \`PUT /api/knowledge/guides/:guideId/articles/:articleId\` - Update an article
- \`DELETE /api/knowledge/guides/:guideId/articles/:articleId\` - Delete an article
- \`PUT /api/knowledge/guides/:guideId/reorder\` - Reorder articles

**Seeding:**
- \`GET /api/knowledge/needs-seed\` - Check if database needs initial content
- \`POST /api/knowledge/seed\` - Seed database from hardcoded content (one-time)

**Guide Object Fields:**
- key, title, description, icon, color
- visibleTo: array of tier strings (empty = all users)
- portalSection: which portal section this belongs to
- isKnownIssue: boolean for Known Issues section
- articles: array of { title, content, format }`
          }
        ]
      }
    };

    // ═══════════════════════════════════════════════════════
    // V2 API HELPERS & SEED TRANSFORM
    // ═══════════════════════════════════════════════════════

    const V2_VISIBILITY = {
      'portal-hub': ['public', 'superAdmin', 'manager', 'teamMember', 'vendor', 'client'],
      'admin-hub': ['superAdmin', 'manager', 'teamMember'],
      'launch-app': ['superAdmin', 'manager', 'teamMember'],
      'service-portal': ['superAdmin', 'manager', 'teamMember', 'vendor'],
      'client-portal': ['superAdmin', 'manager', 'teamMember'],
      'inventory': ['superAdmin', 'manager', 'teamMember', 'client'],
      'customer-support': ['public', 'superAdmin', 'manager', 'teamMember', 'vendor', 'client'],
      'files': ['public', 'superAdmin', 'manager', 'teamMember', 'vendor', 'client'],
      'technical-docs': ['superAdmin'],
      'admin-guide': ['superAdmin']
    };

    const ICON_KEY_MAP = {
      'portal-hub': 'hub', 'admin-hub': 'admin', 'launch-app': 'launch',
      'service-portal': 'service', 'client-portal': 'client', 'inventory': 'inventory',
      'customer-support': 'support', 'files': 'files', 'technical-docs': 'code', 'admin-guide': 'admin'
    };

    function transformGuidesToV2Seed(guidesObj) {
      return Object.entries(guidesObj).map(([key, guide], idx) => ({
        key,
        title: guide.title,
        description: guide.description,
        icon: ICON_KEY_MAP[key] || 'book',
        color: guide.color,
        sortOrder: idx,
        visibleTo: V2_VISIBILITY[key] || ['superAdmin'],
        features: guide.articles.map((article, aIdx) => ({
          title: article.title,
          slug: article.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,''),
          sortOrder: aIdx,
          visibleTo: V2_VISIBILITY[key] || ['superAdmin'],
          tags: [key],
          content: {
            whatItIs: (article.content.split('\n').find(l => l.trim().length > 10) || '').replace(/\*\*/g, '').trim(),
            howToUseIt: article.content
          },
          knownIssues: ''
        }))
      }));
    }

    async function seedV2IfNeeded(token, isAdmin) {
      try {
        const check = await fetch('/api/knowledge/v2/needs-seed', {
          headers: token ? { 'Authorization': 'Bearer ' + token } : {}
        }).then(r => r.json());
        if (check.needsSeed && isAdmin) {
          const sections = transformGuidesToV2Seed(guides);
          await fetch('/api/knowledge/v2/seed', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ sections })
          });
        }
      } catch (e) { console.warn('V2 seed check failed:', e); }
    }

    async function fetchV2Sections(token) {
      try {
        const res = await fetch('/api/knowledge/v2/sections', {
          headers: token ? { 'Authorization': 'Bearer ' + token } : {}
        });
        const data = await res.json();
        return data.sections || [];
      } catch (e) {
        console.warn('V2 fetch failed, using local data:', e);
        return [];
      }
    }

    async function searchV2(token, query) {
      if (!query || query.trim().length < 2) return [];
      try {
        const res = await fetch('/api/knowledge/v2/search?q=' + encodeURIComponent(query), {
          headers: token ? { 'Authorization': 'Bearer ' + token } : {}
        });
        const data = await res.json();
        return data.results || [];
      } catch (e) { return []; }
    }

    // ============== UTILITY COMPONENTS ==============

    // Highlight search terms in text
    const HighlightText = ({ text, searchTerm }) => {
      if (!searchTerm || !searchTerm.trim() || typeof text !== 'string') return text;
      const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${escapedTerm})`, 'gi');
      const parts = text.split(regex);
      return parts.map((part, i) =>
        regex.test(part)
          ? <mark key={i} className="bg-yellow-200 text-yellow-900 rounded px-0.5">{part}</mark>
          : part
      );
    };

    // Helper function to render text with inline bold formatting (with search highlighting)
    const renderTextWithBold = (text, searchTerm) => {
      const parts = [];
      let remaining = text;
      let key = 0;

      while (remaining.length > 0) {
        const boldStart = remaining.indexOf('**');

        if (boldStart === -1) {
          parts.push(<span key={key++}><HighlightText text={remaining} searchTerm={searchTerm} /></span>);
          break;
        }

        if (boldStart > 0) {
          parts.push(<span key={key++}><HighlightText text={remaining.substring(0, boldStart)} searchTerm={searchTerm} /></span>);
        }

        const boldEnd = remaining.indexOf('**', boldStart + 2);

        if (boldEnd === -1) {
          parts.push(<span key={key++}><HighlightText text={remaining} searchTerm={searchTerm} /></span>);
          break;
        }

        const boldText = remaining.substring(boldStart + 2, boldEnd);
        parts.push(<strong key={key++} className="font-semibold text-gray-900"><HighlightText text={boldText} searchTerm={searchTerm} /></strong>);

        remaining = remaining.substring(boldEnd + 2);
      }

      return parts;
    };

    // ============== CONTENT BLOCK RENDERER (shared helper) ==============
    // Groups consecutive list items into proper <ol>/<ul> wrappers so numbering resets per section
    const renderContentBlock = (content, searchTerm, options = {}) => {
      if (!content) return null;
      const { compact } = options;
      const mlClass = compact ? 'ml-4' : 'ml-6';
      const lines = content.split('\n');
      const elements = [];
      let i = 0;
      let key = 0;

      while (i < lines.length) {
        const trimmed = lines[i].trim();

        // Empty line spacer
        if (trimmed === '') {
          elements.push(<div key={key++} className={compact ? 'h-1' : 'h-2'} />);
          i++;
          continue;
        }

        // Section header (**BOLD UPPERCASE:** or **BOLD UPPERCASE**)
        if (!compact && trimmed.match(/^\*\*[A-Z][^*]+:?\*\*$/)) {
          const text = trimmed.replace(/\*\*/g, '');
          elements.push(<h4 key={key++} className="font-bold text-gray-900 mt-6 mb-3 text-base"><HighlightText text={text} searchTerm={searchTerm} /></h4>);
          i++;
          continue;
        }

        // Step header (**STEP N: ...**)
        if (!compact && trimmed.match(/^\*\*STEP \d+:/i)) {
          const text = trimmed.replace(/\*\*/g, '');
          elements.push(<h5 key={key++} className="font-bold text-gray-800 mt-4 mb-2"><HighlightText text={text} searchTerm={searchTerm} /></h5>);
          i++;
          continue;
        }

        // Checkboxes (must check before bullets since - [ ] starts with -)
        if (trimmed.startsWith('- [ ]') || trimmed.startsWith('- [x]')) {
          const checked = trimmed.includes('[x]');
          const text = trimmed.substring(trimmed.indexOf(']') + 2);
          elements.push(
            <div key={key++} className="flex items-center gap-2 mb-1 ml-4">
              <input type="checkbox" checked={checked} readOnly className="rounded" />
              <span>{renderTextWithBold(text, searchTerm)}</span>
            </div>
          );
          i++;
          continue;
        }

        // Checkmark lines (✓) - group consecutive into a styled list
        if (trimmed.startsWith('\u2713 ') || trimmed.startsWith('\u2714 ')) {
          const items = [];
          while (i < lines.length) {
            const t = lines[i].trim();
            if (t.startsWith('\u2713 ') || t.startsWith('\u2714 ')) {
              items.push(t.substring(2));
              i++;
            } else break;
          }
          elements.push(
            <div key={key++} className={`space-y-1 mb-2 ${mlClass}`}>
              {items.map((item, j) => (
                <div key={j} className="flex items-start gap-2">
                  <svg className="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" strokeWidth="2.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                  <span>{renderTextWithBold(item, searchTerm)}</span>
                </div>
              ))}
            </div>
          );
          continue;
        }

        // Consecutive bullet items → wrap in <ul>
        if (trimmed.startsWith('• ') || (trimmed.startsWith('- ') && !trimmed.startsWith('- ['))) {
          const items = [];
          while (i < lines.length) {
            const t = lines[i].trim();
            if ((t.startsWith('• ') || (t.startsWith('- ') && !t.startsWith('- ['))) && t.length > 2) {
              items.push(t.substring(2));
              i++;
            } else break;
          }
          elements.push(
            <ul key={key++} className={`${mlClass} mb-2 list-disc space-y-1`}>
              {items.map((item, j) => <li key={j}>{renderTextWithBold(item, searchTerm)}</li>)}
            </ul>
          );
          continue;
        }

        // Consecutive numbered items → wrap in <ol> (resets numbering per group)
        if (trimmed.match(/^\d+\.\s/)) {
          const items = [];
          while (i < lines.length) {
            const t = lines[i].trim();
            if (t.match(/^\d+\.\s/)) {
              items.push(t.substring(t.indexOf('.') + 2));
              i++;
            } else break;
          }
          elements.push(
            <ol key={key++} className={`${mlClass} mb-2 list-decimal space-y-1`}>
              {items.map((item, j) => <li key={j}>{renderTextWithBold(item, searchTerm)}</li>)}
            </ol>
          );
          continue;
        }

        // Default paragraph
        elements.push(<p key={key++} className={`${compact ? 'mb-1' : 'mb-2'} leading-relaxed`}>{renderTextWithBold(compact ? trimmed : lines[i], searchTerm)}</p>);
        i++;
      }

      return elements;
    };

    // ============== STRUCTURED ARTICLE RENDERER ==============
    const StructuredArticleContent = ({ article, searchTerm }) => {
      if (!article.format) return null;
      const sections = [
        { key: 'whatItIs', label: 'What It Is', borderColor: 'border-blue-500', textColor: 'text-blue-700' },
        { key: 'whoUsesIt', label: 'Who Uses It', borderColor: 'border-purple-500', textColor: 'text-purple-700' },
        { key: 'whenToUse', label: 'When to Use', borderColor: 'border-green-500', textColor: 'text-green-700' },
        { key: 'howToUse', label: 'How to Use', borderColor: 'border-indigo-500', textColor: 'text-indigo-700' },
        { key: 'whatHappensNext', label: 'What Happens Next', borderColor: 'border-teal-500', textColor: 'text-teal-700' },
        { key: 'commonMistakes', label: 'Common Mistakes', borderColor: 'border-red-500', textColor: 'text-red-700' }
      ];
      return (
        <div className="space-y-4 mt-4">
          {sections.map(section => {
            const value = article.format[section.key];
            if (!value) return null;
            return (
              <div key={section.key} className={`border-l-4 ${section.borderColor} pl-4 py-2`}>
                <h5 className={`font-semibold ${section.textColor} text-sm uppercase tracking-wide mb-1`}>{section.label}</h5>
                <div className="text-gray-600 text-sm">
                  {renderContentBlock(value, searchTerm, { compact: true })}
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    // Freeform article content renderer
    const FreeformArticleContent = ({ content, searchTerm }) => {
      if (!content) return null;
      return (
        <div className="prose prose-sm max-w-none mt-4 text-gray-600">
          {renderContentBlock(content, searchTerm)}
        </div>
      );
    };

    // ============== FEATURE REFERENCE DATA ==============
    const FEATURE_MAP = {
      super_admin: [
        { portal: 'Admin Hub', icon: Icons.admin, colorClass: 'bg-accent', features: [
          'User account creation & permission management',
          'Live dashboard stats (users, projects, reports, clients)',
          'Inbox: password reset approvals & feedback review',
          'Notifications management',
          'Service portal administration'
        ]},
        { portal: 'Implementations', icon: Icons.launch, colorClass: 'bg-primary-500', features: [
          '10-phase project lifecycle tracking',
          'Create, clone & manage projects',
          'Task & subtask management with dependencies',
          'Bulk task operations (update & delete)',
          'Template library (create, clone, import/export)',
          'CSV import/export for tasks',
          'HubSpot CRM sync',
          'Client milestone visibility controls',
          'Progress reporting dashboard'
        ]},
        { portal: 'Service Portal', icon: Icons.service, colorClass: 'bg-success-600', features: [
          'Create & manage service reports',
          'Assign service visits to vendors',
          'Validation report management',
          'PDF report generation',
          'Full report history'
        ]},
        { portal: 'Client Portal Admin', icon: Icons.client, colorClass: 'bg-purple-600', features: [
          'Publish announcements',
          'Manage client documents',
          'Inventory template & submissions review',
          'Support ticket oversight',
          'Custom domain configuration'
        ]},
        { portal: 'Knowledge Hub', icon: Icons.book, colorClass: 'bg-indigo-600', features: [
          'All portal guides including internal docs',
          'Known issues log',
          'Admin-only technical documentation',
          'Role-specific workflow walkthroughs'
        ]}
      ],
      manager: [
        { portal: 'Admin Hub', icon: Icons.admin, colorClass: 'bg-accent', features: [
          'Dashboard stats overview',
          'Service portal administration',
          'View system activity'
        ]},
        { portal: 'Service Portal', icon: Icons.service, colorClass: 'bg-success-600', features: [
          'Manage & assign service visits to vendors',
          'Review submitted service reports',
          'Validation report oversight',
          'Full report history'
        ]},
        { portal: 'Client Portal Admin', icon: Icons.client, colorClass: 'bg-purple-600', features: [
          'Publish announcements',
          'Manage client documents',
          'Inventory review',
          'Support ticket oversight'
        ]},
        { portal: 'Knowledge Hub', icon: Icons.book, colorClass: 'bg-indigo-600', features: [
          'All portal guides',
          'Role-specific workflow walkthroughs',
          'Internal documentation'
        ]}
      ],
      vendor: [
        { portal: 'Service Portal', icon: Icons.service, colorClass: 'bg-success-600', features: [
          'Submit service reports',
          'View assigned service visits',
          'Complete validation reports',
          'View your report history'
        ]},
        { portal: 'Knowledge Hub', icon: Icons.book, colorClass: 'bg-indigo-600', features: [
          'Service portal guides',
          'Role-specific workflow walkthroughs'
        ]}
      ],
      client: [
        { portal: 'My Portal', icon: Icons.hub, colorClass: 'bg-primary-500', features: [
          'View implementation milestones & progress',
          'Submit weekly inventory updates',
          'View announcements from Thrive 365 Labs',
          'Access shared documents & resources',
          'Submit and track support tickets',
          'View signed service report history'
        ]},
        { portal: 'Knowledge Hub', icon: Icons.book, colorClass: 'bg-indigo-600', features: [
          'Client portal guides',
          'Workflow walkthroughs'
        ]}
      ]
    };

    const getTeamMemberFeatures = (user) => {
      const features = [];
      if (user.hasImplementationsAccess || (user.assignedProjects && user.assignedProjects.length > 0)) {
        features.push({ portal: 'Implementations', icon: Icons.launch, colorClass: 'bg-primary-500', features: [
          'Track assigned project progress',
          'Update task & subtask completion',
          'Add notes and file attachments to tasks',
          'View project phases & milestones',
          'Client milestone visibility controls'
        ]});
      }
      if (user.hasServicePortalAccess) {
        features.push({ portal: 'Service Portal', icon: Icons.service, colorClass: 'bg-success-600', features: [
          'Create & submit service reports',
          'Complete assigned service visits',
          'Submit validation reports',
          'View your report history'
        ]});
      }
      if (user.hasAdminHubAccess) {
        features.push({ portal: 'Admin Hub', icon: Icons.admin, colorClass: 'bg-accent', features: [
          'User account management',
          'Dashboard stats overview',
          'Process inbox requests'
        ]});
      }
      if (user.hasClientPortalAdminAccess) {
        features.push({ portal: 'Client Portal Admin', icon: Icons.client, colorClass: 'bg-purple-600', features: [
          'Publish announcements',
          'Manage client documents',
          'Inventory review'
        ]});
      }
      features.push({ portal: 'Knowledge Hub', icon: Icons.book, colorClass: 'bg-indigo-600', features: [
        'Portal guides for your access areas',
        'Role-specific workflow walkthroughs'
      ]});
      return features;
    };

    const ROLE_TABS = [
      { key: 'super_admin', label: 'Super Admin' },
      { key: 'manager', label: 'Manager' },
      { key: 'team_member', label: 'Team Member' },
      { key: 'vendor', label: 'Vendor' },
      { key: 'client', label: 'Client' }
    ];

    // ============== FEATURE OVERVIEW COMPONENT ==============
    const FeatureOverview = ({ userTier, user }) => {
      const canSwitchRoles = userTier === 'super_admin' || userTier === 'manager';
      const [activeTab, setActiveTab] = useState(userTier);

      const getFeatures = (tier) => {
        if (tier === 'team_member') return getTeamMemberFeatures(user);
        return FEATURE_MAP[tier] || [];
      };

      const displayFeatures = getFeatures(activeTab);

      const tierLabel = {
        super_admin: 'Super Admin', manager: 'Manager',
        team_member: 'Team Member', vendor: 'Vendor Technician', client: 'Client'
      };

      return (
        <div id="section-feature-overview" className="mb-8">
          {/* Header */}
          <div className="flex items-center justify-between mb-4">
            <div>
              <div className="flex items-center gap-3 mb-1">
                <h2 className="text-2xl font-bold text-accent">Feature Reference</h2>
                <span className="bg-primary-100 text-primary-700 text-xs font-semibold px-2.5 py-1 rounded-full uppercase tracking-wide">Quick Reference</span>
              </div>
              <p className="text-gray-500 text-sm">
                {canSwitchRoles
                  ? 'Overview of features available per role across the platform.'
                  : `Features available for your ${tierLabel[userTier]} account.`}
              </p>
            </div>
          </div>

          {/* Role tabs (admin/manager only) */}
          {canSwitchRoles && (
            <div className="flex flex-wrap gap-2 mb-5">
              {ROLE_TABS.map(tab => (
                <button
                  key={tab.key}
                  onClick={() => setActiveTab(tab.key)}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                    activeTab === tab.key
                      ? 'bg-primary-500 text-white shadow-sm'
                      : 'bg-white text-gray-600 border border-gray-200 hover:border-primary-300 hover:text-primary-600'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>
          )}

          {/* Team member note when viewing their own view */}
          {userTier === 'team_member' && (
            <div className="mb-4 p-3 bg-blue-50 border border-blue-100 rounded-lg text-sm text-blue-700">
              Showing features enabled for your account. Contact your admin to adjust access permissions.
            </div>
          )}

          {/* Feature cards grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            {displayFeatures.map((item, idx) => (
              <div key={idx} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div className="flex items-center gap-3 p-4 border-b border-gray-50">
                  <div className={`${item.colorClass} text-white rounded-lg w-10 h-10 flex items-center justify-center flex-shrink-0`}>
                    {item.icon}
                  </div>
                  <h3 className="font-semibold text-gray-800 text-sm">{item.portal}</h3>
                </div>
                <ul className="p-4 space-y-2">
                  {item.features.map((f, fi) => (
                    <li key={fi} className="flex items-start gap-2 text-sm text-gray-600">
                      <svg className="w-4 h-4 text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5"/>
                      </svg>
                      {f}
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // ============== GUIDE SECTION COMPONENT ==============
    const GuideSection = ({ guide, userTier, forceOpen, searchTerm }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [openArticle, setOpenArticle] = useState(null);
      const effectiveOpen = forceOpen || isOpen;

      const getBorderClass = () => {
        if (guide.isKnownIssue) return 'border-red-200 ring-1 ring-red-100';
        if (guide.ownerOnly) return 'border-amber-200 ring-1 ring-amber-100';
        if (guide.adminOnly) return 'border-rose-200 ring-1 ring-rose-100';
        const vt = guide.visibleTo || [];
        if (vt.length > 0 && vt.length <= 2) return 'border-amber-200 ring-1 ring-amber-100';
        return 'border-gray-100';
      };

      const getAccessBadge = () => {
        if (guide.isKnownIssue) return <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-red-100 text-red-700 text-xs font-medium rounded-full">{Icons.lock} Internal Only</span>;
        if (guide.ownerOnly) return <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded-full">{Icons.lock} Super Admin</span>;
        if (guide.adminOnly) return <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-rose-100 text-rose-700 text-xs font-medium rounded-full">{Icons.lock} Super Admin</span>;
        const vt = guide.visibleTo || [];
        if (vt.length === 1 && vt[0] === 'super_admin') return <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded-full">{Icons.lock} Super Admin</span>;
        if (vt.length > 0 && vt.length <= 2 && !vt.includes('team_member') && !vt.includes('vendor') && !vt.includes('client')) return <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-rose-100 text-rose-700 text-xs font-medium rounded-full">{Icons.lock} Admin/Manager</span>;
        return null;
      };

      return (
        <div id={`section-${guide.key || ''}`} className={`bg-white rounded-xl shadow-sm border overflow-hidden mb-4 ${getBorderClass()}`}>
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="w-full p-5 flex items-center justify-between hover:bg-gray-50 transition"
          >
            <div className="flex items-center gap-4">
              <div className={`inline-flex items-center justify-center w-12 h-12 ${guide.color || 'bg-gray-500'} text-white rounded-xl`}>
                {guide.icon || Icons.book}
              </div>
              <div className="text-left">
                <div className="flex items-center gap-2 flex-wrap">
                  <h3 className="text-lg font-semibold text-accent">
                    <HighlightText text={guide.title} searchTerm={searchTerm} />
                  </h3>
                  {getAccessBadge()}
                </div>
                <p className="text-gray-500 text-sm"><HighlightText text={guide.description} searchTerm={searchTerm} /></p>
              </div>
            </div>
            <div className={`text-gray-400 transition-transform ${effectiveOpen ? 'rotate-180' : ''}`}>
              {Icons.chevronDown}
            </div>
          </button>

          <div className={`guide-content ${effectiveOpen ? 'open' : ''}`}>
            <div className="border-t border-gray-100 p-4 bg-gray-50">
              <p className="text-sm text-gray-500 mb-3">{(guide.articles || []).length} article{(guide.articles || []).length !== 1 ? 's' : ''}</p>
              <div className="space-y-2">
                {(guide.articles || []).map((article, idx) => (
                  <div key={article.id || idx} className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <button
                      onClick={() => setOpenArticle(openArticle === idx ? null : idx)}
                      className="w-full p-4 flex items-center justify-between hover:bg-gray-50 transition text-left"
                    >
                      <span className="font-medium text-gray-800">
                        <HighlightText text={article.title} searchTerm={searchTerm} />
                      </span>
                      <span className={`text-gray-400 transition-transform ${openArticle === idx ? 'rotate-90' : ''}`}>
                        {Icons.chevronRight}
                      </span>
                    </button>
                    {(openArticle === idx || forceOpen) && (
                      <div className="px-4 pb-4 border-t border-gray-100 bg-gray-50">
                        {article.format ? (
                          <StructuredArticleContent article={article} searchTerm={searchTerm} />
                        ) : (
                          <FreeformArticleContent content={article.content} searchTerm={searchTerm} />
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============== SEARCH BAR COMPONENT ==============
    const SearchBar = ({ searchTerm, onSearchChange, resultCount, currentMatchIndex, totalMatches, onPrevMatch, onNextMatch }) => {
      const inputRef = useRef(null);
      return (
        <div className={`mb-6 ${searchTerm ? 'sticky top-0 z-40 pb-2 pt-2 -mx-4 px-4 lg:-mx-8 lg:px-8 bg-gray-50/95 backdrop-blur-sm shadow-sm' : ''}`}>
          <div className="relative">
            <input
              ref={inputRef}
              type="text"
              value={searchTerm}
              onChange={(e) => onSearchChange(e.target.value)}
              onKeyDown={(e) => {
                if (!searchTerm || totalMatches === 0) return;
                if (e.key === 'Enter') { e.shiftKey ? onPrevMatch() : onNextMatch(); e.preventDefault(); }
              }}
              placeholder="Search guides, articles, and documentation..."
              className="w-full px-4 py-3 pl-12 bg-white border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-800 placeholder-gray-400 transition"
            />
            <svg className="absolute left-4 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            {searchTerm && (
              <div className="flex items-center gap-2 absolute right-3 top-2">
                {totalMatches > 0 && (
                  <>
                    <span className="text-xs text-gray-500 tabular-nums min-w-[4rem] text-center">{currentMatchIndex + 1} of {totalMatches}</span>
                    <div className="flex items-center border border-gray-200 rounded-lg overflow-hidden">
                      <button
                        onClick={onPrevMatch}
                        title="Previous match (Shift+Enter)"
                        className="p-1.5 text-gray-500 hover:text-primary-600 hover:bg-primary-50 transition border-r border-gray-200"
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M5 15l7-7 7 7"/></svg>
                      </button>
                      <button
                        onClick={onNextMatch}
                        title="Next match (Enter)"
                        className="p-1.5 text-gray-500 hover:text-primary-600 hover:bg-primary-50 transition"
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7"/></svg>
                      </button>
                    </div>
                  </>
                )}
                {totalMatches === 0 && <span className="text-xs text-gray-400">0 results</span>}
                <button onClick={() => onSearchChange('')} className="p-1.5 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition ml-1">
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============== WORKFLOW WALKTHROUGH COMPONENT ==============
    const WorkflowWalkthrough = ({ userTier, onNavigate }) => {
      const walkthrough = WORKFLOW_WALKTHROUGHS[userTier];
      if (!walkthrough) return null;
      const [isExpanded, setIsExpanded] = useState(true);

      return (
        <div id="section-walkthroughs" className="mb-8">
          <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl overflow-hidden shadow-lg">
            <button onClick={() => setIsExpanded(!isExpanded)} className="w-full p-6 text-left text-white">
              <div className="flex items-center justify-between">
                <div>
                  <div className="flex items-center gap-2 mb-1">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>
                    <span className="text-xs font-medium text-white/70 uppercase tracking-wider">Getting Started</span>
                  </div>
                  <h2 className="text-2xl font-bold">{walkthrough.title}</h2>
                  <p className="text-white/80 mt-1">{walkthrough.subtitle}</p>
                </div>
                <span className={`text-white/60 transition-transform ${isExpanded ? 'rotate-180' : ''}`}>
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7"/></svg>
                </span>
              </div>
            </button>
            {isExpanded && (
              <div className="px-6 pb-6">
                <div className="grid gap-3">
                  {walkthrough.steps.map((step) => (
                    <div key={step.step}
                      className="flex items-start gap-4 bg-white/10 rounded-xl p-4 hover:bg-white/15 transition cursor-pointer"
                      onClick={() => onNavigate(step.link)}
                    >
                      <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                        {step.step}
                      </div>
                      <div>
                        <h3 className="font-semibold text-white">{step.title}</h3>
                        <p className="text-white/70 text-sm mt-0.5">{step.description}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============== SIDEBAR COMPONENT ==============
    const KnowledgeSidebar = ({ sections, activeSection, onNavigate, user, userTier, isMobileOpen, onClose, onSearchFocus }) => {
      const groupedSections = useMemo(() => {
        const groups = {};
        (sections || []).forEach(([key, guide]) => {
          const ps = guide.portalSection || 'general';
          const label = PORTAL_SECTION_LABELS[ps] || 'General';
          if (!groups[label]) groups[label] = [];
          groups[label].push({ key, title: guide.title, isKnownIssue: guide.isKnownIssue });
        });
        return groups;
      }, [sections]);

      return (
        <>
          {isMobileOpen && (
            <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 lg:hidden" onClick={onClose}></div>
          )}
          <aside className={`w-72 bg-white/95 backdrop-blur-sm border-r border-gray-100 min-h-screen fixed left-0 top-0 z-50 transform transition-all duration-300 ease-out ${isMobileOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'} lg:translate-x-0 lg:shadow-none`}>
            {/* Header */}
            <div className="p-5 border-b border-gray-100 flex justify-between items-center">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-9" />
              <button onClick={onClose} className="lg:hidden p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>

            {/* Profile Card */}
            <div className="mx-4 mt-4 p-4 rounded-xl bg-gradient-to-br from-primary-500/10 to-primary-700/5 border border-primary-100">
              <div className="flex items-center gap-3">
                <div className="w-11 h-11 rounded-xl gradient-header flex items-center justify-center text-white text-sm font-bold shadow-md">
                  {(user?.name || 'U').charAt(0).toUpperCase()}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="font-semibold text-gray-900 truncate">{user?.name || 'User'}</p>
                  <p className="text-xs text-primary-600 font-medium">{TIER_LABELS[userTier] || 'User'}</p>
                </div>
              </div>
            </div>

            {/* Search Shortcut */}
            <div className="mx-4 mt-3">
              <button
                onClick={onSearchFocus}
                className="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-left text-sm text-gray-400 hover:bg-gray-100 hover:border-gray-300 transition flex items-center gap-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                Search docs...
              </button>
            </div>

            {/* Navigation */}
            <nav className="p-3 mt-2 overflow-y-auto" style={{maxHeight: 'calc(100vh - 320px)'}}>
              {/* Getting Started */}
              <p className="px-3 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Getting Started</p>
              <button
                onClick={() => { onNavigate('walkthroughs'); onClose(); }}
                className={`w-full text-left px-4 py-2.5 mb-1 sidebar-link flex items-center gap-3 ${activeSection === 'walkthroughs' ? 'active' : 'text-gray-600 hover:text-gray-900'}`}
              >
                <span className={activeSection === 'walkthroughs' ? 'text-white' : 'text-primary-500'}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>
                </span>
                <span className="font-medium text-sm">Your Workflow</span>
              </button>
              <button
                onClick={() => { onNavigate('feature-overview'); onClose(); }}
                className={`w-full text-left px-4 py-2.5 mb-1 sidebar-link flex items-center gap-3 ${activeSection === 'feature-overview' ? 'active' : 'text-gray-600 hover:text-gray-900'}`}
              >
                <span className={activeSection === 'feature-overview' ? 'text-white' : 'text-primary-500'}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z"/></svg>
                </span>
                <span className="font-medium text-sm">Feature Reference</span>
              </button>

              {/* Portal Section Groups */}
              {Object.entries(groupedSections).map(([groupLabel, groupGuides]) => {
                const nonIssueGuides = groupGuides.filter(g => !g.isKnownIssue);
                if (nonIssueGuides.length === 0) return null;
                return (
                  <div key={groupLabel}>
                    <p className="px-3 mt-4 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">{groupLabel}</p>
                    {nonIssueGuides.map(guide => (
                      <button
                        key={guide.key}
                        onClick={() => { onNavigate(guide.key); onClose(); }}
                        className={`w-full text-left px-4 py-2.5 mb-1 sidebar-link flex items-center gap-3 ${activeSection === guide.key ? 'active' : 'text-gray-600 hover:text-gray-900'}`}
                      >
                        <span className={`w-2 h-2 rounded-full flex-shrink-0 ${activeSection === guide.key ? 'bg-white' : 'bg-primary-300'}`}></span>
                        <span className="font-medium text-sm truncate">{guide.title}</span>
                      </button>
                    ))}
                  </div>
                );
              })}

              {/* Known Issues (internal only) */}
              {(userTier === 'super_admin' || userTier === 'manager') && groupedSections['General']?.some(g => g.isKnownIssue) && (
                <div>
                  <p className="px-3 mt-4 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Internal</p>
                  <button
                    onClick={() => { onNavigate('known-issues'); onClose(); }}
                    className={`w-full text-left px-4 py-2.5 mb-1 sidebar-link flex items-center gap-3 ${activeSection === 'known-issues' ? 'active' : 'text-red-600 hover:text-red-700'}`}
                  >
                    <span className={`w-2 h-2 rounded-full flex-shrink-0 ${activeSection === 'known-issues' ? 'bg-white' : 'bg-red-400'}`}></span>
                    <span className="font-medium text-sm">Known Issues</span>
                  </button>
                </div>
              )}
            </nav>

            {/* Footer */}
            <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 bg-white/80 space-y-2">
              <button
                onClick={() => { window.location.href = '/login'; }}
                className="w-full text-left px-4 py-2.5 text-gray-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl flex items-center gap-3 transition font-medium text-sm"
              >
                {Icons.hub}
                <span>Portal Hub</span>
              </button>
              <button
                onClick={() => {
                  localStorage.removeItem('unified_token');
                  localStorage.removeItem('unified_user');
                  localStorage.removeItem('admin_token');
                  localStorage.removeItem('admin_user');
                  localStorage.removeItem('token');
                  localStorage.removeItem('user');
                  localStorage.removeItem('portal_token');
                  localStorage.removeItem('portal_user');
                  localStorage.removeItem('service_token');
                  localStorage.removeItem('service_user');
                  window.location.href = '/login';
                }}
                className="w-full text-left px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-xl flex items-center gap-3 transition font-medium text-sm"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/></svg>
                <span>Sign Out</span>
              </button>
            </div>
          </aside>
        </>
      );
    };

    // ============== MAIN APP ==============
    const App = () => {
      // Authentication
      const [token, setToken] = useState(() => {
        return localStorage.getItem('unified_token') || localStorage.getItem('admin_token') || localStorage.getItem('token') || localStorage.getItem('portal_token') || localStorage.getItem('service_token');
      });
      const [user, setUser] = useState(() => {
        try {
          const userData = localStorage.getItem('unified_user') || localStorage.getItem('admin_user') || localStorage.getItem('user') || localStorage.getItem('portal_user') || localStorage.getItem('service_user');
          return userData ? JSON.parse(userData) : null;
        } catch {
          return null;
        }
      });

      // State
      const [apiGuides, setApiGuides] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [activeSection, setActiveSection] = useState('walkthroughs');
      const [isMobileOpen, setIsMobileOpen] = useState(false);
      const [currentMatchIndex, setCurrentMatchIndex] = useState(0);
      const [totalMatches, setTotalMatches] = useState(0);
      const searchInputRef = useRef(null);

      // Compute user tier
      const userTier = getUserTier(user);
      const isAdmin = user?.role === 'admin';

      // Seed v2 data and fetch sections on mount
      useEffect(() => {
        const init = async () => {
          try {
            // Seed v2 data if needed
            await seedV2IfNeeded(token, isAdmin);

            // Seed v1 data if needed
            const seedCheck = await fetch('/api/knowledge/needs-seed', {
              headers: { 'Authorization': `Bearer ${token}` }
            }).then(r => r.json());

            if (seedCheck.needsSeed && isAdmin) {
              const guidesArray = Object.entries(guides).map(([key, guide]) => ({
                key,
                title: guide.title,
                description: guide.description,
                icon: guide.icon ? 'custom' : 'book',
                color: guide.color,
                ownerOnly: guide.ownerOnly || false,
                adminOnly: guide.adminOnly || false,
                visibleTo: guide.visibleTo || [],
                portalSection: guide.portalSection || 'general',
                isKnownIssue: guide.isKnownIssue || false,
                articles: guide.articles
              }));
              await fetch('/api/knowledge/seed', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ guides: guidesArray })
              });
            }

            const response = await fetch('/api/knowledge/guides', {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (Array.isArray(data)) {
              setApiGuides(data);
            }
          } catch (error) {
            console.error('Error loading knowledge hub:', error);
          } finally {
            setLoading(false);
          }
        };
        init();
      }, [token, isAdmin]);

      // Compute visible guides with 5-tier filtering
      // Always use hardcoded visibleTo/portalSection as the authoritative source for
      // access control — the DB copy may be stale (seeded before visibleTo arrays were set).
      // Guide content (articles) still comes from the DB when available.
      const visibleGuides = useMemo(() => {
        if (apiGuides.length > 0) {
          const dbKeys = new Set(apiGuides.map(g => g.key));

          // DB guides: filter using hardcoded visibleTo (overrides potentially stale DB value)
          const fromDb = apiGuides
            .filter(guide => {
              const hardcoded = guides[guide.key];
              const effectiveVisibleTo = hardcoded ? (hardcoded.visibleTo || []) : (guide.visibleTo || []);
              const effectiveSection = hardcoded ? (hardcoded.portalSection || guide.portalSection) : guide.portalSection;
              return canUserSeeGuide(userTier, user, { ...guide, visibleTo: effectiveVisibleTo, portalSection: effectiveSection });
            })
            .map(guide => [guide.key, { ...guide, icon: Icons[guide.icon] || Icons.book }]);

          // Hardcoded-only guides not yet in the DB (e.g. newly added guides)
          const fromHardcoded = Object.entries(guides)
            .filter(([key, guide]) => !dbKeys.has(key) && canUserSeeGuide(userTier, user, guide));

          return [...fromDb, ...fromHardcoded];
        }
        return Object.entries(guides).filter(([key, guide]) => canUserSeeGuide(userTier, user, guide));
      }, [apiGuides, userTier, user]);

      // Search filtering
      const filteredGuides = useMemo(() => {
        if (!searchTerm.trim()) return visibleGuides;
        const term = searchTerm.toLowerCase().trim();
        return visibleGuides
          .map(([key, guide]) => {
            const guideTitleMatch = guide.title.toLowerCase().includes(term) || (guide.description || '').toLowerCase().includes(term);
            const matchingArticles = (guide.articles || []).filter(article =>
              article.title.toLowerCase().includes(term) || (article.content || '').toLowerCase().includes(term)
            );
            if (guideTitleMatch || matchingArticles.length > 0) {
              return [key, { ...guide, articles: guideTitleMatch ? guide.articles : matchingArticles }];
            }
            return null;
          })
          .filter(Boolean);
      }, [visibleGuides, searchTerm]);

      const searchResultCount = useMemo(() =>
        filteredGuides.reduce((count, [, guide]) => count + (guide.articles || []).length, 0),
      [filteredGuides]);

      // Count and track <mark> highlight elements for navigation
      useEffect(() => {
        if (!searchTerm) { setTotalMatches(0); setCurrentMatchIndex(0); return; }
        // Short delay to let React render the <mark> elements first
        const timer = setTimeout(() => {
          const marks = document.querySelectorAll('main mark:not(.active-match)');
          setTotalMatches(marks.length);
          setCurrentMatchIndex(prev => prev >= marks.length ? 0 : prev);
        }, 150);
        return () => clearTimeout(timer);
      }, [searchTerm, filteredGuides]);

      // Navigate to a specific <mark> match by index
      const navigateToMatch = useCallback((index) => {
        const marks = document.querySelectorAll('main mark');
        if (marks.length === 0) return;
        // Wrap around
        const targetIndex = ((index % marks.length) + marks.length) % marks.length;
        // Remove active class from all marks
        marks.forEach(m => m.classList.remove('active-match'));
        // Activate target
        const target = marks[targetIndex];
        target.classList.add('active-match');
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setCurrentMatchIndex(targetIndex);
      }, []);

      const handleNextMatch = useCallback(() => {
        navigateToMatch(currentMatchIndex + 1);
      }, [currentMatchIndex, navigateToMatch]);

      const handlePrevMatch = useCallback(() => {
        navigateToMatch(currentMatchIndex - 1);
      }, [currentMatchIndex, navigateToMatch]);

      // Separate known issues from regular guides
      const regularGuides = filteredGuides.filter(([key, guide]) => !guide.isKnownIssue);
      const knownIssuesGuide = filteredGuides.find(([key, guide]) => guide.isKnownIssue);

      // Scroll to section
      const scrollToSection = useCallback((sectionKey) => {
        const el = document.getElementById(`section-${sectionKey}`);
        if (el) {
          el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          setActiveSection(sectionKey);
        }
        setIsMobileOpen(false);
      }, []);

      // IntersectionObserver for active section tracking
      useEffect(() => {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const sectionKey = entry.target.id.replace('section-', '');
              setActiveSection(sectionKey);
            }
          });
        }, { rootMargin: '-20% 0px -70% 0px' });

        const allKeys = ['walkthroughs', 'feature-overview', ...visibleGuides.map(([key]) => key)];
        allKeys.forEach(key => {
          const el = document.getElementById(`section-${key}`);
          if (el) observer.observe(el);
        });

        return () => observer.disconnect();
      }, [visibleGuides]);

      // Redirect to login if not authenticated
      if (!token || !user) {
        window.location.href = '/login';
        return null;
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Sidebar */}
          <KnowledgeSidebar
            sections={visibleGuides}
            activeSection={activeSection}
            onNavigate={scrollToSection}
            user={user}
            userTier={userTier}
            isMobileOpen={isMobileOpen}
            onClose={() => setIsMobileOpen(false)}
            onSearchFocus={() => {
              setIsMobileOpen(false);
              setTimeout(() => {
                const input = document.querySelector('input[placeholder*="Search"]');
                if (input) input.focus();
              }, 100);
            }}
          />

          {/* Mobile Header */}
          <div className="lg:hidden bg-white/95 backdrop-blur-sm border-b border-gray-100 p-4 flex items-center justify-between sticky top-0 z-30">
            <button onClick={() => setIsMobileOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
            </button>
            <div className="flex items-center gap-2">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-8" />
              <span className="font-semibold text-accent text-sm">Knowledge Hub</span>
            </div>
            <div className="w-10"></div>
          </div>

          {/* Main Content */}
          <main className="lg:ml-72 p-4 lg:p-8">
            {/* Search Bar */}
            <SearchBar
              searchTerm={searchTerm}
              onSearchChange={(val) => { setSearchTerm(val); setCurrentMatchIndex(0); }}
              resultCount={searchResultCount}
              currentMatchIndex={currentMatchIndex}
              totalMatches={totalMatches}
              onPrevMatch={handlePrevMatch}
              onNextMatch={handleNextMatch}
            />

            {/* Workflow Walkthrough (hidden when searching) */}
            {!searchTerm && (
              <WorkflowWalkthrough userTier={userTier} onNavigate={scrollToSection} />
            )}

            {/* Feature Reference (hidden when searching) */}
            {!searchTerm && (
              <FeatureOverview userTier={userTier} user={user} />
            )}

            {/* No Results */}
            {searchTerm && filteredGuides.length === 0 && (
              <div className="text-center py-16">
                <svg className="mx-auto w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" strokeWidth="1" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <h3 className="text-lg font-semibold text-gray-600 mb-2">No results found</h3>
                <p className="text-gray-500">No guides or articles match "<strong>{searchTerm}</strong>"</p>
                <button onClick={() => setSearchTerm('')} className="mt-4 text-primary-600 hover:underline font-medium">
                  Clear search
                </button>
              </div>
            )}

            {/* Guide Sections */}
            {regularGuides.map(([key, guide]) => (
              <GuideSection
                key={key}
                guide={{ ...guide, key }}
                userTier={userTier}
                forceOpen={!!searchTerm}
                searchTerm={searchTerm}
              />
            ))}

            {/* Known Issues Section (at bottom, before tips) */}
            {knownIssuesGuide && (
              <GuideSection
                key={knownIssuesGuide[0]}
                guide={{ ...knownIssuesGuide[1], key: knownIssuesGuide[0] }}
                userTier={userTier}
                forceOpen={!!searchTerm}
                searchTerm={searchTerm}
              />
            )}

            {/* Quick Tips Section (hidden when searching) */}
            {!searchTerm && (
              <div className="mt-10">
                <h3 className="text-xl font-bold text-accent mb-6">Quick Tips</h3>
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                  <ul className="space-y-3 text-gray-600">
                    <li className="flex items-start gap-3">
                      <span className="inline-flex items-center justify-center w-6 h-6 bg-primary-100 text-primary-600 rounded-full text-sm font-bold flex-shrink-0">1</span>
                      <span>Use the <strong>Portal Hub</strong> as your central navigation point - bookmark it for quick access each morning.</span>
                    </li>
                    <li className="flex items-start gap-3">
                      <span className="inline-flex items-center justify-center w-6 h-6 bg-primary-100 text-primary-600 rounded-full text-sm font-bold flex-shrink-0">2</span>
                      <span><strong>Service reports</strong> should be submitted within 24 hours of completing a service visit - use the draft feature to save progress.</span>
                    </li>
                    <li className="flex items-start gap-3">
                      <span className="inline-flex items-center justify-center w-6 h-6 bg-primary-100 text-primary-600 rounded-full text-sm font-bold flex-shrink-0">3</span>
                      <span>Update <strong>project task status</strong> daily to keep implementation teams and clients in sync with progress.</span>
                    </li>
                    <li className="flex items-start gap-3">
                      <span className="inline-flex items-center justify-center w-6 h-6 bg-primary-100 text-primary-600 rounded-full text-sm font-bold flex-shrink-0">4</span>
                      <span>Keep multiple <strong>browser tabs</strong> open for different portals - the system supports simultaneous access across services.</span>
                    </li>
                    <li className="flex items-start gap-3">
                      <span className="inline-flex items-center justify-center w-6 h-6 bg-primary-100 text-primary-600 rounded-full text-sm font-bold flex-shrink-0">5</span>
                      <span>Data syncs with <strong>HubSpot automatically</strong> - changes to projects, tasks, and reports update CRM records in real-time.</span>
                    </li>
                    <li className="flex items-start gap-3">
                      <span className="inline-flex items-center justify-center w-6 h-6 bg-primary-100 text-primary-600 rounded-full text-sm font-bold flex-shrink-0">6</span>
                      <span>Report <strong>bugs or issues</strong> immediately using Admin Hub > Bug Reports so technical issues can be addressed promptly.</span>
                    </li>
                  </ul>
                </div>
              </div>
            )}

            {/* Need Help Section (hidden when searching) */}
            {!searchTerm && (
              <div className="mt-10 bg-gradient-to-r from-primary-500 to-primary-700 rounded-2xl p-8 text-white">
                <h3 className="text-2xl font-bold mb-3">Need Additional Help?</h3>
                <p className="text-white/80 mb-6">Can't find what you're looking for? Our support team is here to help.</p>
                <div className="flex flex-wrap gap-4">
                  <a href="mailto:support@thrive365labs.com" className="bg-white text-primary-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                    Email Support
                  </a>
                  <a href="/login" className="bg-white/20 text-white px-6 py-3 rounded-lg font-semibold hover:bg-white/30 transition">
                    Back to Portal Hub
                  </a>
                </div>
              </div>
            )}

            {/* Footer */}
            <footer className="mt-12 py-6 border-t border-gray-200">
              <div className="text-center text-sm text-gray-500">
                &copy; 2026 Thrive 365 Labs. All rights reserved.
              </div>
            </footer>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
