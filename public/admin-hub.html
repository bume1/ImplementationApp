<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrive 365 Labs - Admin Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#045E9F', 600: '#0353a4', 700: '#00205A', 800: '#001d51', 900: '#001233' },
            accent: '#00205A',
            surface: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7' },
            success: { 50: '#ecfdf5', 500: '#10b981', 600: '#059669' },
            warning: { 50: '#fffbeb', 500: '#f59e0b', 600: '#d97706' },
            danger: { 50: '#fef2f2', 500: '#ef4444', 600: '#dc2626' }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          },
          boxShadow: {
            'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
            'card': '0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1)',
            'card-hover': '0 10px 40px -10px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)'
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); }
    .sidebar-link { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0.75rem; }
    .sidebar-link:hover { background: linear-gradient(90deg, rgba(4, 94, 159, 0.08) 0%, rgba(4, 94, 159, 0.02) 100%); }
    .sidebar-link.active { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); color: white; box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.4); }
    .card-modern { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(0,0,0,0.04); }
    .card-modern:hover { box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: translateY(-2px); }
    .btn-primary { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); transition: all 0.2s; }
    .btn-primary:hover { background: linear-gradient(135deg, #0353a4 0%, #00205A 100%); box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.5); transform: translateY(-1px); }
    .input-modern { border: 1.5px solid #e4e4e7; border-radius: 0.75rem; transition: all 0.2s; }
    .input-modern:focus { border-color: #045E9F; box-shadow: 0 0 0 3px rgba(4, 94, 159, 0.1); outline: none; }
    .gradient-header { background: linear-gradient(135deg, #045E9F 0%, #00205A 100%); }
    .stat-card { position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%); border-radius: 0 1rem 0 100%; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .glass-effect { backdrop-filter: blur(10px); background: rgba(255,255,255,0.9); }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const API_URL = window.location.origin;

    const handleResponse = async (response) => {
      if (!response.ok) {
        // Auto-redirect to login on auth failure (expired/invalid token)
        if (response.status === 401 || response.status === 403) {
          try {
            const errData = await response.clone().json();
            if (errData.error === 'Invalid token' || errData.error === 'User not found' || response.status === 401) {
              localStorage.clear();
              window.location.href = '/';
              throw new Error('Session expired. Redirecting to login...');
            }
          } catch (redirectErr) {
            if (redirectErr.message.includes('Session expired')) throw redirectErr;
          }
        }
        try {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error ${response.status}`);
        } catch (e) {
          if (e.message.includes('HTTP error') || e.message.includes('Session expired')) throw e;
          throw new Error(`HTTP error ${response.status}`);
        }
      }
      return response.json();
    };

    const api = {
      adminLogin: (email, password) =>
        fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }).then(handleResponse).then(result => {
          // Verify user has admin hub access (super admins, managers, or users with hasAdminHubAccess)
          if (result.user && result.user.role !== 'admin' && !result.user.isManager && !result.user.hasAdminHubAccess) {
            return { error: 'Access denied. Admin Hub access required.' };
          }
          return result;
        }).catch(err => ({ error: err.message })),

      getDashboard: (token) =>
        fetch(`${API_URL}/api/admin-hub/dashboard`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      getUsers: (token) =>
        fetch(`${API_URL}/api/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      createUser: (token, userData) =>
        fetch(`${API_URL}/api/users`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        }).then(handleResponse).catch(err => ({ error: err.message })),

      updateUser: (token, userId, userData) =>
        fetch(`${API_URL}/api/users/${userId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        }).then(handleResponse).catch(err => ({ error: err.message })),

      deleteUser: (token, userId) =>
        fetch(`${API_URL}/api/users/${userId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      getProjects: (token) =>
        fetch(`${API_URL}/api/projects`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      getPasswordResetRequests: (token) =>
        fetch(`${API_URL}/api/admin/password-reset-requests`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      handlePasswordReset: (token, requestId) =>
        fetch(`${API_URL}/api/admin/password-reset-requests/${requestId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'completed' })
        }).then(handleResponse).catch(err => ({ error: err.message })),

      dismissPasswordReset: (token, requestId) =>
        fetch(`${API_URL}/api/admin/password-reset-requests/${requestId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      bulkPasswordReset: (token, userType = 'all') =>
        fetch(`${API_URL}/api/admin/bulk-password-reset`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ userType })
        }).then(handleResponse).catch(err => ({ error: err.message })),

      getServiceReports: (token) =>
        fetch(`${API_URL}/api/service-reports`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      // Service Portal APIs
      getServiceClients: (token) =>
        fetch(`${API_URL}/api/service-portal/clients`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      submitServiceReport: (token, reportData) =>
        fetch(`${API_URL}/api/service-reports`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message })),

      // Service Report Assignment APIs
      getTechnicians: (token) =>
        fetch(`${API_URL}/api/service-portal/technicians`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      assignServiceReport: (token, reportData) =>
        fetch(`${API_URL}/api/service-reports/assign`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message })),

      uploadServiceReportPhotos: (token, reportId, files) => {
        const formData = new FormData();
        files.forEach(file => formData.append('photos', file));
        return fetch(`${API_URL}/api/service-reports/${reportId}/photos`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        }).then(handleResponse).catch(err => ({ error: err.message }));
      },

      uploadServiceReportFiles: (token, reportId, files) => {
        const formData = new FormData();
        files.forEach(file => formData.append('files', file));
        return fetch(`${API_URL}/api/service-reports/${reportId}/files`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        }).then(handleResponse).catch(err => ({ error: err.message }));
      },

      updateManagerNotes: (token, reportId, managerNotes) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/manager-notes`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ managerNotes })
        }).then(handleResponse).catch(err => ({ error: err.message })),

      deleteServiceReportPhoto: (token, reportId, photoId) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/photos/${photoId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      deleteServiceReportFile: (token, reportId, fileId) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/files/${fileId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      // Client Portal APIs
      getPortalSettings: () =>
        fetch(`${API_URL}/api/portal-settings`).then(handleResponse).catch(err => ({ error: err.message })),

      updatePortalSettings: (token, settings) =>
        fetch(`${API_URL}/api/portal-settings`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        }).then(handleResponse).catch(err => ({ error: err.message })),

      getAnnouncements: () =>
        fetch(`${API_URL}/api/announcements`).then(handleResponse).catch(err => ({ error: err.message })),

      createAnnouncement: (token, data) =>
        fetch(`${API_URL}/api/announcements`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).then(handleResponse).catch(err => ({ error: err.message })),

      deleteAnnouncement: (token, id) =>
        fetch(`${API_URL}/api/announcements/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      getInventoryReports: (token) =>
        fetch(`${API_URL}/api/inventory/all-reports`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      // Feedback/Inbox APIs
      getFeedback: (token) =>
        fetch(`${API_URL}/api/admin/feedback`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message })),

      updateFeedback: (token, id, data) =>
        fetch(`${API_URL}/api/admin/feedback/${id}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).then(handleResponse).catch(err => ({ error: err.message }))
    };

    // Icons
    // Modern refined icons with consistent stroke weight
    const Icons = {
      home: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>,
      users: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>,
      clipboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/></svg>,
      folder: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/></svg>,
      cog: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      logout: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"/></svg>,
      menu: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>,
      close: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>,
      externalLink: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/></svg>,
      plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>,
      edit: <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/></svg>,
      trash: <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>,
      check: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>,
      x: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>,
      eye: <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      key: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>,
      upload: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>,
      chart: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>,
      beaker: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>,
      rocket: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>,
      chat: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>,
      message: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/></svg>,
      inbox: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 012.012 1.244l.256.512a2.25 2.25 0 002.013 1.244h3.218a2.25 2.25 0 002.013-1.244l.256-.512a2.25 2.25 0 012.013-1.244h3.859m-17.5 0a2.25 2.25 0 00-1.883 1.013A11.945 11.945 0 003 19.5h18c.844 0 1.654-.178 2.383-.5a2.25 2.25 0 00-1.883-1.013M2.25 13.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0115.686 0c1.1.128 1.907 1.077 1.907 2.185V13.5"/></svg>,
      bug: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75zm0 0c2.883 0 5.647.508 8.207 1.44a23.91 23.91 0 01-1.152 6.06M12 12.75c-2.883 0-5.647.508-8.208 1.44.125 2.104.52 4.136 1.153 6.06M12 12.75V8.25m0 0c1.086 0 2.152-.14 3.181-.406a1.128 1.128 0 01-.664-.814 2.999 2.999 0 00-5.034 0 1.128 1.128 0 01-.664.814A10.988 10.988 0 0012 8.25zM12 21c-.17.001-.34 0-.508-.004A23.91 23.91 0 015.793 14.69M12 21c.17.001.34 0 .508-.004a23.91 23.91 0 005.699-6.306M9 9.75h6m-3-6.75a2.25 2.25 0 012.25 2.25v.407a2.25 2.25 0 01-.664 1.591L15 9.75"/></svg>,
      download: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>,
      document: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>,
      bell: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"/></svg>
    };

    // Login Page - Modern sleek design
    const LoginPage = ({ onLogin }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        const result = await api.adminLogin(email, password);
        if (result.error) {
          setError(result.error);
        } else {
          localStorage.setItem('admin_token', result.token);
          localStorage.setItem('admin_user', JSON.stringify(result.user));
          onLogin(result.token, result.user);
        }
        setLoading(false);
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4" style={{background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%)'}}>
          {/* Decorative elements */}
          <div className="absolute inset-0 overflow-hidden pointer-events-none">
            <div className="absolute -top-40 -right-40 w-80 h-80 rounded-full opacity-20" style={{background: 'radial-gradient(circle, #045E9F 0%, transparent 70%)'}}></div>
            <div className="absolute -bottom-40 -left-40 w-96 h-96 rounded-full opacity-10" style={{background: 'radial-gradient(circle, #00205A 0%, transparent 70%)'}}></div>
          </div>

          <div className="relative w-full max-w-md">
            {/* Main card */}
            <div className="bg-white/95 backdrop-blur-sm rounded-2xl shadow-soft p-5 sm:p-8 border border-white/50">
              {/* Logo and header */}
              <div className="text-center mb-6 sm:mb-8">
                <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-12 mx-auto mb-4" />
                <h1 className="text-2xl font-semibold text-gray-900 tracking-tight">Admin Hub</h1>
                <p className="text-gray-500 mt-1 text-sm">Precision Diagnostics Administration</p>
              </div>

              {/* Form */}
              <form onSubmit={handleSubmit} className="space-y-5">
                {error && (
                  <div className="flex items-center gap-3 bg-danger-50 text-danger-600 p-4 rounded-xl text-sm border border-red-100 animate-fade-in">
                    <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <span>{error}</span>
                  </div>
                )}

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                    placeholder="you@thrive365labs.live"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                    placeholder="Enter your password"
                    required
                  />
                </div>

                <button
                  type="submit"
                  disabled={loading}
                  className="btn-primary w-full text-white py-3.5 rounded-xl font-semibold text-sm tracking-wide disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <>
                      <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                      <span>Signing in...</span>
                    </>
                  ) : (
                    <span>Sign In</span>
                  )}
                </button>
              </form>

              {/* Footer */}
              <div className="mt-8 pt-6 border-t border-gray-100 text-center">
                <p className="text-xs text-gray-400">&copy; 2026 Thrive 365 Labs. All rights reserved.</p>
                <a href="/changelog" className="text-primary-500 hover:underline text-xs mt-1 inline-block">View Changelog</a>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Sidebar with portal access - Modern design
    const Sidebar = ({ activePage, onNavigate, user, token, isMobileOpen, onClose }) => {
      // Check if user is a Super Admin (role === 'admin')
      const isSuperAdmin = user?.role === 'admin';
      // Check if user is a Manager
      const isManager = user?.isManager && !isSuperAdmin;

      // Build menu items based on user permissions
      // Managers can only see Dashboard and Service Portal (no Inbox or User Management)
      const allMenuItems = [
        { id: 'dashboard', label: 'Dashboard', icon: Icons.home, color: 'text-primary-500', superAdminOnly: false },
        { id: 'inbox', label: 'Inbox', icon: Icons.inbox, color: 'text-primary-500', superAdminOnly: true },
        { id: 'users', label: 'User Management', icon: Icons.users, color: 'text-primary-500', superAdminOnly: true },
        { id: 'service_portal', label: 'Service Portal', icon: Icons.clipboard, color: 'text-primary-500', superAdminOnly: false },
        { id: 'notifications', label: 'Notifications', icon: Icons.bell, color: 'text-primary-500', superAdminOnly: false },
      ];

      // Filter menu items: Super Admin sees all, Manager only sees non-superAdminOnly items
      const menuItems = isSuperAdmin
        ? allMenuItems
        : allMenuItems.filter(item => !item.superAdminOnly);

      // Determine user role label
      const getRoleLabel = () => {
        if (isSuperAdmin) return 'Super Admin';
        if (isManager) return 'Manager';
        return 'Admin Hub User';
      };

      // External links with token passing
      const openExternalApp = (path) => {
        localStorage.setItem('portal_token', token);
        localStorage.setItem('portal_user', JSON.stringify(user));
        window.open(path, '_blank');
      };

      return (
        <>
          {isMobileOpen && <div className="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-40 lg:hidden" onClick={onClose}></div>}
          <aside className={`w-72 bg-white min-h-screen fixed left-0 top-0 z-50 transform transition-all duration-300 ease-out shadow-soft ${isMobileOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
            {/* Logo Header */}
            <div className="p-5 border-b border-gray-100 flex justify-between items-center">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-9" />
              <button onClick={onClose} className="lg:hidden text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100 transition">{Icons.close}</button>
            </div>

            {/* User Profile Card */}
            <div className="p-4 mx-4 my-4 rounded-xl gradient-header text-white">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-sm font-semibold">
                  {user?.name?.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2)}
                </div>
                <div>
                  <p className="text-xs opacity-75">{getRoleLabel()}</p>
                  <p className="font-semibold text-sm">{user?.name}</p>
                </div>
              </div>
            </div>

            {/* Navigation */}
            <nav className="px-3 py-2 flex-1">
              <p className="px-4 py-2 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">Management</p>
              <div className="space-y-1">
                {menuItems.map(item => (
                  <button key={item.id} onClick={() => { onNavigate(item.id); onClose && onClose(); }}
                    className={`w-full text-left px-4 py-3 rounded-xl sidebar-link flex items-center gap-3 ${activePage === item.id ? 'active' : 'text-gray-600 hover:text-gray-900'}`}>
                    <span className={activePage === item.id ? 'text-white' : item.color}>{item.icon}</span>
                    <span className="font-medium text-sm">{item.label}</span>
                  </button>
                ))}
              </div>

              <p className="px-4 py-2 mt-6 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">External Apps</p>
              <div className="space-y-1">
                <button onClick={() => openExternalApp('/thrive365labslaunch')} className="w-full text-left px-4 py-3 rounded-xl sidebar-link flex items-center gap-3 text-gray-600 hover:text-gray-900 group">
                  <span className="text-primary-500 group-hover:text-primary-600">{Icons.folder}</span>
                  <span className="font-medium text-sm">Implementations</span>
                  <span className="ml-auto opacity-0 group-hover:opacity-100 transition">{Icons.externalLink}</span>
                </button>
                <button onClick={() => openExternalApp('/portal')} className="w-full text-left px-4 py-3 rounded-xl sidebar-link flex items-center gap-3 text-gray-600 hover:text-gray-900 group">
                  <span className="text-primary-500 group-hover:text-primary-600">{Icons.users}</span>
                  <span className="font-medium text-sm">Client Portal</span>
                  <span className="ml-auto opacity-0 group-hover:opacity-100 transition">{Icons.externalLink}</span>
                </button>
              </div>
            </nav>

            {/* Portal Hub & Sign Out */}
            <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 bg-gray-50/50 space-y-2">
              <button onClick={() => { window.location.href = '/'; }}
                className="w-full text-left px-4 py-2.5 text-gray-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl flex items-center gap-3 transition group">
                <span className="text-primary-500 group-hover:text-primary-600">{Icons.home}</span>
                <span className="text-sm font-medium">Portal Hub</span>
              </button>
              <button onClick={() => { localStorage.clear(); sessionStorage.clear(); window.location.href = '/login'; }}
                className="w-full text-left px-4 py-2.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-xl flex items-center gap-3 transition group">
                <span className="group-hover:text-red-500">{Icons.logout}</span>
                <span className="text-sm font-medium">Sign Out</span>
              </button>
            </div>
          </aside>
        </>
      );
    };

    // Dashboard Page - Modern design
    const DashboardPage = ({ token, onNavigate, user }) => {
      const isManager = user?.isManager && user?.role !== 'admin';
      const [stats, setStats] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        api.getDashboard(token).then(data => {
          if (!data.error) setStats(data);
          setLoading(false);
        });
      }, [token]);

      if (loading) return (
        <div className="flex items-center justify-center py-20">
          <div className="flex flex-col items-center gap-4">
            <div className="animate-spin rounded-full h-10 w-10 border-[3px] border-primary-500 border-t-transparent"></div>
            <p className="text-gray-500 text-sm">Loading dashboard...</p>
          </div>
        </div>
      );

      // Different stat cards for Manager vs Super Admin
      const statCards = isManager ? [
        { label: 'Total Users', value: stats?.totalUsers || 0, color: 'from-primary-500 to-primary-700', icon: Icons.users },
        { label: 'New Launches', value: stats?.activeProjects || 0, color: 'from-warning-500 to-warning-600', icon: Icons.rocket },
        { label: 'Service Portal', value: stats?.servicePortalUsers || 0, color: 'from-success-500 to-success-600', icon: Icons.clipboard },
        { label: 'Client Accounts', value: stats?.clientUsers || 0, color: 'from-warning-500 to-warning-600', icon: Icons.folder },
      ] : [
        { label: 'Total Users', value: stats?.totalUsers || 0, color: 'from-primary-500 to-primary-700', icon: Icons.users },
        { label: 'New Launches', value: stats?.activeProjects || 0, color: 'from-accent to-primary-900', icon: Icons.rocket },
        { label: 'Service Portal', value: stats?.servicePortalUsers || 0, color: 'from-success-500 to-success-600', icon: Icons.clipboard },
        { label: 'Client Accounts', value: stats?.clientUsers || 0, color: 'from-warning-500 to-warning-600', icon: Icons.folder },
      ];

      return (
        <div className="space-y-8 animate-fade-in">
          {/* Dynamic Banner Header */}
          <div className="relative rounded-2xl overflow-hidden shadow-lg" style={{minHeight: '200px'}}>
            <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-admin.jpg)'}}></div>
            <div className="absolute inset-0 bg-gradient-to-r from-primary-700/90 via-primary-600/70 to-transparent"></div>
            <div className="relative p-5 sm:p-8 flex items-center min-h-[160px] sm:min-h-[200px]">
              <div className="text-white">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center shadow-lg">{Icons.chart}</div>
                  <h1 className="text-xl sm:text-3xl font-bold tracking-tight drop-shadow-sm">Admin Hub Dashboard</h1>
                </div>
                <p className="text-white/90 text-sm max-w-xl mt-2">Central management console for Thrive 365 Labs diagnostic platforms and services.</p>
              </div>
            </div>
          </div>

          {/* Stats Grid */}
          <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
            {statCards.map((stat, i) => (
              <div key={i} className={`stat-card bg-gradient-to-br ${stat.color} text-white p-4 sm:p-6 rounded-2xl shadow-lg`}>
                <div className="flex items-start justify-between mb-3 sm:mb-4">
                  <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-white/20 flex items-center justify-center">{stat.icon}</div>
                </div>
                <p className="text-2xl sm:text-3xl font-bold mb-1">{stat.value}</p>
                <p className="text-sm text-white/80">{stat.label}</p>
              </div>
            ))}
          </div>

          {/* Quick Actions & Projects */}
          <div className="grid lg:grid-cols-2 gap-6">
            <div className="card-modern p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2">
                <span className="w-8 h-8 rounded-lg bg-primary-50 text-primary-500 flex items-center justify-center">{Icons.plus}</span>
                Quick Actions
              </h2>
              <div className="space-y-3">
                <button onClick={() => onNavigate('users')} className="w-full text-left p-4 bg-gray-50 hover:bg-primary-50 rounded-xl flex items-center gap-4 transition group">
                  <span className="w-10 h-10 rounded-lg bg-primary-100 text-primary-600 flex items-center justify-center group-hover:bg-primary-500 group-hover:text-white transition">{Icons.users}</span>
                  <div>
                    <p className="font-medium text-gray-900">Manage Users</p>
                    <p className="text-xs text-gray-500">Add, edit, and manage user accounts</p>
                  </div>
                </button>
                <button onClick={() => onNavigate('service_portal')} className="w-full text-left p-4 bg-gray-50 hover:bg-success-50 rounded-xl flex items-center gap-4 transition group">
                  <span className="w-10 h-10 rounded-lg bg-success-50 text-success-600 flex items-center justify-center group-hover:bg-success-500 group-hover:text-white transition">{Icons.clipboard}</span>
                  <div>
                    <p className="font-medium text-gray-900">Service Portal</p>
                    <p className="text-xs text-gray-500">View and manage service reports</p>
                  </div>
                </button>
              </div>
            </div>

            <div className="card-modern p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2">
                <span className="w-8 h-8 rounded-lg bg-purple-50 text-purple-500 flex items-center justify-center">{Icons.rocket}</span>
                Quick Stats
              </h2>
              <div className="space-y-3">
                <div className="flex justify-between items-center p-4 bg-gray-50 rounded-xl">
                  <div className="flex items-center gap-3">
                    <span className="w-8 h-8 rounded-lg bg-red-50 text-red-600 flex items-center justify-center">{Icons.chat}</span>
                    <span className="text-gray-700">Open Tickets</span>
                  </div>
                  <span className="text-xl font-bold text-red-600">{stats?.openTickets || 0}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Inbox Page - Bug Reports and Feature Requests
    const InboxPage = ({ token }) => {
      const [feedback, setFeedback] = useState([]);
      const [passwordResets, setPasswordResets] = useState([]);
      const [loading, setLoading] = useState(true);
      const [activeTab, setActiveTab] = useState('feedback');
      const [selectedItem, setSelectedItem] = useState(null);

      useEffect(() => {
        loadData();
      }, [token]);

      const loadData = async () => {
        setLoading(true);
        const [feedbackData, resetData] = await Promise.all([
          api.getFeedback(token),
          api.getPasswordResetRequests(token)
        ]);
        if (!feedbackData.error) setFeedback(feedbackData);
        if (!resetData.error) setPasswordResets(resetData);
        setLoading(false);
      };

      const updateFeedbackStatus = async (id, status) => {
        await api.updateFeedback(token, id, { status });
        loadData();
        setSelectedItem(null);
      };

      const handlePasswordReset = async (id) => {
        await api.handlePasswordReset(token, id);
        loadData();
      };

      const dismissPasswordReset = async (id) => {
        await api.dismissPasswordReset(token, id);
        loadData();
      };

      const openFeedback = feedback.filter(f => f.status === 'open');
      const resolvedFeedback = feedback.filter(f => f.status === 'resolved');

      if (loading) return (
        <div className="flex items-center justify-center py-20">
          <div className="flex flex-col items-center gap-4">
            <div className="animate-spin rounded-full h-10 w-10 border-[3px] border-primary-500 border-t-transparent"></div>
            <p className="text-gray-500 text-sm">Loading inbox...</p>
          </div>
        </div>
      );

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold text-accent">Inbox</h1>
              <p className="text-gray-500 text-sm mt-1">Bug reports, feature requests, and password resets</p>
            </div>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 border-b border-gray-200">
            <button onClick={() => setActiveTab('feedback')}
              className={`px-4 py-3 text-sm font-medium border-b-2 transition ${activeTab === 'feedback' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
              Feedback & Requests
              {openFeedback.length > 0 && <span className="ml-2 px-2 py-0.5 bg-red-100 text-red-600 rounded-full text-xs">{openFeedback.length}</span>}
            </button>
            <button onClick={() => setActiveTab('password')}
              className={`px-4 py-3 text-sm font-medium border-b-2 transition ${activeTab === 'password' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
              Password Resets
              {passwordResets.length > 0 && <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-600 rounded-full text-xs">{passwordResets.length}</span>}
            </button>
          </div>

          {activeTab === 'feedback' && (
            <div className="space-y-4">
              {/* Open Feedback */}
              <div className="bg-white rounded-xl shadow-soft border border-gray-100 overflow-hidden">
                <div className="px-5 py-4 border-b border-gray-100 bg-gray-50/50">
                  <h3 className="font-semibold text-gray-800">Open Items ({openFeedback.length})</h3>
                </div>
                {openFeedback.length === 0 ? (
                  <div className="p-8 text-center text-gray-500">
                    <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      {Icons.check}
                    </div>
                    <p>No open feedback items</p>
                  </div>
                ) : (
                  <div className="divide-y divide-gray-100">
                    {openFeedback.map(item => (
                      <div key={item.id} className="p-4 hover:bg-gray-50 cursor-pointer transition" onClick={() => setSelectedItem(item)}>
                        <div className="flex items-start gap-4">
                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 ${item.type === 'bug' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                            {item.type === 'bug' ? Icons.bug : Icons.chat}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${item.type === 'bug' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                                {item.type === 'bug' ? 'Bug Report' : 'Feature Request'}
                              </span>
                              <span className="text-xs text-gray-400">{new Date(item.createdAt).toLocaleDateString()}</span>
                            </div>
                            <h4 className="font-medium text-gray-800 truncate">{item.subject}</h4>
                            <p className="text-sm text-gray-500 truncate">{item.description}</p>
                            <p className="text-xs text-gray-400 mt-1">From: {item.userName} ({item.userEmail})</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Resolved Feedback */}
              {resolvedFeedback.length > 0 && (
                <div className="bg-white rounded-xl shadow-soft border border-gray-100 overflow-hidden">
                  <div className="px-5 py-4 border-b border-gray-100 bg-gray-50/50">
                    <h3 className="font-semibold text-gray-800">Resolved ({resolvedFeedback.length})</h3>
                  </div>
                  <div className="divide-y divide-gray-100">
                    {resolvedFeedback.slice(0, 5).map(item => (
                      <div key={item.id} className="p-4 opacity-60">
                        <div className="flex items-start gap-4">
                          <div className="w-10 h-10 rounded-lg bg-green-100 text-green-600 flex items-center justify-center flex-shrink-0">
                            {Icons.check}
                          </div>
                          <div className="flex-1 min-w-0">
                            <h4 className="font-medium text-gray-800 truncate">{item.subject}</h4>
                            <p className="text-sm text-gray-500">{item.type === 'bug' ? 'Bug Report' : 'Feature Request'} - Resolved</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'password' && (
            <div className="bg-white rounded-xl shadow-soft border border-gray-100 overflow-hidden">
              <div className="px-5 py-4 border-b border-gray-100 bg-gray-50/50">
                <h3 className="font-semibold text-gray-800">Pending Password Reset Requests</h3>
              </div>
              {passwordResets.length === 0 ? (
                <div className="p-8 text-center text-gray-500">
                  <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    {Icons.key}
                  </div>
                  <p>No pending password reset requests</p>
                </div>
              ) : (
                <div className="divide-y divide-gray-100">
                  {passwordResets.map(request => (
                    <div key={request.id} className="p-4 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center">
                          {Icons.key}
                        </div>
                        <div>
                          <p className="font-medium text-gray-800">{request.email}</p>
                          <p className="text-sm text-gray-500">Requested: {new Date(request.requestedAt).toLocaleString()}</p>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => handlePasswordReset(request.id)}
                          className="px-3 py-1.5 bg-primary-500 text-white text-sm rounded-lg hover:bg-primary-600 transition">
                          Reset Password
                        </button>
                        <button onClick={() => dismissPasswordReset(request.id)}
                          className="px-3 py-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 text-sm rounded-lg transition">
                          Dismiss
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Detail Modal */}
          {selectedItem && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg animate-fade-in">
                <div className="p-6 border-b border-gray-100">
                  <div className="flex justify-between items-start">
                    <div className="flex items-center gap-3">
                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${selectedItem.type === 'bug' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                        {selectedItem.type === 'bug' ? Icons.bug : Icons.chat}
                      </div>
                      <div>
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${selectedItem.type === 'bug' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                          {selectedItem.type === 'bug' ? 'Bug Report' : 'Feature Request'}
                        </span>
                        <h2 className="text-lg font-bold text-accent mt-1">{selectedItem.subject}</h2>
                      </div>
                    </div>
                    <button onClick={() => setSelectedItem(null)} className="text-gray-400 hover:text-gray-600">
                      {Icons.close}
                    </button>
                  </div>
                </div>
                <div className="p-6 space-y-4">
                  <div>
                    <p className="text-sm font-medium text-gray-500 mb-1">From</p>
                    <p className="text-gray-800">{selectedItem.userName} ({selectedItem.userEmail})</p>
                  </div>
                  <div>
                    <p className="text-sm font-medium text-gray-500 mb-1">Submitted</p>
                    <p className="text-gray-800">{new Date(selectedItem.createdAt).toLocaleString()}</p>
                  </div>
                  <div>
                    <p className="text-sm font-medium text-gray-500 mb-1">Description</p>
                    <p className="text-gray-800 whitespace-pre-wrap bg-gray-50 p-4 rounded-lg">{selectedItem.description}</p>
                  </div>
                </div>
                <div className="p-6 border-t border-gray-100 flex gap-3">
                  <button onClick={() => setSelectedItem(null)}
                    className="flex-1 py-2.5 px-4 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition">
                    Close
                  </button>
                  <button onClick={() => updateFeedbackStatus(selectedItem.id, 'resolved')}
                    className="flex-1 py-2.5 px-4 rounded-xl bg-green-500 text-white font-medium hover:bg-green-600 transition">
                    Mark Resolved
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Full User Management Page with all features
    const UsersPage = ({ token }) => {
      const [users, setUsers] = useState([]);
      const [projects, setProjects] = useState([]);
      const [clients, setClients] = useState([]);
      const [clientPortals, setClientPortals] = useState([]);
      const [passwordResets, setPasswordResets] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [editingUser, setEditingUser] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [roleFilter, setRoleFilter] = useState('all');
      const [message, setMessage] = useState('');
      const [activeTab, setActiveTab] = useState('list');
      const [saving, setSaving] = useState(false);
      const [showBulkReset, setShowBulkReset] = useState(false);
      const [bulkResetType, setBulkResetType] = useState('all');
      const [bulkResetResults, setBulkResetResults] = useState(null);
      const [bulkResetLoading, setBulkResetLoading] = useState(false);
      const logoInputRef = useRef(null);

      const defaultFormData = {
        name: '', email: '', password: '', phone: '', role: 'user',
        isManager: false, // Manager flag - limited admin access (no inbox/user management)
        hasServicePortalAccess: false, hasAdminHubAccess: false,
        hasImplementationsAccess: false, hasClientPortalAdminAccess: false,
        practiceName: '', isNewClient: false, existingPortalSlug: '',
        logo: '', hubspotCompanyId: '', hubspotDealId: '', hubspotContactId: '',
        assignedProjects: [], projectAccessLevels: {}, assignedClients: []
      };
      const [formData, setFormData] = useState(defaultFormData);

      useEffect(() => { loadData(); }, []);

      const loadData = async () => {
        setLoading(true);
        const [usersRes, projectsRes, resetsRes, clientsRes, portalsRes] = await Promise.all([
          api.getUsers(token),
          api.getProjects(token),
          api.getPasswordResetRequests(token),
          fetch('/api/clients', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).catch(() => []),
          fetch('/api/client-portals', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).catch(() => [])
        ]);
        if (!usersRes.error) setUsers(usersRes);
        if (!projectsRes.error) setProjects(projectsRes);
        if (!resetsRes.error) setPasswordResets(resetsRes);
        if (Array.isArray(clientsRes)) setClients(clientsRes);
        if (Array.isArray(portalsRes)) setClientPortals(portalsRes);
        setLoading(false);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage('');
        setSaving(true);
        try {
          let result;
          if (editingUser) {
            const updateData = { ...formData };
            if (!updateData.password) delete updateData.password;
            console.log('Updating user:', editingUser.id, updateData);
            result = await api.updateUser(token, editingUser.id, updateData);
          } else {
            console.log('Creating user:', formData);
            result = await api.createUser(token, formData);
          }
          console.log('API Result:', result);
          if (result.error) {
            setMessage(`Error: ${result.error}`);
          } else {
            setMessage(editingUser ? 'User updated successfully' : 'User created successfully');
            setShowForm(false);
            setEditingUser(null);
            setFormData(defaultFormData);
            loadData();
          }
        } catch (err) {
          console.error('Submit error:', err);
          setMessage(`Error: ${err.message || 'Unknown error occurred'}`);
        } finally {
          setSaving(false);
        }
      };

      const handleEdit = (user) => {
        setEditingUser(user);
        setFormData({
          name: user.name || '',
          email: user.email || '',
          password: '',
          phone: user.phone || '',
          role: user.role || 'user',
          isManager: user.isManager || false,
          hasServicePortalAccess: user.hasServicePortalAccess || false,
          hasAdminHubAccess: user.hasAdminHubAccess || false,
          hasImplementationsAccess: user.hasImplementationsAccess || false,
          hasClientPortalAdminAccess: user.hasClientPortalAdminAccess || false,
          practiceName: user.practiceName || '',
          isNewClient: user.isNewClient || false,
          logo: user.logo || '',
          hubspotCompanyId: user.hubspotCompanyId || '',
          hubspotDealId: user.hubspotDealId || '',
          hubspotContactId: user.hubspotContactId || '',
          assignedProjects: user.assignedProjects || [],
          projectAccessLevels: user.projectAccessLevels || {},
          assignedClients: user.assignedClients || [],
          existingPortalSlug: ''
        });
        setShowForm(true);
      };

      const handleDelete = async (userId) => {
        if (!confirm('Are you sure you want to delete this user?')) return;
        const result = await api.deleteUser(token, userId);
        if (result.error) setMessage(`Error: ${result.error}`);
        else loadData();
      };

      const toggleServiceAccess = async (user) => {
        const result = await api.updateUser(token, user.id, { hasServicePortalAccess: !user.hasServicePortalAccess });
        if (result.error) { setMessage(`Error: ${result.error}`); return; }
        loadData();
      };

      const toggleAccountStatus = async (user) => {
        if (user.role === 'admin') return;
        const currentlyActive = user.accountStatus !== 'inactive';
        const action = currentlyActive ? 'deactivate' : 'reactivate';
        if (!confirm(`Are you sure you want to ${action} ${user.name}'s account?${currentlyActive ? '\n\nThey will be unable to log in until reactivated.' : ''}`)) return;
        const newStatus = currentlyActive ? 'inactive' : 'active';
        const result = await api.updateUser(token, user.id, { accountStatus: newStatus });
        if (result.error) { setMessage(`Error: ${result.error}`); return; }
        setMessage(`Account ${currentlyActive ? 'deactivated' : 'reactivated'} successfully.`);
        loadData();
      };

      const toggleProjectAssignment = (projectId) => {
        const assigned = formData.assignedProjects.includes(projectId);
        let newAssigned, newLevels;
        if (assigned) {
          newAssigned = formData.assignedProjects.filter(id => id !== projectId);
          newLevels = { ...formData.projectAccessLevels };
          delete newLevels[projectId];
        } else {
          newAssigned = [...formData.assignedProjects, projectId];
          newLevels = { ...formData.projectAccessLevels, [projectId]: 'edit' };
        }
        setFormData({ ...formData, assignedProjects: newAssigned, projectAccessLevels: newLevels });
      };

      const setProjectAccessLevel = (projectId, level) => {
        setFormData({ ...formData, projectAccessLevels: { ...formData.projectAccessLevels, [projectId]: level } });
      };

      const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
          setMessage('Error: Logo must be less than 2MB');
          return;
        }
        const reader = new FileReader();
        reader.onloadend = () => setFormData({ ...formData, logo: reader.result });
        reader.readAsDataURL(file);
      };

      const handlePasswordReset = async (requestId, userId) => {
        const newPassword = prompt('Enter new password for user:');
        if (!newPassword) return;
        const result = await api.updateUser(token, userId, { password: newPassword });
        if (!result.error) {
          await api.dismissPasswordReset(token, requestId);
          setMessage('Password reset successfully');
          loadData();
        } else {
          setMessage(`Error: ${result.error}`);
        }
      };

      const dismissReset = async (requestId) => {
        await api.dismissPasswordReset(token, requestId);
        loadData();
      };

      const handleBulkReset = async () => {
        if (!confirm(`Are you sure you want to reset passwords for ${bulkResetType === 'all' ? 'ALL non-admin users' : bulkResetType === 'clients' ? 'all CLIENT users' : 'all TEAM MEMBER users'}? They will be required to change their password on next login.`)) return;
        setBulkResetLoading(true);
        setBulkResetResults(null);
        try {
          const response = await fetch('/api/admin/bulk-password-reset', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ userType: bulkResetType })
          });
          const result = await response.json();
          if (result.error) {
            setMessage(`Error: ${result.error}`);
          } else {
            setBulkResetResults(result.results);
            setMessage(result.message);
            loadData();
          }
        } catch (err) {
          setMessage(`Error: ${err.message || 'Network error'}`);
        }
        setBulkResetLoading(false);
      };


      // Export users to xlsx
      const exportUsersToXlsx = () => {
        // Prepare data for export
        const getRoleDisplay = (user) => {
          if (user.role === 'admin') return 'Super Admin';
          if (user.isManager) return 'Manager';
          if (user.role === 'user') return 'Team Member';
          if (user.role === 'client') return 'Client';
          if (user.role === 'vendor') return 'Vendor';
          return user.role || '';
        };

        const exportData = users.map(user => ({
          'Name': user.name || '',
          'Email': user.email || '',
          'Role': getRoleDisplay(user),
          'Is Manager': user.isManager ? 'Yes' : 'No',
          'Practice/Company': user.practiceName || '',
          'Service Portal Access': user.hasServicePortalAccess ? 'Yes' : 'No',
          'Admin Hub Access': user.hasAdminHubAccess ? 'Yes' : 'No',
          'Implementations Access': user.hasImplementationsAccess ? 'Yes' : 'No',
          'Client Portal Admin': user.hasClientPortalAdminAccess ? 'Yes' : 'No',
          'HubSpot Company ID': user.hubspotCompanyId || '',
          'HubSpot Deal ID': user.hubspotDealId || '',
          'HubSpot Contact ID': user.hubspotContactId || '',
          'Assigned Clients': Array.isArray(user.assignedClients) ? user.assignedClients.join(', ') : '',
          'Created At': user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '',
          'User ID': user.id || ''
        }));

        // Create workbook and worksheet
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Users');

        // Set column widths
        const colWidths = [
          { wch: 25 }, // Name
          { wch: 30 }, // Email
          { wch: 15 }, // Role
          { wch: 25 }, // Practice/Company
          { wch: 12 }, // Service Portal
          { wch: 12 }, // Admin Hub
          { wch: 15 }, // Implementations
          { wch: 15 }, // Client Portal Admin
          { wch: 18 }, // HubSpot Company ID
          { wch: 18 }, // HubSpot Deal ID
          { wch: 18 }, // HubSpot Contact ID
          { wch: 30 }, // Assigned Clients
          { wch: 12 }, // Created At
          { wch: 38 }  // User ID
        ];
        ws['!cols'] = colWidths;

        // Generate filename with date
        const date = new Date().toISOString().split('T')[0];
        const filename = `thrive365-users-${date}.xlsx`;

        // Download file
        XLSX.writeFile(wb, filename);
      };

      const filteredUsers = users.filter(user => {
        const matchesSearch = user.name?.toLowerCase().includes(searchTerm.toLowerCase()) || user.email?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesRole = roleFilter === 'all' || user.role === roleFilter || (roleFilter === 'service' && user.hasServicePortalAccess);
        return matchesSearch && matchesRole;
      });

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">User Management</h1>
                <p className="text-gray-600 mt-1">Manage all users, roles, and portal access</p>
              </div>
              <div className="flex gap-2 flex-wrap">
                <button onClick={exportUsersToXlsx}
                  className="px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm hover:shadow-md transition-all border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">
                  {Icons.download} Export
                </button>
                <button onClick={() => { setShowBulkReset(true); setBulkResetResults(null); }}
                  className="px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm hover:shadow-md transition-all border border-orange-300 bg-orange-50 text-orange-700 hover:bg-orange-100">
                  {Icons.key} Bulk Reset
                </button>
                <button onClick={() => { setShowForm(true); setEditingUser(null); setFormData(defaultFormData); }}
                  className="px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm hover:shadow-md transition-all"
                  style={{backgroundColor: '#045E9F', color: 'white'}}>
                  {Icons.plus} Add User
                </button>
              </div>
            </div>

            {/* Tabs */}
            <div className="mt-4 flex gap-2 border-b">
              <button onClick={() => setActiveTab('list')} className={`px-4 py-2 font-medium ${activeTab === 'list' ? 'border-b-2 border-primary text-primary' : 'text-gray-500'}`}>
                Users ({users.length})
              </button>
              <button onClick={() => setActiveTab('resets')} className={`px-4 py-2 font-medium ${activeTab === 'resets' ? 'border-b-2 border-primary text-primary' : 'text-gray-500'}`}>
                Password Resets {passwordResets.length > 0 && <span className="ml-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{passwordResets.length}</span>}
              </button>
            </div>

            {message && <div className={`mt-4 p-3 rounded-lg ${message.includes('Error') ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}>{message}</div>}

            {activeTab === 'list' && (
              <div className="mt-4 flex flex-col md:flex-row gap-4">
                <input type="text" placeholder="Search users..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                  className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" />
                <select value={roleFilter} onChange={(e) => setRoleFilter(e.target.value)} className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary">
                  <option value="all">All Roles</option>
                  <option value="admin">Admins</option>
                  <option value="user">Team Members</option>
                  <option value="vendor">Vendors</option>
                  <option value="client">Clients</option>
                  <option value="service">Service Portal Access</option>
                </select>
              </div>
            )}
          </div>

          {/* Password Reset Requests Tab */}
          {activeTab === 'resets' && (
            <div className="bg-white rounded-xl shadow-sm p-6">
              <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">{Icons.key} Password Reset Requests</h2>
              {passwordResets.length > 0 ? (
                <div className="space-y-3">
                  {passwordResets.map(req => {
                    const user = users.find(u => u.id === req.userId);
                    return (
                      <div key={req.id} className="flex justify-between items-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div>
                          <p className="font-medium">{user?.name || 'Unknown User'}</p>
                          <p className="text-sm text-gray-500">{user?.email}</p>
                          <p className="text-xs text-gray-400">Requested: {new Date(req.requestedAt).toLocaleString()}</p>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => handlePasswordReset(req.id, req.userId)} className="px-3 py-1 bg-primary text-white rounded text-sm">Reset Password</button>
                          <button onClick={() => dismissReset(req.id)} className="px-3 py-1 bg-gray-200 rounded text-sm">Dismiss</button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p className="text-gray-500 text-center py-8">No pending password reset requests</p>
              )}
            </div>
          )}

          {/* User Form Modal */}
          {showForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                  <h2 className="text-lg font-bold text-accent">{editingUser ? 'Edit User' : 'Create New User'}</h2>
                  <button onClick={() => { setShowForm(false); setEditingUser(null); }} className="text-gray-400 hover:text-gray-600">
                    {Icons.close}
                  </button>
                </div>
                <form onSubmit={handleSubmit} className="p-6 space-y-6">
                  {/* Error/Success Message */}
                  {message && (
                    <div className={`p-3 rounded-lg ${message.includes('Error') ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'}`}>
                      {message}
                    </div>
                  )}
                  {/* Basic Info */}
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                      <input type="text" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                      <input type="email" value={formData.email} onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
                      <input type="tel" value={formData.phone || ''} onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                        placeholder="(555) 123-4567"
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Password {editingUser ? '(leave blank to keep)' : '*'}</label>
                      <input type="password" value={formData.password} onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" required={!editingUser} />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                      <select value={formData.role === 'user' && formData.isManager ? 'manager' : formData.role} onChange={(e) => {
                          const val = e.target.value;
                          if (val === 'manager') {
                            setFormData({ ...formData, role: 'user', isManager: true });
                          } else {
                            setFormData({ ...formData, role: val, isManager: false });
                          }
                        }}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="user">Team Member</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Super Admin</option>
                        <option value="client">Client</option>
                        <option value="vendor">External Vendor</option>
                      </select>
                    </div>
                  </div>

                  {/* Permission Flags (for team members) */}
                  {(formData.role === 'user' || formData.role === 'admin') && (
                    <div className="border-t pt-4">
                      <h3 className="font-medium text-gray-800 mb-3">Access Permissions</h3>

                      <div className="grid md:grid-cols-2 gap-3">
                        <div className="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                          <input type="checkbox" id="serviceAccess" checked={formData.hasServicePortalAccess}
                            onChange={(e) => setFormData({ ...formData, hasServicePortalAccess: e.target.checked })}
                            className="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500" />
                          <label htmlFor="serviceAccess" className="text-sm font-medium text-gray-700">Service Portal</label>
                        </div>
                        <div className="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                          <input type="checkbox" id="adminHubAccess" checked={formData.hasAdminHubAccess}
                            onChange={(e) => setFormData({ ...formData, hasAdminHubAccess: e.target.checked })}
                            className="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                          <label htmlFor="adminHubAccess" className="text-sm font-medium text-gray-700">Admin Hub</label>
                        </div>
                        <div className="flex items-center gap-3 p-3 bg-purple-50 rounded-lg">
                          <input type="checkbox" id="implAccess" checked={formData.hasImplementationsAccess}
                            onChange={(e) => setFormData({ ...formData, hasImplementationsAccess: e.target.checked })}
                            className="w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500" />
                          <label htmlFor="implAccess" className="text-sm font-medium text-gray-700">Implementations App</label>
                        </div>
                        <div className="flex items-center gap-3 p-3 bg-orange-50 rounded-lg">
                          <input type="checkbox" id="clientPortalAdmin" checked={formData.hasClientPortalAdminAccess}
                            onChange={(e) => setFormData({ ...formData, hasClientPortalAdminAccess: e.target.checked })}
                            className="w-5 h-5 rounded border-gray-300 text-orange-600 focus:ring-orange-500" />
                          <label htmlFor="clientPortalAdmin" className="text-sm font-medium text-gray-700">Client Portal Admin</label>
                        </div>
                      </div>
                      <p className="text-xs text-gray-500 mt-2">Admins automatically have all permissions. Managers with Service Portal access can manage vendors and assignments.</p>
                    </div>
                  )}

                  {/* Vendor-specific fields */}
                  {formData.role === 'vendor' && (
                    <div className="border-t pt-4">
                      <h3 className="font-medium text-gray-800 mb-3">Vendor Settings</h3>
                      <p className="text-sm text-gray-500 mb-3">Vendors can submit service reports and view reports for their assigned clients</p>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Assigned Clients</label>
                        <div className="max-h-48 overflow-y-auto border rounded-lg p-2 space-y-2">
                          {clients.length > 0 ? clients.map((client, idx) => {
                            const isAssigned = (formData.assignedClients || []).includes(client.name || client.clientName);
                            return (
                              <div key={idx} className={`flex items-center p-2 rounded ${isAssigned ? 'bg-green-50' : 'bg-gray-50'}`}>
                                <label className="flex items-center gap-2 cursor-pointer flex-1">
                                  <input type="checkbox" checked={isAssigned}
                                    onChange={() => {
                                      const clientName = client.name || client.clientName;
                                      const current = formData.assignedClients || [];
                                      setFormData({
                                        ...formData,
                                        assignedClients: isAssigned
                                          ? current.filter(c => c !== clientName)
                                          : [...current, clientName]
                                      });
                                    }}
                                    className="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500" />
                                  <span className="text-sm">{client.name || client.clientName}</span>
                                </label>
                              </div>
                            );
                          }) : <p className="text-sm text-gray-500 text-center py-4">No clients available</p>}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Client-specific fields */}
                  {formData.role === 'client' && (
                    <div className="border-t pt-4">
                      <h3 className="font-medium text-gray-800 mb-3">Client Settings</h3>

                      {/* Add to existing portal option - only for new users */}
                      {!editingUser && clientPortals.length > 0 && (
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-1">Add to Existing Portal</label>
                          <select
                            value={formData.existingPortalSlug}
                            onChange={(e) => {
                              const slug = e.target.value;
                              if (slug) {
                                const portal = clientPortals.find(p => p.slug === slug);
                                if (portal) {
                                  setFormData({
                                    ...formData,
                                    existingPortalSlug: slug,
                                    practiceName: portal.practiceName,
                                    logo: portal.logo || formData.logo,
                                    hubspotCompanyId: portal.hubspotCompanyId || formData.hubspotCompanyId,
                                  });
                                }
                              } else {
                                setFormData({ ...formData, existingPortalSlug: '', practiceName: '' });
                              }
                            }}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                          >
                            <option value="">-- Create New Portal --</option>
                            {clientPortals.map(p => (
                              <option key={p.slug} value={p.slug}>
                                {p.practiceName} ({p.memberCount} {p.memberCount === 1 ? 'user' : 'users'})
                              </option>
                            ))}
                          </select>
                          {formData.existingPortalSlug && (
                            <div className="mt-2 p-3 bg-blue-50 rounded-lg">
                              <p className="text-sm text-gray-700">
                                <span className="font-medium">Adding user to portal:</span> {window.location.origin}/portal/{formData.existingPortalSlug}
                              </p>
                              {(() => {
                                const portal = clientPortals.find(p => p.slug === formData.existingPortalSlug);
                                return portal ? (
                                  <p className="text-xs text-gray-500 mt-1">
                                    Current members: {portal.members.map(m => m.name).join(', ')}
                                  </p>
                                ) : null;
                              })()}
                            </div>
                          )}
                        </div>
                      )}

                      <div className="grid md:grid-cols-2 gap-4">
                        <div className="md:col-span-2">
                          <label className="block text-sm font-medium text-gray-700 mb-1">Practice Name {!formData.existingPortalSlug && '*'}</label>
                          <input type="text" value={formData.practiceName} onChange={(e) => setFormData({ ...formData, practiceName: e.target.value })}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" required={!formData.existingPortalSlug}
                            disabled={!!formData.existingPortalSlug} />
                          {formData.existingPortalSlug && <p className="text-xs text-gray-500 mt-1">Inherited from existing portal</p>}
                        </div>
                        <div className="md:col-span-2">
                          <label className="block text-sm font-medium text-gray-700 mb-1">Practice Logo</label>
                          <div className="flex items-center gap-4">
                            {formData.logo && <img src={formData.logo} alt="Logo" className="h-16 w-16 object-contain border rounded" />}
                            <input type="file" ref={logoInputRef} accept="image/png,image/jpeg" onChange={handleLogoUpload} className="hidden" />
                            <button type="button" onClick={() => logoInputRef.current?.click()}
                              className="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white flex items-center gap-2">
                              {Icons.upload} Upload Logo
                            </button>
                            {formData.logo && <button type="button" onClick={() => setFormData({ ...formData, logo: '' })} className="text-red-600 text-sm">Remove</button>}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Max 2MB, PNG or JPEG</p>
                        </div>
                        {editingUser?.slug && (
                          <div className="md:col-span-2 p-3 bg-blue-50 rounded-lg">
                            <p className="text-sm text-gray-700"><span className="font-medium">Client Portal URL:</span> {window.location.origin}/portal/{editingUser.slug}</p>
                          </div>
                        )}
                      </div>

                      {/* HubSpot Integration */}
                      <h4 className="font-medium text-gray-800 mt-4 mb-2">HubSpot Integration</h4>
                      <div className="grid md:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company ID</label>
                          <input type="text" value={formData.hubspotCompanyId} onChange={(e) => setFormData({ ...formData, hubspotCompanyId: e.target.value })}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" placeholder="HubSpot Company ID" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Deal ID</label>
                          <input type="text" value={formData.hubspotDealId} onChange={(e) => setFormData({ ...formData, hubspotDealId: e.target.value })}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" placeholder="HubSpot Deal ID" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Contact ID</label>
                          <input type="text" value={formData.hubspotContactId} onChange={(e) => setFormData({ ...formData, hubspotContactId: e.target.value })}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" placeholder="HubSpot Contact ID" />
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Project Assignment (for non-admin users) */}
                  {formData.role !== 'admin' && projects.length > 0 && (
                    <div className="border-t pt-4">
                      <h3 className="font-medium text-gray-800 mb-3">Project Access</h3>
                      <p className="text-sm text-gray-500 mb-3">
                        {formData.role === 'client' ? 'Select projects this client can view in their portal' : 'Select projects this user can access'}
                      </p>
                      <div className="max-h-48 overflow-y-auto border rounded-lg p-2 space-y-2">
                        {projects.map(project => {
                          const isAssigned = formData.assignedProjects.includes(project.id);
                          const accessLevel = formData.projectAccessLevels[project.id] || 'edit';
                          return (
                            <div key={project.id} className={`flex items-center justify-between p-2 rounded ${isAssigned ? 'bg-blue-50' : 'bg-gray-50'}`}>
                              <label className="flex items-center gap-2 cursor-pointer flex-1">
                                <input type="checkbox" checked={isAssigned} onChange={() => toggleProjectAssignment(project.id)}
                                  className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary" />
                                <span className="text-sm">{project.name || project.clientName}</span>
                              </label>
                              {isAssigned && formData.role !== 'client' && (
                                <select value={accessLevel} onChange={(e) => setProjectAccessLevel(project.id, e.target.value)}
                                  className="ml-2 text-xs px-2 py-1 border rounded">
                                  <option value="edit">Edit</option>
                                  <option value="view">View Only</option>
                                </select>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  <div className="flex justify-end gap-3 pt-4 border-t sticky bottom-0 bg-white pb-2">
                    <button type="button" onClick={() => { setShowForm(false); setEditingUser(null); setMessage(''); }} className="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium" disabled={saving}>
                      Cancel
                    </button>
                    <button type="submit" disabled={saving} className="px-6 py-2.5 rounded-lg font-medium flex items-center gap-2" style={{backgroundColor: '#045E9F', color: 'white'}}>
                      {saving && <span className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>}
                      {saving ? 'Saving...' : (editingUser ? 'Update User' : 'Create User')}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Bulk Password Reset Modal */}
          {showBulkReset && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                  <h2 className="text-lg font-bold text-accent flex items-center gap-2">{Icons.key} Bulk Password Reset</h2>
                  <button onClick={() => setShowBulkReset(false)} className="text-gray-400 hover:text-gray-600">
                    {Icons.close}
                  </button>
                </div>
                <div className="p-6 space-y-6">
                  {!bulkResetResults ? (
                    <>
                      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p className="text-yellow-800 text-sm">
                          <strong>Warning:</strong> This will reset passwords for selected users. They will be required to change their password on their next login.
                        </p>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Select User Type</label>
                        <select value={bulkResetType} onChange={(e) => setBulkResetType(e.target.value)}
                          className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary">
                          <option value="all">All Users (excludes admins)</option>
                          <option value="clients">Clients Only</option>
                          <option value="users">Team Members Only (non-clients)</option>
                        </select>
                      </div>

                      <div className="bg-gray-50 rounded-lg p-4">
                        <p className="text-sm text-gray-600">
                          <strong>Password Format:</strong><br/>
                          - Clients: <code className="bg-gray-200 px-1 rounded">PracticeName2026!</code><br/>
                          - Team Members: <code className="bg-gray-200 px-1 rounded">FirstNameLastName2026!</code>
                        </p>
                      </div>

                      <div className="flex justify-end gap-3 pt-4 border-t">
                        <button onClick={() => setShowBulkReset(false)} className="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                          Cancel
                        </button>
                        <button onClick={handleBulkReset} disabled={bulkResetLoading}
                          className="px-6 py-2.5 rounded-lg font-medium flex items-center gap-2 bg-orange-500 text-white hover:bg-orange-600 disabled:opacity-50">
                          {bulkResetLoading && <span className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>}
                          {bulkResetLoading ? 'Resetting...' : 'Reset Passwords'}
                        </button>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className={`rounded-lg p-4 ${bulkResetResults.total > 0 ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}`}>
                        <p className={`font-medium ${bulkResetResults.total > 0 ? 'text-green-800' : 'text-yellow-800'}`}>
                          {bulkResetResults.total > 0 ? `Successfully reset passwords for ${bulkResetResults.total} user(s).` : 'No users were reset. This may be because all users are admins (excluded) or no users matched the selected type.'}
                        </p>
                      </div>

                      {bulkResetResults.total > 0 && (
                        <div>
                          <h3 className="font-medium text-gray-700 mb-2">Reset Users & Temporary Passwords:</h3>
                          <div className="max-h-60 overflow-y-auto border rounded-lg">
                            <table className="w-full text-sm">
                              <thead className="bg-gray-50 sticky top-0">
                                <tr>
                                  <th className="px-3 py-2 text-left font-medium text-gray-600">User</th>
                                  <th className="px-3 py-2 text-left font-medium text-gray-600">Temp Password</th>
                                </tr>
                              </thead>
                              <tbody className="divide-y">
                                {bulkResetResults.reset.map(u => (
                                  <tr key={u.id} className="hover:bg-gray-50">
                                    <td className="px-3 py-2">
                                      <div className="font-medium">{u.name}</div>
                                      <div className="text-xs text-gray-500">{u.email}</div>
                                    </td>
                                    <td className="px-3 py-2 font-mono text-xs bg-gray-100 rounded">{u.tempPassword}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      )}

                      {bulkResetResults.skipped?.length > 0 && (
                        <div>
                          <h3 className="font-medium text-gray-700 mb-2">Skipped ({bulkResetResults.skipped.length}):</h3>
                          <div className="text-sm text-gray-500 space-y-1">
                            {bulkResetResults.skipped.map((s, i) => (
                              <div key={i}>{s.email} - {s.reason}</div>
                            ))}
                          </div>
                        </div>
                      )}

                      <div className="flex justify-end pt-4 border-t">
                        <button onClick={() => setShowBulkReset(false)} className="px-6 py-2.5 rounded-lg font-medium bg-primary text-white hover:bg-primary/90">
                          Done
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Users List */}
          {activeTab === 'list' && (
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              {loading ? (
                <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50 border-b">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">User</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Role</th>
                        <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Portal Access</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Details</th>
                        <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Status</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Created</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredUsers.map(user => (
                        <tr key={user.id} className={`hover:bg-gray-50 ${user.accountStatus === 'inactive' ? 'opacity-60' : ''}`}>
                          <td className="px-4 py-4">
                            <div className="flex items-center gap-3">
                              {user.logo && <img src={user.logo} alt="" className="h-8 w-8 rounded object-contain bg-gray-100" />}
                              <div>
                                <div className="font-medium text-gray-900">{user.name}</div>
                                <div className="text-sm text-gray-500">{user.email}</div>
                              </div>
                            </div>
                          </td>
                          <td className="px-4 py-4 text-center">
                            <span className={`inline-block px-3 py-1 text-xs rounded-full font-medium text-center ${
                              user.role === 'admin' ? 'bg-purple-100 text-purple-700' :
                              user.isManager ? 'bg-indigo-100 text-indigo-700' :
                              user.role === 'client' ? 'bg-blue-100 text-blue-700' :
                              user.role === 'vendor' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                            }`}>{
                              user.role === 'admin' ? 'Super Admin' :
                              user.isManager ? 'Manager' :
                              user.role === 'client' ? 'Client' :
                              user.role === 'vendor' ? 'Vendor' :
                              user.role === 'user' ? 'Team Member' : user.role
                            }</span>
                          </td>
                          <td className="px-4 py-4">
                            <div className="flex flex-wrap gap-1 justify-center">
                              <span className={`px-2 py-0.5 text-xs rounded ${user.role === 'admin' || user.assignedProjects?.length > 0 ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-400'}`} title="Implementations App">Impl</span>
                              <span className={`px-2 py-0.5 text-xs rounded ${user.role === 'client' || user.role === 'admin' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-400'}`} title="Client Portal">Client</span>
                              <button onClick={() => toggleServiceAccess(user)} disabled={user.role === 'admin'}
                                className={`px-2 py-0.5 text-xs rounded ${user.hasServicePortalAccess || user.role === 'admin' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}
                                title={user.role === 'admin' ? 'Admins always have access' : 'Click to toggle'}>Service</button>
                            </div>
                          </td>
                          <td className="px-4 py-4 text-xs text-gray-500">
                            {user.practiceName && <div><span className="font-medium">Practice:</span> {user.practiceName}</div>}
                            {user.slug && <div><span className="font-medium">Slug:</span> {user.slug}</div>}
                            {user.assignedProjects?.length > 0 && <div><span className="font-medium">Projects:</span> {user.assignedProjects.length}</div>}
                          </td>
                          <td className="px-4 py-4 text-center">
                            <button onClick={() => toggleAccountStatus(user)}
                              disabled={user.role === 'admin'}
                              className={`px-2.5 py-1 text-xs rounded-full font-medium transition ${user.accountStatus === 'inactive' ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} ${user.role === 'admin' ? 'cursor-not-allowed opacity-70' : 'cursor-pointer'}`}
                              title={user.role === 'admin' ? 'Admin accounts cannot be deactivated' : `Click to ${user.accountStatus === 'inactive' ? 'reactivate' : 'deactivate'}`}>{user.accountStatus === 'inactive' ? 'Inactive' : 'Active'}</button>
                          </td>
                          <td className="px-4 py-4 text-sm text-gray-500">{new Date(user.createdAt).toLocaleDateString()}</td>
                          <td className="px-4 py-4">
                            <div className="flex gap-2">
                              <button onClick={() => handleEdit(user)} className="p-1 text-primary hover:bg-primary/10 rounded" title="Edit">{Icons.edit}</button>
                              <button onClick={() => handleDelete(user.id)} className="p-1 text-red-600 hover:bg-red-50 rounded" title="Delete">{Icons.trash}</button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    // Full Service Portal Page (embedded admin view)
    const ServicePortalPage = ({ token, user }) => {
      const [activeTab, setActiveTab] = useState('reports');
      const [reports, setReports] = useState([]);
      const [validationReports, setValidationReports] = useState([]);
      const [clients, setClients] = useState([]);
      const [technicians, setTechnicians] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [sortBy, setSortBy] = useState('date_desc');
      const [statusFilter, setStatusFilter] = useState('');
      const [viewingReport, setViewingReport] = useState(null);
      const [viewingValidation, setViewingValidation] = useState(null);
      const [showNewReport, setShowNewReport] = useState(false);
      const [submitting, setSubmitting] = useState(false);
      const [formData, setFormData] = useState({
        clientFacilityName: '', customerName: '', serviceProviderName: user?.name || '',
        address: '', serviceCompletionDate: new Date().toISOString().split('T')[0],
        analyzerModel: '', analyzerSerialNumber: '', hubspotTicketNumber: '', hubspotCompanyId: '',
        serviceType: '', descriptionOfWork: '', materialsUsed: '', solution: '', outstandingIssues: ''
      });
      const [validationFormData, setValidationFormData] = useState({
        clientFacilityName: '', serviceProviderName: user?.name || '',
        startDate: new Date().toISOString().split('T')[0],
        endDate: new Date().toISOString().split('T')[0],
        daysOnSite: 1,
        hubspotCompanyId: '',
        analyzersValidated: [{ model: '', serialNumber: '', validationStatus: 'Passed' }],
        trainingProvided: '', validationResults: '', outstandingItems: '', nextSteps: ''
      });

      // Assignment form state
      const [assignFormData, setAssignFormData] = useState({
        assignedToId: '', clientFacilityName: '', customerName: '', address: '',
        serviceType: '', analyzerModel: '', analyzerSerialNumber: '',
        hubspotTicketNumber: '', hubspotCompanyId: '', serviceCompletionDate: '',
        managerNotes: '', validationStartDate: '', validationEndDate: '', expectedDays: ''
      });
      const [assignedPhotos, setAssignedPhotos] = useState([]);
      const [assignedFiles, setAssignedFiles] = useState([]);
      const [photoPreviewUrls, setPhotoPreviewUrls] = useState([]);
      const [fileNames, setFileNames] = useState([]);
      const photoInputRef = React.useRef(null);
      const fileInputRef = React.useRef(null);

      const serviceTypes = ['Analyzer Hardware', 'Inventory', 'LIS/EMR', 'Billing & Fees', 'Compliance', 'Training', 'Validations'];

      // Vendor Management State (for admins and managers)
      const [vendors, setVendors] = useState([]);
      const [allClients, setAllClients] = useState([]);
      const [showVendorForm, setShowVendorForm] = useState(false);
      const [editingVendor, setEditingVendor] = useState(null);
      const [vendorFormData, setVendorFormData] = useState({
        name: '', email: '', password: '', assignedClients: []
      });
      const [vendorSaving, setVendorSaving] = useState(false);
      // Vendor Management is visible to Managers with Service Portal access
      const canManageVendors = user?.isManager && user?.hasServicePortalAccess && user?.role !== 'admin';

      useEffect(() => {
        loadData();
      }, [token]);

      const loadData = async () => {
        setLoading(true);
        const [reportsData, validationData, clientsData, usersData, allClientsData, techniciansData] = await Promise.all([
          api.getServiceReports(token),
          fetch('/api/validation-reports', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).catch(() => []),
          api.getServiceClients(token),
          canManageVendors ? api.getUsers(token) : Promise.resolve([]),
          canManageVendors ? fetch('/api/clients', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).catch(() => []) : Promise.resolve([]),
          api.getTechnicians(token)
        ]);
        if (!techniciansData.error) setTechnicians(techniciansData);
        // Load vendors from users
        if (Array.isArray(usersData)) {
          setVendors(usersData.filter(u => u.role === 'vendor'));
        }
        if (Array.isArray(allClientsData)) {
          setAllClients(allClientsData);
        }
        if (!reportsData.error) {
          // Separate service reports from validation service reports
          const serviceReportsOnly = reportsData.filter(r => r.serviceType !== 'Validations');
          const validationServiceReports = reportsData.filter(r => r.serviceType === 'Validations');
          setReports(serviceReportsOnly);
          // Combine validation service reports with dedicated validation reports
          const allValidationReports = [
            ...validationServiceReports.map(r => ({ ...r, isServiceReport: true })),
            ...(Array.isArray(validationData) ? validationData : [])
          ];
          setValidationReports(allValidationReports);
        } else {
          if (Array.isArray(validationData)) setValidationReports(validationData);
        }
        if (!clientsData.error) setClients(clientsData);
        setLoading(false);
      };

      const handleClientSelect = (clientName, isValidation = false) => {
        const client = clients.find(c => c.name === clientName || c.clientName === clientName);
        if (client) {
          if (isValidation) {
            setValidationFormData(prev => ({
              ...prev,
              clientFacilityName: client.name || client.clientName || '',
              hubspotCompanyId: client.hubspotCompanyId || ''
            }));
          } else {
            setFormData(prev => ({
              ...prev,
              clientFacilityName: client.name || client.clientName || '',
              address: client.address || '',
              hubspotCompanyId: client.hubspotCompanyId || ''
            }));
          }
        }
      };

      const handleAddAnalyzer = () => {
        setValidationFormData(prev => ({
          ...prev,
          analyzersValidated: [...prev.analyzersValidated, { model: '', serialNumber: '', validationStatus: 'Passed' }]
        }));
      };

      const handleRemoveAnalyzer = (idx) => {
        setValidationFormData(prev => ({
          ...prev,
          analyzersValidated: prev.analyzersValidated.filter((_, i) => i !== idx)
        }));
      };

      const handleAnalyzerChange = (idx, field, value) => {
        setValidationFormData(prev => ({
          ...prev,
          analyzersValidated: prev.analyzersValidated.map((a, i) => i === idx ? { ...a, [field]: value } : a)
        }));
      };

      const handleSubmitValidation = async (e) => {
        e.preventDefault();
        if (!validationFormData.clientFacilityName || !validationFormData.startDate || !validationFormData.endDate) {
          alert('Please fill in all required fields');
          return;
        }
        setSubmitting(true);
        try {
          const response = await fetch('/api/validation-reports', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(validationFormData)
          });
          const result = await response.json();
          if (result.error) {
            alert('Error: ' + result.error);
          } else {
            setActiveTab('validation');
            setValidationFormData({
              clientFacilityName: '', serviceProviderName: user?.name || '',
              startDate: new Date().toISOString().split('T')[0],
              endDate: new Date().toISOString().split('T')[0],
              daysOnSite: 1,
              hubspotCompanyId: '',
              analyzersValidated: [{ model: '', serialNumber: '', validationStatus: 'Passed' }],
              trainingProvided: '', validationResults: '', outstandingItems: '', nextSteps: ''
            });
            loadData();
          }
        } catch (err) {
          alert('Error submitting validation report');
        }
        setSubmitting(false);
      };

      const handleSubmitReport = async (e) => {
        e.preventDefault();
        if (!formData.clientFacilityName || !formData.serviceType || !formData.descriptionOfWork) {
          alert('Please fill in all required fields');
          return;
        }
        setSubmitting(true);
        const result = await api.submitServiceReport(token, formData);
        if (result.error) {
          alert('Error: ' + result.error);
        } else {
          setShowNewReport(false);
          setFormData({
            clientFacilityName: '', customerName: '', serviceProviderName: user?.name || '',
            address: '', serviceCompletionDate: new Date().toISOString().split('T')[0],
            analyzerModel: '', analyzerSerialNumber: '', hubspotTicketNumber: '', hubspotCompanyId: '',
            serviceType: '', descriptionOfWork: '', materialsUsed: '', solution: '', outstandingIssues: ''
          });
          loadData();
        }
        setSubmitting(false);
      };

      // Assignment handlers
      const handlePhotoSelect = (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length > 0) {
          setAssignedPhotos(prev => [...prev, ...files]);
          const newPreviews = files.map(file => URL.createObjectURL(file));
          setPhotoPreviewUrls(prev => [...prev, ...newPreviews]);
        }
      };

      const handleFileSelect = (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length > 0) {
          setAssignedFiles(prev => [...prev, ...files]);
          setFileNames(prev => [...prev, ...files.map(f => f.name)]);
        }
      };

      const removePhoto = (idx) => {
        setAssignedPhotos(prev => prev.filter((_, i) => i !== idx));
        setPhotoPreviewUrls(prev => prev.filter((_, i) => i !== idx));
      };

      const removeFile = (idx) => {
        setAssignedFiles(prev => prev.filter((_, i) => i !== idx));
        setFileNames(prev => prev.filter((_, i) => i !== idx));
      };

      const handleAssignClientSelect = (clientName) => {
        const client = clients.find(c => c.name === clientName || c.clientName === clientName);
        if (client) {
          setAssignFormData(prev => ({
            ...prev,
            clientFacilityName: client.name || client.clientName || '',
            address: client.address || '',
            hubspotCompanyId: client.hubspotCompanyId || ''
          }));
        }
      };

      const handleAssignReport = async (e) => {
        e.preventDefault();
        if (!assignFormData.assignedToId || !assignFormData.clientFacilityName) {
          alert('Please select a technician/vendor and client');
          return;
        }
        setSubmitting(true);
        try {
          // First create the assigned report
          const result = await api.assignServiceReport(token, assignFormData);
          if (result.error) {
            alert('Error: ' + result.error);
            setSubmitting(false);
            return;
          }

          // Upload photos if any
          if (assignedPhotos.length > 0) {
            await api.uploadServiceReportPhotos(token, result.id, assignedPhotos);
          }

          // Upload files if any
          if (assignedFiles.length > 0) {
            await api.uploadServiceReportFiles(token, result.id, assignedFiles);
          }

          // Reset form
          setAssignFormData({
            assignedToId: '', clientFacilityName: '', customerName: '', address: '',
            serviceType: '', analyzerModel: '', analyzerSerialNumber: '',
            hubspotTicketNumber: '', hubspotCompanyId: '', serviceCompletionDate: '',
            managerNotes: '', validationStartDate: '', validationEndDate: '', expectedDays: ''
          });
          setAssignedPhotos([]);
          setAssignedFiles([]);
          setPhotoPreviewUrls([]);
          setFileNames([]);
          setActiveTab('reports');
          loadData();
          alert('Service report assigned successfully!');
        } catch (err) {
          alert('Error assigning report: ' + err.message);
        }
        setSubmitting(false);
      };

      // Include all reports (submitted and assigned) with sort and filter
      const filteredReports = reports
        .filter(r => {
          if (searchTerm && !r.clientFacilityName?.toLowerCase().includes(searchTerm.toLowerCase()) &&
              !r.serviceType?.toLowerCase().includes(searchTerm.toLowerCase()) &&
              !r.technicianName?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
          if (statusFilter && r.status !== statusFilter) return false;
          return true;
        })
        .sort((a, b) => {
          const dateA = new Date(a.serviceCompletionDate || a.createdAt);
          const dateB = new Date(b.serviceCompletionDate || b.createdAt);
          if (sortBy === 'date_desc') return dateB - dateA;
          if (sortBy === 'date_asc') return dateA - dateB;
          if (sortBy === 'client_asc') return (a.clientFacilityName || '').localeCompare(b.clientFacilityName || '');
          if (sortBy === 'client_desc') return (b.clientFacilityName || '').localeCompare(a.clientFacilityName || '');
          if (sortBy === 'type_asc') return (a.serviceType || '').localeCompare(b.serviceType || '');
          if (sortBy === 'tech_asc') return (a.technicianName || a.serviceProviderName || '').localeCompare(b.technicianName || b.serviceProviderName || '');
          return dateB - dateA;
        });

      // Vendor Management Functions
      const handleEditVendor = (vendor) => {
        setEditingVendor(vendor);
        setVendorFormData({
          name: vendor.name || '',
          email: vendor.email || '',
          password: '',
          assignedClients: vendor.assignedClients || []
        });
        setShowVendorForm(true);
      };

      const handleVendorSubmit = async (e) => {
        e.preventDefault();
        if (!vendorFormData.name || !vendorFormData.email) {
          alert('Please fill in name and email');
          return;
        }
        setVendorSaving(true);
        try {
          let result;
          if (editingVendor) {
            const updateData = { ...vendorFormData, role: 'vendor' };
            if (!updateData.password) delete updateData.password;
            result = await api.updateUser(token, editingVendor.id, updateData);
          } else {
            if (!vendorFormData.password) {
              alert('Password is required for new vendors');
              setVendorSaving(false);
              return;
            }
            result = await api.createUser(token, { ...vendorFormData, role: 'vendor' });
          }
          if (result.error) {
            alert('Error: ' + result.error);
          } else {
            setShowVendorForm(false);
            setEditingVendor(null);
            setVendorFormData({ name: '', email: '', password: '', assignedClients: [] });
            loadData();
          }
        } catch (err) {
          alert('Error saving vendor: ' + err.message);
        }
        setVendorSaving(false);
      };

      const handleDeleteVendor = async (vendorId) => {
        if (!confirm('Are you sure you want to delete this vendor?')) return;
        const result = await api.deleteUser(token, vendorId);
        if (result.error) {
          alert('Error: ' + result.error);
        } else {
          loadData();
        }
      };

      // View single validation report
      if (viewingValidation) {
        const startDate = viewingValidation.validationStartDate || viewingValidation.startDate;
        const endDate = viewingValidation.validationEndDate || viewingValidation.endDate;
        const daysOnSite = viewingValidation.isServiceReport && startDate && endDate
          ? Math.ceil(Math.abs(new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1
          : viewingValidation.daysOnSite || 1;
        return (
          <div className="space-y-6">
            <button onClick={() => setViewingValidation(null)} className="flex items-center gap-2 text-primary hover:text-accent">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
              Back to Validation Reports
            </button>
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6">
                <h1 className="text-2xl font-bold">Validation Report Details</h1>
                <p className="opacity-90">Report ID: {viewingValidation.id}</p>
                {viewingValidation.isServiceReport && (
                  <span className="inline-block mt-2 px-2 py-1 bg-white/20 rounded text-sm">Service Portal Submission</span>
                )}
              </div>
              <div className="p-6">
                <div className="grid md:grid-cols-3 gap-6 mb-6">
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <p className="text-sm text-purple-600 font-medium">Client</p>
                    <p className="text-lg font-bold text-gray-900">{viewingValidation.clientFacilityName}</p>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <p className="text-sm text-purple-600 font-medium">Date Range</p>
                    <p className="text-lg font-bold text-gray-900">
                      {startDate && endDate
                        ? `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`
                        : new Date(viewingValidation.createdAt).toLocaleDateString()}
                    </p>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <p className="text-sm text-purple-600 font-medium">Days On-Site</p>
                    <p className="text-lg font-bold text-gray-900">{daysOnSite} days</p>
                  </div>
                </div>

                <div className="mb-6">
                  <p className="text-sm text-gray-500">Service Provider</p>
                  <p className="font-medium">{viewingValidation.serviceProviderName || viewingValidation.technicianName}</p>
                </div>

                {viewingValidation.analyzersValidated && viewingValidation.analyzersValidated.length > 0 && (
                  <div className="mb-6">
                    <h3 className="font-bold text-accent mb-3">Analyzers Validated</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-2 text-left">Model</th>
                            <th className="px-4 py-2 text-left">Serial Number</th>
                            <th className="px-4 py-2 text-left">Status</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {viewingValidation.analyzersValidated.map((a, idx) => (
                            <tr key={idx}>
                              <td className="px-4 py-2">{a.model || '-'}</td>
                              <td className="px-4 py-2">{a.serialNumber || '-'}</td>
                              <td className="px-4 py-2">
                                <span className={`px-2 py-1 rounded text-xs font-medium ${
                                  (a.validationStatus || a.status) === 'Passed' ? 'bg-green-100 text-green-700' :
                                  (a.validationStatus || a.status) === 'Failed' ? 'bg-red-100 text-red-700' :
                                  (a.validationStatus || a.status) === 'Conditional' || (a.validationStatus || a.status) === 'Pending' ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-gray-100 text-gray-700'
                                }`}>
                                  {a.validationStatus || a.status}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {viewingValidation.trainingProvided && (
                  <div className="mb-6">
                    <h3 className="font-bold text-accent mb-2">Training Provided</h3>
                    <p className="text-sm bg-gray-50 p-3 rounded-lg whitespace-pre-wrap">{viewingValidation.trainingProvided}</p>
                  </div>
                )}

                <div className="mb-6">
                  <h3 className="font-bold text-accent mb-2">Validation Results</h3>
                  <p className="text-sm bg-gray-50 p-3 rounded-lg whitespace-pre-wrap">{viewingValidation.validationResults || '-'}</p>
                </div>

                {viewingValidation.validationReportFileName && (
                  <div className="mb-6">
                    <h3 className="font-bold text-accent mb-2">Validation Report File</h3>
                    <div className="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                      <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                      </svg>
                      {viewingValidation.validationReportFile ? (
                        <a href={viewingValidation.validationReportFile} download={viewingValidation.validationReportFileName} className="text-purple-600 hover:underline font-medium">
                          {viewingValidation.validationReportFileName}
                        </a>
                      ) : (
                        <span className="font-medium">{viewingValidation.validationReportFileName}</span>
                      )}
                    </div>
                  </div>
                )}

                {viewingValidation.recommendations && (
                  <div className="mb-6">
                    <h3 className="font-bold text-accent mb-2">Recommendations</h3>
                    <p className="text-sm bg-blue-50 p-3 rounded-lg whitespace-pre-wrap">{viewingValidation.recommendations}</p>
                  </div>
                )}

                {viewingValidation.outstandingItems && (
                  <div className="mb-6">
                    <h3 className="font-bold text-accent mb-2">Outstanding Items</h3>
                    <p className="text-sm bg-yellow-50 p-3 rounded-lg whitespace-pre-wrap">{viewingValidation.outstandingItems}</p>
                  </div>
                )}

                {viewingValidation.nextSteps && (
                  <div className="mb-6">
                    <h3 className="font-bold text-accent mb-2">Next Steps</h3>
                    <p className="text-sm bg-blue-50 p-3 rounded-lg whitespace-pre-wrap">{viewingValidation.nextSteps}</p>
                  </div>
                )}

                {/* Signatures if available */}
                {(viewingValidation.customerSignature || viewingValidation.technicianSignature) && (
                  <div className="mt-6 pt-6 border-t">
                    <h3 className="font-bold text-accent mb-4">Signatures</h3>
                    <div className="grid md:grid-cols-2 gap-6">
                      {viewingValidation.customerSignature && (
                        <div>
                          <p className="text-sm text-gray-500 mb-2">Customer Signature</p>
                          <div className="border rounded-lg p-2 bg-gray-50">
                            <img src={viewingValidation.customerSignature} alt="Customer Signature" className="max-h-20" />
                          </div>
                          {viewingValidation.customerSignatureDate && <p className="text-xs text-gray-500 mt-1">Date: {viewingValidation.customerSignatureDate}</p>}
                        </div>
                      )}
                      {viewingValidation.technicianSignature && (
                        <div>
                          <p className="text-sm text-gray-500 mb-2">Technician Signature</p>
                          <div className="border rounded-lg p-2 bg-gray-50">
                            <img src={viewingValidation.technicianSignature} alt="Technician Signature" className="max-h-20" />
                          </div>
                          {viewingValidation.technicianSignatureDate && <p className="text-xs text-gray-500 mt-1">Date: {viewingValidation.technicianSignatureDate}</p>}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // View single report
      if (viewingReport) {
        const isAssigned = viewingReport.status === 'assigned';
        const isSignatureNeeded = viewingReport.status === 'signature_needed';
        const headerGradient = isAssigned ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
          isSignatureNeeded ? 'bg-gradient-to-r from-orange-500 to-orange-600' :
          'bg-gradient-to-r from-green-600 to-green-800';
        const statusLabel = isAssigned ? 'Pending - Awaiting Completion' :
          isSignatureNeeded ? 'Signature Needed - Awaiting Client Signature' : 'Complete';
        return (
          <div className="space-y-6">
            <button onClick={() => setViewingReport(null)} className="flex items-center gap-2 text-primary hover:text-accent">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
              Back to Service Portal
            </button>
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className={`${headerGradient} text-white p-6`}>
                <div className="flex items-center gap-3 mb-2">
                  <h1 className="text-2xl font-bold">Service Report Details</h1>
                  <span className="px-3 py-1 rounded-full text-sm font-medium bg-white/20">
                    {statusLabel}
                  </span>
                </div>
                <p className="opacity-90">Report ID: {viewingReport.id}</p>
                {isAssigned && viewingReport.assignedByName && (
                  <p className="opacity-90 mt-1">Assigned by: {viewingReport.assignedByName} to {viewingReport.assignedToName}</p>
                )}
              </div>
              <div className="p-6 space-y-6">
                {/* Assignment Info for assigned reports */}
                {isAssigned && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 className="font-semibold text-yellow-800 mb-2">Assignment Details</h3>
                    <div className="grid md:grid-cols-2 gap-4 text-sm">
                      <p><span className="text-yellow-700">Assigned To:</span> <span className="font-medium">{viewingReport.assignedToName}</span></p>
                      <p><span className="text-yellow-700">Assigned By:</span> <span className="font-medium">{viewingReport.assignedByName}</span></p>
                      <p><span className="text-yellow-700">Assigned At:</span> {new Date(viewingReport.assignedAt).toLocaleString()}</p>
                    </div>
                  </div>
                )}

                {/* Manager Notes */}
                {viewingReport.managerNotes && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 className="font-semibold text-blue-800 mb-2">Manager Notes</h3>
                    <p className="text-sm text-blue-900 whitespace-pre-wrap">{viewingReport.managerNotes}</p>
                  </div>
                )}

                {/* Photos */}
                {viewingReport.photos && viewingReport.photos.length > 0 && (
                  <div>
                    <h3 className="font-bold text-accent mb-3">Photos</h3>
                    <div className="flex flex-wrap gap-3">
                      {viewingReport.photos.map((photo, idx) => (
                        <a key={photo.id || idx} href={photo.url} target="_blank" rel="noopener noreferrer" className="block">
                          <img src={photo.url} alt={photo.name} className="w-24 h-24 object-cover rounded-lg border hover:opacity-80 transition" />
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                {/* Client Files */}
                {viewingReport.clientFiles && viewingReport.clientFiles.length > 0 && (
                  <div>
                    <h3 className="font-bold text-accent mb-3">Client Files</h3>
                    <div className="space-y-2">
                      {viewingReport.clientFiles.map((file, idx) => (
                        <a key={file.id || idx} href={file.url} target="_blank" rel="noopener noreferrer"
                          className="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                          {Icons.folder}
                          <span className="text-sm text-primary hover:underline">{file.name}</span>
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <h3 className="font-bold text-accent mb-3">Client Information</h3>
                    <div className="space-y-2 text-sm">
                      <p><span className="text-gray-500">Facility:</span> {viewingReport.clientFacilityName}</p>
                      <p><span className="text-gray-500">Customer:</span> {viewingReport.customerName || '-'}</p>
                      <p><span className="text-gray-500">Address:</span> {viewingReport.address || '-'}</p>
                      <p><span className="text-gray-500">Service Date:</span> {viewingReport.serviceCompletionDate || '-'}</p>
                      <p><span className="text-gray-500">Analyzer:</span> {viewingReport.analyzerModel || '-'} (S/N: {viewingReport.analyzerSerialNumber || '-'})</p>
                      <p><span className="text-gray-500">HubSpot Ticket:</span> {viewingReport.hubspotTicketNumber || '-'}</p>
                    </div>
                  </div>
                  <div>
                    <h3 className="font-bold text-accent mb-3">Service Details</h3>
                    <div className="space-y-2 text-sm">
                      <p><span className="text-gray-500">Service Type:</span> <span className="px-2 py-1 bg-green-100 text-green-700 rounded">{viewingReport.serviceType || '-'}</span></p>
                      <p><span className="text-gray-500">Technician:</span> {viewingReport.serviceProviderName || viewingReport.technicianName || (isAssigned ? 'Pending' : '-')}</p>
                    </div>
                  </div>
                </div>

                {/* Only show technician-provided details if submitted */}
                {!isAssigned && (
                  <>
                    {viewingReport.descriptionOfWork && (
                      <div>
                        <h3 className="font-bold text-accent mb-3">Work Performed</h3>
                        <p className="text-sm bg-gray-50 p-3 rounded-lg whitespace-pre-wrap">{viewingReport.descriptionOfWork}</p>
                      </div>
                    )}
                    {viewingReport.materialsUsed && (
                      <div>
                        <h3 className="font-bold text-accent mb-3">Materials Used</h3>
                        <p className="text-sm bg-gray-50 p-3 rounded-lg">{viewingReport.materialsUsed}</p>
                      </div>
                    )}
                    {viewingReport.solution && (
                      <div>
                        <h3 className="font-bold text-accent mb-3">Solution</h3>
                        <p className="text-sm bg-gray-50 p-3 rounded-lg whitespace-pre-wrap">{viewingReport.solution}</p>
                      </div>
                    )}
                    {viewingReport.outstandingIssues && (
                      <div>
                        <h3 className="font-bold text-accent mb-3">Outstanding Issues / Recommendations</h3>
                        <p className="text-sm bg-gray-50 p-3 rounded-lg whitespace-pre-wrap">{viewingReport.outstandingIssues}</p>
                      </div>
                    )}
                  </>
                )}

                {isAssigned && (
                  <div className="bg-gray-50 rounded-lg p-4 text-center text-gray-500">
                    <p>Technician details will appear here once the report is submitted.</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="bg-gradient-to-r from-green-600 to-green-800 text-white p-6 rounded-xl">
            <h1 className="text-2xl font-bold">Service Portal</h1>
            <p className="mt-1 opacity-90">Manage service reports and technician activities</p>
          </div>

          {/* Tabs */}
          <div className="bg-white rounded-xl shadow-sm">
            <div className="flex border-b flex-wrap">
              <button onClick={() => setActiveTab('reports')}
                className={`px-6 py-4 font-medium ${activeTab === 'reports' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-500 hover:text-gray-700'}`}>
                Service Reports ({reports.length})
              </button>
              <button onClick={() => setActiveTab('validation')}
                className={`px-6 py-4 font-medium ${activeTab === 'validation' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700'}`}>
                Validation Reports ({validationReports.length})
              </button>
              {canManageVendors && (
                <button onClick={() => setActiveTab('vendors')}
                  className={`px-6 py-4 font-medium ${activeTab === 'vendors' ? 'text-orange-600 border-b-2 border-orange-600' : 'text-gray-500 hover:text-gray-700'}`}>
                  Vendors ({vendors.length})
                </button>
              )}
            </div>

            {/* Reports Tab */}
            {activeTab === 'reports' && (
              <div className="p-6">
                <div className="flex flex-wrap items-end gap-3 mb-4">
                  <div className="flex-1 min-w-[200px]">
                    <input type="text" placeholder="Search by client, service type, or technician..." value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">Sort</label>
                    <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                      <option value="date_desc">Newest First</option>
                      <option value="date_asc">Oldest First</option>
                      <option value="client_asc">Client A-Z</option>
                      <option value="client_desc">Client Z-A</option>
                      <option value="type_asc">Service Type</option>
                      <option value="tech_asc">Technician</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">Status</label>
                    <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                      <option value="">All Statuses</option>
                      <option value="submitted">Complete</option>
                      <option value="assigned">Pending</option>
                      <option value="signature_needed">Signature Needed</option>
                    </select>
                  </div>
                </div>
                {loading ? (
                  <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-green-600 border-t-transparent"></div></div>
                ) : filteredReports.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Service Type</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Assigned To / Technician</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ticket #</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {filteredReports.map(report => (
                          <tr key={report.id} className="hover:bg-gray-50">
                            <td className="px-4 py-3">
                              {report.status === 'assigned' ? (
                                <span className="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded font-medium">Pending</span>
                              ) : report.status === 'signature_needed' ? (
                                <span className="px-2 py-1 text-xs bg-orange-100 text-orange-700 rounded font-medium">Signature Needed</span>
                              ) : (
                                <span className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded font-medium">Complete</span>
                              )}
                            </td>
                            <td className="px-4 py-3 text-sm">{new Date(report.serviceCompletionDate || report.createdAt).toLocaleDateString()}</td>
                            <td className="px-4 py-3">
                              <div className="font-medium text-gray-900">{report.clientFacilityName}</div>
                            </td>
                            <td className="px-4 py-3"><span className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded">{report.serviceType || '-'}</span></td>
                            <td className="px-4 py-3 text-sm">
                              {report.status === 'assigned' ? (
                                <span className="text-yellow-700">{report.assignedToName}</span>
                              ) : (
                                report.serviceProviderName || report.technicianName || '-'
                              )}
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-500">{report.hubspotTicketNumber || '-'}</td>
                            <td className="px-4 py-3">
                              <button onClick={() => setViewingReport(report)} className="flex items-center gap-1 text-green-600 hover:text-green-800">
                                {Icons.eye} View
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500"><p>No service reports found</p></div>
                )}
              </div>
            )}

            {/* Validation Reports Tab */}
            {activeTab === 'validation' && (
              <div className="p-6">
                <div className="mb-4">
                  <input type="text" placeholder="Search validation reports..." value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" />
                </div>
                <p className="text-sm text-gray-500 mb-4">Showing validation reports submitted by service technicians and vendors</p>
                {loading ? (
                  <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-purple-600 border-t-transparent"></div></div>
                ) : validationReports.filter(r => r.clientFacilityName?.toLowerCase().includes(searchTerm.toLowerCase())).length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Days On-Site</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Analyzers</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Technician</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {validationReports.filter(r => r.clientFacilityName?.toLowerCase().includes(searchTerm.toLowerCase())).map(report => {
                          // Handle both service-based validations and dedicated validation reports
                          const startDate = report.validationStartDate || report.startDate;
                          const endDate = report.validationEndDate || report.endDate;
                          const daysOnSite = report.isServiceReport && startDate && endDate
                            ? Math.ceil(Math.abs(new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1
                            : report.daysOnSite || 1;
                          return (
                            <tr key={report.id} className="hover:bg-gray-50">
                              <td className="px-4 py-3 text-sm">
                                {startDate && endDate
                                  ? `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`
                                  : new Date(report.createdAt).toLocaleDateString()}
                              </td>
                              <td className="px-4 py-3 font-medium text-gray-900">{report.clientFacilityName}</td>
                              <td className="px-4 py-3 text-sm">{daysOnSite} days</td>
                              <td className="px-4 py-3 text-sm">{report.analyzersValidated?.length || 0} units</td>
                              <td className="px-4 py-3 text-sm">{report.serviceProviderName || report.technicianName}</td>
                              <td className="px-4 py-3">
                                <button onClick={() => setViewingValidation(report)} className="flex items-center gap-1 text-purple-600 hover:text-purple-800">
                                  {Icons.eye} View
                                </button>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p>No validation reports found</p>
                    <p className="text-sm mt-2">Validation reports are submitted by service technicians through the Service Portal</p>
                  </div>
                )}
              </div>
            )}

            {/* Vendors Tab */}
            {activeTab === 'vendors' && canManageVendors && (
              <div className="p-6">
                <div className="flex justify-between items-center mb-6">
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">External Vendors</h3>
                    <p className="text-sm text-gray-500">Manage service vendors and their client assignments</p>
                  </div>
                  <button onClick={() => { setEditingVendor(null); setVendorFormData({ name: '', email: '', password: '', assignedClients: [] }); setShowVendorForm(true); }}
                    className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center gap-2">
                    {Icons.plus} Add Vendor
                  </button>
                </div>

                {/* Vendor Form Modal */}
                {showVendorForm && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                      <div className="p-6 border-b flex justify-between items-center">
                        <h3 className="text-xl font-bold">{editingVendor ? 'Edit Vendor' : 'Add New Vendor'}</h3>
                        <button onClick={() => { setShowVendorForm(false); setEditingVendor(null); }} className="text-gray-400 hover:text-gray-600">{Icons.close}</button>
                      </div>
                      <form onSubmit={handleVendorSubmit} className="p-6 space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                          <input type="text" value={vendorFormData.name} onChange={(e) => setVendorFormData({...vendorFormData, name: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" required />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                          <input type="email" value={vendorFormData.email} onChange={(e) => setVendorFormData({...vendorFormData, email: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" required />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Password {editingVendor ? '(leave blank to keep)' : '*'}</label>
                          <input type="password" value={vendorFormData.password} onChange={(e) => setVendorFormData({...vendorFormData, password: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" {...(!editingVendor && { required: true })} />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Assigned Clients</label>
                          <p className="text-xs text-gray-500 mb-2">Vendors can submit service reports and view reports for their assigned clients</p>
                          <div className="max-h-48 overflow-y-auto border rounded-lg p-2 space-y-2">
                            {allClients.length > 0 ? allClients.map((client, idx) => {
                              const clientName = client.name || client.clientName;
                              const isAssigned = (vendorFormData.assignedClients || []).includes(clientName);
                              return (
                                <div key={idx} className={`flex items-center p-2 rounded ${isAssigned ? 'bg-orange-50' : 'bg-gray-50'}`}>
                                  <label className="flex items-center gap-2 cursor-pointer flex-1">
                                    <input type="checkbox" checked={isAssigned}
                                      onChange={() => {
                                        const current = vendorFormData.assignedClients || [];
                                        setVendorFormData({
                                          ...vendorFormData,
                                          assignedClients: isAssigned
                                            ? current.filter(c => c !== clientName)
                                            : [...current, clientName]
                                        });
                                      }}
                                      className="w-4 h-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500" />
                                    <span className="text-sm">{clientName}</span>
                                  </label>
                                </div>
                              );
                            }) : <p className="text-sm text-gray-500 text-center py-4">No clients available</p>}
                          </div>
                        </div>
                        <div className="flex gap-3 pt-4">
                          <button type="button" onClick={() => { setShowVendorForm(false); setEditingVendor(null); }}
                            className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                          <button type="submit" disabled={vendorSaving}
                            className="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50">
                            {vendorSaving ? 'Saving...' : (editingVendor ? 'Update Vendor' : 'Create Vendor')}
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                )}

                {/* Vendors List */}
                {vendors.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Vendor</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Assigned Clients</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {vendors.map(vendor => (
                          <tr key={vendor.id} className="hover:bg-gray-50">
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-sm font-medium">
                                  {(vendor.name || 'V').charAt(0).toUpperCase()}
                                </div>
                                <span className="font-medium text-gray-900">{vendor.name}</span>
                              </div>
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-600">{vendor.email}</td>
                            <td className="px-4 py-3">
                              {vendor.assignedClients?.length > 0 ? (
                                <div className="flex flex-wrap gap-1">
                                  {vendor.assignedClients.slice(0, 3).map((c, i) => (
                                    <span key={i} className="px-2 py-0.5 bg-orange-50 text-orange-700 text-xs rounded">{c}</span>
                                  ))}
                                  {vendor.assignedClients.length > 3 && (
                                    <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">+{vendor.assignedClients.length - 3} more</span>
                                  )}
                                </div>
                              ) : (
                                <span className="text-sm text-gray-400">No clients assigned</span>
                              )}
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex gap-2">
                                <button onClick={() => handleEditVendor(vendor)} className="p-1 text-orange-600 hover:bg-orange-50 rounded" title="Edit">{Icons.edit}</button>
                                <button onClick={() => handleDeleteVendor(vendor.id)} className="p-1 text-red-600 hover:bg-red-50 rounded" title="Delete">{Icons.trash}</button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p>No external vendors yet</p>
                    <p className="text-sm mt-2">Click "Add Vendor" to create your first vendor account</p>
                  </div>
                )}
              </div>
            )}

          </div>
        </div>
      );
    };

    // Full Client Portal Page (embedded admin view)
    const ClientPortalPage = ({ token }) => {
      const [activeTab, setActiveTab] = useState('settings');
      const [settings, setSettings] = useState({ portalName: '', welcomeMessage: '', primaryColor: '#045E9F' });
      const [announcements, setAnnouncements] = useState([]);
      const [clientUsers, setClientUsers] = useState([]);
      const [inventoryReports, setInventoryReports] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [newAnnouncement, setNewAnnouncement] = useState({ title: '', content: '', type: 'info' });

      useEffect(() => {
        loadData();
      }, [token]);

      const loadData = async () => {
        setLoading(true);
        const [settingsData, announcementsData, usersData, reportsData] = await Promise.all([
          api.getPortalSettings(),
          api.getAnnouncements(),
          api.getUsers(token),
          api.getInventoryReports(token)
        ]);
        if (!settingsData.error) setSettings(settingsData);
        if (!announcementsData.error) setAnnouncements(announcementsData);
        if (!usersData.error) setClientUsers(usersData.filter(u => u.role === 'client'));
        if (!reportsData.error) setInventoryReports(Array.isArray(reportsData) ? reportsData : []);
        setLoading(false);
      };

      const handleSaveSettings = async () => {
        setSaving(true);
        await api.updatePortalSettings(token, settings);
        setSaving(false);
      };

      const handleCreateAnnouncement = async (e) => {
        e.preventDefault();
        if (!newAnnouncement.title || !newAnnouncement.content) return;
        await api.createAnnouncement(token, newAnnouncement);
        setNewAnnouncement({ title: '', content: '', type: 'info' });
        loadData();
      };

      const handleDeleteAnnouncement = async (id) => {
        if (!confirm('Delete this announcement?')) return;
        await api.deleteAnnouncement(token, id);
        loadData();
      };

      if (loading) {
        return (
          <div className="flex justify-center py-12">
            <div className="animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-xl">
            <h1 className="text-2xl font-bold">Client Portal Management</h1>
            <p className="mt-1 opacity-90">Configure portal settings, announcements, and manage client access</p>
          </div>

          {/* Tabs */}
          <div className="bg-white rounded-xl shadow-sm">
            <div className="flex border-b overflow-x-auto">
              <button onClick={() => setActiveTab('settings')}
                className={`px-6 py-4 font-medium whitespace-nowrap ${activeTab === 'settings' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
                Portal Settings
              </button>
              <button onClick={() => setActiveTab('announcements')}
                className={`px-6 py-4 font-medium whitespace-nowrap ${activeTab === 'announcements' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
                Announcements ({announcements.length})
              </button>
              <button onClick={() => setActiveTab('clients')}
                className={`px-6 py-4 font-medium whitespace-nowrap ${activeTab === 'clients' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
                Client Users ({clientUsers.length})
              </button>
              <button onClick={() => setActiveTab('inventory')}
                className={`px-6 py-4 font-medium whitespace-nowrap ${activeTab === 'inventory' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
                Inventory Reports
              </button>
            </div>

            {/* Settings Tab */}
            {activeTab === 'settings' && (
              <div className="p-6 space-y-6">
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Portal Name</label>
                    <input type="text" value={settings.portalName || ''} onChange={(e) => setSettings({...settings, portalName: e.target.value})}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Client Portal" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Primary Color</label>
                    <div className="flex gap-2">
                      <input type="color" value={settings.primaryColor || '#045E9F'} onChange={(e) => setSettings({...settings, primaryColor: e.target.value})}
                        className="w-12 h-10 border rounded cursor-pointer" />
                      <input type="text" value={settings.primaryColor || '#045E9F'} onChange={(e) => setSettings({...settings, primaryColor: e.target.value})}
                        className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                    </div>
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Welcome Message</label>
                    <textarea value={settings.welcomeMessage || ''} onChange={(e) => setSettings({...settings, welcomeMessage: e.target.value})}
                      rows={3} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Welcome to your client portal..." />
                  </div>
                </div>
                <div className="flex justify-end">
                  <button onClick={handleSaveSettings} disabled={saving}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                    {saving ? 'Saving...' : 'Save Settings'}
                  </button>
                </div>
              </div>
            )}

            {/* Announcements Tab */}
            {activeTab === 'announcements' && (
              <div className="p-6 space-y-6">
                <form onSubmit={handleCreateAnnouncement} className="bg-gray-50 p-4 rounded-lg space-y-4">
                  <h3 className="font-medium text-gray-800">Create New Announcement</h3>
                  <div className="grid md:grid-cols-2 gap-4">
                    <input type="text" value={newAnnouncement.title} onChange={(e) => setNewAnnouncement({...newAnnouncement, title: e.target.value})}
                      className="px-4 py-2 border rounded-lg" placeholder="Title" required />
                    <select value={newAnnouncement.type} onChange={(e) => setNewAnnouncement({...newAnnouncement, type: e.target.value})}
                      className="px-4 py-2 border rounded-lg">
                      <option value="info">Info (Blue)</option>
                      <option value="success">Success (Green)</option>
                      <option value="warning">Warning (Yellow)</option>
                    </select>
                  </div>
                  <textarea value={newAnnouncement.content} onChange={(e) => setNewAnnouncement({...newAnnouncement, content: e.target.value})}
                    className="w-full px-4 py-2 border rounded-lg" rows={2} placeholder="Announcement content..." required />
                  <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Create Announcement
                  </button>
                </form>
                <div className="space-y-3">
                  {announcements.length > 0 ? announcements.map(ann => (
                    <div key={ann.id} className={`p-4 rounded-lg border-l-4 flex justify-between items-start ${
                      ann.type === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                      ann.type === 'success' ? 'border-green-500 bg-green-50' : 'border-blue-500 bg-blue-50'
                    }`}>
                      <div>
                        <h4 className="font-semibold text-gray-800">{ann.title}</h4>
                        <p className="text-sm text-gray-600 mt-1">{ann.content}</p>
                        <p className="text-xs text-gray-400 mt-2">{new Date(ann.createdAt).toLocaleDateString()}</p>
                      </div>
                      <button onClick={() => handleDeleteAnnouncement(ann.id)} className="text-red-600 hover:text-red-800 p-1">
                        {Icons.trash}
                      </button>
                    </div>
                  )) : <p className="text-gray-500 text-center py-8">No announcements yet</p>}
                </div>
              </div>
            )}

            {/* Clients Tab */}
            {activeTab === 'clients' && (
              <div className="p-6">
                {clientUsers.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Practice</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Portal URL</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Projects</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {clientUsers.map(client => (
                          <tr key={client.id} className="hover:bg-gray-50">
                            <td className="px-4 py-3">
                              <div className="flex items-center gap-3">
                                {client.logo && <img src={client.logo} alt="" className="h-8 w-8 rounded object-contain bg-gray-100" />}
                                <span className="font-medium text-gray-900">{client.name}</span>
                              </div>
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-600">{client.practiceName || '-'}</td>
                            <td className="px-4 py-3 text-sm text-gray-600">{client.email}</td>
                            <td className="px-4 py-3 text-sm">
                              {client.slug ? (
                                <a href={`/portal/${client.slug}`} target="_blank" className="text-blue-600 hover:underline">/portal/{client.slug}</a>
                              ) : '-'}
                            </td>
                            <td className="px-4 py-3 text-sm text-gray-600">{client.assignedProjects?.length || 0}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p>No client users found</p>
                    <p className="text-sm mt-2">Create client users in User Management</p>
                  </div>
                )}
              </div>
            )}

            {/* Inventory Reports Tab */}
            {activeTab === 'inventory' && (
              <div className="p-6">
                {inventoryReports.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Items</th>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {inventoryReports.map((report, idx) => (
                          <tr key={idx} className="hover:bg-gray-50">
                            <td className="px-4 py-3 text-sm">{new Date(report.submittedAt || report.createdAt).toLocaleDateString()}</td>
                            <td className="px-4 py-3 font-medium text-gray-900">{report.clientName || report.practiceName || 'Unknown'}</td>
                            <td className="px-4 py-3 text-sm">{report.items?.length || report.itemCount || 0} items</td>
                            <td className="px-4 py-3">
                              <span className="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Submitted</span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p>No inventory reports submitted yet</p>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };

    // Knowledge Hub Admin Page
    const KnowledgeHubPage = ({ token }) => {
      const [guides, setGuides] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedGuide, setSelectedGuide] = useState(null);
      const [editingArticle, setEditingArticle] = useState(null);
      const [showGuideForm, setShowGuideForm] = useState(false);
      const [showArticleForm, setShowArticleForm] = useState(false);
      const [saving, setSaving] = useState(false);
      const [guideForm, setGuideForm] = useState({ key: '', title: '', description: '', color: 'bg-gray-500', ownerOnly: false, adminOnly: false, visibleTo: [], portalSection: 'general', isKnownIssue: false });
      const [articleForm, setArticleForm] = useState({ title: '', content: '' });

      const tierOptions = [
        { value: 'super_admin', label: 'Super Admin' },
        { value: 'manager', label: 'Manager' },
        { value: 'team_member', label: 'Team Member' },
        { value: 'vendor', label: 'Vendor Technician' },
        { value: 'client', label: 'Client' }
      ];

      const portalSectionOptions = [
        { value: 'general', label: 'General' },
        { value: 'admin_hub', label: 'Admin Hub' },
        { value: 'launch_portal', label: 'Implementations' },
        { value: 'service_portal', label: 'Service Portal' },
        { value: 'client_portal', label: 'Client Portal' },
        { value: 'client_portal_admin', label: 'Client Portal Admin' }
      ];

      const colorOptions = [
        { value: 'bg-primary-500', label: 'Blue' },
        { value: 'bg-emerald-600', label: 'Green' },
        { value: 'bg-purple-600', label: 'Purple' },
        { value: 'bg-amber-500', label: 'Amber' },
        { value: 'bg-rose-500', label: 'Rose' },
        { value: 'bg-teal-500', label: 'Teal' },
        { value: 'bg-indigo-600', label: 'Indigo' },
        { value: 'bg-gray-500', label: 'Gray' }
      ];

      const loadGuides = async () => {
        setLoading(true);
        try {
          const response = await fetch('/api/knowledge/guides', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          if (Array.isArray(data)) setGuides(data);
        } catch (error) {
          console.error('Error loading guides:', error);
        }
        setLoading(false);
      };

      useEffect(() => { loadGuides(); }, [token]);

      const handleSaveGuide = async (e) => {
        e.preventDefault();
        setSaving(true);
        try {
          const url = selectedGuide ? `/api/knowledge/guides/${selectedGuide.id}` : '/api/knowledge/guides';
          const method = selectedGuide ? 'PUT' : 'POST';
          await fetch(url, {
            method,
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(guideForm)
          });
          loadGuides();
          setShowGuideForm(false);
          setSelectedGuide(null);
          setGuideForm({ key: '', title: '', description: '', color: 'bg-gray-500', ownerOnly: false, adminOnly: false, visibleTo: [], portalSection: 'general', isKnownIssue: false });
        } catch (error) {
          console.error('Error saving guide:', error);
        }
        setSaving(false);
      };

      const handleDeleteGuide = async (guideId) => {
        if (!confirm('Delete this guide and all its articles?')) return;
        await fetch(`/api/knowledge/guides/${guideId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        loadGuides();
        if (selectedGuide?.id === guideId) setSelectedGuide(null);
      };

      const handleSaveArticle = async (e) => {
        e.preventDefault();
        if (!selectedGuide) return;
        setSaving(true);
        try {
          const url = editingArticle
            ? `/api/knowledge/guides/${selectedGuide.id}/articles/${editingArticle.id}`
            : `/api/knowledge/guides/${selectedGuide.id}/articles`;
          const method = editingArticle ? 'PUT' : 'POST';
          await fetch(url, {
            method,
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(articleForm)
          });
          loadGuides();
          setShowArticleForm(false);
          setEditingArticle(null);
          setArticleForm({ title: '', content: '' });
        } catch (error) {
          console.error('Error saving article:', error);
        }
        setSaving(false);
      };

      const handleDeleteArticle = async (articleId) => {
        if (!confirm('Delete this article?')) return;
        await fetch(`/api/knowledge/guides/${selectedGuide.id}/articles/${articleId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        loadGuides();
      };

      const openEditGuide = (guide) => {
        setGuideForm({
          key: guide.key,
          title: guide.title,
          description: guide.description || '',
          color: guide.color || 'bg-gray-500',
          ownerOnly: guide.ownerOnly || false,
          adminOnly: guide.adminOnly || false,
          visibleTo: guide.visibleTo || [],
          portalSection: guide.portalSection || 'general',
          isKnownIssue: guide.isKnownIssue || false
        });
        setSelectedGuide(guide);
        setShowGuideForm(true);
      };

      const openEditArticle = (article) => {
        setArticleForm({ title: article.title, content: article.content });
        setEditingArticle(article);
        setShowArticleForm(true);
      };

      // Get the current guide data (after reload)
      const currentGuide = guides.find(g => g.id === selectedGuide?.id);

      if (loading) return (
        <div className="flex items-center justify-center py-20">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-teal-500 border-t-transparent"></div>
        </div>
      );

      return (
        <div className="max-w-7xl mx-auto">
          <div className="flex justify-between items-center mb-6">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Knowledge Hub Management</h1>
              <p className="text-gray-500 mt-1">Manage guides and articles for the Knowledge Hub</p>
            </div>
            <button onClick={() => { setShowGuideForm(true); setSelectedGuide(null); setGuideForm({ key: '', title: '', description: '', color: 'bg-gray-500', ownerOnly: false, adminOnly: false }); }}
              className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 flex items-center gap-2">
              {Icons.plus} New Guide
            </button>
          </div>

          <div className="grid lg:grid-cols-3 gap-6">
            {/* Guides List */}
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
              <h2 className="font-semibold text-gray-800 mb-4">Guides ({guides.length})</h2>
              <div className="space-y-2">
                {guides.map(guide => (
                  <div key={guide.id}
                    onClick={() => setSelectedGuide(guide)}
                    className={`p-3 rounded-lg border cursor-pointer transition ${selectedGuide?.id === guide.id ? 'border-teal-500 bg-teal-50' : 'border-gray-200 hover:border-gray-300'}`}>
                    <div className="flex items-center gap-3">
                      <div className={`w-3 h-3 rounded-full ${guide.color}`}></div>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-gray-800 truncate">{guide.title}</p>
                        <p className="text-xs text-gray-500">{guide.articles?.length || 0} articles</p>
                      </div>
                      <div className="flex gap-1 flex-wrap">
                        {guide.isKnownIssue && <span className="px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded">Issues</span>}
                        {guide.ownerOnly && <span className="px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded">Owner</span>}
                        {guide.adminOnly && <span className="px-1.5 py-0.5 bg-purple-100 text-purple-600 text-xs rounded">Admin</span>}
                        {guide.portalSection && guide.portalSection !== 'general' && <span className="px-1.5 py-0.5 bg-blue-100 text-blue-600 text-xs rounded">{guide.portalSection.replace(/_/g, ' ')}</span>}
                      </div>
                    </div>
                  </div>
                ))}
                {guides.length === 0 && (
                  <p className="text-center text-gray-400 py-8">No guides yet. Create one to get started.</p>
                )}
              </div>
            </div>

            {/* Articles Panel */}
            <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-4">
              {currentGuide ? (
                <>
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <h2 className="font-semibold text-gray-800">{currentGuide.title}</h2>
                      <p className="text-sm text-gray-500">{currentGuide.description}</p>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => openEditGuide(currentGuide)} className="p-2 text-gray-500 hover:text-teal-600 hover:bg-teal-50 rounded-lg">{Icons.edit}</button>
                      <button onClick={() => handleDeleteGuide(currentGuide.id)} className="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg">{Icons.trash}</button>
                    </div>
                  </div>
                  <div className="flex justify-between items-center mb-3">
                    <h3 className="text-sm font-medium text-gray-600">Articles</h3>
                    <button onClick={() => { setShowArticleForm(true); setEditingArticle(null); setArticleForm({ title: '', content: '' }); }}
                      className="px-3 py-1.5 bg-teal-600 text-white text-sm rounded-lg hover:bg-teal-700 flex items-center gap-1">
                      {Icons.plus} Add Article
                    </button>
                  </div>
                  <div className="space-y-2 max-h-[500px] overflow-y-auto">
                    {(currentGuide.articles || []).map((article, idx) => (
                      <div key={article.id} className="p-3 border border-gray-200 rounded-lg hover:border-gray-300 group">
                        <div className="flex justify-between items-start">
                          <div className="flex-1 min-w-0">
                            <p className="font-medium text-gray-800">{idx + 1}. {article.title}</p>
                            <p className="text-xs text-gray-400 mt-1">Updated: {new Date(article.updatedAt).toLocaleDateString()}</p>
                          </div>
                          <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onClick={() => openEditArticle(article)} className="p-1.5 text-gray-400 hover:text-teal-600 hover:bg-teal-50 rounded">{Icons.edit}</button>
                            <button onClick={() => handleDeleteArticle(article.id)} className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded">{Icons.trash}</button>
                          </div>
                        </div>
                      </div>
                    ))}
                    {(!currentGuide.articles || currentGuide.articles.length === 0) && (
                      <p className="text-center text-gray-400 py-8">No articles yet. Add one to get started.</p>
                    )}
                  </div>
                </>
              ) : (
                <div className="flex flex-col items-center justify-center py-16 text-gray-400">
                  <svg className="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
                  <p>Select a guide to manage its articles</p>
                </div>
              )}
            </div>
          </div>

          {/* Guide Form Modal */}
          {showGuideForm && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-xl max-w-md w-full">
                <div className="p-4 border-b flex justify-between items-center">
                  <h3 className="text-lg font-bold">{selectedGuide ? 'Edit Guide' : 'New Guide'}</h3>
                  <button onClick={() => setShowGuideForm(false)} className="text-gray-400 hover:text-gray-600">{Icons.close}</button>
                </div>
                <form onSubmit={handleSaveGuide} className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Key (URL-friendly)</label>
                    <input type="text" value={guideForm.key} onChange={(e) => setGuideForm({...guideForm, key: e.target.value.toLowerCase().replace(/\s+/g, '-')})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" required disabled={!!selectedGuide} placeholder="e.g., service-portal" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" value={guideForm.title} onChange={(e) => setGuideForm({...guideForm, title: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" required placeholder="e.g., Service Portal" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <input type="text" value={guideForm.description} onChange={(e) => setGuideForm({...guideForm, description: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="Brief description" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Color</label>
                    <select value={guideForm.color} onChange={(e) => setGuideForm({...guideForm, color: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500">
                      {colorOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Portal Section</label>
                    <select value={guideForm.portalSection} onChange={(e) => setGuideForm({...guideForm, portalSection: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500">
                      {portalSectionOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Visible To (leave all unchecked for everyone)</label>
                    <div className="grid grid-cols-2 gap-2">
                      {tierOptions.map(tier => (
                        <label key={tier.value} className="flex items-center gap-2">
                          <input type="checkbox"
                            checked={(guideForm.visibleTo || []).includes(tier.value)}
                            onChange={(e) => {
                              const current = guideForm.visibleTo || [];
                              setGuideForm({...guideForm, visibleTo: e.target.checked ? [...current, tier.value] : current.filter(t => t !== tier.value)});
                            }} className="rounded" />
                          <span className="text-sm">{tier.label}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                  <div className="flex gap-4">
                    <label className="flex items-center gap-2">
                      <input type="checkbox" checked={guideForm.isKnownIssue} onChange={(e) => setGuideForm({...guideForm, isKnownIssue: e.target.checked})} className="rounded" />
                      <span className="text-sm">Known Issue (internal only)</span>
                    </label>
                    <label className="flex items-center gap-2">
                      <input type="checkbox" checked={guideForm.adminOnly} onChange={(e) => setGuideForm({...guideForm, adminOnly: e.target.checked})} className="rounded" />
                      <span className="text-sm text-gray-500">Legacy: Admin Only</span>
                    </label>
                  </div>
                  <div className="flex gap-3 pt-2">
                    <button type="button" onClick={() => setShowGuideForm(false)} className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" disabled={saving} className="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-50">
                      {saving ? 'Saving...' : 'Save Guide'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Article Form Modal */}
          {showArticleForm && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div className="p-4 border-b flex justify-between items-center flex-shrink-0">
                  <h3 className="text-lg font-bold">{editingArticle ? 'Edit Article' : 'New Article'}</h3>
                  <button onClick={() => setShowArticleForm(false)} className="text-gray-400 hover:text-gray-600">{Icons.close}</button>
                </div>
                <form onSubmit={handleSaveArticle} className="p-4 space-y-4 overflow-y-auto flex-1">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" value={articleForm.title} onChange={(e) => setArticleForm({...articleForm, title: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" required placeholder="Article title" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Content (Markdown-style formatting supported)</label>
                    <textarea value={articleForm.content} onChange={(e) => setArticleForm({...articleForm, content: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500 font-mono text-sm" rows="20" required
                      placeholder="Article content. Use **bold** for headers, - for bullets, 1. for numbered lists." />
                    <p className="text-xs text-gray-500 mt-1">Tip: **text** = bold header, - item = bullet, 1. item = numbered list</p>
                  </div>
                  <div className="flex gap-3 pt-2">
                    <button type="button" onClick={() => setShowArticleForm(false)} className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" disabled={saving} className="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-50">
                      {saving ? 'Saving...' : 'Save Article'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ===== NOTIFICATIONS PAGE =====
    const NotificationsPage = ({ token }) => {
      const [stats, setStats] = useState(null);
      const [queue, setQueue] = useState([]);
      const [log, setLog] = useState([]);
      const [activeTab, setActiveTab] = useState('overview');
      const [notifSettings, setNotifSettings] = useState(null);
      const [reminderSettings, setReminderSettings] = useState(null);
      const [loading, setLoading] = useState(true);
      const [selectedIds, setSelectedIds] = useState(new Set());

      // Email template state
      const [emailTemplates, setEmailTemplates] = useState([]);
      const [editingTemplate, setEditingTemplate] = useState(null);
      const [editForm, setEditForm] = useState({ subject: '', body: '', htmlBody: '' });
      const [templatePreview, setTemplatePreview] = useState(null);
      const [templateSaving, setTemplateSaving] = useState(false);
      const [templateTestSending, setTemplateTestSending] = useState(false);
      const [collapsedPools, setCollapsedPools] = useState({});

      const togglePoolCollapse = (poolName) => {
        setCollapsedPools(prev => ({ ...prev, [poolName]: !prev[poolName] }));
      };

      const API_URL = window.location.origin;
      const apiFetch = (url, opts = {}) =>
        fetch(`${API_URL}${url}`, { ...opts, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...opts.headers } }).then(r => r.json());

      const loadData = async () => {
        setLoading(true);
        try {
          const results = await Promise.allSettled([
            apiFetch('/api/admin/notifications/stats'),
            apiFetch('/api/admin/notifications/queue'),
            apiFetch('/api/admin/notifications/log?limit=50'),
            apiFetch('/api/admin/notification-settings'),
            apiFetch('/api/admin/reminder-settings'),
            apiFetch('/api/admin/email-templates'),
          ]);
          const val = (i) => results[i].status === 'fulfilled' ? results[i].value : null;
          const s = val(0), q = val(1), l = val(2), ns = val(3), rs = val(4), et = val(5);
          if (s && !s.error) setStats(s);
          if (Array.isArray(q)) setQueue(q);
          if (Array.isArray(l)) setLog(l);
          if (ns && !ns.error) setNotifSettings(ns);
          if (rs && !rs.error) setReminderSettings(rs);
          if (Array.isArray(et)) setEmailTemplates(et);
        } catch (e) { console.error('Load notifications error:', e); }
        setLoading(false);
      };

      React.useEffect(() => { loadData(); }, []);

      const handleCancel = async (id) => {
        await apiFetch(`/api/admin/notifications/cancel/${id}`, { method: 'POST' });
        loadData();
      };
      const handleRetry = async (id) => {
        await apiFetch(`/api/admin/notifications/retry/${id}`, { method: 'POST' });
        loadData();
      };
      const handleProcessQueue = async () => {
        await apiFetch('/api/admin/notifications/process', { method: 'POST' });
        loadData();
      };
      const handleTriggerScan = async () => {
        await apiFetch('/api/admin/reminders/trigger', { method: 'POST' });
        loadData();
      };
      const handleToggleNotifications = async (enabled) => {
        await apiFetch('/api/admin/notification-settings', { method: 'PUT', body: JSON.stringify({ enabled }) });
        loadData();
      };
      const handleToggleReminders = async (enabled) => {
        await apiFetch('/api/admin/reminder-settings', { method: 'PUT', body: JSON.stringify({ enabled }) });
        loadData();
      };
      const handleToggleScenario = async (scenario, enabled) => {
        const scenarios = { ...(reminderSettings?.scenarios || {}), [scenario]: { ...(reminderSettings?.scenarios?.[scenario] || {}), enabled } };
        await apiFetch('/api/admin/reminder-settings', { method: 'PUT', body: JSON.stringify({ scenarios }) });
        loadData();
      };
      const toggleSelect = (id) => {
        setSelectedIds(prev => { const next = new Set(prev); next.has(id) ? next.delete(id) : next.add(id); return next; });
      };
      const toggleSelectAll = () => {
        const queueIds = queue.map(n => n.id);
        setSelectedIds(prev => prev.size === queueIds.length ? new Set() : new Set(queueIds));
      };
      const handleBulkDelete = async () => {
        if (selectedIds.size === 0) return;
        if (!confirm(`Remove ${selectedIds.size} notification(s) from the queue? This cannot be undone.`)) return;
        await apiFetch('/api/admin/notifications/bulk-delete', { method: 'POST', body: JSON.stringify({ ids: [...selectedIds] }) });
        setSelectedIds(new Set());
        loadData();
      };

      // Email template handlers
      const handleEditTemplate = (template) => {
        setEditingTemplate(template);
        setEditForm({ subject: template.subject, body: template.body, htmlBody: template.htmlBody || '' });
        setTemplatePreview(null);
        setCollapsedPools({});
      };

      const handleCancelEdit = () => {
        setEditingTemplate(null);
        setEditForm({ subject: '', body: '', htmlBody: '' });
        setTemplatePreview(null);
        setCollapsedPools({});
      };

      const handleSaveTemplate = async () => {
        if (!editingTemplate) return;
        setTemplateSaving(true);
        try {
          const result = await apiFetch(`/api/admin/email-templates/${editingTemplate.id}`, {
            method: 'PUT',
            body: JSON.stringify({ subject: editForm.subject, body: editForm.body, htmlBody: editForm.htmlBody || null })
          });
          if (result.error) { alert(result.error); return; }
          setEditingTemplate(null);
          setEditForm({ subject: '', body: '', htmlBody: '' });
          setTemplatePreview(null);
          loadData();
        } catch (e) { alert('Failed to save template'); }
        setTemplateSaving(false);
      };

      const handleResetTemplate = async (templateId) => {
        if (!confirm('Reset this template to its default? Your customizations will be lost.')) return;
        const result = await apiFetch(`/api/admin/email-templates/${templateId}/reset`, { method: 'POST' });
        if (result.error) { alert(result.error); return; }
        if (editingTemplate && editingTemplate.id === templateId) {
          setEditingTemplate(result);
          setEditForm({ subject: result.subject, body: result.body, htmlBody: result.htmlBody || '' });
        }
        loadData();
      };

      const handlePreviewTemplate = async () => {
        if (!editingTemplate) return;
        // Client-side preview using example data
        const vars = {};
        (editingTemplate.variables || []).forEach(v => { vars[v.key] = v.example || `[${v.label}]`; });
        const preview = {
          subject: editForm.subject.replace(/\{\{(\w+)\}\}/g, (m, k) => vars[k] !== undefined ? vars[k] : m),
          body: editForm.body.replace(/\{\{(\w+)\}\}/g, (m, k) => vars[k] !== undefined ? vars[k] : m),
        };
        // Fetch server-rendered HTML preview
        const serverPreview = await apiFetch(`/api/admin/email-templates/${editingTemplate.id}/preview`, {
          method: 'POST', body: JSON.stringify({ variables: {} })
        });
        preview.html = serverPreview.html || '';
        setTemplatePreview(preview);
      };

      const handleTestSendTemplate = async () => {
        if (!editingTemplate) return;
        setTemplateTestSending(true);
        try {
          // Save first so the test uses latest content
          await apiFetch(`/api/admin/email-templates/${editingTemplate.id}`, {
            method: 'PUT',
            body: JSON.stringify({ subject: editForm.subject, body: editForm.body, htmlBody: editForm.htmlBody || null })
          });
          const result = await apiFetch(`/api/admin/email-templates/${editingTemplate.id}/test-send`, { method: 'POST' });
          if (result.error) alert(result.error);
          else alert(result.message || 'Test email sent!');
        } catch (e) { alert('Failed to send test email'); }
        setTemplateTestSending(false);
      };

      const handleInsertVariable = (varKey, field) => {
        const tag = `{{${varKey}}}`;
        setEditForm(prev => ({ ...prev, [field]: prev[field] + tag }));
      };

      const typeLabels = {
        service_report_signature: 'Service Report Signature',
        service_report_review: 'Service Report Review',
        task_deadline: 'Task Deadline',
        task_overdue: 'Task Overdue',
        inventory_reminder: 'Inventory Reminder',
        milestone_reached: 'Milestone Reached',
        milestone_reminder: 'Go-Live Reminder',
        custom_email: 'Custom Email',
        announcement_nudge: 'Announcement'
      };
      const statusColors = {
        pending: 'bg-yellow-100 text-yellow-800',
        sent: 'bg-green-100 text-green-800',
        failed: 'bg-red-100 text-red-800',
        cancelled: 'bg-gray-100 text-gray-600'
      };

      if (loading) return <div className="flex justify-center py-12"><div className="w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div></div>;

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold text-accent mb-1">Notification Center</h1>
              <p className="text-gray-500 text-sm">Email queue, delivery history, and automated reminder settings</p>
            </div>
            <div className="flex gap-2">
              <button onClick={handleTriggerScan} className="px-3 py-1.5 text-sm bg-amber-500 text-white rounded-lg hover:bg-amber-600">Run Scan</button>
              <button onClick={handleProcessQueue} className="px-3 py-1.5 text-sm bg-primary-500 text-white rounded-lg hover:bg-primary-700">Process Queue</button>
            </div>
          </div>

          {/* Stats Cards */}
          {stats && (
            <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-400">
                <p className="text-2xl font-bold">{stats.pending}</p><p className="text-sm text-gray-500">Pending</p>
              </div>
              <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-400">
                <p className="text-2xl font-bold">{stats.sentToday}</p><p className="text-sm text-gray-500">Sent Today</p>
              </div>
              <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400">
                <p className="text-2xl font-bold">{stats.failedToday}</p><p className="text-sm text-gray-500">Failed Today</p>
              </div>
              <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-400">
                <p className="text-2xl font-bold">{stats.failureRate}%</p><p className="text-sm text-gray-500">Failure Rate</p>
              </div>
            </div>
          )}

          {/* Tabs */}
          <div className="flex gap-1 bg-gray-100 p-1 rounded-lg w-fit flex-wrap">
            {['overview', 'queue', 'history', 'templates', 'settings'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)}
                className={`px-4 py-2 text-sm rounded-md capitalize ${activeTab === tab ? 'bg-white shadow-sm font-medium' : 'text-gray-600 hover:text-gray-900'}`}>{tab}</button>
            ))}
          </div>

          {/* Overview Tab */}
          {activeTab === 'overview' && stats && (
            <div className="bg-white rounded-xl shadow-sm p-6">
              <h3 className="font-semibold mb-4">Pending by Type</h3>
              {Object.keys(stats.pendingByType || {}).length > 0 ? (
                <div className="space-y-2">
                  {Object.entries(stats.pendingByType).map(([type, count]) => (
                    <div key={type} className="flex justify-between items-center py-2 border-b">
                      <span className="text-sm">{typeLabels[type] || type}</span>
                      <span className="text-sm font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">{count}</span>
                    </div>
                  ))}
                </div>
              ) : <p className="text-gray-400 text-sm">No pending notifications</p>}
              <div className="mt-4 pt-4 border-t text-sm text-gray-500">
                <p>Total sent (all time): {stats.totalSent} | Total failed: {stats.totalFailed} | Log size: {stats.logSize}</p>
                <p>Daily send limit: {stats.dailyLimit} | Used today: {stats.sentToday}</p>
              </div>
            </div>
          )}

          {/* Queue Tab */}
          {activeTab === 'queue' && (
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="p-4 border-b flex items-center justify-between">
                <h3 className="font-semibold">Pending Queue ({queue.filter(n => n.status === 'pending').length})</h3>
                {queue.length > 0 && (
                  <div className="flex items-center gap-3">
                    <label className="flex items-center gap-2 text-sm text-gray-600 cursor-pointer select-none">
                      <input type="checkbox" checked={selectedIds.size === queue.length && queue.length > 0} onChange={toggleSelectAll} className="rounded border-gray-300 text-primary-600 focus:ring-primary-500" />
                      Select all
                    </label>
                    {selectedIds.size > 0 && (
                      <button onClick={handleBulkDelete} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded-lg hover:bg-red-700 transition">
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        Delete {selectedIds.size} selected
                      </button>
                    )}
                  </div>
                )}
              </div>
              {queue.length > 0 ? (
                <div className="divide-y">
                  {queue.map(n => (
                    <div key={n.id} className={`p-4 flex items-start gap-3 ${selectedIds.has(n.id) ? 'bg-blue-50' : 'hover:bg-gray-50'} transition`}>
                      <input type="checkbox" checked={selectedIds.has(n.id)} onChange={() => toggleSelect(n.id)} className="mt-1 rounded border-gray-300 text-primary-600 focus:ring-primary-500 flex-shrink-0" />
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <span className={`text-xs px-2 py-0.5 rounded font-medium ${statusColors[n.status]}`}>{n.status}</span>
                          <span className="text-xs text-gray-400">{typeLabels[n.type] || n.type}</span>
                        </div>
                        <p className="text-sm font-medium truncate">{n.templateData?.subject}</p>
                        <p className="text-xs text-gray-500">To: {n.recipientEmail} | Trigger: {new Date(n.triggerDate).toLocaleString()}</p>
                      </div>
                      {n.status === 'pending' && (
                        <button onClick={() => handleCancel(n.id)} className="text-xs text-red-600 hover:underline flex-shrink-0">Cancel</button>
                      )}
                    </div>
                  ))}
                </div>
              ) : <p className="p-4 text-gray-400 text-sm">Queue is empty</p>}
            </div>
          )}

          {/* History Tab */}
          {activeTab === 'history' && (
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="p-4 border-b"><h3 className="font-semibold">Delivery History (last 50)</h3></div>
              {log.length > 0 ? (
                <div className="divide-y">
                  {log.slice(0, 50).map(n => (
                    <div key={n.id} className="p-4 flex items-start justify-between gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <span className={`text-xs px-2 py-0.5 rounded font-medium ${statusColors[n.status]}`}>{n.status}</span>
                          <span className="text-xs text-gray-400">{typeLabels[n.type] || n.type}</span>
                        </div>
                        <p className="text-sm font-medium truncate">{n.templateData?.subject}</p>
                        <p className="text-xs text-gray-500">To: {n.recipientEmail} | {n.sentAt ? `Sent: ${new Date(n.sentAt).toLocaleString()}` : `Failed: ${n.failureReason || 'Unknown'}`}</p>
                      </div>
                      {n.status === 'failed' && (
                        <button onClick={() => handleRetry(n.id)} className="text-xs text-blue-600 hover:underline">Retry</button>
                      )}
                    </div>
                  ))}
                </div>
              ) : <p className="p-4 text-gray-400 text-sm">No delivery history yet</p>}
            </div>
          )}

          {/* Templates Tab */}
          {activeTab === 'templates' && (
            <div className="space-y-6">
              {editingTemplate ? (
                /* Template Editor */
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="font-semibold text-lg">{editingTemplate.name}</h3>
                      <span className={`text-xs px-2 py-0.5 rounded font-medium ${editingTemplate.category === 'announcement' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}`}>
                        {editingTemplate.category === 'announcement' ? 'Announcement' : 'Automated'}
                      </span>
                    </div>
                    <button onClick={handleCancelEdit} className="text-sm text-gray-500 hover:text-gray-700">Back to list</button>
                  </div>

                  <div className="grid lg:grid-cols-3 gap-4">
                    {/* Editor Panel */}
                    <div className="lg:col-span-2 space-y-4">
                      <div className="bg-white rounded-xl shadow-sm p-5">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Subject Line</label>
                        <input type="text" value={editForm.subject} onChange={e => setEditForm(prev => ({ ...prev, subject: e.target.value }))}
                          className="w-full input-modern px-3 py-2 text-sm font-mono" placeholder="Email subject..." />
                      </div>

                      <div className="bg-white rounded-xl shadow-sm p-5">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Body (Plain Text)</label>
                        <textarea value={editForm.body} onChange={e => setEditForm(prev => ({ ...prev, body: e.target.value }))}
                          rows={8} className="w-full input-modern px-3 py-2 text-sm font-mono resize-y" placeholder="Email body text..." />
                        {editingTemplate.id === 'announcement' && !editForm.body.includes('{{content}}') && (
                          <div className="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2">
                            <span className="text-amber-600 mt-0.5">&#9888;</span>
                            <p className="text-xs text-amber-800">
                              <strong>Missing {'{{content}}'} variable.</strong> The full announcement text will still be appended automatically, but including {'{{content}}'} gives you control over where it appears.
                            </p>
                          </div>
                        )}
                      </div>

                      {editingTemplate.category === 'announcement' && (
                        <div className="bg-white rounded-xl shadow-sm p-5">
                          <label className="block text-sm font-medium text-gray-700 mb-1">HTML Body <span className="text-gray-400 font-normal">(optional  overrides base wrapper)</span></label>
                          <textarea value={editForm.htmlBody} onChange={e => setEditForm(prev => ({ ...prev, htmlBody: e.target.value }))}
                            rows={10} className="w-full input-modern px-3 py-2 text-sm font-mono resize-y" placeholder="Custom HTML email body..." />
                        </div>
                      )}

                      {/* Action Buttons */}
                      <div className="flex items-center gap-3">
                        <button onClick={handleSaveTemplate} disabled={templateSaving}
                          className="btn-primary text-white px-5 py-2 rounded-lg text-sm font-medium disabled:opacity-50">
                          {templateSaving ? 'Saving...' : 'Save Template'}
                        </button>
                        <button onClick={handlePreviewTemplate}
                          className="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                          Preview
                        </button>
                        <button onClick={handleTestSendTemplate} disabled={templateTestSending}
                          className="px-4 py-2 text-sm border border-primary-500 text-primary-500 rounded-lg hover:bg-primary-50 font-medium disabled:opacity-50">
                          {templateTestSending ? 'Sending...' : 'Send Test Email'}
                        </button>
                        <button onClick={() => handleResetTemplate(editingTemplate.id)}
                          className="px-4 py-2 text-sm text-red-600 hover:text-red-800 font-medium ml-auto">
                          Reset to Default
                        </button>
                      </div>
                    </div>

                    {/* Variables Sidebar  grouped by pool */}
                    <div className="space-y-4">
                      <div className="bg-white rounded-xl shadow-sm p-5">
                        <h4 className="font-semibold text-sm mb-1">Available Variables</h4>
                        <p className="text-xs text-gray-400 mb-3">Click to insert into subject or body</p>
                        <div className="space-y-3">
                          {(editingTemplate.poolGroups && editingTemplate.poolGroups.length > 0) ? (
                            editingTemplate.poolGroups.map(group => (
                              <div key={group.pool} className="border border-gray-100 rounded-lg overflow-hidden">
                                <button
                                  onClick={() => togglePoolCollapse(group.pool)}
                                  className="w-full flex items-center justify-between px-3 py-2 bg-gray-50 hover:bg-gray-100 transition-colors text-left"
                                >
                                  <span className="text-xs font-semibold text-gray-700 uppercase tracking-wide">{group.label}</span>
                                  <span className="text-gray-400 text-xs">{collapsedPools[group.pool] ? '+' : '\u2212'}</span>
                                </button>
                                {!collapsedPools[group.pool] && (
                                  <div className="px-3 py-2 space-y-2">
                                    {group.variables.map(v => (
                                      <div key={v.key} className="group">
                                        <div className="flex items-center gap-1.5">
                                          <button onClick={() => handleInsertVariable(v.key, 'body')}
                                            className="text-xs font-mono bg-blue-50 text-blue-700 px-2 py-1 rounded hover:bg-blue-100 transition-colors"
                                            title={`Insert {{${v.key}}} into body`}>
                                            {`{{${v.key}}}`}
                                          </button>
                                          <button onClick={() => handleInsertVariable(v.key, 'subject')}
                                            className="text-xs text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Insert into subject">
                                            +subj
                                          </button>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-0.5 ml-1">{v.label}: <span className="italic text-gray-400">{v.example}</span></p>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            ))
                          ) : (
                            /* Fallback: flat list for templates without pool groups */
                            (editingTemplate.variables || []).map(v => (
                              <div key={v.key} className="group">
                                <div className="flex items-center gap-1.5">
                                  <button onClick={() => handleInsertVariable(v.key, 'body')}
                                    className="text-xs font-mono bg-blue-50 text-blue-700 px-2 py-1 rounded hover:bg-blue-100 transition-colors"
                                    title={`Insert {{${v.key}}} into body`}>
                                    {`{{${v.key}}}`}
                                  </button>
                                  <button onClick={() => handleInsertVariable(v.key, 'subject')}
                                    className="text-xs text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Insert into subject">
                                    +subj
                                  </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-0.5 ml-1">{v.label}: <span className="italic text-gray-400">{v.example}</span></p>
                              </div>
                            ))
                          )}
                        </div>
                      </div>

                      {/* Live Preview Card */}
                      {templatePreview && (
                        <div className="bg-white rounded-xl shadow-sm p-5">
                          <h4 className="font-semibold text-sm mb-3">Preview</h4>
                          <div className="border rounded-lg p-3 bg-gray-50 space-y-2">
                            <p className="text-xs text-gray-500">Subject:</p>
                            <p className="text-sm font-medium">{templatePreview.subject}</p>
                            <hr className="border-gray-200" />
                            <p className="text-xs text-gray-500">Body:</p>
                            <p className="text-sm text-gray-700 whitespace-pre-wrap">{templatePreview.body}</p>
                          </div>
                          {templatePreview.html && (
                            <div className="mt-3">
                              <p className="text-xs text-gray-500 mb-1">HTML Preview:</p>
                              <div className="border rounded-lg overflow-hidden bg-white" style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                <iframe srcDoc={templatePreview.html} style={{ width: '100%', height: '350px', border: 'none' }} title="Email preview" />
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ) : (
                /* Template List */
                <div>
                  <div className="mb-4">
                    <h3 className="font-semibold text-lg">Email Templates</h3>
                    <p className="text-sm text-gray-500">Customize the content of automated email notifications. Use {"{{variable}}"} placeholders for dynamic data.</p>
                  </div>
                  <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {emailTemplates.map(t => (
                      <div key={t.id} className="bg-white rounded-xl shadow-sm p-5 hover:shadow-md transition-shadow border border-transparent hover:border-primary-100">
                        <div className="flex items-start justify-between mb-2">
                          <span className={`text-xs px-2 py-0.5 rounded font-medium ${t.category === 'announcement' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}`}>
                            {t.category === 'announcement' ? 'Announcement' : 'Automated'}
                          </span>
                          {t.isDefault ? (
                            <span className="text-xs text-gray-400">Default</span>
                          ) : (
                            <span className="text-xs text-green-600 font-medium">Customized</span>
                          )}
                        </div>
                        <h4 className="font-medium text-sm mb-1">{t.name}</h4>
                        <p className="text-xs text-gray-500 truncate font-mono mb-3">{t.subject}</p>
                        {t.updatedAt && !t.isDefault && (
                          <p className="text-xs text-gray-400 mb-3">Edited {new Date(t.updatedAt).toLocaleDateString()} by {t.updatedBy}</p>
                        )}
                        <button onClick={() => handleEditTemplate(t)}
                          className="text-sm text-primary-500 hover:text-primary-700 font-medium">
                          Edit Template
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Settings Tab */}
          {activeTab === 'settings' && (
            <div className="space-y-6">
              {/* Notification Queue Settings */}
              <div className="bg-white rounded-xl shadow-sm p-6">
                <h3 className="font-semibold mb-4">Queue Settings</h3>
                <div className="flex items-center justify-between py-3 border-b">
                  <div>
                    <p className="font-medium text-sm">Email Notifications</p>
                    <p className="text-xs text-gray-500">Master toggle for all email delivery</p>
                  </div>
                  <button onClick={() => handleToggleNotifications(!notifSettings?.enabled)}
                    className={`px-3 py-1.5 rounded text-sm font-medium ${notifSettings?.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                    {notifSettings?.enabled ? 'Enabled' : 'Disabled'}
                  </button>
                </div>
                <p className="text-xs text-gray-400 mt-3">Queue processes every {notifSettings?.checkIntervalMinutes || 15} minutes | Max retries: {notifSettings?.maxRetriesDefault || 3} | Daily limit: {notifSettings?.dailySendLimit || 500}</p>
              </div>

              {/* Automated Reminder Settings */}
              <div className="bg-white rounded-xl shadow-sm p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-semibold">Automated Reminders</h3>
                  <button onClick={() => handleToggleReminders(!reminderSettings?.enabled)}
                    className={`px-3 py-1.5 rounded text-sm font-medium ${reminderSettings?.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                    {reminderSettings?.enabled ? 'Enabled' : 'Disabled'}
                  </button>
                </div>
                <div className="space-y-3">
                  {[
                    { key: 'serviceReportFollowups', label: 'Service Report Follow-Ups', desc: 'Notify clients for missing signatures, admins for pending reviews' },
                    { key: 'taskDeadlines', label: 'Task Deadline Alerts', desc: 'Warn owners at 7/3/1 days before due, escalate when overdue' },
                    { key: 'clientActivityNudges', label: 'Client Activity Nudges', desc: 'Remind clients to submit inventory when overdue' },
                    { key: 'milestoneReminders', label: 'Milestone Reminders', desc: 'Notify at 25/50/75/100% completion and approaching go-live' },
                  ].map(scenario => (
                    <div key={scenario.key} className="flex items-center justify-between py-3 border-b last:border-0">
                      <div>
                        <p className="font-medium text-sm">{scenario.label}</p>
                        <p className="text-xs text-gray-500">{scenario.desc}</p>
                      </div>
                      <button onClick={() => handleToggleScenario(scenario.key, !(reminderSettings?.scenarios?.[scenario.key]?.enabled !== false))}
                        className={`px-3 py-1.5 rounded text-xs font-medium ${reminderSettings?.scenarios?.[scenario.key]?.enabled !== false ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                        {reminderSettings?.scenarios?.[scenario.key]?.enabled !== false ? 'On' : 'Off'}
                      </button>
                    </div>
                  ))}
                </div>
                <p className="text-xs text-gray-400 mt-3">Scanner runs every {reminderSettings?.scanIntervalMinutes || 30} minutes</p>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Main App
    const App = () => {
      // Check multiple token sources - admin_token or unified_token from Portal Hub
      const [token, setToken] = useState(() => {
        return localStorage.getItem('admin_token') || localStorage.getItem('unified_token');
      });
      const [user, setUser] = useState(() => {
        try {
          const userData = localStorage.getItem('admin_user') || localStorage.getItem('unified_user');
          return userData ? JSON.parse(userData) : null;
        } catch {
          return null;
        }
      });
      const [activePage, setActivePage] = useState('dashboard');
      const [isMobileOpen, setIsMobileOpen] = useState(false);

      // Handle browser back/forward cache (bfcache) - re-validate auth when page is restored
      useEffect(() => {
        const handlePageShow = (event) => {
          // Check if page was restored from bfcache
          if (event.persisted) {
            // Re-check localStorage for valid tokens
            const storedToken = localStorage.getItem('admin_token') || localStorage.getItem('unified_token');
            const storedUserData = localStorage.getItem('admin_user') || localStorage.getItem('unified_user');

            if (!storedToken || !storedUserData) {
              // Tokens were cleared (user logged out), update React state
              setToken(null);
              setUser(null);
            }
          }
        };

        window.addEventListener('pageshow', handlePageShow);
        return () => window.removeEventListener('pageshow', handlePageShow);
      }, []);

      const handleLogin = (newToken, newUser) => {
        setToken(newToken);
        setUser(newUser);
      };

      if (!token || !user) return <LoginPage onLogin={handleLogin} />;

      // Check if user is a Super Admin (role === 'admin') - full access
      const isSuperAdmin = user?.role === 'admin';
      // Check if user is a Manager - limited access (no inbox/user management)
      const isManager = user?.isManager && !isSuperAdmin;

      // Navigation guard: Managers cannot access inbox or users pages
      const handleNavigation = (page) => {
        if (isManager && (page === 'inbox' || page === 'users')) {
          // Redirect managers to dashboard if they try to access restricted pages
          setActivePage('dashboard');
        } else {
          setActivePage(page);
        }
      };

      const renderPage = () => {
        // Additional protection: if manager somehow gets to restricted page, show dashboard
        if (isManager && (activePage === 'inbox' || activePage === 'users')) {
          return <DashboardPage token={token} onNavigate={handleNavigation} user={user} />;
        }

        switch (activePage) {
          case 'dashboard': return <DashboardPage token={token} onNavigate={handleNavigation} user={user} />;
          case 'inbox': return <InboxPage token={token} />;
          case 'users': return <UsersPage token={token} />;
          case 'service_portal': return <ServicePortalPage token={token} user={user} />;
          case 'notifications': return <NotificationsPage token={token} />;
          default: return <DashboardPage token={token} onNavigate={handleNavigation} user={user} />;
        }
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <Sidebar activePage={activePage} onNavigate={handleNavigation} user={user} token={token} isMobileOpen={isMobileOpen} onClose={() => setIsMobileOpen(false)} />
          <div className="lg:hidden bg-white border-b p-4 flex items-center justify-between sticky top-0 z-30">
            <button onClick={() => setIsMobileOpen(true)} className="text-gray-600">{Icons.menu}</button>
            <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-8" />
            <div className="w-6"></div>
          </div>
          <main className="lg:ml-72 p-4 lg:p-8">{renderPage()}</main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
