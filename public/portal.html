<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrive 365 Labs Client Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#045E9F', 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#045E9F', 600: '#0353a4', 700: '#00205A', 800: '#001d51', 900: '#001233' },
            accent: '#00205A',
            surface: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7' },
            success: { DEFAULT: '#10b981', 50: '#ecfdf5', 500: '#10b981', 600: '#059669' },
            warning: { DEFAULT: '#f59e0b', 50: '#fffbeb', 500: '#f59e0b', 600: '#d97706' },
            danger: { DEFAULT: '#ef4444', 50: '#fef2f2', 500: '#ef4444', 600: '#dc2626' }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%); min-height: 100vh; }
    .sidebar-link { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0.75rem; }
    .sidebar-link:hover { background: linear-gradient(135deg, rgba(4, 94, 159, 0.08) 0%, rgba(4, 94, 159, 0.12) 100%); }
    .sidebar-link.active { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); color: white; box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.4); }
    .card-modern { background: white; border-radius: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.04); }
    .card-modern:hover { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); transition: all 0.2s; }
    .btn-primary:hover { background: linear-gradient(135deg, #0353a4 0%, #00205A 100%); box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.5); transform: translateY(-1px); }
    .input-modern { border: 1.5px solid #e4e4e7; border-radius: 0.75rem; transition: all 0.2s; background: white; }
    .input-modern:focus { border-color: #045E9F; box-shadow: 0 0 0 3px rgba(4, 94, 159, 0.1); outline: none; }
    .gradient-header { background: linear-gradient(135deg, #045E9F 0%, #00205A 100%); }
    .glass-card { backdrop-filter: blur(10px); background: rgba(255,255,255,0.95); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    const API_URL = window.location.origin;
    
    const getSlugFromUrl = () => {
      const path = window.location.pathname;
      const match = path.match(/\/portal\/([^\/]+)/);
      return match ? match[1] : null;
    };

    // Helper function to handle fetch responses properly
    const handleResponse = async (response) => {
      if (!response.ok) {
        // Auto-redirect to login on auth failure (expired/invalid token)
        if (response.status === 401 || response.status === 403) {
          try {
            const errData = await response.clone().json();
            if (errData.error === 'Invalid token' || errData.error === 'User not found' || response.status === 401) {
              localStorage.removeItem('portal_token');
              localStorage.removeItem('portal_user');
              localStorage.removeItem('unified_token');
              localStorage.removeItem('unified_user');
              window.location.href = '/';
              throw new Error('Session expired. Redirecting to login...');
            }
          } catch (redirectErr) {
            if (redirectErr.message.includes('Session expired')) throw redirectErr;
          }
        }
        // Try to parse error message from response
        try {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error ${response.status}`);
        } catch (e) {
          if (e.message.includes('Session expired')) throw e;
          // If parsing fails, throw generic error
          throw new Error(`HTTP error ${response.status}`);
        }
      }
      return response.json();
    };

    const api = {
      clientLogin: (email, password, slug) =>
        fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }).then(handleResponse).then(result => {
          // Verify slug matches for client users if a slug was specified in URL
          if (result.user && result.user.role === 'client' && slug && result.user.slug !== slug) {
            return { error: 'This account is not associated with this portal' };
          }
          return result;
        }).catch(err => ({ error: err.message || 'Network error' })),

      getPortalData: (token) =>
        fetch(`${API_URL}/api/client-portal/data`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getPortalSettings: () =>
        fetch(`${API_URL}/api/portal-settings`).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getAnnouncements: () =>
        fetch(`${API_URL}/api/announcements`).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getClientDocuments: (slug, token) =>
        fetch(`${API_URL}/api/client-documents/${slug}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getValidationProgress: (token) =>
        fetch(`${API_URL}/api/client-portal/validation-progress`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }))
    };
    
    const LoginPage = ({ slug, onLogin }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const result = await api.clientLogin(email, password, slug);
          if (result.error) {
            setError(result.error);
          } else {
            localStorage.setItem('portal_token', result.token);
            localStorage.setItem('portal_user', JSON.stringify(result.user));
            // If logged in from central /portal without slug, redirect to user's portal
            if (!slug && result.user.slug) {
              window.location.href = `/portal/${result.user.slug}`;
              return;
            }
            onLogin(result.token, result.user);
          }
        } catch (err) {
          setError('Login failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="min-h-screen flex items-center justify-center p-4 relative">
          {/* Decorative background elements */}
          <div className="absolute inset-0 overflow-hidden pointer-events-none">
            <div className="absolute -top-40 -right-40 w-80 h-80 rounded-full opacity-20" style={{background: 'radial-gradient(circle, #045E9F 0%, transparent 70%)'}}></div>
            <div className="absolute -bottom-40 -left-40 w-96 h-96 rounded-full opacity-10" style={{background: 'radial-gradient(circle, #00205A 0%, transparent 70%)'}}></div>
          </div>

          <div className="glass-card p-8 rounded-2xl shadow-xl w-full max-w-md animate-fade-in relative border border-white/50">
            <div className="text-center mb-8">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-12 mx-auto mb-4" />
              <h1 className="text-xl font-semibold text-gray-900">Client Portal</h1>
              <p className="text-gray-500 mt-1 text-sm">Sign in to access your portal</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-5">
              {error && (
                <div className="flex items-center gap-3 bg-danger-50 text-danger-600 p-4 rounded-xl text-sm border border-red-100">
                  <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                  <span>{error}</span>
                </div>
              )}

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                  placeholder="you@example.com"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                  placeholder="Enter your password"
                  required
                />
              </div>

              <button
                type="submit"
                disabled={loading}
                className="btn-primary w-full text-white py-3.5 rounded-xl font-semibold text-sm disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {loading ? (
                  <>
                    <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                    <span>Signing in...</span>
                  </>
                ) : 'Sign In'}
              </button>
            </form>
            
            <div className="mt-8 pt-6 border-t border-gray-100 text-center">
              <p className="text-xs text-gray-400">Precision Diagnostics Platform</p>
            </div>
          </div>
        </div>
      );
    };
    
    // SVG icons for consistent branding
    const Icons = {
      home: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>,
      target: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
      package: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>,
      clipboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>,
      chart: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
      chat: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>,
      folder: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
      logout: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
      megaphone: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>,
      activity: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
      warning: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
      calendar: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
      list: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>,
      menu: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>,
      close: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>,
      upload: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,
      download: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
      plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg>,
      refresh: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
      check: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
      trash: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
    };
    
    // Additional icons for admin portal
    const AdminIcons = {
      settings: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      users: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
      document: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>,
      back: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
    };
    
    const Sidebar = ({ activePage, onNavigate, user, isMobileOpen, onClose, projects }) => {
      const [inventoryExpanded, setInventoryExpanded] = useState(activePage === 'inventory' || activePage === 'reports' || activePage === 'submission_history');
      const [adminExpanded, setAdminExpanded] = useState(activePage.startsWith('admin_'));
      // Super Admin, Manager, or users with hasClientPortalAdminAccess can access admin features
      const isAdmin = user?.role === 'admin' || user?.isManager || user?.hasClientPortalAdminAccess;

      const mainItems = [
        { id: 'home', label: isAdmin ? 'Admin Dashboard' : 'Home', icon: Icons.home }
      ];

      // Show Launch Milestones for clients with assigned projects that are NOT complete
      const activeProjects = (projects || []).filter(p => p.status !== 'Complete' && p.status !== 'Completed');
      if (activeProjects.length > 0 && !isAdmin) {
        mainItems.push({ id: 'milestones', label: 'Launch Milestones', icon: Icons.target });
      }
      
      const bottomItems = isAdmin ? [] : [
        { id: 'support', label: 'Customer Support', icon: Icons.chat },
        { id: 'files', label: 'Files', icon: Icons.folder }
      ];
      
      const handleNavigate = (id) => {
        onNavigate(id);
        if (onClose) onClose();
      };
      
      return (
        <>
          {/* Mobile overlay */}
          {isMobileOpen && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden" onClick={onClose}></div>
          )}
          
          <aside className={`w-64 bg-white border-r min-h-screen fixed left-0 top-0 z-50 transform transition-transform duration-300 ${isMobileOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
            <div className="p-4 border-b flex justify-between items-center">
              {user?.logo ? (
                <img src={user.logo} alt={user.practiceName || 'Practice Logo'} className="h-12 max-w-full object-contain" />
              ) : (
                <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-10" />
              )}
              <button onClick={onClose} className="lg:hidden text-gray-500 hover:text-gray-700">
                {Icons.close}
              </button>
            </div>
            
            <div className="p-4 border-b bg-gray-50">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-500">Welcome,</p>
                  <p className="font-semibold text-accent">{user?.practiceName || user?.name || 'Client'}</p>
                </div>
                <span className={`px-2 py-0.5 text-xs font-medium rounded-full ${
                  user?.role === 'admin' ? 'bg-purple-100 text-purple-700' :
                  user?.isManager ? 'bg-indigo-100 text-indigo-700' : 'bg-blue-100 text-blue-700'
                }`}>{
                  user?.role === 'admin' ? 'Super Admin' :
                  user?.isManager ? 'Manager' : 'Client'
                }</span>
              </div>
              {user?.practiceName && user?.name && <p className="text-xs text-gray-500 mt-1">{user?.name}</p>}
            </div>
            
            <nav className="p-2">
              {mainItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => handleNavigate(item.id)}
                  className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                    activePage === item.id ? 'active' : 'text-gray-700'
                  }`}
                >
                  <span className="text-primary">{item.icon}</span>
                  <span className="font-medium">{item.label}</span>
                </button>
              ))}
              
              <div className="mt-1">
                <button
                  onClick={() => setInventoryExpanded(!inventoryExpanded)}
                  className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center justify-between ${
                    (activePage === 'inventory' || activePage === 'reports' || activePage === 'submission_history') ? 'active' : 'text-gray-700'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <span className="text-primary">{Icons.package}</span>
                    <span className="font-medium">Inventory</span>
                  </div>
                  <span className="text-xs">{inventoryExpanded ? '‚ñº' : '‚ñ∂'}</span>
                </button>
                
                {inventoryExpanded && (
                  <div className="ml-6 mt-1 space-y-1">
                    {!isAdmin && (
                      <button
                        onClick={() => handleNavigate('inventory')}
                        className={`w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-2 ${
                          activePage === 'inventory' ? 'bg-primary/10 text-primary font-medium' : 'text-gray-600 hover:bg-gray-100'
                        }`}
                      >
                        <span className="text-primary">{Icons.clipboard}</span> Weekly Update
                      </button>
                    )}
                    <button
                      onClick={() => handleNavigate('reports')}
                      className={`w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-2 ${
                        activePage === 'reports' ? 'bg-primary/10 text-primary font-medium' : 'text-gray-600 hover:bg-gray-100'
                      }`}
                    >
                      <span className="text-primary">{Icons.chart}</span> {isAdmin ? 'All Clients Report' : 'Reports & Alerts'}
                    </button>
                    <button
                      onClick={() => handleNavigate('submission_history')}
                      className={`w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-2 ${
                        activePage === 'submission_history' ? 'bg-primary/10 text-primary font-medium' : 'text-gray-600 hover:bg-gray-100'
                      }`}
                    >
                      <span className="text-primary">{Icons.list}</span> Submission History
                    </button>
                  </div>
                )}
              </div>
              
              {/* Admin Portal Management Menu */}
              {isAdmin && (
                <div className="mt-4 pt-4 border-t">
                  <p className="px-4 text-xs font-semibold text-gray-400 uppercase mb-2">Portal Management</p>
                  <button
                    onClick={() => handleNavigate('admin_settings')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_settings' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{AdminIcons.settings}</span>
                    <span className="font-medium">Portal Settings</span>
                  </button>
                  <button
                    onClick={() => handleNavigate('admin_announcements')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_announcements' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{Icons.megaphone}</span>
                    <span className="font-medium">Announcements</span>
                  </button>
                  <button
                    onClick={() => handleNavigate('admin_documents')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_documents' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{AdminIcons.document}</span>
                    <span className="font-medium">Client Documents</span>
                  </button>
                  <button
                    onClick={() => handleNavigate('admin_clients')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_clients' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{AdminIcons.users}</span>
                    <span className="font-medium">Client Users</span>
                  </button>
                </div>
              )}
              
              {bottomItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => handleNavigate(item.id)}
                  className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                    activePage === item.id ? 'active' : 'text-gray-700'
                  }`}
                >
                  <span className="text-primary">{item.icon}</span>
                  <span className="font-medium">{item.label}</span>
                </button>
              ))}
            </nav>
            
            <div className="absolute bottom-0 left-0 right-0 p-4 border-t space-y-2">
              {isAdmin && (
                <button
                  onClick={() => { window.location.href = '/'; }}
                  className="w-full text-left px-4 py-2 text-gray-600 hover:text-primary hover:bg-primary/10 rounded-lg flex items-center gap-2"
                >
                  {Icons.home}
                  <span>Portal Hub</span>
                </button>
              )}
              <button
                onClick={() => {
                  localStorage.removeItem('portal_token');
                  localStorage.removeItem('portal_user');
                  localStorage.removeItem('unified_token');
                  localStorage.removeItem('unified_user');
                  window.location.href = '/';
                }}
                className="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2"
              >
                {Icons.logout}
                <span>Sign Out</span>
              </button>
            </div>
          </aside>
        </>
      );
    };
    
    const HomePage = ({ data, announcements, onNavigate }) => {
      return (
        <div className="space-y-6">
          {/* Dynamic Banner Header */}
          <div className="relative rounded-2xl overflow-hidden shadow-lg" style={{minHeight: '160px'}}>
            <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-client.jpg)', backgroundColor: '#00205A'}}></div>
            <div className="absolute inset-0" style={{background: 'linear-gradient(to right, rgba(0,32,90,0.95) 0%, rgba(4,94,159,0.8) 50%, rgba(4,94,159,0.4) 100%)'}}></div>
            <div className="relative p-6 md:p-8 flex items-center justify-between min-h-[160px]">
              <div className="text-white">
                <h1 className="text-2xl md:text-3xl font-bold drop-shadow-sm">Welcome to Your Portal</h1>
                <p className="mt-2 text-white/90">{data?.user?.practiceName || 'Your Practice'}</p>
              </div>
              {data?.user?.logo && (
                <img src={data.user.logo} alt={data?.user?.practiceName || 'Practice Logo'} className="h-16 md:h-20 max-w-[200px] object-contain bg-white/90 rounded-xl p-3 shadow-lg" />
              )}
            </div>
          </div>
          
          {/* Full-width Announcements Section */}
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">
              <span className="text-primary">{Icons.megaphone}</span> Announcements
            </h2>
            {announcements && announcements.length > 0 ? (
              <div className="space-y-4">
                {/* Sort: pinned first, then priority, then by date */}
                {[...announcements].sort((a, b) => {
                  if (a.pinned && !b.pinned) return -1;
                  if (!a.pinned && b.pinned) return 1;
                  if (a.priority && !b.priority) return -1;
                  if (!a.priority && b.priority) return 1;
                  return new Date(b.createdAt) - new Date(a.createdAt);
                }).map(ann => (
                  <div key={ann.id} className={`p-4 rounded-lg border-l-4 ${
                    ann.priority ? 'border-red-500 bg-red-50' :
                    ann.pinned ? 'border-primary bg-primary/5' :
                    ann.type === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                    ann.type === 'success' ? 'border-green-500 bg-green-50' :
                    'border-blue-500 bg-blue-50'
                  }`}>
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 flex-wrap mb-2">
                          {ann.pinned && (
                            <span className="text-xs font-semibold text-blue-700 bg-blue-100 px-2 py-0.5 rounded">üìå PINNED</span>
                          )}
                          {ann.priority && (
                            <span className="text-xs font-semibold text-red-700 bg-red-100 px-2 py-0.5 rounded">‚ö†Ô∏è PRIORITY</span>
                          )}
                        </div>
                        <h3 className="font-semibold text-gray-800 text-lg">{ann.title}</h3>
                        {ann.priority && (
                          <p className="text-xs text-red-600 mt-1 italic">This is a priority announcement. Please review carefully.</p>
                        )}
                        <p className="text-gray-600 mt-2 whitespace-pre-wrap">{ann.content}</p>
                        {ann.attachmentUrl && (
                          <a
                            href={ann.attachmentUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-2 mt-3 text-sm text-primary hover:text-accent font-medium"
                          >
                            üìé {ann.attachmentName || 'Download Attachment'}
                          </a>
                        )}
                        <p className="text-xs text-gray-400 mt-3">
                          Posted: {new Date(ann.createdAt).toLocaleDateString()}
                        </p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-gray-500 text-sm">No announcements at this time.</p>
            )}
          </div>

          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">
              <span className="text-primary">{Icons.activity}</span> Recent Activity
            </h2>
              {data?.activities && data.activities.length > 0 ? (
                <div className="space-y-2">
                  {data.activities.slice(0, 10).map((act, idx) => {
                    const getIcon = () => {
                      if (act.action === 'inventory_submitted') return { icon: Icons.clipboard, color: 'text-blue-500' };
                      if (act.action === 'hubspot_file_upload') return { icon: Icons.folder, color: 'text-green-500' };
                      if (act.action === 'support_ticket_submitted') return { icon: Icons.chat, color: 'text-purple-500' };
                      if (act.action === 'form_submitted') return { icon: Icons.clipboard, color: 'text-purple-500' };
                      if (act.action === 'phase_completed') return { icon: Icons.target, color: 'text-yellow-500' };
                      if (act.action === 'stage_completed') return { icon: Icons.target, color: 'text-orange-500' };
                      if (act.action === 'task_completed') return { icon: Icons.target, color: 'text-green-500' };
                      if (act.action === 'document_added') return { icon: Icons.folder, color: 'text-primary' };
                      if (act.action === 'service_report_client_signed') return { icon: Icons.check, color: 'text-green-600' };
                      if (act.action === 'inventory_submissions_deleted') return { icon: Icons.clipboard, color: 'text-red-500' };
                      return { icon: Icons.activity, color: 'text-gray-500' };
                    };
                    const getLabel = () => {
                      if (act.action === 'inventory_submitted') return `Inventory submitted (${act.details?.itemCount || 0} items)`;
                      if (act.action === 'hubspot_file_upload') return `File uploaded: ${typeof act.details === 'string' ? act.details : 'Document'}`;
                      if (act.action === 'support_ticket_submitted') return 'Support ticket submitted';
                      if (act.action === 'form_submitted') return `Form submitted: ${act.formType || 'Unknown'}`;
                      if (act.action === 'phase_completed') return `Phase completed: ${act.details?.phase || ''}`;
                      if (act.action === 'stage_completed') return `Stage completed: ${act.details?.stage || ''}`;
                      if (act.action === 'task_completed') return act.details?.taskTitle || 'Task completed';
                      if (act.action === 'document_added') return `New document: ${act.details?.documentTitle || 'File shared'}`;
                      if (act.action === 'service_report_client_signed') return `Service report signed: ${act.details?.serviceType || 'Report'}`;
                      if (act.action === 'inventory_submissions_deleted') return `Inventory submissions removed`;
                      return typeof act.details === 'string' ? act.details : 'Activity recorded';
                    };
                    const { icon, color } = getIcon();
                    return (
                      <div key={idx} className="flex items-start gap-3 text-sm py-2 border-b last:border-0">
                        <span className={color}>{icon}</span>
                        <div>
                          <p className="text-gray-800">{getLabel()}</p>
                          <p className="text-xs text-gray-400">
                            {new Date(act.timestamp).toLocaleDateString()}
                          </p>
                        </div>
                      </div>
                    );
                  })}
                </div>
            ) : (
              <p className="text-gray-500 text-sm">No recent activity.</p>
            )}
          </div>

          <div className="grid md:grid-cols-3 gap-4">
            <button onClick={() => onNavigate('inventory')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center cursor-pointer w-full">
              <div className="flex justify-center mb-2 text-primary">{React.cloneElement(Icons.package, { className: 'w-10 h-10' })}</div>
              <h3 className="font-semibold text-gray-800">Inventory Management</h3>
              <p className="text-sm text-gray-500 mt-1">Submit inventory requests</p>
            </button>
            <button onClick={() => onNavigate('support')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center cursor-pointer w-full">
              <div className="flex justify-center mb-2 text-primary">{React.cloneElement(Icons.chat, { className: 'w-10 h-10' })}</div>
              <h3 className="font-semibold text-gray-800">Customer Support</h3>
              <p className="text-sm text-gray-500 mt-1">Get help from our team</p>
            </button>
            <button onClick={() => onNavigate('files')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center cursor-pointer w-full">
              <div className="flex justify-center mb-2 text-primary">{React.cloneElement(Icons.folder, { className: 'w-10 h-10' })}</div>
              <h3 className="font-semibold text-gray-800">Files</h3>
              <p className="text-sm text-gray-500 mt-1">Upload and view documents</p>
            </button>
          </div>
        </div>
      );
    };
    
    const MilestonesPage = ({ data, onNavigate, token }) => {
      const project = data?.projects?.[0];
      const allTasks = project?.tasks || [];
      const tasks = allTasks.filter(t => t.showToClient !== false);
      const [viewType, setViewType] = useState('list');
      const [validationProgress, setValidationProgress] = useState([]);
      const [showValidationDetails, setShowValidationDetails] = useState(false);

      // Fetch active validation progress
      useEffect(() => {
        if (token) {
          api.getValidationProgress(token).then(result => {
            if (!result.error && Array.isArray(result)) {
              setValidationProgress(result);
            }
          });
        }
      }, [token]);

      // Phase name mappings for full display titles
      const phaseNames = {
        'Phase 1': 'Contract & Initial Setup',
        'Phase 2': 'Billing, CLIA & Hiring',
        'Phase 3': 'Tech Infrastructure & LIS Integration',
        'Phase 4': 'Inventory Forecasting & Procurement',
        'Phase 5': 'Supply Orders & Logistics',
        'Phase 6': 'Onboarding & Welcome Calls',
        'Phase 7': 'Virtual Soft Pilot & Prep',
        'Phase 8': 'Training & Full Validation',
        'Phase 9': 'Go-Live',
        'Phase 10': 'Post-Launch Support & Optimization'
      };

      // Dynamic phase extraction from task data - phases are derived from actual tasks
      // This ensures client portal view always matches the internal project board
      const extractPhasesFromTasks = (taskList) => {
        const phaseMap = {};
        taskList.forEach(task => {
          const phase = task.phase || 'No Phase';
          if (!phaseMap[phase]) {
            phaseMap[phase] = { name: phaseNames[phase] || phase, stages: new Set() };
          }
          const stage = task.stage || 'General';
          phaseMap[phase].stages.add(stage);
        });
        Object.keys(phaseMap).forEach(phase => {
          phaseMap[phase].stages = Array.from(phaseMap[phase].stages);
        });
        return phaseMap;
      };

      // Sort phases naturally (Phase 1, Phase 2, ... Phase 10, etc.)
      const sortPhases = (phases) => {
        return phases.sort((a, b) => {
          const numA = parseInt(a.match(/\d+/)?.[0] || '999');
          const numB = parseInt(b.match(/\d+/)?.[0] || '999');
          if (numA !== numB) return numA - numB;
          return a.localeCompare(b);
        });
      };

      // Extract dynamic phases from tasks
      const dynamicPhases = extractPhasesFromTasks(tasks);
      const PHASE_ORDER = sortPhases(Object.keys(dynamicPhases));

      const formatDateForDisplay = (dateStr) => {
        if (!dateStr) return '';
        try {
          if (dateStr.includes('T')) {
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
          }
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          }
          return dateStr;
        } catch (e) {
          return dateStr;
        }
      };

      // Dynamic phase colors that cycle through a palette
      const getPhaseColor = (phase, index) => {
        const colors = ['border-purple-500', 'border-blue-600', 'border-green-500', 'border-yellow-500', 'border-orange-500', 'border-red-500', 'border-pink-500', 'border-indigo-500', 'border-teal-500', 'border-cyan-500'];
        return colors[index % colors.length] || 'border-gray-500';
      };

      // Dynamic phase gradients that cycle through a palette
      const getPhaseGradient = (phase, index) => {
        const gradients = ['bg-gradient-to-r from-purple-600 to-purple-700', 'bg-gradient-to-r from-blue-600 to-blue-700', 'bg-gradient-to-r from-green-600 to-green-700', 'bg-gradient-to-r from-yellow-500 to-yellow-600', 'bg-gradient-to-r from-orange-500 to-orange-600', 'bg-gradient-to-r from-red-500 to-red-600', 'bg-gradient-to-r from-pink-500 to-pink-600', 'bg-gradient-to-r from-indigo-500 to-indigo-600', 'bg-gradient-to-r from-teal-500 to-teal-600', 'bg-gradient-to-r from-cyan-500 to-cyan-600'];
        return gradients[index % gradients.length] || 'bg-gradient-to-r from-gray-600 to-gray-700';
      };

      // Helper to organize tasks by phase and stage
      const organizeTasksByPhaseAndStage = (taskList, phaseOrder, phases) => {
        const result = {};
        phaseOrder.forEach(phase => {
          result[phase] = {};
          const stages = phases[phase]?.stages || [];
          stages.forEach(stage => { result[phase][stage] = []; });
        });
        taskList.forEach(task => {
          const phase = task.phase || 'No Phase';
          const stage = task.stage || 'General';
          if (!result[phase]) result[phase] = {};
          if (!result[phase][stage]) result[phase][stage] = [];
          result[phase][stage].push(task);
        });
        return result;
      };
      
      // Use server-calculated overall progress (based on ALL tasks, matching admin dashboard)
      // Falls back to client-visible calculation if server doesn't provide it
      const completedTasks = tasks.filter(t => t.completed).length;
      const totalTasks = tasks.length;
      const progressPercent = project.overallProgressPercent !== undefined
        ? project.overallProgressPercent
        : (totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0);

      // Use dynamic phase organization
      const groupedByPhase = organizeTasksByPhaseAndStage(tasks, PHASE_ORDER, dynamicPhases);

      const ValidationProgressCard = () => {
        if (validationProgress.length === 0) return null;
        return (
          <div className="space-y-4 mb-8">
            {validationProgress.map(v => {
              const daysLogged = v.daysLogged || 0;
              const expected = v.expectedDays;
              const progressPct = expected ? Math.min(100, Math.round((daysLogged / expected) * 100)) : null;
              return (
                <div key={v.id} className="bg-white rounded-xl shadow-sm border-2 border-blue-200 overflow-hidden">
                  <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-4 text-white">
                    <div className="flex items-center justify-between">
                      <div>
                        <h3 className="font-bold text-lg flex items-center gap-2">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082"/></svg>
                          Active Validation
                        </h3>
                        <p className="text-blue-100 text-sm mt-1">
                          {v.analyzerModel || 'Biolis AU480'} {v.analyzerSerialNumber ? `¬∑ ${v.analyzerSerialNumber}` : ''}
                          {v.technicianName ? ` ¬∑ Technician: ${v.technicianName}` : ''}
                        </p>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-bold">{daysLogged}</div>
                        <div className="text-xs text-blue-100">day{daysLogged !== 1 ? 's' : ''} logged</div>
                      </div>
                    </div>
                    {expected && progressPct !== null && (
                      <div className="mt-3">
                        <div className="w-full bg-white/20 rounded-full h-2 overflow-hidden">
                          <div className={`h-full rounded-full transition-all duration-500 ${progressPct >= 100 ? 'bg-green-300' : 'bg-white'}`} style={{ width: `${progressPct}%` }} />
                        </div>
                        <p className="text-xs text-blue-100 mt-1">{daysLogged} of {expected} expected days ¬∑ {progressPct}%</p>
                      </div>
                    )}
                  </div>
                  <div className="p-4">
                    <div className="flex items-center gap-2 mb-3">
                      {(v.segments || []).map((s, i) => (
                        <div key={i} className={`w-3 h-3 rounded-full ${s.status === 'complete' ? 'bg-green-500' : 'bg-yellow-400'}`} title={`Day ${s.day}: ${s.status}`}></div>
                      ))}
                      {expected && Array.from({ length: Math.max(0, expected - daysLogged) }).map((_, i) => (
                        <div key={`pending-${i}`} className="w-3 h-3 rounded-full bg-gray-200" title="Pending"></div>
                      ))}
                    </div>
                    <button
                      onClick={() => setShowValidationDetails(!showValidationDetails)}
                      className="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1"
                    >
                      {showValidationDetails ? 'Hide' : 'View'} Daily Details
                      <svg className={`w-4 h-4 transition-transform ${showValidationDetails ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                    </button>
                    {showValidationDetails && (
                      <div className="mt-3 space-y-3">
                        {(v.segments || []).map(seg => (
                          <div key={seg.day} className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <div className="flex items-center gap-2 mb-2">
                              <div className={`w-5 h-5 rounded-full flex items-center justify-center text-white text-xs ${seg.status === 'complete' ? 'bg-green-500' : 'bg-yellow-400'}`}>
                                {seg.status === 'complete' ? '‚úì' : '...'}
                              </div>
                              <span className="font-medium text-gray-900 text-sm">Day {seg.day} ‚Äî {seg.date ? new Date(seg.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : ''}</span>
                            </div>
                            {seg.testsPerformed && (
                              <div className="mb-1"><span className="text-xs font-medium text-gray-500">Tests:</span> <span className="text-sm text-gray-700">{seg.testsPerformed}</span></div>
                            )}
                            {seg.results && (
                              <div className="mb-1"><span className="text-xs font-medium text-gray-500">Results:</span> <span className="text-sm text-gray-700">{seg.results}</span></div>
                            )}
                            {seg.observations && (
                              <div><span className="text-xs font-medium text-gray-500">Notes:</span> <span className="text-sm text-gray-700">{seg.observations}</span></div>
                            )}
                          </div>
                        ))}
                        {expected && daysLogged < expected && (
                          <div className="bg-gray-50 rounded-lg p-3 border border-dashed border-gray-300 text-center text-sm text-gray-400">
                            {expected - daysLogged} more day{expected - daysLogged > 1 ? 's' : ''} remaining
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        );
      };

      const ListView = () => (
        <div className="space-y-8">
          <ValidationProgressCard />
          {PHASE_ORDER.map((phase, phaseIndex) => {
            const phaseTasks = Object.values(groupedByPhase[phase] || {}).flat();
            const phaseCompleted = phaseTasks.filter(t => t.completed).length;
            const phaseTotal = phaseTasks.length;
            const phasePercent = phaseTotal > 0 ? Math.round((phaseCompleted / phaseTotal) * 100) : 0;
            return (
            <div key={phase} className="space-y-4">
              <div className={`${getPhaseGradient(phase, phaseIndex)} p-4 rounded-lg text-white shadow-md`}>
                <div className="flex items-center justify-between">
                  <div>
                    <h2 className="text-lg font-bold">{dynamicPhases[phase]?.name || phase.replace(/^Phase\s*\d+\s*:\s*/i, '')}</h2>
                    <p className="text-sm opacity-90 mt-1">
                      {phaseTotal > 0 ? `${phaseCompleted} of ${phaseTotal} complete` : 'No tasks assigned yet'}
                    </p>
                  </div>
                  {phaseTotal > 0 && (
                    <div className="text-right">
                      <div className="text-2xl font-bold">{phasePercent}%</div>
                    </div>
                  )}
                </div>
                {phaseTotal > 0 && (
                  <div className="mt-3 w-full bg-white/20 rounded-full h-2 overflow-hidden">
                    <div className="h-full bg-white rounded-full transition-all duration-500" style={{ width: `${phasePercent}%` }} />
                  </div>
                )}
              </div>
              {Object.entries(groupedByPhase[phase] || {}).map(([stageName, stageTasks]) => {
                const dueDates = stageTasks.filter(t => t.dueDate).map(t => t.dueDate).sort();
                const targetDate = dueDates.length > 0 ? dueDates[dueDates.length - 1] : null;
                return (
                  <div key={stageName} className={`bg-white rounded-lg shadow-sm overflow-hidden border-l-4 ${getPhaseColor(phase, phaseIndex)}`}>
                    <div className="bg-gray-50 p-3 border-b flex justify-between items-start">
                      <div>
                        <h3 className="font-semibold text-gray-700">{stageName}</h3>
                        <p className="text-xs text-gray-500">{stageTasks.filter(t => t.completed).length} of {stageTasks.length} complete</p>
                        {phase === 'Phase 8' && onNavigate && (
                          <button onClick={() => onNavigate('files')} className="text-xs text-primary hover:underline mt-1 inline-block">
                            View Validation Reports in Files ‚Üí
                          </button>
                        )}
                      </div>
                      {targetDate && (
                        <span className="text-xs bg-blue-100 text-primary px-2 py-1 rounded">
                          Target Due Date: {targetDate}
                        </span>
                      )}
                    </div>
                    <div className="divide-y divide-gray-200">
                      {stageTasks.length === 0 ? (
                        <div className="p-4 text-gray-400 text-sm italic">No tasks in this stage</div>
                      ) : stageTasks.map(task => (
                        <div key={task.id} className="p-4">
                          <div className="flex items-start gap-3">
                            <div className="mt-1">
                              {task.completed ? (
                                <div className="w-5 h-5 bg-green-600 rounded-full flex items-center justify-center text-white text-xs">‚úì</div>
                              ) : (
                                <div className="w-5 h-5 border-2 border-gray-300 rounded-full" />
                              )}
                            </div>
                            <div className="flex-1">
                              <h3 className={`font-medium ${task.completed ? 'text-gray-500 line-through' : 'text-gray-900'}`}>
                                {task.clientName || task.taskTitle}
                                {(task.files || []).length > 0 && (
                                  <span className="ml-2 text-gray-400" title={`${task.files.length} file${task.files.length > 1 ? 's' : ''} attached`}>üìé</span>
                                )}
                              </h3>
                              {(task.dateCompleted || task.dueDate) && (
                                <p className="text-sm text-gray-600 mt-1">
                                  {task.dueDate && !task.completed && (
                                    <span className={new Date(task.dueDate) < new Date() ? 'text-red-600' : 'text-blue-600'}>
                                      Due: {new Date(task.dueDate + 'T12:00:00').toLocaleDateString()}
                                    </span>
                                  )}
                                  {task.dueDate && !task.completed && task.dateCompleted && <span className="mx-2">‚Ä¢</span>}
                                  {task.dateCompleted && <span className="text-green-600">Completed: {formatDateForDisplay(task.dateCompleted)}</span>}
                                </p>
                              )}
                              {task.description && (
                                <div className="mt-2 p-2 bg-gray-50 rounded-md border-l-2 border-primary">
                                  <p className="text-sm text-gray-700">{task.description}</p>
                                </div>
                              )}
                              {(task.files || []).length > 0 && (
                                <div className="mt-2">
                                  <p className="text-xs font-medium text-gray-500 mb-1">Attached Files:</p>
                                  <div className="flex flex-wrap gap-2">
                                    {(task.files || []).map(file => (
                                      <a
                                        key={file.id}
                                        href={file.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-primary text-xs rounded hover:bg-blue-100 border border-blue-200"
                                      >
                                        <span>
                                          {file.mimeType?.includes('pdf') ? 'üìÑ' : 
                                           file.mimeType?.includes('image') ? 'üñºÔ∏è' : 
                                           file.mimeType?.includes('word') ? 'üìù' : 
                                           file.mimeType?.includes('excel') || file.mimeType?.includes('spreadsheet') ? 'üìä' : 'üìé'}
                                        </span>
                                        {file.name}
                                      </a>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
            );
          })}
        </div>
      );

      const TimelineView = () => (
        <div className="bg-white rounded-lg shadow-sm p-6">
          <h2 className="text-2xl font-bold mb-6 text-accent">Project Timeline</h2>
          <ValidationProgressCard />
          <div className="space-y-8">
            {PHASE_ORDER.map((phase, phaseIndex) => {
              const phaseData = groupedByPhase[phase] || {};
              const phaseTasks = Object.values(phaseData).flat();
              const completedCount = phaseTasks.filter(t => t.completed).length;
              return (
                <div key={phase} className={`border-l-4 ${getPhaseColor(phase, phaseIndex)} pl-6`}>
                  <div className="mb-4">
                    <h3 className="text-xl font-bold text-gray-900">{dynamicPhases[phase]?.name || phase.replace(/^Phase\s*\d+\s*:\s*/i, '')}</h3>
                    <p className="text-sm text-gray-600">{completedCount} of {phaseTasks.length} complete ({phaseTasks.length > 0 ? Math.round((completedCount / phaseTasks.length) * 100) : 0}%)</p>
                  </div>
                  <div className="space-y-4">
                    {Object.entries(phaseData).map(([stage, stageTasks]) => {
                      const dueDates = stageTasks.filter(t => t.dueDate).map(t => t.dueDate).sort();
                      const targetDate = dueDates.length > 0 ? dueDates[dueDates.length - 1] : null;
                      return (
                        <div key={stage} className="bg-gray-50 rounded-lg p-4">
                          <div className="flex justify-between items-start mb-3">
                            <div>
                              <h4 className="font-semibold text-gray-800">{stage}</h4>
                              {phase === 'Phase 8' && onNavigate && (
                                <button onClick={() => onNavigate('files')} className="text-xs text-primary hover:underline mt-1 inline-block">
                                  View Validation Reports in Files ‚Üí
                                </button>
                              )}
                            </div>
                            {targetDate && <span className="text-xs bg-blue-100 text-primary px-2 py-1 rounded">Target Due Date: {targetDate}</span>}
                          </div>
                          <div className="space-y-2">
                            {stageTasks.map(task => (
                              <div key={task.id} className={`flex items-start gap-3 p-3 rounded-lg ${task.completed ? 'bg-green-50' : 'bg-white'} border border-gray-200`}>
                                <div className={`mt-0.5 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 ${task.completed ? 'bg-green-500 text-white' : 'border-2 border-gray-300'}`}>
                                  {task.completed && <span className="text-xs">‚úì</span>}
                                </div>
                                <div className="flex-1 min-w-0">
                                  <h5 className={`font-medium ${task.completed ? 'text-gray-500 line-through' : 'text-gray-900'}`}>
                                    {task.clientName || task.taskTitle}
                                    {(task.files || []).length > 0 && (
                                      <span className="ml-2 text-gray-400" title={`${task.files.length} file${task.files.length > 1 ? 's' : ''} attached`}>üìé</span>
                                    )}
                                  </h5>
                                  {task.dateCompleted && (
                                    <p className="mt-1 text-xs text-gray-600">
                                      <span className="text-green-600">Completed: {formatDateForDisplay(task.dateCompleted)}</span>
                                    </p>
                                  )}
                                  {task.description && (
                                    <div className="mt-2 p-2 bg-gray-50 rounded-md border-l-2 border-primary">
                                      <p className="text-sm text-gray-700">{task.description}</p>
                                    </div>
                                  )}
                                  {(task.files || []).length > 0 && (
                                    <div className="mt-2">
                                      <p className="text-xs font-medium text-gray-500 mb-1">Attached Files:</p>
                                      <div className="flex flex-wrap gap-2">
                                        {(task.files || []).map(file => (
                                          <a
                                            key={file.id}
                                            href={file.url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-primary text-xs rounded hover:bg-blue-100 border border-blue-200"
                                          >
                                            <span>
                                              {file.mimeType?.includes('pdf') ? 'üìÑ' : 
                                               file.mimeType?.includes('image') ? 'üñºÔ∏è' : 
                                               file.mimeType?.includes('word') ? 'üìù' : 
                                               file.mimeType?.includes('excel') || file.mimeType?.includes('spreadsheet') ? 'üìä' : 'üìé'}
                                            </span>
                                            {file.name}
                                          </a>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
      
      const CalendarView = () => {
        const [selectedDate, setSelectedDate] = useState(new Date());
        const getDaysInMonth = (date) => {
          const year = date.getFullYear();
          const month = date.getMonth();
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          return { daysInMonth: lastDay.getDate(), startingDayOfWeek: firstDay.getDay(), year, month };
        };
        const { daysInMonth, startingDayOfWeek, year, month } = getDaysInMonth(selectedDate);
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const getTasksForDay = (day) => {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return tasks.filter(t => t.dueDate === dateStr || t.dateCompleted === dateStr);
        };
        return (
          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold text-accent">{monthNames[month]} {year}</h2>
              <div className="flex gap-1">
                <button onClick={() => setSelectedDate(new Date(year, month - 1, 1))} className="p-2 hover:bg-gray-100 rounded-lg">‚Üê</button>
                <button onClick={() => setSelectedDate(new Date())} className="px-3 py-1 text-sm text-primary hover:underline">Today</button>
                <button onClick={() => setSelectedDate(new Date(year, month + 1, 1))} className="p-2 hover:bg-gray-100 rounded-lg">‚Üí</button>
              </div>
            </div>
            <div className="grid grid-cols-7 gap-2 mb-2">
              {dayNames.map(day => (<div key={day} className="text-center text-sm font-semibold text-gray-600 py-2">{day}</div>))}
            </div>
            <div className="grid grid-cols-7 gap-2">
              {[...Array(startingDayOfWeek)].map((_, idx) => (<div key={`empty-${idx}`} className="aspect-square"></div>))}
              {[...Array(daysInMonth)].map((_, idx) => {
                const day = idx + 1;
                const dayTasks = getTasksForDay(day);
                const isToday = new Date().getDate() === day && new Date().getMonth() === month && new Date().getFullYear() === year;
                return (
                  <div key={day} className={`min-h-[80px] border rounded-lg p-2 ${isToday ? 'border-primary bg-blue-50' : 'border-gray-200'}`}>
                    <div className={`text-sm font-semibold mb-1 ${isToday ? 'text-primary' : 'text-gray-700'}`}>{day}</div>
                    <div className="space-y-1">
                      {dayTasks.slice(0, 2).map(task => (
                        <div key={task.id} className={`text-xs px-1 py-0.5 rounded truncate ${task.completed ? 'bg-green-200 text-green-800' : 'bg-blue-100 text-primary'}`} title={task.clientName || task.taskTitle}>
                          {(task.clientName || task.taskTitle).substring(0, 10)}...
                        </div>
                      ))}
                      {dayTasks.length > 2 && <div className="text-xs text-gray-500">+{dayTasks.length - 2} more</div>}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      };
      
      if (!project || tasks.length === 0) {
        return (
          <div className="bg-white p-6 rounded-xl shadow-sm text-center text-gray-500">
            No project milestones available.
          </div>
        );
      }
      
      return (
        <div className="space-y-6">
          <div className="bg-white shadow-sm border-b rounded-xl">
            <div className="px-4 sm:px-6 py-4">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div className="flex items-center gap-4">
                  <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-10" />
                  <div>
                    <h1 className="text-xl font-bold text-accent">{project.name}</h1>
                    <p className="text-sm text-gray-600">{project.clientName}</p>
                  </div>
                </div>
                <div className="flex items-center gap-4">
                  <div className="text-right">
                    <div className="text-2xl font-bold text-primary">{progressPercent}%</div>
                    <div className="text-sm text-gray-500">Complete</div>
                  </div>
                  <div className="w-24 h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div className="h-full bg-primary rounded-full transition-all duration-500" style={{ width: `${progressPercent}%` }} />
                  </div>
                </div>
              </div>
              {project.goLiveDate && (() => {
                const dateStr = project.goLiveDate;
                let d;
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                  d = new Date(dateStr + 'T12:00:00');
                } else if (dateStr.includes('T') && dateStr.endsWith('Z')) {
                  const datePart = dateStr.split('T')[0];
                  d = new Date(datePart + 'T12:00:00');
                } else if (dateStr.includes('T')) {
                  d = new Date(dateStr);
                } else {
                  d = new Date(dateStr);
                }
                return !isNaN(d.getTime()) ? (
                  <div className="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                    <svg className="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span className="text-sm font-medium text-gray-700">Target Go-Live: {d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
                  </div>
                ) : null;
              })()}
            </div>
          </div>
          
          <div className="flex gap-2 bg-white p-2 rounded-lg shadow-sm">
            <button onClick={() => setViewType('list')} style={viewType === 'list' ? {backgroundColor: '#045E9F', color: 'white'} : {}} className={`px-4 py-2 rounded-md font-medium transition-all ${viewType === 'list' ? 'shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
              <span className="flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                List View
              </span>
            </button>
            <button onClick={() => setViewType('timeline')} style={viewType === 'timeline' ? {backgroundColor: '#045E9F', color: 'white'} : {}} className={`px-4 py-2 rounded-md font-medium transition-all ${viewType === 'timeline' ? 'shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
              <span className="flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                Timeline
              </span>
            </button>
            <button onClick={() => setViewType('calendar')} style={viewType === 'calendar' ? {backgroundColor: '#045E9F', color: 'white'} : {}} className={`px-4 py-2 rounded-md font-medium transition-all ${viewType === 'calendar' ? 'shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
              <span className="flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                Calendar
              </span>
            </button>
          </div>
          
          {viewType === 'list' && <ListView />}
          {viewType === 'timeline' && <TimelineView />}
          {viewType === 'calendar' && <CalendarView />}
        </div>
      );
    };
    
    const InventoryPage = ({ token, slug }) => {
      const [template, setTemplate] = useState([]);
      const [customItems, setCustomItems] = useState([]);
      const [inventoryData, setInventoryData] = useState({});
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [lastSubmitted, setLastSubmitted] = useState(null);
      const [expandedCategories, setExpandedCategories] = useState({});
      const [message, setMessage] = useState('');
      const [showAddItem, setShowAddItem] = useState(false);
      const [newItemCategory, setNewItemCategory] = useState('');
      const [newItemName, setNewItemName] = useState('');

      useEffect(() => { loadInventory(); }, []);

      const loadInventory = async () => {
        try {
          const [templateData, latestData, customData] = await Promise.all([
            fetch(`${API_URL}/api/inventory/template`).then(r => r.json()),
            fetch(`${API_URL}/api/inventory/latest/${slug}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
            fetch(`${API_URL}/api/inventory/custom-items/${slug}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
          ]);
          setTemplate(templateData);
          setCustomItems(customData || []);
          const normalized = {};
          Object.entries(latestData.data || {}).forEach(([key, value]) => {
            if (value.batches) { normalized[key] = value; }
            else { normalized[key] = { batches: [value] }; }
          });
          setInventoryData(normalized);
          setLastSubmitted(latestData.submittedAt);
          const expanded = {};
          templateData.forEach(cat => { expanded[cat.category] = false; });
          expanded['Custom Items'] = false;
          setExpandedCategories(expanded);
        } catch (err) { console.error('Failed to load inventory:', err); }
        finally { setLoading(false); }
      };

      const getBatches = (category, item) => {
        const key = `${category}|${item}`;
        const data = inventoryData[key];
        if (!data || !data.batches || data.batches.length === 0) {
          return [{ lotNumber: '', expiry: '', openQty: '', openDate: '', closedQty: '', notes: '' }];
        }
        return data.batches;
      };

      const updateBatch = (category, item, batchIdx, field, value) => {
        const key = `${category}|${item}`;
        setInventoryData(prev => {
          const current = prev[key] || { batches: [{}] };
          const batches = [...(current.batches || [{}])];
          batches[batchIdx] = { ...(batches[batchIdx] || {}), [field]: value };
          return { ...prev, [key]: { batches } };
        });
      };

      const addBatch = (category, item) => {
        const key = `${category}|${item}`;
        setInventoryData(prev => {
          const current = prev[key] || { batches: [] };
          const batches = [...(current.batches || []), { lotNumber: '', expiry: '', openQty: '', openDate: '', closedQty: '', notes: '' }];
          return { ...prev, [key]: { batches } };
        });
      };

      const removeBatch = (category, item, batchIdx) => {
        const key = `${category}|${item}`;
        setInventoryData(prev => {
          const current = prev[key] || { batches: [] };
          const batches = current.batches.filter((_, i) => i !== batchIdx);
          return { ...prev, [key]: { batches: batches.length ? batches : [{}] } };
        });
      };

      const handleSubmit = async () => {
        setSaving(true);
        setMessage('');
        try {
          const response = await fetch(`${API_URL}/api/inventory/submit`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ slug, data: inventoryData })
          });
          const result = await response.json();
          if (result.success) {
            setMessage('Inventory submitted successfully!');
            setLastSubmitted(new Date().toISOString());
            setTimeout(() => setMessage(''), 5000);
          } else { setMessage('Failed to submit inventory'); }
        } catch (err) { setMessage('Error submitting inventory'); }
        finally { setSaving(false); }
      };

      const addCustomItem = async () => {
        if (!newItemCategory || !newItemName) return;
        try {
          const response = await fetch(`${API_URL}/api/inventory/custom-items/${slug}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ category: newItemCategory, itemName: newItemName })
          });
          const newItem = await response.json();
          setCustomItems(prev => [...prev, newItem]);
          setNewItemCategory('');
          setNewItemName('');
          setShowAddItem(false);
        } catch (err) { console.error('Failed to add custom item:', err); }
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({ ...prev, [category]: !prev[category] }));
      };

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      const allCategories = [...template];
      const customByCategory = {};
      customItems.forEach(ci => {
        if (!customByCategory[ci.category]) customByCategory[ci.category] = [];
        customByCategory[ci.category].push(ci.itemName);
      });

      const renderItemRows = (category, items, isCustom = false) => {
        return items.map(item => {
          const batches = getBatches(category, item);
          return (
            <React.Fragment key={`${category}|${item}`}>
              {batches.map((batch, bIdx) => (
                <tr key={`${category}|${item}|${bIdx}`} className="hover:bg-gray-50 border-b">
                  <td className="px-3 py-2 font-medium text-gray-800">
                    {bIdx === 0 ? item : ''}
                    {bIdx === 0 && <button onClick={() => addBatch(category, item)} className="ml-2 text-xs text-primary hover:underline">+Lot</button>}
                  </td>
                  <td className="px-1 py-1"><input type="text" value={batch.lotNumber || ''} onChange={(e) => updateBatch(category, item, bIdx, 'lotNumber', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" placeholder="Lot #" /></td>
                  <td className="px-1 py-1"><input type="date" value={batch.expiry || ''} onChange={(e) => updateBatch(category, item, bIdx, 'expiry', e.target.value)} className="w-full px-1 py-1 border rounded text-sm" /></td>
                  <td className="px-1 py-1"><input type="number" value={batch.openQty || ''} onChange={(e) => updateBatch(category, item, bIdx, 'openQty', e.target.value)} className="w-16 px-1 py-1 border rounded text-sm text-center" min="0" /></td>
                  <td className="px-1 py-1"><input type="date" value={batch.openDate || ''} onChange={(e) => updateBatch(category, item, bIdx, 'openDate', e.target.value)} className="w-full px-1 py-1 border rounded text-sm" /></td>
                  <td className="px-1 py-1"><input type="number" value={batch.closedQty || ''} onChange={(e) => updateBatch(category, item, bIdx, 'closedQty', e.target.value)} className="w-16 px-1 py-1 border rounded text-sm text-center" min="0" /></td>
                  <td className="px-1 py-1"><input type="text" value={batch.notes || ''} onChange={(e) => updateBatch(category, item, bIdx, 'notes', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" placeholder="Notes" /></td>
                  <td className="px-1 py-1 text-center">{batches.length > 1 && <button onClick={() => removeBatch(category, item, bIdx)} className="text-red-500 hover:text-red-700 text-xs">x</button>}</td>
                </tr>
              ))}
            </React.Fragment>
          );
        });
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex justify-between items-start flex-wrap gap-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Inventory Management</h1>
                <p className="text-gray-600 mt-1">Update your weekly inventory counts</p>
                {lastSubmitted && <p className="text-sm text-gray-500 mt-2">Last submitted: {new Date(lastSubmitted).toLocaleString()}</p>}
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowAddItem(true)} className="px-4 py-2 border border-primary text-primary rounded-lg font-medium hover:bg-primary hover:text-white transition">+ Add Item</button>
                <button onClick={handleSubmit} disabled={saving} className="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-accent transition disabled:opacity-50">{saving ? 'Saving...' : 'Submit Inventory'}</button>
              </div>
            </div>
            {message && <div className={`mt-4 p-3 rounded-lg ${message.includes('success') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>{message}</div>}
          </div>

          {showAddItem && (
            <div className="bg-white p-6 rounded-xl shadow-sm border-2 border-primary">
              <h3 className="font-bold text-lg mb-4">Add Custom Item</h3>
              <div className="grid md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                  <select value={newItemCategory} onChange={(e) => setNewItemCategory(e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                    <option value="">Select category...</option>
                    {template.map(cat => <option key={cat.category} value={cat.category}>{cat.category}</option>)}
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                  <input type="text" value={newItemName} onChange={(e) => setNewItemName(e.target.value)} className="w-full px-3 py-2 border rounded-lg" placeholder="Enter item name" />
                </div>
                <div className="flex items-end gap-2">
                  <button onClick={addCustomItem} className="px-4 py-2 bg-primary text-white rounded-lg">Add</button>
                  <button onClick={() => setShowAddItem(false)} className="px-4 py-2 border rounded-lg">Cancel</button>
                </div>
              </div>
            </div>
          )}

          {allCategories.map(cat => {
            const standardItems = cat.items;
            const customCatItems = customByCategory[cat.category] || [];
            const allItems = [...standardItems, ...customCatItems];
            return (
              <div key={cat.category} className="bg-white rounded-xl shadow-sm overflow-hidden">
                <button onClick={() => toggleCategory(cat.category)} className="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                  <h2 className="text-lg font-bold text-gray-800">{cat.category} <span className="text-sm font-normal text-gray-500">({allItems.length} items)</span></h2>
                  <span className="text-gray-500">{expandedCategories[cat.category] ? '‚ñº' : '‚ñ∂'}</span>
                </button>
                {expandedCategories[cat.category] && (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="px-3 py-2 text-left font-medium text-gray-600 w-48">Item</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-24">Lot #</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Expiry</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Open</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Open Date</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Closed</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600">Notes</th>
                          <th className="w-8"></th>
                        </tr>
                      </thead>
                      <tbody>{renderItemRows(cat.category, allItems)}</tbody>
                    </table>
                  </div>
                )}
              </div>
            );
          })}

          {Object.keys(customByCategory).filter(c => !template.find(t => t.category === c)).length > 0 && (
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <button onClick={() => toggleCategory('Other')} className="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                <h2 className="text-lg font-bold text-gray-800">Other Custom Items</h2>
                <span className="text-gray-500">{expandedCategories['Other'] ? '‚ñº' : '‚ñ∂'}</span>
              </button>
              {expandedCategories['Other'] && (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50 border-b">
                      <tr>
                        <th className="px-3 py-2 text-left font-medium text-gray-600 w-48">Item</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-24">Lot #</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Expiry</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Open</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Open Date</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Closed</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600">Notes</th>
                        <th className="w-8"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(customByCategory).filter(([c]) => !template.find(t => t.category === c)).map(([cat, items]) => renderItemRows(cat, items, true))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <button onClick={handleSubmit} disabled={saving} className="px-8 py-3 bg-primary text-white rounded-lg font-medium hover:bg-accent transition disabled:opacity-50">{saving ? 'Saving...' : 'Submit Weekly Inventory'}</button>
          </div>
        </div>
      );
    };

    const ReportsPage = ({ token, slug }) => {
      const [report, setReport] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showGuide, setShowGuide] = useState(false);
      const [itemSearch, setItemSearch] = useState('');
      const [categoryFilter, setCategoryFilter] = useState('All');

      useEffect(() => {
        fetch(`${API_URL}/api/inventory/report/${slug}`, { headers: { 'Authorization': `Bearer ${token}` } })
          .then(r => r.json())
          .then(data => { setReport(data); setLoading(false); })
          .catch(err => { console.error(err); setLoading(false); });
      }, []);

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      const { alerts, submissions, usageTrends } = report || {};
      const lowStock = alerts?.lowStock || [];
      const expiring = alerts?.expiringSoon || [];

      // Check if client hasn't submitted this week
      const hasSubmittedThisWeek = () => {
        if (!submissions || submissions.length === 0) return false;
        const lastSubmission = new Date(submissions[0].submittedAt);
        const today = new Date();
        const daysSinceSubmission = Math.floor((today - lastSubmission) / (1000 * 60 * 60 * 24));
        return daysSinceSubmission < 7;
      };

      // Get current stock items from most recent submission
      const getCurrentStock = () => {
        if (!submissions || submissions.length === 0) return [];
        const latestSubmission = submissions[0];
        const items = [];
        if (latestSubmission.data) {
          Object.entries(latestSubmission.data).forEach(([key, item]) => {
            const totalQty = (item.openQty || 0) + (item.closedQty || 0);
            if (totalQty > 0) {
              items.push({
                key,
                itemName: item.itemName || key,
                category: item.category || 'Other',
                quantity: totalQty,
                openQty: item.openQty || 0,
                closedQty: item.closedQty || 0
              });
            }
          });
        }
        return items.sort((a, b) => a.itemName.localeCompare(b.itemName));
      };

      const currentStock = getCurrentStock();
      const categories = ['All', ...new Set(currentStock.map(i => i.category))];
      const filteredStock = currentStock.filter(item =>
        (categoryFilter === 'All' || item.category === categoryFilter) &&
        item.itemName.toLowerCase().includes(itemSearch.toLowerCase())
      );

      const handleDownload = () => {
        window.open(`${API_URL}/api/inventory/export/${slug}?token=${token}`, '_blank');
      };

      return (
        <div className="space-y-6">
          {/* Submission Warning Flag */}
          {!hasSubmittedThisWeek() && (
            <div className="bg-yellow-50 border border-yellow-300 p-4 rounded-xl flex items-center gap-3">
              <span className="text-2xl">‚ö†Ô∏è</span>
              <div>
                <p className="font-semibold text-yellow-800">Inventory Update Needed</p>
                <p className="text-sm text-yellow-700">You haven't submitted your inventory this week. Please update your inventory to keep records current.</p>
              </div>
            </div>
          )}

          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex flex-col sm:flex-row justify-between items-start gap-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Inventory Reports</h1>
                <p className="text-gray-600 mt-1">View alerts and current stock levels</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={handleDownload} className="bg-primary text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-accent transition-colors flex items-center gap-1">
                  {Icons.download} Download CSV
                </button>
                <button onClick={() => setShowGuide(!showGuide)} className="text-primary hover:text-accent text-sm flex items-center gap-1">
                  <span>‚ÑπÔ∏è</span> {showGuide ? 'Hide Guide' : 'How to Use'}
                </button>
              </div>
            </div>
          </div>

          {showGuide && (
            <div className="bg-blue-50 border border-blue-200 p-6 rounded-xl">
              <h3 className="text-lg font-bold text-blue-800 mb-4">Understanding Your Inventory Reports</h3>
              <div className="grid md:grid-cols-2 gap-6 text-sm text-gray-700">
                <div>
                  <h4 className="font-semibold text-red-600 mb-2">Low Stock Alerts</h4>
                  <p className="mb-2">Items with a combined quantity (open + closed) of 2 or fewer units are flagged here. These require immediate attention to prevent stockouts.</p>
                  <p className="text-xs text-gray-500">Action: Reorder these items as soon as possible.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-orange-600 mb-2">Expiring Soon</h4>
                  <p className="mb-2">Items with expiration dates within the next 30 days appear here. Use these items first to minimize waste.</p>
                  <p className="text-xs text-gray-500">Action: Prioritize using expiring items; plan replacement orders.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-blue-600 mb-2">Current Stock Levels</h4>
                  <p className="mb-2">Shows all items currently in stock based on your most recent inventory submission.</p>
                  <ul className="list-disc list-inside text-xs space-y-1 mt-1">
                    <li>Filter by category to find specific item types</li>
                    <li>Search to quickly locate items</li>
                    <li>See breakdown of open vs closed quantities</li>
                  </ul>
                  <p className="text-xs text-gray-500 mt-2">Submit weekly updates to keep this data accurate.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-yellow-600 mb-2">Weekly Submission Reminder</h4>
                  <p className="mb-2">A warning appears at the top if you haven't submitted inventory in the past 7 days.</p>
                  <p className="text-xs text-gray-500">Action: Submit your inventory weekly to maintain accurate stock visibility.</p>
                </div>
              </div>
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-red-600 mb-4 flex items-center gap-2">
                <span className="text-red-600">{Icons.warning}</span> Low Stock Alerts ({lowStock.length})
              </h2>
              {lowStock.length > 0 ? (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {lowStock.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.category}</p>
                      </div>
                      <span className="text-red-600 font-bold">{item.quantity} left</span>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>All items are well stocked</p>
                </div>
              )}
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-orange-600 mb-4 flex items-center gap-2">
                <span className="text-orange-600">{Icons.calendar}</span> Expiring Soon ({expiring.length})
              </h2>
              {expiring.length > 0 ? (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {expiring.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.category}</p>
                      </div>
                      <div className="text-right">
                        <span className="text-orange-600 font-bold">{item.daysUntilExpiry} days</span>
                        <p className="text-xs text-gray-500">{new Date(item.expiry).toLocaleDateString()}</p>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>No items expiring soon</p>
                </div>
              )}
            </div>
          </div>


          {/* Current Stock Levels */}
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-blue-600 mb-4 flex items-center gap-2">
              <span className="text-blue-600">{Icons.list}</span> Current Stock Levels
            </h2>
            <p className="text-xs text-gray-500 mb-3">Items currently in stock based on your most recent inventory submission</p>

            {currentStock.length > 0 ? (
              <>
                {/* Category filter chips */}
                <div className="flex flex-wrap gap-2 mb-3">
                  {categories.map(cat => (
                    <button key={cat} onClick={() => setCategoryFilter(cat)} className={`px-3 py-1 rounded-full text-xs font-medium transition ${categoryFilter === cat ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{cat}</button>
                  ))}
                </div>

                {/* Search */}
                <input type="text" placeholder="Search items..." value={itemSearch} onChange={e => setItemSearch(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm mb-4" />

                {/* Stock table */}
                <div className="overflow-x-auto max-h-96 overflow-y-auto">
                  <table className="w-full text-sm">
                    <thead className="sticky top-0 bg-white">
                      <tr className="border-b">
                        <th className="text-left py-2 font-medium text-gray-600">Item</th>
                        <th className="text-left py-2 font-medium text-gray-600">Category</th>
                        <th className="text-right py-2 font-medium text-gray-600">Open</th>
                        <th className="text-right py-2 font-medium text-gray-600">Closed</th>
                        <th className="text-right py-2 font-medium text-gray-600">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredStock.map((item, idx) => (
                        <tr key={idx} className="border-b hover:bg-gray-50">
                          <td className="py-2 font-medium text-gray-800">{item.itemName}</td>
                          <td className="py-2 text-gray-500">{item.category}</td>
                          <td className="text-right text-gray-600">{item.openQty}</td>
                          <td className="text-right text-gray-600">{item.closedQty}</td>
                          <td className="text-right font-semibold text-blue-600">{item.quantity}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <p className="text-xs text-gray-400 mt-3">Showing {filteredStock.length} of {currentStock.length} items</p>
              </>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <p>No stock data available - submit your inventory to see current stock levels</p>
              </div>
            )}
          </div>
        </div>
      );
    };
    
    // Admin Aggregate Inventory Report Page
    const AdminReportsPage = ({ token, onNavigate }) => {
      const [report, setReport] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch(`${API_URL}/api/inventory/report-all`, { headers: { 'Authorization': `Bearer ${token}` } })
          .then(r => r.json())
          .then(data => { setReport(data); setLoading(false); })
          .catch(err => { console.error(err); setLoading(false); });
      }, []);

      const handleDownloadAll = () => {
        window.open(`${API_URL}/api/inventory/export-all?token=${token}`, '_blank');
      };

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      const { summary, alerts, clientSummaries, inactiveClients } = report || {};
      const lowStock = alerts?.lowStock || [];
      const expiring = alerts?.expiringSoon || [];

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h1 className="text-2xl font-bold text-accent">All Clients Inventory Report</h1>
              <p className="text-gray-600 mt-1">Aggregated inventory metrics across all client sites</p>
            </div>
            <div className="flex flex-wrap gap-2">
              <button onClick={handleDownloadAll} className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition-colors flex items-center gap-2">
                {Icons.download} Download All CSV
              </button>
              <button onClick={() => onNavigate('submission_history')} className="border border-primary text-primary px-4 py-2 rounded-lg font-medium hover:bg-primary/10 transition-colors flex items-center gap-2">
                {Icons.list} Submission History
              </button>
            </div>
          </div>

          {/* Summary Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-primary">
              <p className="text-gray-500 text-sm">Total Clients</p>
              <p className="text-2xl font-bold text-accent">{summary?.totalClients || 0}</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
              <p className="text-gray-500 text-sm">With Inventory Data</p>
              <p className="text-2xl font-bold text-green-600">{summary?.activeClients || 0}</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
              <p className="text-gray-500 text-sm">Low Stock Alerts</p>
              <p className="text-2xl font-bold text-red-600">{summary?.totalLowStockAlerts || 0}</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
              <p className="text-gray-500 text-sm">Expiring Soon</p>
              <p className="text-2xl font-bold text-orange-600">{summary?.totalExpiringAlerts || 0}</p>
            </div>
          </div>

          {/* Client Summaries Table */}
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">
              <span className="text-primary">{Icons.target}</span> Client Inventory Summary
            </h2>
            {clientSummaries && clientSummaries.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b bg-gray-50">
                      <th className="text-left py-3 px-4 font-medium text-gray-600">Client</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Last Update</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Items</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Total Qty</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Low Stock</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Expiring</th>
                    </tr>
                  </thead>
                  <tbody>
                    {clientSummaries.map((client, idx) => (
                      <tr key={idx} className="border-b hover:bg-gray-50">
                        <td className="py-3 px-4 font-medium text-gray-800">{client.clientName}</td>
                        <td className="py-3 px-4 text-right text-gray-600">{new Date(client.lastSubmission).toLocaleDateString()}</td>
                        <td className="py-3 px-4 text-right text-gray-600">{client.totalItems}</td>
                        <td className="py-3 px-4 text-right text-gray-600">{client.totalQuantity}</td>
                        <td className="py-3 px-4 text-right">
                          <span className={client.lowStockCount > 0 ? 'text-red-600 font-medium' : 'text-green-600'}>
                            {client.lowStockCount}
                          </span>
                        </td>
                        <td className="py-3 px-4 text-right">
                          <span className={client.expiringCount > 0 ? 'text-orange-600 font-medium' : 'text-green-600'}>
                            {client.expiringCount}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <p>No client inventory data available yet</p>
              </div>
            )}
          </div>

          {/* Inactive Clients Warning */}
          {inactiveClients && inactiveClients.length > 0 && (
            <div className="bg-yellow-50 border border-yellow-200 p-6 rounded-xl">
              <h2 className="text-lg font-bold text-yellow-700 mb-3 flex items-center gap-2">
                <span className="text-yellow-600">{Icons.warning}</span> Clients Needing Follow-up
              </h2>
              <p className="text-sm text-yellow-700 mb-3">These clients haven't submitted inventory in over 7 days:</p>
              <div className="space-y-2">
                {inactiveClients.map((client, idx) => (
                  <div key={idx} className="flex justify-between items-center p-3 bg-white rounded-lg border border-yellow-200">
                    <span className="font-medium text-gray-800">{client.clientName}</span>
                    <span className="text-yellow-700 text-sm">Last: {new Date(client.lastSubmission).toLocaleDateString()}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* All Low Stock Alerts */}
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-red-600 mb-4 flex items-center gap-2">
                <span className="text-red-600">{Icons.warning}</span> All Low Stock Alerts ({lowStock.length})
              </h2>
              {lowStock.length > 0 ? (
                <div className="space-y-2 max-h-80 overflow-y-auto">
                  {lowStock.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.clientName} - {item.category}</p>
                      </div>
                      <span className="text-red-600 font-bold">{item.quantity} left</span>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>All clients well stocked</p>
                </div>
              )}
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-orange-600 mb-4 flex items-center gap-2">
                <span className="text-orange-600">{Icons.calendar}</span> All Expiring Soon ({expiring.length})
              </h2>
              {expiring.length > 0 ? (
                <div className="space-y-2 max-h-80 overflow-y-auto">
                  {expiring.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.clientName} - {item.category}</p>
                      </div>
                      <div className="text-right">
                        <span className="text-orange-600 font-bold">{item.daysUntilExpiry} days</span>
                        <p className="text-xs text-gray-500">{new Date(item.expiry).toLocaleDateString()}</p>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>No items expiring soon</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Client Submission History Page - Spreadsheet View
    const SubmissionHistoryPage = ({ token, slug, isAdmin, onNavigate, currentUser }) => {
      const [submissions, setSubmissions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedClient, setSelectedClient] = useState('');
      const [clientList, setClientList] = useState([]);
      const [expandedRows, setExpandedRows] = useState({});
      const [deleting, setDeleting] = useState(false);

      // Check if user can delete (Super Admin or Manager only)
      const canDelete = currentUser?.role === 'admin' || currentUser?.isManager;

      // Filters
      const [dateFrom, setDateFrom] = useState('');
      const [dateTo, setDateTo] = useState('');
      const [categoryFilter, setCategoryFilter] = useState('');
      const [searchTerm, setSearchTerm] = useState('');

      // Flatten all submissions into item-level rows
      const [itemRows, setItemRows] = useState([]);
      const [selectedRows, setSelectedRows] = useState(new Set());

      useEffect(() => {
        if (isAdmin) {
          fetch(`${API_URL}/api/inventory/report-all`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json())
            .then(data => {
              setClientList(data.clientSummaries || []);
              setLoading(false);
            })
            .catch(err => { console.error(err); setLoading(false); });
        } else {
          loadSubmissions(slug);
        }
      }, []);

      useEffect(() => {
        if (isAdmin && selectedClient) {
          loadSubmissions(selectedClient);
        }
      }, [selectedClient]);

      const loadSubmissions = async (clientSlug) => {
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/inventory/submissions/${clientSlug}`, { 
            headers: { 'Authorization': `Bearer ${token}` } 
          });
          const data = await response.json();
          const sorted = data.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
          setSubmissions(sorted);
          
          // Flatten into item rows
          const rows = [];
          sorted.forEach(sub => {
            const submissionDate = new Date(sub.submittedAt);
            Object.entries(sub.data || {}).forEach(([itemName, itemData]) => {
              const batches = Array.isArray(itemData?.batches) ? itemData.batches : [itemData || {}];
              batches.forEach((batch, batchIdx) => {
                rows.push({
                  submissionId: sub.id,
                  submissionDate: submissionDate,
                  submittedBy: sub.submittedBy,
                  itemName: itemName,
                  category: itemData?.category || batch?.category || 'General',
                  lotNumber: batch?.lotNumber || batch?.lot || '',
                  expiry: batch?.expiry || '',
                  openQty: parseInt(batch?.openQty) || 0,
                  closedQty: parseInt(batch?.closedQty) || 0,
                  totalQty: (parseInt(batch?.openQty) || 0) + (parseInt(batch?.closedQty) || 0),
                  notes: batch?.notes || '',
                  batchIndex: batchIdx
                });
              });
            });
          });
          setItemRows(rows);
        } catch (err) {
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      // Get unique categories for filter
      const categories = [...new Set(itemRows.map(r => r.category))].filter(Boolean).sort();

      // Apply filters
      const filteredRows = itemRows.filter(row => {
        if (dateFrom && row.submissionDate < new Date(dateFrom)) return false;
        if (dateTo && row.submissionDate > new Date(dateTo + 'T23:59:59')) return false;
        if (categoryFilter && row.category !== categoryFilter) return false;
        if (searchTerm && !row.itemName.toLowerCase().includes(searchTerm.toLowerCase())) return false;
        return true;
      });

      const toggleSelectAll = () => {
        if (selectedRows.size === filteredRows.length) {
          setSelectedRows(new Set());
        } else {
          setSelectedRows(new Set(filteredRows.map((_, i) => i)));
        }
      };

      const toggleRow = (idx) => {
        const newSelected = new Set(selectedRows);
        if (newSelected.has(idx)) {
          newSelected.delete(idx);
        } else {
          newSelected.add(idx);
        }
        setSelectedRows(newSelected);
      };

      const handleDownloadFiltered = () => {
        const rowsToExport = selectedRows.size > 0 
          ? filteredRows.filter((_, i) => selectedRows.has(i))
          : filteredRows;
        
        if (rowsToExport.length === 0) {
          alert('No data to export');
          return;
        }

        const headers = ['Date', 'Submitted By', 'Item Name', 'Category', 'Lot Number', 'Expiry Date', 'Open Qty', 'Closed Qty', 'Total Qty', 'Notes'];
        const csvContent = [
          headers.join(','),
          ...rowsToExport.map(row => [
            row.submissionDate.toLocaleDateString(),
            `"${row.submittedBy}"`,
            `"${row.itemName}"`,
            `"${row.category}"`,
            `"${row.lotNumber}"`,
            row.expiry ? new Date(row.expiry).toLocaleDateString() : '',
            row.openQty,
            row.closedQty,
            row.totalQty,
            `"${row.notes}"`
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inventory-submissions-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const clearFilters = () => {
        setDateFrom('');
        setDateTo('');
        setCategoryFilter('');
        setSearchTerm('');
        setSelectedRows(new Set());
      };

      const handleDeleteSelected = async () => {
        if (!canDelete) return;

        // Get unique submission IDs from selected rows
        const selectedSubmissionIds = [...new Set(
          filteredRows
            .filter((_, i) => selectedRows.has(i))
            .map(row => row.submissionId)
        )];

        if (selectedSubmissionIds.length === 0) {
          alert('No submissions selected');
          return;
        }

        const confirmMessage = selectedRows.size === filteredRows.length
          ? `Are you sure you want to delete ALL ${selectedSubmissionIds.length} submission(s)? This action cannot be undone.`
          : `Are you sure you want to delete ${selectedSubmissionIds.length} submission(s) containing ${selectedRows.size} row(s)? This action cannot be undone.`;

        if (!confirm(confirmMessage)) return;

        setDeleting(true);
        try {
          const response = await fetch(`${API_URL}/api/inventory/submissions`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              submissionIds: selectedSubmissionIds,
              slug: isAdmin ? selectedClient : slug
            })
          });

          const data = await response.json();

          if (response.ok) {
            alert(`Successfully deleted ${data.deletedCount} submission(s)`);
            setSelectedRows(new Set());
            // Reload submissions
            loadSubmissions(isAdmin ? selectedClient : slug);
          } else {
            alert(data.error || 'Failed to delete submissions');
          }
        } catch (error) {
          console.error('Delete error:', error);
          alert('Failed to delete submissions');
        } finally {
          setDeleting(false);
        }
      };

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      // Client view - show simplified summary (not item-level details)
      if (!isAdmin) {
        return (
          <div className="space-y-6">
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                  <h1 className="text-2xl font-bold text-accent">Submission History</h1>
                  <p className="text-gray-600 mt-1">Overview of your inventory submissions</p>
                </div>
                <button
                  onClick={() => onNavigate('reports')}
                  className="text-primary hover:text-accent text-sm flex items-center gap-1"
                >
                  {Icons.chart} View Reports & Alerts
                </button>
              </div>
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm">
              {submissions.length > 0 ? (
                <div className="space-y-3">
                  {submissions.map((sub, idx) => {
                    const itemCount = Object.keys(sub.data || {}).length;
                    const totalQuantity = Object.values(sub.data || {}).reduce((sum, item) => {
                      const batches = Array.isArray(item?.batches) ? item.batches : [item || {}];
                      return sum + batches.reduce((batchSum, b) => batchSum + (parseInt(b.openQty) || 0) + (parseInt(b.closedQty) || 0), 0);
                    }, 0);
                    return (
                      <div key={sub.id || idx} className="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div>
                          <p className="font-semibold text-gray-800">{new Date(sub.submittedAt).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</p>
                          <p className="text-sm text-gray-500">Submitted by {sub.submittedBy}</p>
                        </div>
                        <div className="text-right">
                          <p className="font-medium text-gray-700">{itemCount} items tracked</p>
                          <p className="text-sm text-gray-500">{totalQuantity} total units</p>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div className="text-center py-12">
                  <div className="flex justify-center mb-4 text-gray-400">{React.cloneElement(Icons.list, { className: 'w-16 h-16' })}</div>
                  <p className="text-gray-500">No submissions yet</p>
                  <p className="text-sm text-gray-400 mt-1">Submit your first inventory to see your history here</p>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Admin view - detailed spreadsheet
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Submission History</h1>
                <p className="text-gray-600 mt-1">Detailed inventory submission records from all clients</p>
              </div>
            </div>
          </div>

          {isAdmin && (
            <div className="bg-white p-4 rounded-xl shadow-sm">
              <label className="block text-sm font-medium text-gray-700 mb-2">Select Client</label>
              <select
                value={selectedClient}
                onChange={(e) => { setSelectedClient(e.target.value); setSelectedRows(new Set()); }}
                className="w-full md:w-64 p-2 border rounded-lg"
              >
                <option value="">Choose a client...</option>
                {clientList.map(c => (
                  <option key={c.slug} value={c.slug}>{c.clientName}</option>
                ))}
              </select>
            </div>
          )}

          {(isAdmin && !selectedClient) ? (
            <div className="bg-white p-6 rounded-xl shadow-sm text-center py-12">
              <div className="flex justify-center mb-4 text-gray-400">{React.cloneElement(Icons.list, { className: 'w-16 h-16' })}</div>
              <p className="text-gray-500">Select a client above to view their submission history</p>
            </div>
          ) : itemRows.length === 0 ? (
            <div className="bg-white p-6 rounded-xl shadow-sm text-center py-12">
              <div className="flex justify-center mb-4 text-gray-400">{React.cloneElement(Icons.list, { className: 'w-16 h-16' })}</div>
              <p className="text-gray-500">No submissions found</p>
            </div>
          ) : (
            <>
              {/* Filters */}
              <div className="bg-white p-4 rounded-xl shadow-sm">
                <div className="flex flex-wrap gap-4 items-end">
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">Search Item</label>
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      placeholder="Search items..."
                      className="border rounded-lg px-3 py-2 text-sm w-48"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">Category</label>
                    <select
                      value={categoryFilter}
                      onChange={(e) => setCategoryFilter(e.target.value)}
                      className="border rounded-lg px-3 py-2 text-sm"
                    >
                      <option value="">All Categories</option>
                      {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">From Date</label>
                    <input
                      type="date"
                      value={dateFrom}
                      onChange={(e) => setDateFrom(e.target.value)}
                      className="border rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">To Date</label>
                    <input
                      type="date"
                      value={dateTo}
                      onChange={(e) => setDateTo(e.target.value)}
                      className="border rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <button
                    onClick={clearFilters}
                    className="text-gray-500 hover:text-gray-700 text-sm underline"
                  >
                    Clear Filters
                  </button>
                </div>
              </div>

              {/* Download & Delete Options */}
              <div className="bg-white p-4 rounded-xl shadow-sm flex flex-wrap items-center justify-between gap-4">
                <div className="text-sm text-gray-600">
                  {selectedRows.size > 0 ? (
                    <span className="font-medium text-primary">{selectedRows.size} of {filteredRows.length} rows selected</span>
                  ) : (
                    <span>{filteredRows.length} records found</span>
                  )}
                </div>
                <div className="flex gap-2">
                  {canDelete && selectedRows.size > 0 && (
                    <button
                      onClick={handleDeleteSelected}
                      disabled={deleting}
                      className="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center gap-2 text-sm disabled:opacity-50"
                    >
                      {deleting ? (
                        <><div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div> Deleting...</>
                      ) : (
                        <>{Icons.trash} Delete Selected ({selectedRows.size})</>
                      )}
                    </button>
                  )}
                  <button
                    onClick={handleDownloadFiltered}
                    className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition-colors flex items-center gap-2 text-sm"
                  >
                    {Icons.download} {selectedRows.size > 0 ? `Download Selected (${selectedRows.size})` : 'Download All'}
                  </button>
                </div>
              </div>

              {/* Spreadsheet Table */}
              <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-100 border-b">
                      <tr>
                        <th className="p-3 text-left">
                          <input
                            type="checkbox"
                            checked={selectedRows.size === filteredRows.length && filteredRows.length > 0}
                            onChange={toggleSelectAll}
                            className="rounded"
                          />
                        </th>
                        <th className="p-3 text-left font-semibold text-gray-700">Date</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Item Name</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Category</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Lot #</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Expiry</th>
                        <th className="p-3 text-center font-semibold text-gray-700">Open</th>
                        <th className="p-3 text-center font-semibold text-gray-700">Closed</th>
                        <th className="p-3 text-center font-semibold text-gray-700">Total</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Notes</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {filteredRows.length === 0 ? (
                        <tr>
                          <td colSpan="10" className="p-8 text-center text-gray-500">
                            No records match your filters
                          </td>
                        </tr>
                      ) : (
                        filteredRows.map((row, idx) => (
                          <tr 
                            key={`${row.submissionId}-${row.itemName}-${row.batchIndex}`}
                            className={`hover:bg-gray-50 ${selectedRows.has(idx) ? 'bg-blue-50' : ''}`}
                          >
                            <td className="p-3">
                              <input
                                type="checkbox"
                                checked={selectedRows.has(idx)}
                                onChange={() => toggleRow(idx)}
                                className="rounded"
                              />
                            </td>
                            <td className="p-3 text-gray-600 whitespace-nowrap">
                              {row.submissionDate.toLocaleDateString()}
                            </td>
                            <td className="p-3 font-medium text-gray-800">{row.itemName}</td>
                            <td className="p-3">
                              <span className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">{row.category}</span>
                            </td>
                            <td className="p-3 text-gray-600 font-mono text-xs">{row.lotNumber || '-'}</td>
                            <td className="p-3 text-gray-600 whitespace-nowrap">
                              {row.expiry ? (
                                <span className={new Date(row.expiry) < new Date() ? 'text-red-600' : ''}>
                                  {new Date(row.expiry).toLocaleDateString()}
                                </span>
                              ) : '-'}
                            </td>
                            <td className="p-3 text-center">{row.openQty}</td>
                            <td className="p-3 text-center">{row.closedQty}</td>
                            <td className="p-3 text-center font-semibold">{row.totalQty}</td>
                            <td className="p-3 text-gray-500 text-xs max-w-xs truncate">{row.notes || '-'}</td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
                {filteredRows.length > 50 && (
                  <div className="p-4 bg-gray-50 border-t text-center text-sm text-gray-500">
                    Showing {filteredRows.length} records. Use filters to narrow results or download for full analysis.
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      );
    };

    // Signature Pad Component for Client Portal
    const SignaturePad = ({ onSave, label, initialValue }) => {
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [hasSignature, setHasSignature] = useState(!!initialValue);

      useEffect(() => {
        if (initialValue && canvasRef.current) {
          const ctx = canvasRef.current.getContext('2d');
          const img = new Image();
          img.onload = () => { ctx.drawImage(img, 0, 0); };
          img.src = initialValue;
        }
      }, [initialValue]);

      const startDrawing = (e) => {
        e.preventDefault();
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
      };

      const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        ctx.lineTo(x, y);
        ctx.stroke();
      };

      const stopDrawing = () => {
        if (isDrawing) {
          setIsDrawing(false);
          setHasSignature(true);
          if (onSave) onSave(canvasRef.current.toDataURL());
        }
      };

      const clearSignature = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        setHasSignature(false);
        if (onSave) onSave('');
      };

      return (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">{label}</label>
          <canvas
            ref={canvasRef}
            width={400}
            height={100}
            style={{ border: '2px dashed #d1d5db', background: '#f9fafb', touchAction: 'none' }}
            className={`w-full rounded-lg cursor-crosshair ${hasSignature ? 'border-green-400' : ''}`}
            onMouseDown={startDrawing}
            onMouseMove={draw}
            onMouseUp={stopDrawing}
            onMouseLeave={stopDrawing}
            onTouchStart={startDrawing}
            onTouchMove={draw}
            onTouchEnd={stopDrawing}
          />
          <button type="button" onClick={clearSignature} className="mt-2 text-sm text-red-600 hover:text-red-800">
            Clear Signature
          </button>
        </div>
      );
    };

    // Service Report Detail View for Client Portal (read-only view + signing)
    const ServiceReportDetail = ({ report, token, onBack, onSigned }) => {
      const [signing, setSigning] = useState(false);
      const [customerSignature, setCustomerSignature] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [signError, setSignError] = useState(null);
      const [signSuccess, setSignSuccess] = useState(false);

      const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      };

      const needsSignature = report.rawStatus === 'signature_needed';

      const handleSign = async () => {
        if (!customerSignature || !customerSignature.startsWith('data:image')) {
          setSignError('Please provide your signature before submitting.');
          return;
        }
        setSubmitting(true);
        setSignError(null);
        try {
          const response = await fetch(`${API_URL}/api/client/service-reports/${report.id}/sign`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              customerSignature,
              customerSignatureDate: new Date().toISOString().split('T')[0]
            })
          });
          const data = await response.json();
          if (!response.ok) {
            setSignError(data.error || 'Failed to submit signature');
          } else {
            setSignSuccess(true);
            if (onSigned) onSigned(report.id);
          }
        } catch (err) {
          console.error('Error signing report:', err);
          setSignError('Network error. Please try again.');
        } finally {
          setSubmitting(false);
        }
      };

      const isValidation = (report.serviceType || '').toLowerCase().includes('validation');

      return (
        <div className="space-y-6">
          {/* Back button */}
          <button onClick={onBack} className="flex items-center gap-2 text-primary hover:text-accent font-medium text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg>
            Back to Service History
          </button>

          {/* Report Header */}
          <div className={`rounded-xl overflow-hidden shadow-sm border ${needsSignature ? 'border-orange-300' : 'border-green-300'}`}>
            <div className={`p-5 ${needsSignature ? 'bg-orange-50' : 'bg-green-50'}`}>
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold text-gray-900">{report.serviceType || 'Service Report'}</h2>
                  <p className="text-sm text-gray-600 mt-1">{report.clientFacilityName}</p>
                </div>
                <span className={`px-3 py-1.5 rounded-full text-xs font-semibold ${
                  needsSignature ? 'bg-orange-100 text-orange-700 border border-orange-300' : 'bg-green-100 text-green-700 border border-green-300'
                }`}>
                  {needsSignature ? 'Signature Needed' : 'Complete'}
                </span>
              </div>
            </div>

            {/* Service Info */}
            <div className="p-5 border-b">
              <h3 className="text-sm font-semibold text-gray-500 uppercase mb-3">Service Information</h3>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <p className="text-xs text-gray-500">Technician</p>
                  <p className="font-medium text-gray-900">{report.technicianName || '-'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500">Service Date</p>
                  <p className="font-medium text-gray-900">{formatDate(report.serviceCompletionDate || report.completedAt)}</p>
                </div>
                {report.analyzerModel && (
                  <div>
                    <p className="text-xs text-gray-500">Analyzer Model</p>
                    <p className="font-medium text-gray-900">{report.analyzerModel}</p>
                  </div>
                )}
                {report.analyzerSerialNumber && (
                  <div>
                    <p className="text-xs text-gray-500">Serial Number</p>
                    <p className="font-medium text-gray-900">{report.analyzerSerialNumber}</p>
                  </div>
                )}
                {report.ticketNumber && (
                  <div>
                    <p className="text-xs text-gray-500">Ticket #</p>
                    <p className="font-medium text-primary">{report.ticketNumber}</p>
                  </div>
                )}
              </div>
            </div>

            {/* Work Details */}
            <div className="p-5 border-b">
              <h3 className="text-sm font-semibold text-gray-500 uppercase mb-3">Work Performed</h3>
              <div className="space-y-4">
                {report.descriptionOfWork && (
                  <div>
                    <p className="text-xs text-gray-500 mb-1">Description of Work</p>
                    <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.descriptionOfWork}</p>
                  </div>
                )}
                {report.materialsUsed && (
                  <div>
                    <p className="text-xs text-gray-500 mb-1">Materials Used</p>
                    <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.materialsUsed}</p>
                  </div>
                )}
                {report.solution && (
                  <div>
                    <p className="text-xs text-gray-500 mb-1">Solution Provided</p>
                    <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.solution}</p>
                  </div>
                )}
                {report.outstandingIssues && (
                  <div>
                    <p className="text-xs text-gray-500 mb-1">Outstanding Issues / Recommendations</p>
                    <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.outstandingIssues}</p>
                  </div>
                )}

                {/* Validation-specific fields */}
                {isValidation && (
                  <>
                    {(report.validationStartDate || report.validationEndDate) && (
                      <div className="grid md:grid-cols-2 gap-4">
                        {report.validationStartDate && (
                          <div>
                            <p className="text-xs text-gray-500 mb-1">Validation Start Date</p>
                            <p className="text-sm font-medium">{formatDate(report.validationStartDate)}</p>
                          </div>
                        )}
                        {report.validationEndDate && (
                          <div>
                            <p className="text-xs text-gray-500 mb-1">Validation End Date</p>
                            <p className="text-sm font-medium">{formatDate(report.validationEndDate)}</p>
                          </div>
                        )}
                      </div>
                    )}
                    {report.testProcedures && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Test Procedures</p>
                        <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.testProcedures}</p>
                      </div>
                    )}
                    {report.trainingProvided && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Training Provided</p>
                        <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.trainingProvided}</p>
                      </div>
                    )}
                    {report.validationResults && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Validation Results</p>
                        <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.validationResults}</p>
                      </div>
                    )}
                  </>
                )}

                {report.recommendations && (
                  <div>
                    <p className="text-xs text-gray-500 mb-1">Recommendations</p>
                    <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.recommendations}</p>
                  </div>
                )}
              </div>
            </div>

            {/* Signatures */}
            <div className="p-5">
              <h3 className="text-sm font-semibold text-gray-500 uppercase mb-3">Signatures</h3>
              <div className="grid md:grid-cols-2 gap-6">
                {/* Technician Signature (always shown) */}
                <div>
                  <p className="text-xs text-gray-500 mb-2">Technician Signature</p>
                  {report.technicianSignature ? (
                    <div className="border rounded-lg p-3 bg-gray-50">
                      <img src={report.technicianSignature} alt="Technician Signature" className="max-h-20" />
                      <p className="text-xs text-gray-500 mt-2">Signed: {formatDate(report.technicianSignatureDate)}</p>
                    </div>
                  ) : (
                    <p className="text-gray-400 italic text-sm">No signature</p>
                  )}
                </div>

                {/* Customer Signature */}
                <div>
                  <p className="text-xs text-gray-500 mb-2">Customer Signature</p>
                  {report.customerSignature ? (
                    <div className="border rounded-lg p-3 bg-gray-50">
                      <img src={report.customerSignature} alt="Customer Signature" className="max-h-20" />
                      <p className="text-xs text-gray-500 mt-2">Signed: {formatDate(report.customerSignatureDate)}</p>
                    </div>
                  ) : needsSignature ? (
                    <div className="border-2 border-dashed border-orange-300 rounded-lg p-4 bg-orange-50 text-center">
                      <p className="text-sm text-orange-700 font-medium">Your signature is required</p>
                      <p className="text-xs text-orange-600 mt-1">Please sign below to complete this service report</p>
                    </div>
                  ) : (
                    <p className="text-gray-400 italic text-sm">No signature</p>
                  )}
                </div>
              </div>

              {/* Client Signing Section */}
              {needsSignature && !signSuccess && (
                <div className="mt-6 p-5 bg-orange-50 border border-orange-200 rounded-xl">
                  <h4 className="font-semibold text-orange-800 mb-1">Action Required: Sign This Service Report</h4>
                  <p className="text-sm text-orange-700 mb-4">
                    Your technician has completed the service work. Please review the report above and provide your signature below to confirm.
                  </p>

                  {!signing ? (
                    <button
                      onClick={() => setSigning(true)}
                      className="px-6 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-accent transition-colors"
                    >
                      Sign Service Report
                    </button>
                  ) : (
                    <div className="space-y-4">
                      <SignaturePad
                        label="Your Signature"
                        onSave={(sig) => setCustomerSignature(sig)}
                      />

                      {signError && (
                        <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700">{signError}</div>
                      )}

                      <div className="flex gap-3">
                        <button
                          onClick={handleSign}
                          disabled={submitting || !customerSignature}
                          className="px-6 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                        >
                          {submitting ? (
                            <><div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div> Submitting...</>
                          ) : (
                            <>
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" /></svg>
                              Submit Signature
                            </>
                          )}
                        </button>
                        <button
                          onClick={() => { setSigning(false); setCustomerSignature(''); setSignError(null); }}
                          className="px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Success message */}
              {signSuccess && (
                <div className="mt-6 p-5 bg-green-50 border border-green-200 rounded-xl text-center">
                  <svg className="w-12 h-12 text-green-500 mx-auto mb-3" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  <h4 className="font-semibold text-green-800 text-lg">Signature Submitted Successfully</h4>
                  <p className="text-sm text-green-700 mt-1">This service report is now complete. Thank you!</p>
                  <button onClick={onBack} className="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 text-sm">
                    Return to Service History
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const SupportPage = ({ settings, token, userData, documents, activeTab: propActiveTab, onTabChange, onNavigateToFile }) => {
      const [tickets, setTickets] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [localActiveTab, setLocalActiveTab] = useState(propActiveTab || 'history');
      const [expandedTicket, setExpandedTicket] = useState(null);
      const [statusFilter, setStatusFilter] = useState('all');

      // Derive service visit log from client_documents (slug-based, no separate API needed)
      const serviceReportDocs = (documents || []).filter(doc => doc.serviceReportId && doc.category === 'Service Reports');

      const activeTab = propActiveTab || localActiveTab;
      const setActiveTab = (tab) => {
        if (onTabChange) {
          onTabChange(tab);
        } else {
          setLocalActiveTab(tab);
        }
      };

      useEffect(() => {
        if (token) {
          fetchTickets();
        } else {
          setLoading(false);
        }
      }, [token]);

      const fetchTickets = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(`${API_URL}/api/client/hubspot/tickets`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          if (data.error) {
            setError(data.error);
          } else {
            setTickets(data.tickets || []);
          }
        } catch (err) {
          console.error('Error fetching support tickets:', err);
          setError('Unable to load support tickets');
        } finally {
          setLoading(false);
        }
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', {
          year: 'numeric', month: 'short', day: 'numeric'
        });
      };

      const filteredTickets = statusFilter === 'all' ? tickets
        : tickets.filter(t => t.status === statusFilter);

      return (
        <div className="space-y-6">
          {/* Hero Banner */}
          <div className="relative rounded-2xl overflow-hidden shadow-lg">
            <div className="absolute inset-0 bg-gradient-to-r from-blue-900/80 to-blue-700/60 z-10"></div>
            <img
              src="https://images.unsplash.com/photo-1579154204601-01588f351e67?w=1200&h=400&fit=crop"
              alt="Laboratory Equipment"
              className="w-full h-48 object-cover"
            />
            <div className="absolute inset-0 z-20 flex flex-col justify-center items-center text-white text-center px-6">
              <h1 className="text-3xl md:text-4xl font-bold drop-shadow-lg">Customer Support Center</h1>
              <p className="text-lg mt-2 opacity-90 drop-shadow">Thrive 365 Labs Client Portal</p>
            </div>
          </div>

          {/* Tab Navigation */}
          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            <div className="grid grid-cols-3 border-b">
              <button
                onClick={() => setActiveTab('history')}
                style={activeTab === 'history' ? {backgroundColor: '#045E9F', color: 'white'} : {}}
                className={`py-4 px-4 font-medium transition flex items-center justify-center gap-2 ${activeTab === 'history' ? '' : 'text-gray-600 hover:bg-gray-50 border-r'}`}
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                <span className="hidden sm:inline">Service History</span>
                <span className="sm:hidden">History</span>
                {serviceReportDocs.length > 0 && (
                  <span className="ml-1 w-5 h-5 rounded-full text-xs font-bold flex items-center justify-center bg-primary text-white">
                    {serviceReportDocs.length}
                  </span>
                )}
              </button>
              <button
                onClick={() => setActiveTab('tickets')}
                style={activeTab === 'tickets' ? {backgroundColor: '#045E9F', color: 'white'} : {}}
                className={`py-4 px-4 font-medium transition flex items-center justify-center gap-2 ${activeTab === 'tickets' ? '' : 'text-gray-600 hover:bg-gray-50 border-r'}`}
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                <span className="hidden sm:inline">Support Tickets</span>
                <span className="sm:hidden">Tickets</span>
              </button>
              <button
                onClick={() => setActiveTab('submit')}
                style={activeTab === 'submit' ? {backgroundColor: '#045E9F', color: 'white'} : {}}
                className={`py-4 px-4 font-medium transition flex items-center justify-center gap-2 ${activeTab === 'submit' ? '' : 'text-gray-600 hover:bg-gray-50'}`}
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                <span className="hidden sm:inline">Submit a Ticket</span>
                <span className="sm:hidden">Ticket</span>
              </button>
            </div>

            <div className="p-6">
              {/* Service History Tab - powered by client_documents, no separate API */}
              {activeTab === 'history' && (
                <div>
                  <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <h2 className="text-lg font-semibold text-gray-800">Your Service History</h2>
                    {serviceReportDocs.length > 1 && (
                      <div className="flex items-center gap-2">
                        <select value={reportSort} onChange={e => setReportSort(e.target.value)} className="text-xs border rounded-lg px-2 py-1.5 text-gray-600 focus:ring-1 focus:ring-primary">
                          <option value="date_desc">Newest First</option>
                          <option value="date_asc">Oldest First</option>
                          <option value="title_asc">Name A-Z</option>
                        </select>
                        <select value={reportStatusFilter} onChange={e => setReportStatusFilter(e.target.value)} className="text-xs border rounded-lg px-2 py-1.5 text-gray-600 focus:ring-1 focus:ring-primary">
                          <option value="">All</option>
                          <option value="signature_needed">Needs Signature</option>
                          <option value="submitted">Signed</option>
                        </select>
                      </div>
                    )}
                  </div>

                  {serviceReportDocs.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <div className="flex justify-center mb-4">
                        <svg className="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                      </div>
                      <p className="font-medium">No service visits yet</p>
                      <p className="text-sm mt-2">Service reports will appear here after visits are completed.</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {serviceReportDocs
                        .filter(d => !reportStatusFilter || d.reportStatus === reportStatusFilter)
                        .sort((a, b) => {
                          if (reportSort === 'date_asc') return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
                          if (reportSort === 'title_asc') return (a.title || '').localeCompare(b.title || '');
                          return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                        })
                        .map(doc => (
                        <div key={doc.id} className="border border-gray-200 rounded-lg p-4 flex items-center justify-between hover:bg-gray-50 transition">
                          <div className="flex items-center gap-3 flex-1 min-w-0">
                            <div className="flex-shrink-0 w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                              <svg className="w-5 h-5 text-primary" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            </div>
                            <div className="min-w-0">
                              <p className="font-medium text-gray-800 truncate">{doc.title || 'Service Report'}</p>
                              <p className="text-sm text-gray-500 mt-0.5">{formatDate(doc.createdAt)}</p>
                            </div>
                          </div>
                          {onNavigateToFile && (
                            <button
                              onClick={() => onNavigateToFile(doc.serviceReportId)}
                              className="ml-4 flex-shrink-0 flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-primary hover:text-accent hover:bg-primary/5 rounded-lg transition"
                            >
                              View Report
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Support Tickets Tab */}
              {activeTab === 'tickets' && (
                <div>
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-gray-800">Your Support Tickets</h2>
                    <div className="flex items-center gap-3">
                      <select
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        className="text-sm border rounded-lg px-3 py-1.5 text-gray-600 focus:outline-none focus:ring-2 focus:ring-primary/20"
                      >
                        <option value="all">All Tickets</option>
                        <option value="Open">Open</option>
                        <option value="Closed">Closed</option>
                      </select>
                      <button onClick={fetchTickets} className="text-primary hover:text-accent text-sm flex items-center gap-1">
                        {Icons.refresh || '\u21bb'} Refresh
                      </button>
                    </div>
                  </div>

                  {loading ? (
                    <div className="flex justify-center py-12">
                      <div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                    </div>
                  ) : error ? (
                    <div className="text-center py-12 text-red-500">
                      <p>{error}</p>
                      <button onClick={fetchTickets} className="mt-4 text-primary hover:underline">Try again</button>
                    </div>
                  ) : filteredTickets.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <div className="flex justify-center mb-4 text-green-400">{React.cloneElement(Icons.check, { className: 'w-16 h-16' })}</div>
                      <p className="font-medium">No support tickets</p>
                      <p className="text-sm mt-2">{statusFilter !== 'all' ? `No ${statusFilter.toLowerCase()} tickets found.` : 'No support tickets have been filed for your account yet.'}</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {filteredTickets.map(ticket => (
                        <div key={ticket.id} className="border rounded-lg overflow-hidden">
                          <button
                            onClick={() => setExpandedTicket(expandedTicket === ticket.id ? null : ticket.id)}
                            className="w-full p-4 flex items-center justify-between hover:bg-gray-50 transition text-left"
                          >
                            <div className="flex-1 min-w-0">
                              <p className="font-medium text-gray-800 truncate">{ticket.subject}</p>
                              <div className="flex flex-wrap items-center gap-3 mt-1 text-sm text-gray-500">
                                <span>Opened: {formatDate(ticket.createdAt)}</span>
                                {ticket.closedAt && <span>Closed: {formatDate(ticket.closedAt)}</span>}
                                {ticket.serviceReport && (
                                  <span className="text-primary font-medium flex items-center gap-1">
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    Service Report Attached
                                  </span>
                                )}
                              </div>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ml-3 ${
                              ticket.status === 'Open'
                                ? 'bg-blue-100 text-blue-700 border border-blue-200'
                                : 'bg-gray-100 text-gray-600 border border-gray-200'
                            }`}>
                              {ticket.status}
                            </span>
                          </button>
                          {expandedTicket === ticket.id && (
                            <div className="px-4 pb-4 border-t bg-gray-50">
                              {ticket.description && (
                                <div className="pt-3">
                                  <p className="text-xs font-medium text-gray-500 mb-1">Description:</p>
                                  <p className="text-sm text-gray-600 whitespace-pre-wrap">{ticket.description}</p>
                                </div>
                              )}
                              {/* Linked Service Report */}
                              {ticket.serviceReport && (
                                <div className="mt-3 pt-3 border-t border-gray-200">
                                  <p className="text-xs font-medium text-gray-500 mb-2">Service Report:</p>
                                  <div className="bg-white rounded-lg border p-3">
                                    <div className="flex items-start justify-between">
                                      <div className="flex-1">
                                        <p className="font-medium text-sm text-gray-800">{ticket.serviceReport.serviceType}</p>
                                        <p className="text-xs text-gray-500 mt-1">
                                          Technician: {ticket.serviceReport.technicianName} &middot; Completed: {formatDate(ticket.serviceReport.completedAt)}
                                        </p>
                                        {ticket.serviceReport.description && (
                                          <p className="text-xs text-gray-500 mt-1 line-clamp-2">{ticket.serviceReport.description}</p>
                                        )}
                                      </div>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          window.open(`${API_URL}/api/client/service-reports/${ticket.serviceReport.id}/pdf?token=${encodeURIComponent(token)}`, '_blank');
                                        }}
                                        className="ml-3 flex items-center gap-1 px-3 py-1.5 bg-primary text-white text-xs font-medium rounded-lg hover:bg-accent transition whitespace-nowrap"
                                      >
                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                        Download PDF
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Submit Ticket Tab */}
              {activeTab === 'submit' && (
                <div className="grid md:grid-cols-2 gap-8 items-stretch min-h-[500px]">
                  {/* Left Side - Header */}
                  <div className="bg-white rounded-xl flex flex-col justify-center items-center text-center p-8">
                    <h2 className="text-4xl font-bold text-gray-800 mb-6">Submit a Ticket</h2>
                    <p className="text-gray-500 text-lg">
                      <span className="italic">or</span> email us at{' '}
                      <a href="mailto:support@thrive365labs.com" className="text-primary hover:text-accent font-semibold">
                        support@thrive365labs.com
                      </a>
                    </p>
                  </div>

                  {/* Right Side - Form */}
                  <div className="bg-white rounded-xl shadow-sm border p-6">
                    <p className="text-gray-500 text-sm text-center mb-4">Agent response within 24-48 hours</p>
                    <div
                      className="hs-form-frame"
                      data-region="na1"
                      data-form-id="089d904f-4acb-4ff7-8c61-53ee99e12345"
                      data-portal-id="49020024"
                      ref={(el) => {
                        if (el && !document.getElementById('hs-form-script')) {
                          const script = document.createElement('script');
                          script.id = 'hs-form-script';
                          script.src = 'https://js.hsforms.net/forms/embed/49020024.js';
                          script.defer = true;
                          document.body.appendChild(script);
                        }
                      }}
                    ></div>
                  </div>
                </div>
              )}

            </div>
          </div>
        </div>
      );
    };
    
    const FilesPage = ({ settings, documents: initialDocuments, token, projects, userData, highlightServiceReportId }) => {
      const [documents, setDocuments] = useState(initialDocuments || []);
      const [selectedFile, setSelectedFile] = useState(null);
      const [category, setCategory] = useState('');
      const [note, setNote] = useState('');
      const [uploading, setUploading] = useState(false);
      const [uploadMessage, setUploadMessage] = useState(null);
      const [signingReportId, setSigningReportId] = useState(null);
      const [customerSignature, setCustomerSignature] = useState('');
      const [signSubmitting, setSignSubmitting] = useState(false);
      const [signError, setSignError] = useState(null);
      const [reportSort, setReportSort] = useState('date_desc');
      const [reportStatusFilter, setReportStatusFilter] = useState('');
      const highlightRef = useRef(null);

      const slug = localStorage.getItem('portal_user') ? JSON.parse(localStorage.getItem('portal_user')).slug : null;

      // Check if user has any HubSpot IDs configured for uploads
      const hasHubSpotConfig = userData?.hubspotCompanyId || userData?.hubspotDealId || userData?.hubspotContactId;

      // Scroll to highlighted report when navigating from Service History
      useEffect(() => {
        if (highlightServiceReportId && highlightRef.current) {
          setTimeout(() => {
            highlightRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }, [highlightServiceReportId, documents]);

      const refreshDocuments = async () => {
        if (!slug) return;
        try {
          const response = await fetch(`${API_URL}/api/client-documents/${slug}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          setDocuments(data || []);
        } catch (err) {
          console.error('Failed to refresh documents:', err);
        }
      };

      // Handle signing a service report from the Files area
      const handleSignReport = async () => {
        if (!signingReportId) return;
        if (!customerSignature || !customerSignature.startsWith('data:image')) {
          setSignError('Please provide your signature before submitting.');
          return;
        }
        setSignSubmitting(true);
        setSignError(null);
        try {
          const response = await fetch(`${API_URL}/api/client/service-reports/${signingReportId}/sign`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              customerSignature,
              customerSignatureDate: new Date().toISOString().split('T')[0]
            })
          });
          const result = await response.json();
          if (!response.ok) {
            setSignError(result.error || 'Failed to submit signature');
            return;
          }
          // Update status locally, close modal, refresh docs
          setDocuments(prev => prev.map(d => d.serviceReportId === signingReportId ? { ...d, reportStatus: 'submitted' } : d));
          const signedId = signingReportId;
          setSigningReportId(null);
          setCustomerSignature('');
          refreshDocuments();
          // Open the now-signed report PDF in a new tab
          try {
            window.open(`${API_URL}/api/client/service-reports/${signedId}/pdf?token=${encodeURIComponent(token)}`, '_blank');
          } catch (dlErr) {
            console.error('Auto-download after signing failed:', dlErr);
          }
        } catch (err) {
          setSignError('Network error. Please try again.');
        } finally {
          setSignSubmitting(false);
        }
      };

      const adminDocs = (documents || []).filter(doc => doc.uploadedBy !== 'client');
      const clientUploads = (documents || []).filter(doc => doc.uploadedBy === 'client');
      
      const groupedAdminDocs = adminDocs.reduce((acc, doc) => {
        const cat = doc.category || 'General';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(doc);
        return acc;
      }, {});
      
      const categories = ['Contracts', 'Onboarding', 'Inserts', 'Certificates of Analysis', 'Analyzer', 'Other'];
      
      const handleFileUpload = async (e) => {
        e.preventDefault();
        if (!selectedFile) {
          setUploadMessage({ type: 'error', text: 'Please select a file' });
          return;
        }
        
        setUploading(true);
        setUploadMessage(null);
        
        try {
          const formData = new FormData();
          formData.append('file', selectedFile);
          formData.append('category', category);
          formData.append('noteText', note);
          
          const response = await fetch(`${API_URL}/api/client/hubspot/upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
          });
          
          const result = await response.json();
          
          if (response.ok) {
            setUploadMessage({ type: 'success', text: result.message || 'File uploaded successfully!' });
            setSelectedFile(null);
            setNote('');
            setCategory('');
            document.getElementById('clientFileInput').value = '';
            refreshDocuments();
          } else {
            setUploadMessage({ type: 'error', text: result.error || 'Upload failed' });
          }
        } catch (error) {
          setUploadMessage({ type: 'error', text: 'Failed to upload file. Please try again.' });
        } finally {
          setUploading(false);
        }
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent">Files</h1>
            <p className="text-gray-600 mt-1">Access your documents and upload files</p>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span>üì•</span> Documents From Thrive 365 Labs
            </h2>
            {adminDocs.length > 0 ? (
              <div className="space-y-4">
                {Object.entries(groupedAdminDocs).map(([cat, docs]) => (
                  <div key={cat}>
                    <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">{cat}</h3>
                    <div className="space-y-2">
                      {docs.map(doc => {
                        const reportStatus = doc.serviceReportId ? doc.reportStatus : null;
                        const needsSignature = reportStatus === 'signature_needed';
                        const isSigned = reportStatus === 'submitted';
                        const isHighlighted = highlightServiceReportId && doc.serviceReportId === highlightServiceReportId;

                        const handleDocAction = (e) => {
                          e.preventDefault();
                          if (doc.serviceReportId) {
                            if (needsSignature) {
                              setSigningReportId(doc.serviceReportId);
                              return;
                            }
                            window.open(`${API_URL}/api/client/service-reports/${doc.serviceReportId}/pdf?token=${encodeURIComponent(token)}`, '_blank');
                          }
                        };

                        // Non-service-report documents: simple download link
                        if (!doc.serviceReportId) {
                          return (
                            <a
                              key={doc.id}
                              href={doc.url || '#'}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="flex items-center gap-3 p-3 rounded-lg border hover:bg-gray-50 transition group cursor-pointer"
                            >
                              <span className="text-2xl">üìÑ</span>
                              <div className="flex-1">
                                <p className="font-medium text-gray-800 group-hover:text-primary">{doc.title}</p>
                                {doc.description && <p className="text-sm text-gray-500">{doc.description}</p>}
                              </div>
                              <span className="text-primary text-sm font-medium flex items-center gap-1">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Download
                              </span>
                            </a>
                          );
                        }

                        // Service report documents: signature-aware rendering
                        return (
                          <div
                            key={doc.id}
                            ref={isHighlighted ? highlightRef : null}
                            className={`flex items-center gap-3 p-3 rounded-lg border transition ${
                              isHighlighted ? 'ring-2 ring-primary bg-primary/5 border-primary/30' :
                              needsSignature ? 'border-orange-200 bg-orange-50/50' :
                              'hover:bg-gray-50'
                            }`}
                          >
                            <span className="text-2xl">üìã</span>
                            <div className="flex-1 min-w-0">
                              <p className="font-medium text-gray-800">{doc.title}</p>
                              {doc.description && <p className="text-sm text-gray-500">{doc.description}</p>}
                              {needsSignature && (
                                <p className="text-xs text-orange-600 font-medium mt-1">Signature required before download</p>
                              )}
                            </div>
                            {needsSignature ? (
                              <button
                                onClick={handleDocAction}
                                className="flex-shrink-0 flex items-center gap-1.5 px-3 py-2 bg-orange-500 text-white text-sm font-medium rounded-lg hover:bg-orange-600 transition whitespace-nowrap"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                Sign & Download
                              </button>
                            ) : (
                              <button
                                onClick={handleDocAction}
                                className="flex-shrink-0 flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 transition whitespace-nowrap"
                              >
                                {isSigned && <span className="text-green-600 text-xs font-semibold">‚úì Signed</span>}
                                <span className="text-primary flex items-center gap-1">
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                  Download PDF
                                </span>
                              </button>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">üìÇ</div>
                <p>No documents from Thrive 365 Labs yet.</p>
              </div>
            )}
          </div>
          
          {clientUploads.length > 0 && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>üì§</span> Your Uploaded Files
              </h2>
              <p className="text-sm text-gray-500 mb-4">Files you've uploaded to Thrive 365 Labs</p>
              <div className="space-y-2">
                {clientUploads.map(doc => (
                  <div
                    key={doc.id}
                    className="flex items-center gap-3 p-3 rounded-lg border bg-green-50 border-green-200"
                  >
                    <span className="text-2xl">‚úÖ</span>
                    <div className="flex-1">
                      <p className="font-medium text-gray-800">{doc.title}</p>
                      <div className="flex flex-wrap gap-2 text-xs text-gray-500 mt-1">
                        {doc.category && <span className="bg-gray-100 px-2 py-0.5 rounded">{doc.category}</span>}
                        <span>Uploaded {new Date(doc.createdAt).toLocaleDateString()}</span>
                        {doc.projectName && <span>‚Ä¢ {doc.projectName}</span>}
                      </div>
                      {doc.description && (
                        <p className="text-sm text-gray-600 mt-1">{doc.description}</p>
                      )}
                    </div>
                    {doc.hubspotFileUrl ? (
                      <a 
                        href={doc.hubspotFileUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-primary text-sm font-medium hover:underline"
                      >
                        View ‚Üí
                      </a>
                    ) : (
                      <span className="text-green-600 text-sm font-medium">‚úì Uploaded</span>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {hasHubSpotConfig && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>üì§</span> Upload Files to Thrive 365 Labs
              </h2>
              <p className="text-gray-600 text-sm mb-4">
                Upload documents directly to your account record. Accepted formats: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, GIF, TXT, CSV (max 10MB)
              </p>
              
              {uploadMessage && (
                <div className={`p-3 rounded-lg mb-4 ${uploadMessage.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                  {uploadMessage.text}
                </div>
              )}
              
              <form onSubmit={handleFileUpload} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">File</label>
                  <input
                    id="clientFileInput"
                    type="file"
                    onChange={(e) => setSelectedFile(e.target.files[0])}
                    className="w-full border rounded-lg p-2"
                    accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.txt,.csv"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Note (optional)</label>
                  <textarea
                    value={note}
                    onChange={(e) => setNote(e.target.value)}
                    className="w-full border rounded-lg p-2"
                    rows="2"
                    placeholder="Add a note about this file..."
                  />
                </div>
                
                <button
                  type="submit"
                  disabled={uploading || !selectedFile}
                  className="w-full bg-primary text-white py-2 px-4 rounded-lg font-medium hover:bg-accent transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {uploading ? 'Uploading...' : 'Upload File'}
                </button>
              </form>
            </div>
          )}

          {settings?.filesFormEmbed && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>üìù</span> Additional Upload Options
              </h2>
              <div dangerouslySetInnerHTML={{ __html: (() => {
                // Sanitize embed HTML: strip script tags and event handlers
                let html = settings.filesFormEmbed;
                html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                html = html.replace(/\son\w+\s*=\s*["'][^"']*["']/gi, '');
                html = html.replace(/\son\w+\s*=\s*[^\s>]*/gi, '');
                html = html.replace(/javascript\s*:/gi, '');
                return html;
              })() }} />
            </div>
          )}

          {/* Signature Modal for unsigned service reports */}
          {signingReportId && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => { setSigningReportId(null); setCustomerSignature(''); setSignError(null); }}>
              <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 space-y-4" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-bold text-gray-900">Sign Service Report</h3>
                  <button onClick={() => { setSigningReportId(null); setCustomerSignature(''); setSignError(null); }} className="text-gray-400 hover:text-gray-600">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                </div>

                <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                  <p className="text-sm text-orange-800">
                    Your signature is required to acknowledge this service report. Once signed, the report PDF will download automatically.
                  </p>
                </div>

                <SignaturePad
                  label="Your Signature"
                  onSave={(sig) => setCustomerSignature(sig)}
                />

                {signError && (
                  <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-700">{signError}</div>
                )}

                <div className="flex gap-3 pt-2">
                  <button
                    onClick={() => { setSigningReportId(null); setCustomerSignature(''); setSignError(null); }}
                    className="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition"
                    disabled={signSubmitting}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSignReport}
                    disabled={signSubmitting || !customerSignature}
                    className="flex-1 px-4 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-accent transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {signSubmitting ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                        Submitting...
                      </>
                    ) : (
                      <>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        Sign & Download
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };
    
    // ============== ADMIN PORTAL PAGES ==============
    
    const AdminHomePage = ({ token }) => {
      const [stats, setStats] = useState({ clients: 0, announcements: 0, documents: 0 });
      
      useEffect(() => {
        const loadStats = async () => {
          try {
            const [clientsRes, announcementsRes] = await Promise.all([
              fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
              fetch(`${API_URL}/api/announcements`).then(r => r.json())
            ]);
            setStats({
              clients: Array.isArray(clientsRes) ? clientsRes.filter(u => u.role === 'client').length : 0,
              announcements: Array.isArray(announcementsRes) ? announcementsRes.length : 0
            });
          } catch (err) {
            console.error('Failed to load stats:', err);
          }
        };
        loadStats();
      }, [token]);
      
      return (
        <div className="space-y-6">
          {/* Dynamic Banner Header */}
          <div className="relative rounded-2xl overflow-hidden shadow-lg" style={{minHeight: '180px'}}>
            <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-client.jpg)'}}></div>
            <div className="absolute inset-0 bg-gradient-to-r from-accent/90 via-primary/70 to-transparent"></div>
            <div className="relative p-6 md:p-8 flex items-center min-h-[180px]">
              <div className="text-white">
                <h1 className="text-2xl md:text-3xl font-bold drop-shadow-sm">Admin Portal Dashboard</h1>
                <p className="mt-2 text-white/90 text-sm max-w-md">Manage your client portal settings and content</p>
              </div>
            </div>
          </div>
          
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-primary">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-500 text-sm">Client Users</p>
                  <p className="text-3xl font-bold text-accent">{stats.clients}</p>
                </div>
                <div className="text-primary opacity-50">{React.cloneElement(AdminIcons.users, { className: 'w-12 h-12' })}</div>
              </div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-500 text-sm">Announcements</p>
                  <p className="text-3xl font-bold text-accent">{stats.announcements}</p>
                </div>
                <div className="text-green-500 opacity-50">{React.cloneElement(Icons.megaphone, { className: 'w-12 h-12' })}</div>
              </div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-500 text-sm">Portal Status</p>
                  <p className="text-lg font-bold text-green-600">Active</p>
                </div>
                <div className="text-orange-500 opacity-50">{React.cloneElement(AdminIcons.settings, { className: 'w-12 h-12' })}</div>
              </div>
            </div>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-accent mb-4">Quick Actions</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <a href="/admin" className="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-primary/10 transition group">
                <span className="text-primary">{AdminIcons.settings}</span>
                <span className="font-medium text-gray-700 group-hover:text-primary">Admin Hub</span>
              </a>
              <a href="/launch" className="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-primary/10 transition group">
                <span className="text-primary">{AdminIcons.back}</span>
                <span className="font-medium text-gray-700 group-hover:text-primary">Launch App</span>
              </a>
              <a href="/login" className="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-primary/10 transition group">
                <span className="text-primary">{Icons.home}</span>
                <span className="font-medium text-gray-700 group-hover:text-primary">Portal Hub</span>
              </a>
            </div>
          </div>
        </div>
      );
    };
    
    const AdminSettingsPage = ({ token, settings, onSettingsChange }) => {
      const [formData, setFormData] = useState({
        filesFormEmbed: settings?.filesFormEmbed || '',
        supportUrl: settings?.supportUrl || ''
      });
      const [saving, setSaving] = useState(false);
      const [message, setMessage] = useState('');
      
      const handleSave = async () => {
        setSaving(true);
        setMessage('');
        try {
          const res = await fetch(`${API_URL}/api/portal-settings`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          if (res.ok) {
            setMessage('Settings saved successfully!');
            if (onSettingsChange) onSettingsChange(formData);
          } else {
            const data = await res.json();
            setMessage(data.error || 'Failed to save settings');
          }
        } catch (err) {
          setMessage('Error saving settings');
        } finally {
          setSaving(false);
        }
      };
      
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent mb-2">Portal Settings</h1>
            <p className="text-gray-600">Configure HubSpot embed codes and support settings</p>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm space-y-6">
            {message && (
              <div className={`p-4 rounded-lg ${message.includes('success') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                {message}
              </div>
            )}

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Files Upload Form Embed Code (HubSpot)</label>
              <textarea
                value={formData.filesFormEmbed}
                onChange={(e) => setFormData({ ...formData, filesFormEmbed: e.target.value })}
                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary h-32 font-mono text-sm"
                placeholder="Paste HubSpot embed code here..."
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Customer Support URL</label>
              <input
                type="url"
                value={formData.supportUrl}
                onChange={(e) => setFormData({ ...formData, supportUrl: e.target.value })}
                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                placeholder="https://support.example.com"
              />
            </div>
            
            <button
              onClick={handleSave}
              disabled={saving}
              className="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-accent transition disabled:opacity-50"
            >
              {saving ? 'Saving...' : 'Save Settings'}
            </button>
          </div>
        </div>
      );
    };
    
    const AdminAnnouncementsPage = ({ token }) => {
      const [announcements, setAnnouncements] = useState([]);
      const [clients, setClients] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [formData, setFormData] = useState({
        title: '',
        content: '',
        type: 'info',
        priority: false,
        pinned: false,
        targetAll: true,
        targetClients: [],
        attachmentUrl: '',
        attachmentName: ''
      });

      const loadAnnouncements = async () => {
        try {
          const res = await fetch(`${API_URL}/api/announcements`);
          const data = await res.json();
          setAnnouncements(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error('Failed to load announcements:', err);
        } finally {
          setLoading(false);
        }
      };

      const loadClients = async () => {
        try {
          const res = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
          const data = await res.json();
          setClients(Array.isArray(data) ? data.filter(u => u.role === 'client') : []);
        } catch (err) {
          console.error('Failed to load clients:', err);
        }
      };

      useEffect(() => {
        loadAnnouncements();
        loadClients();
      }, []);

      const handleSave = async () => {
        try {
          const method = editingId ? 'PUT' : 'POST';
          const url = editingId ? `${API_URL}/api/announcements/${editingId}` : `${API_URL}/api/announcements`;
          const res = await fetch(url, {
            method,
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          if (res.ok) {
            setShowForm(false);
            setEditingId(null);
            setFormData({ title: '', content: '', type: 'info', priority: false, pinned: false, targetAll: true, targetClients: [], attachmentUrl: '', attachmentName: '' });
            loadAnnouncements();
          } else {
            const errData = await res.json().catch(() => ({}));
            alert(errData.error || 'Failed to save announcement');
          }
        } catch (err) {
          console.error('Failed to save:', err);
          alert('Failed to save announcement. Please try again.');
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Delete this announcement?')) return;
        try {
          await fetch(`${API_URL}/api/announcements/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          loadAnnouncements();
        } catch (err) {
          console.error('Failed to delete:', err);
        }
      };

      const startEdit = (ann) => {
        setFormData({
          title: ann.title,
          content: ann.content,
          type: ann.type || 'info',
          priority: ann.priority || false,
          pinned: ann.pinned || false,
          targetAll: ann.targetAll !== false,
          targetClients: ann.targetClients || [],
          attachmentUrl: ann.attachmentUrl || '',
          attachmentName: ann.attachmentName || ''
        });
        setEditingId(ann.id);
        setShowForm(true);
      };

      const toggleClientSelection = (slug) => {
        const current = formData.targetClients || [];
        if (current.includes(slug)) {
          setFormData({ ...formData, targetClients: current.filter(s => s !== slug) });
        } else {
          setFormData({ ...formData, targetClients: [...current, slug] });
        }
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold text-accent">Announcements Manager</h1>
              <p className="text-gray-600">Create and manage portal announcements</p>
            </div>
            <button
              onClick={() => { setShowForm(true); setEditingId(null); setFormData({ title: '', content: '', type: 'info', priority: false, pinned: false, targetAll: true, targetClients: [], attachmentUrl: '', attachmentName: '' }); }}
              className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition flex items-center gap-2"
            >
              <span>+</span> New Announcement
            </button>
          </div>

          {showForm && (
            <div className="bg-white p-6 rounded-xl shadow-sm border-2 border-primary/20">
              <h2 className="text-lg font-bold mb-4">{editingId ? 'Edit Announcement' : 'New Announcement'}</h2>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                  <input
                    type="text"
                    value={formData.title}
                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Content</label>
                  <textarea
                    value={formData.content}
                    onChange={(e) => setFormData({ ...formData, content: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary h-32"
                    placeholder="Write your full announcement content here..."
                  />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select
                      value={formData.type}
                      onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                    >
                      <option value="info">Info (Blue)</option>
                      <option value="success">Success (Green)</option>
                      <option value="warning">Warning (Yellow)</option>
                    </select>
                  </div>

                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">Options</label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={formData.priority}
                        onChange={(e) => setFormData({ ...formData, priority: e.target.checked })}
                        className="rounded text-primary focus:ring-primary"
                      />
                      <span className="text-sm text-gray-700">Mark as Priority</span>
                      <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">Shows disclaimer</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={formData.pinned}
                        onChange={(e) => setFormData({ ...formData, pinned: e.target.checked })}
                        className="rounded text-primary focus:ring-primary"
                      />
                      <span className="text-sm text-gray-700">Pin to Top</span>
                      <span className="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">Always visible first</span>
                    </label>
                  </div>
                </div>

                <div className="border-t pt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Target Audience</label>
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="targetAudience"
                        checked={formData.targetAll}
                        onChange={() => setFormData({ ...formData, targetAll: true, targetClients: [] })}
                        className="text-primary focus:ring-primary"
                      />
                      <span className="text-sm text-gray-700">Send to All Clients</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="targetAudience"
                        checked={!formData.targetAll}
                        onChange={() => setFormData({ ...formData, targetAll: false })}
                        className="text-primary focus:ring-primary"
                      />
                      <span className="text-sm text-gray-700">Send to Specific Clients</span>
                    </label>

                    {!formData.targetAll && (
                      <div className="ml-6 mt-2 p-3 bg-gray-50 rounded-lg max-h-48 overflow-y-auto">
                        {clients.length === 0 ? (
                          <p className="text-sm text-gray-500">No clients found</p>
                        ) : (
                          <div className="space-y-2">
                            {clients.map(client => (
                              <label key={client.id} className="flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded">
                                <input
                                  type="checkbox"
                                  checked={(formData.targetClients || []).includes(client.slug)}
                                  onChange={() => toggleClientSelection(client.slug)}
                                  className="rounded text-primary focus:ring-primary"
                                />
                                <span className="text-sm text-gray-700">{client.practiceName || client.name}</span>
                                <span className="text-xs text-gray-400">({client.email})</span>
                              </label>
                            ))}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                <div className="border-t pt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Attachment (Optional)</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">File Name</label>
                      <input
                        type="text"
                        value={formData.attachmentName}
                        onChange={(e) => setFormData({ ...formData, attachmentName: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary text-sm"
                        placeholder="e.g., Product Update Guide.pdf"
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">File URL</label>
                      <input
                        type="url"
                        value={formData.attachmentUrl}
                        onChange={(e) => setFormData({ ...formData, attachmentUrl: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary text-sm"
                        placeholder="https://drive.google.com/..."
                      />
                    </div>
                  </div>
                  <p className="text-xs text-gray-500 mt-1">Add a link to a downloadable file (Google Drive, Dropbox, etc.)</p>
                </div>

                <div className="flex gap-2 pt-2">
                  <button onClick={handleSave} className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent">
                    {editingId ? 'Update' : 'Create'}
                  </button>
                  <button onClick={() => { setShowForm(false); setEditingId(null); }} className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
          
          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            {loading ? (
              <div className="p-8 text-center text-gray-500">Loading...</div>
            ) : announcements.length === 0 ? (
              <div className="p-8 text-center text-gray-500">No announcements yet</div>
            ) : (
              <div className="divide-y">
                {/* Sort: pinned first, then by date */}
                {[...announcements].sort((a, b) => {
                  if (a.pinned && !b.pinned) return -1;
                  if (!a.pinned && b.pinned) return 1;
                  return new Date(b.createdAt) - new Date(a.createdAt);
                }).map(ann => (
                  <div key={ann.id} className={`p-4 flex flex-col sm:flex-row sm:items-start justify-between gap-4 ${ann.pinned ? 'bg-blue-50/50' : ''} ${ann.priority ? 'border-l-4 border-red-500' : ''}`}>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 flex-wrap">
                        {ann.pinned && <span className="text-blue-600 text-xs font-medium">üìå PINNED</span>}
                        {ann.priority && <span className="text-red-600 text-xs font-medium bg-red-100 px-2 py-0.5 rounded">PRIORITY</span>}
                        <h3 className="font-semibold text-gray-800">{ann.title}</h3>
                        <span className={`px-2 py-0.5 text-xs rounded ${
                          ann.type === 'warning' ? 'bg-yellow-100 text-yellow-700' :
                          ann.type === 'success' ? 'bg-green-100 text-green-700' :
                          'bg-blue-100 text-blue-700'
                        }`}>{ann.type || 'info'}</span>
                      </div>
                      <p className="text-sm text-gray-600 mt-1 line-clamp-2">{ann.content}</p>
                      <div className="flex items-center gap-3 mt-2 flex-wrap">
                        <span className="text-xs text-gray-400">{new Date(ann.createdAt).toLocaleDateString()}</span>
                        {ann.targetAll === false && ann.targetClients?.length > 0 && (
                          <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">
                            {ann.targetClients.length} client{ann.targetClients.length !== 1 ? 's' : ''} targeted
                          </span>
                        )}
                        {ann.attachmentUrl && (
                          <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded flex items-center gap-1">
                            üìé {ann.attachmentName || 'Attachment'}
                          </span>
                        )}
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => startEdit(ann)} className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded">Edit</button>
                      <button onClick={() => handleDelete(ann.id)} className="px-3 py-1 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded">Delete</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };
    
    const AdminDocumentsPage = ({ token }) => {
      const [clients, setClients] = useState([]);
      const [selectedClient, setSelectedClient] = useState('');
      const [documents, setDocuments] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [formData, setFormData] = useState({ title: '', url: '', description: '', category: '' });
      const [uploadFile, setUploadFile] = useState(null);
      const [uploadMode, setUploadMode] = useState('link');
      const [uploading, setUploading] = useState(false);
      
      useEffect(() => {
        const loadClients = async () => {
          try {
            const res = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            setClients(Array.isArray(data) ? data.filter(u => u.role === 'client') : []);
          } catch (err) {
            console.error('Failed to load clients:', err);
          } finally {
            setLoading(false);
          }
        };
        loadClients();
      }, [token]);
      
      useEffect(() => {
        if (selectedClient) {
          const loadDocs = async () => {
            try {
              if (selectedClient === 'all') {
                // Load all documents and filter to only show shared ones
                const res = await fetch(`${API_URL}/api/client-documents`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                setDocuments(Array.isArray(data) ? data.filter(d => d.shareWithAll === true) : []);
              } else {
                const res = await fetch(`${API_URL}/api/client-documents/${selectedClient}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                setDocuments(Array.isArray(data) ? data : []);
              }
            } catch (err) {
              console.error('Failed to load docs:', err);
            }
          };
          loadDocs();
        }
      }, [selectedClient, token]);
      
      const handleAdd = async () => {
        setUploading(true);
        const isAllClients = selectedClient === 'all';
        try {
          if (uploadMode === 'file' && uploadFile) {
            const formDataObj = new FormData();
            formDataObj.append('file', uploadFile);
            formDataObj.append('title', formData.title);
            formDataObj.append('description', formData.description);
            formDataObj.append('category', formData.category);

            const res = await fetch(`${API_URL}/api/client-documents/${selectedClient}/upload`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` },
              body: formDataObj
            });
            if (res.ok) {
              setShowForm(false);
              setFormData({ title: '', url: '', description: '', category: '' });
              setUploadFile(null);
              setUploadMode('link');
              // Reload documents
              if (isAllClients) {
                const data = await fetch(`${API_URL}/api/client-documents`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json());
                setDocuments(Array.isArray(data) ? data.filter(d => d.shareWithAll === true) : []);
              } else {
                const data = await fetch(`${API_URL}/api/client-documents/${selectedClient}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json());
                setDocuments(Array.isArray(data) ? data : []);
              }
            }
          } else {
            // Link-based document - use the base endpoint with slug/shareWithAll in body
            const docPayload = {
              ...formData,
              slug: isAllClients ? null : selectedClient,
              shareWithAll: isAllClients
            };
            const res = await fetch(`${API_URL}/api/client-documents`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
              body: JSON.stringify(docPayload)
            });
            if (res.ok) {
              setShowForm(false);
              setFormData({ title: '', url: '', description: '', category: '' });
              // Reload documents
              if (isAllClients) {
                const data = await fetch(`${API_URL}/api/client-documents`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json());
                setDocuments(Array.isArray(data) ? data.filter(d => d.shareWithAll === true) : []);
              } else {
                const data = await fetch(`${API_URL}/api/client-documents/${selectedClient}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json());
                setDocuments(Array.isArray(data) ? data : []);
              }
            }
          }
        } catch (err) {
          console.error('Failed to add doc:', err);
        } finally {
          setUploading(false);
        }
      };
      
      const handleDelete = async (docId) => {
        if (!confirm('Delete this document?')) return;
        const isAllClients = selectedClient === 'all';
        try {
          // Use the ID-only delete endpoint for shared documents or slug-based for specific clients
          const deleteUrl = isAllClients
            ? `${API_URL}/api/client-documents/${docId}`
            : `${API_URL}/api/client-documents/${selectedClient}/${docId}`;
          await fetch(deleteUrl, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          // Reload documents
          if (isAllClients) {
            const data = await fetch(`${API_URL}/api/client-documents`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json());
            setDocuments(Array.isArray(data) ? data.filter(d => d.shareWithAll === true) : []);
          } else {
            const data = await fetch(`${API_URL}/api/client-documents/${selectedClient}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json());
            setDocuments(Array.isArray(data) ? data : []);
          }
        } catch (err) {
          console.error('Failed to delete doc:', err);
        }
      };
      
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent mb-2">Client Documents</h1>
            <p className="text-gray-600">Manage documents for each client portal</p>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <label className="block text-sm font-medium text-gray-700 mb-2">Select Client</label>
            <select
              value={selectedClient}
              onChange={(e) => setSelectedClient(e.target.value)}
              className="w-full md:w-1/2 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">-- Select a client --</option>
              <option value="all" className="font-semibold text-primary">All Clients (Share with Everyone)</option>
              {clients.map(c => (
                <option key={c.id} value={c.slug}>{c.practiceName || c.name} ({c.email})</option>
              ))}
            </select>
            {selectedClient === 'all' && (
              <p className="mt-2 text-sm text-blue-600 flex items-center gap-1">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Documents uploaded here will be visible to all client portals
              </p>
            )}
          </div>
          
          {selectedClient && (
            <>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h2 className="text-lg font-semibold text-gray-800">
                  {selectedClient === 'all'
                    ? 'Documents Shared with All Clients'
                    : `Documents for ${clients.find(c => c.slug === selectedClient)?.practiceName || selectedClient}`}
                </h2>
                <button
                  onClick={() => setShowForm(true)}
                  className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition"
                >
                  + Add Document
                </button>
              </div>
              
              {showForm && (
                <div className="bg-white p-6 rounded-xl shadow-sm border-2 border-primary/20">
                  <h3 className="text-lg font-bold mb-4">Add Document</h3>
                  
                  <div className="flex gap-4 mb-4">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="uploadMode"
                        checked={uploadMode === 'link'}
                        onChange={() => setUploadMode('link')}
                        className="text-primary"
                      />
                      <span className="text-sm font-medium">Cloud Link</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="uploadMode"
                        checked={uploadMode === 'file'}
                        onChange={() => setUploadMode('file')}
                        className="text-primary"
                      />
                      <span className="text-sm font-medium">Upload File</span>
                    </label>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                      <input
                        type="text"
                        value={formData.title}
                        onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                      />
                    </div>
                    
                    {uploadMode === 'link' ? (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">URL</label>
                        <input
                          type="url"
                          value={formData.url}
                          onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                          placeholder="https://..."
                        />
                      </div>
                    ) : (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">File</label>
                        <input
                          type="file"
                          onChange={(e) => setUploadFile(e.target.files[0])}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                          accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.txt,.csv"
                        />
                        <p className="text-xs text-gray-500 mt-1">PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, GIF, TXT, CSV (max 10MB)</p>
                      </div>
                    )}
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                      <select
                        value={formData.category}
                        onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                      >
                        <option value="">Select a category...</option>
                        <option value="Contracts">Contracts</option>
                        <option value="Onboarding">Onboarding</option>
                        <option value="Inserts">Inserts</option>
                        <option value="Certificates of Analysis">Certificates of Analysis</option>
                        <option value="SOP Templates">SOP Templates</option>
                        <option value="Analyzer">Analyzer</option>
                        <option value="Service Reports">Service Reports</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                      <input
                        type="text"
                        value={formData.description}
                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                      />
                    </div>
                  </div>
                  <div className="flex gap-2 mt-4">
                    <button 
                      onClick={handleAdd} 
                      disabled={uploading}
                      className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent disabled:opacity-50"
                    >
                      {uploading ? 'Adding...' : 'Add'}
                    </button>
                    <button onClick={() => { setShowForm(false); setUploadFile(null); setUploadMode('link'); }} className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                  </div>
                </div>
              )}
              
              <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                {documents.length === 0 ? (
                  <div className="p-8 text-center text-gray-500">
                    {selectedClient === 'all' ? 'No documents shared with all clients yet' : 'No documents for this client'}
                  </div>
                ) : (
                  <div className="divide-y">
                    {documents.map(doc => (
                      <div key={doc.id} className={`p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4 ${doc.uploadedBy === 'client' ? 'bg-green-50 border-l-4 border-green-500' : ''}`}>
                        <div className="flex-1">
                          <div className="flex items-center gap-2 flex-wrap">
                            <h3 className="font-semibold text-gray-800">{doc.title}</h3>
                            {doc.shareWithAll && (
                              <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">All Clients</span>
                            )}
                            {doc.uploadedBy === 'client' && (
                              <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-medium">Client Upload</span>
                            )}
                            {doc.hubspotFileId && (
                              <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded">HubSpot</span>
                            )}
                          </div>
                          {doc.category && <span className="text-xs bg-gray-100 px-2 py-0.5 rounded mr-2">{doc.category}</span>}
                          {doc.uploadedBy === 'client' && doc.uploadedByName && (
                            <span className="text-xs text-gray-500">Uploaded by {doc.uploadedByName} on {new Date(doc.createdAt).toLocaleDateString()}</span>
                          )}
                          {doc.description && <p className="text-sm text-gray-500 mt-1">{doc.description}</p>}
                          {doc.url && <a href={doc.url} target="_blank" rel="noopener noreferrer" className="text-sm text-primary hover:underline block mt-1">{doc.url}</a>}
                          {doc.projectName && <p className="text-xs text-gray-400 mt-1">Project: {doc.projectName}</p>}
                        </div>
                        <button onClick={() => handleDelete(doc.id)} className="px-3 py-1 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded">Delete</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      );
    };
    
    const AdminClientsPage = ({ token }) => {
      const [clients, setClients] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editingClient, setEditingClient] = useState(null);
      const [editForm, setEditForm] = useState({});
      const [saving, setSaving] = useState(false);
      const [message, setMessage] = useState(null);
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [createForm, setCreateForm] = useState({
        email: '',
        name: '',
        password: '',
        practiceName: '',
        logo: '',
        hubspotCompanyId: '',
        hubspotDealId: '',
        hubspotContactId: ''
      });

      const createLogoInputRef = useRef(null);
      const editLogoInputRef = useRef(null);

      const handleLogoUpload = (e, formType) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
          setMessage('Error: Logo must be less than 2MB');
          return;
        }
        const reader = new FileReader();
        reader.onloadend = () => {
          if (formType === 'create') {
            setCreateForm(prev => ({ ...prev, logo: reader.result }));
          } else {
            setEditForm(prev => ({ ...prev, logo: reader.result }));
          }
        };
        reader.readAsDataURL(file);
      };

      // Get current user to check if Super Admin
      const currentUser = JSON.parse(localStorage.getItem('portal_user') || localStorage.getItem('admin_user') || '{}');
      const isSuperAdmin = currentUser?.role === 'admin';

      const loadClients = async () => {
        try {
          const res = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
          const data = await res.json();
          setClients(Array.isArray(data) ? data.filter(u => u.role === 'client') : []);
        } catch (err) {
          console.error('Failed to load clients:', err);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadClients();
      }, [token]);

      const handleEdit = (client) => {
        setEditingClient(client.id);
        setEditForm({
          practiceName: client.practiceName || '',
          logo: client.logo || '',
          hubspotCompanyId: client.hubspotCompanyId || '',
          hubspotDealId: client.hubspotDealId || '',
          hubspotContactId: client.hubspotContactId || ''
        });
        setMessage(null);
      };

      const handleCancel = () => {
        setEditingClient(null);
        setEditForm({});
        setMessage(null);
      };

      const handleSave = async () => {
        setSaving(true);
        setMessage(null);
        try {
          const res = await fetch(`${API_URL}/api/client-portal/clients/${editingClient}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(editForm)
          });
          const data = await res.json();
          if (res.ok) {
            setMessage({ type: 'success', text: 'Client details updated successfully!' });
            // Refresh client list to get updated data
            await loadClients();
            setEditingClient(null);
            setEditForm({});
          } else {
            setMessage({ type: 'error', text: data.error || 'Failed to update client' });
          }
        } catch (err) {
          console.error('Error saving client:', err);
          setMessage({ type: 'error', text: 'Network error. Please try again.' });
        } finally {
          setSaving(false);
        }
      };

      const handleCreate = async () => {
        setSaving(true);
        setMessage(null);

        // Validate required fields
        if (!createForm.email || !createForm.name || !createForm.password || !createForm.practiceName) {
          setMessage({ type: 'error', text: 'Email, name, password, and practice name are required' });
          setSaving(false);
          return;
        }

        try {
          const res = await fetch(`${API_URL}/api/users`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ...createForm,
              role: 'client'
            })
          });
          const data = await res.json();
          if (res.ok) {
            setMessage({ type: 'success', text: 'Client user created successfully!' });
            // Refresh client list
            await loadClients();
            // Reset and close form
            setShowCreateForm(false);
            setCreateForm({
              email: '',
              name: '',
              password: '',
              practiceName: '',
              logo: '',
              hubspotCompanyId: '',
              hubspotDealId: '',
              hubspotContactId: ''
            });
          } else {
            setMessage({ type: 'error', text: data.error || 'Failed to create client' });
          }
        } catch (err) {
          console.error('Error creating client:', err);
          setMessage({ type: 'error', text: 'Network error. Please try again.' });
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm flex justify-between items-start">
            <div>
              <h1 className="text-2xl font-bold text-accent mb-2">Client Users</h1>
              <p className="text-gray-600">View and edit client portal user details</p>
            </div>
            <button
              onClick={() => setShowCreateForm(true)}
              className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-accent font-medium flex items-center gap-2"
            >
              <span>+</span> Add Client User
            </button>
          </div>

          {message && (
            <div className={`p-4 rounded-lg text-sm ${message.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
              {message.text}
            </div>
          )}

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            {loading ? (
              <div className="p-8 text-center text-gray-500">Loading...</div>
            ) : clients.length === 0 ? (
              <div className="p-8 text-center text-gray-500">No client users found</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Practice Name</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Portal URL</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HubSpot IDs</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {clients.map(c => (
                      <tr key={c.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm text-gray-800">
                          <div className="flex items-center gap-2">
                            {c.logo && <img src={c.logo} alt="" className="w-6 h-6 rounded object-cover" />}
                            {c.name}
                          </div>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600">{c.email}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{c.practiceName || '-'}</td>
                        <td className="px-4 py-3 text-sm">
                          {c.slug ? (
                            <a href={`/portal/${c.slug}`} target="_blank" rel="noopener noreferrer" className="text-primary hover:underline">
                              /portal/{c.slug}
                            </a>
                          ) : '-'}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-500">
                          {(c.hubspotCompanyId || c.hubspotDealId || c.hubspotContactId) ? (
                            <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Linked</span>
                          ) : (
                            <span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">Not linked</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-sm">
                          <button
                            onClick={() => handleEdit(c)}
                            className="text-primary hover:text-accent font-medium"
                          >
                            Edit Details
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* Create Modal */}
          {showCreateForm && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6 border-b">
                  <h2 className="text-xl font-bold text-accent">Add New Client User</h2>
                  <p className="text-sm text-gray-500 mt-1">Create a new client portal account (syncs with Admin Hub)</p>
                </div>
                <div className="p-6 space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email <span className="text-red-500">*</span></label>
                    <input
                      type="email"
                      value={createForm.email}
                      onChange={(e) => setCreateForm({...createForm, email: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                      placeholder="user@example.com"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Name <span className="text-red-500">*</span></label>
                    <input
                      type="text"
                      value={createForm.name}
                      onChange={(e) => setCreateForm({...createForm, name: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                      placeholder="John Doe"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password <span className="text-red-500">*</span></label>
                    <input
                      type="password"
                      value={createForm.password}
                      onChange={(e) => setCreateForm({...createForm, password: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                      placeholder="Temporary password"
                      required
                    />
                    <p className="text-xs text-gray-400 mt-1">User will be required to change password on first login</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Practice Name <span className="text-red-500">*</span></label>
                    <input
                      type="text"
                      value={createForm.practiceName}
                      onChange={(e) => setCreateForm({...createForm, practiceName: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                      placeholder="e.g., ABC Medical Labs"
                      required
                    />
                    <p className="text-xs text-gray-400 mt-1">Will auto-generate portal URL slug</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Practice Logo</label>
                    <div className="flex items-center gap-4">
                      {createForm.logo && <img src={createForm.logo} alt="Logo" className="h-16 w-16 object-contain border rounded" />}
                      <input type="file" ref={createLogoInputRef} accept="image/png,image/jpeg" onChange={(e) => handleLogoUpload(e, 'create')} className="hidden" />
                      <button type="button" onClick={() => createLogoInputRef.current?.click()}
                        className="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition flex items-center gap-2 text-sm font-medium">
                        {Icons.upload} Upload Logo
                      </button>
                      {createForm.logo && <button type="button" onClick={() => setCreateForm({...createForm, logo: ''})} className="text-red-600 text-sm hover:text-red-800">Remove</button>}
                    </div>
                    <p className="text-xs text-gray-500 mt-1">Max 2MB, PNG or JPEG</p>
                  </div>
                  <div className="border-t pt-4">
                    <p className="text-sm font-medium text-gray-700 mb-3">HubSpot Integration IDs (Optional)</p>
                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Company ID</label>
                        <input
                          type="text"
                          value={createForm.hubspotCompanyId}
                          onChange={(e) => setCreateForm({...createForm, hubspotCompanyId: e.target.value})}
                          className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm"
                          placeholder="e.g., 12345678"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Deal ID</label>
                        <input
                          type="text"
                          value={createForm.hubspotDealId}
                          onChange={(e) => setCreateForm({...createForm, hubspotDealId: e.target.value})}
                          className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm"
                          placeholder="e.g., 87654321"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Contact ID</label>
                        <input
                          type="text"
                          value={createForm.hubspotContactId}
                          onChange={(e) => setCreateForm({...createForm, hubspotContactId: e.target.value})}
                          className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm"
                          placeholder="e.g., 11223344"
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                  <button
                    onClick={() => {
                      setShowCreateForm(false);
                      setCreateForm({
                        email: '',
                        name: '',
                        password: '',
                        practiceName: '',
                        logo: '',
                        hubspotCompanyId: '',
                        hubspotDealId: '',
                        hubspotContactId: ''
                      });
                    }}
                    className="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium"
                    disabled={saving}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleCreate}
                    disabled={saving}
                    className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-accent font-medium disabled:opacity-50"
                  >
                    {saving ? 'Creating...' : 'Create Client User'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Modal */}
          {editingClient && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6 border-b">
                  <h2 className="text-xl font-bold text-accent">Edit Client Details</h2>
                  <p className="text-sm text-gray-500 mt-1">Update client settings (syncs with Admin Hub)</p>
                </div>
                <div className="p-6 space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Practice Name</label>
                    <input
                      type="text"
                      value={editForm.practiceName}
                      onChange={(e) => setEditForm({...editForm, practiceName: e.target.value})}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                      placeholder="e.g., ABC Medical Labs"
                    />
                    <p className="text-xs text-gray-400 mt-1">Portal URL slug will update if changed</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Practice Logo</label>
                    <div className="flex items-center gap-4">
                      {editForm.logo && <img src={editForm.logo} alt="Logo" className="h-16 w-16 object-contain border rounded" />}
                      <input type="file" ref={editLogoInputRef} accept="image/png,image/jpeg" onChange={(e) => handleLogoUpload(e, 'edit')} className="hidden" />
                      <button type="button" onClick={() => editLogoInputRef.current?.click()}
                        className="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition flex items-center gap-2 text-sm font-medium">
                        {Icons.upload} Upload Logo
                      </button>
                      {editForm.logo && <button type="button" onClick={() => setEditForm({...editForm, logo: ''})} className="text-red-600 text-sm hover:text-red-800">Remove</button>}
                    </div>
                    <p className="text-xs text-gray-500 mt-1">Max 2MB, PNG or JPEG</p>
                  </div>
                  <div className="border-t pt-4">
                    <p className="text-sm font-medium text-gray-700 mb-3">HubSpot Integration IDs</p>
                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Company ID</label>
                        <input
                          type="text"
                          value={editForm.hubspotCompanyId}
                          onChange={(e) => setEditForm({...editForm, hubspotCompanyId: e.target.value})}
                          className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm"
                          placeholder="e.g., 12345678"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Deal ID</label>
                        <input
                          type="text"
                          value={editForm.hubspotDealId}
                          onChange={(e) => setEditForm({...editForm, hubspotDealId: e.target.value})}
                          className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm"
                          placeholder="e.g., 87654321"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Contact ID</label>
                        <input
                          type="text"
                          value={editForm.hubspotContactId}
                          onChange={(e) => setEditForm({...editForm, hubspotContactId: e.target.value})}
                          className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm"
                          placeholder="e.g., 11223344"
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                  <button
                    onClick={handleCancel}
                    className="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium"
                    disabled={saving}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSave}
                    disabled={saving}
                    className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-accent font-medium disabled:opacity-50"
                  >
                    {saving ? 'Saving...' : 'Save Changes'}
                  </button>
                </div>
              </div>
            </div>
          )}

          <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-700">
            <p><strong>Note:</strong> Changes made here sync with the Admin Hub. {!isSuperAdmin && 'To edit advanced permissions, contact a Super Admin.'}</p>
          </div>
        </div>
      );
    };
    
    
    const Portal = ({ token, user }) => {
      const urlSlug = getSlugFromUrl();
      // Super Admin, Manager, or users with hasClientPortalAdminAccess can access admin features
      const isAdmin = user?.role === 'admin' || user?.isManager || user?.hasClientPortalAdminAccess;
      const slug = user?.slug || urlSlug || (isAdmin ? 'admin' : null);

      // URL routing helper functions
      const getPageFromUrl = () => {
        const path = window.location.pathname;
        const hash = window.location.hash;
        // Parse path like /portal/slug/page or /portal/slug/page/tab
        const match = path.match(/\/portal\/[^\/]+\/([^\/]+)(?:\/([^\/]+))?/);
        const page = match ? match[1] : 'home';
        const tab = match ? match[2] : null;
        return { page, tab };
      };

      const updateUrl = (page, tab = null) => {
        const basePath = `/portal/${slug}`;
        let newPath = basePath;
        if (page && page !== 'home') {
          newPath += `/${page}`;
          if (tab) newPath += `/${tab}`;
        }
        if (window.location.pathname !== newPath) {
          window.history.pushState({ page, tab }, '', newPath);
        }
      };

      const initialRoute = getPageFromUrl();
      const [activePage, setActivePage] = useState(initialRoute.page || 'home');
      const [activeSubTab, setActiveSubTab] = useState(initialRoute.tab || null);
      const [data, setData] = useState(null);
      const [settings, setSettings] = useState(null);
      const [announcements, setAnnouncements] = useState([]);
      const [documents, setDocuments] = useState([]);
      const [loading, setLoading] = useState(true);
      const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
      const [highlightServiceReportId, setHighlightServiceReportId] = useState(null);

      // Navigate with URL update
      const navigateTo = (page, tab = null) => {
        setActivePage(page);
        setActiveSubTab(tab);
        updateUrl(page, tab);
      };

      // Navigate from Service History to Files with a specific report highlighted
      const navigateToFile = (serviceReportId) => {
        setHighlightServiceReportId(serviceReportId || null);
        navigateTo('files');
      };

      // Handle browser back/forward
      useEffect(() => {
        const handlePopState = (event) => {
          const route = getPageFromUrl();
          setActivePage(route.page || 'home');
          setActiveSubTab(route.tab || null);
        };
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, []);
      
      useEffect(() => {
        const loadData = async () => {
          try {
            // Admin doesn't need portal data for their own view
            if (isAdmin) {
              const portalSettings = await api.getPortalSettings();
              setSettings(portalSettings);
              setData({ user });
              setLoading(false);
              return;
            }
            const [portalData, portalSettings, announcementsData, docsData] = await Promise.all([
              api.getPortalData(token),
              api.getPortalSettings(),
              api.getAnnouncements(),
              api.getClientDocuments(slug, token)
            ]);
            setData(portalData);
            setSettings(portalSettings);
            setAnnouncements(announcementsData);
            setDocuments(docsData);
          } catch (err) {
            console.error('Failed to load portal data:', err);
          } finally {
            setLoading(false);
          }
        };
        loadData();
      }, [token, slug, isAdmin]);
      
      const handleSettingsChange = (newSettings) => {
        setSettings({ ...settings, ...newSettings });
      };
      
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
              <p className="mt-4 text-gray-600">Loading your portal...</p>
            </div>
          </div>
        );
      }
      
      const renderPage = () => {
        // Admin pages
        if (isAdmin) {
          if (activePage === 'home') return <AdminHomePage token={token} />;
          if (activePage === 'admin_settings') return <AdminSettingsPage token={token} settings={settings} onSettingsChange={handleSettingsChange} />;
          if (activePage === 'admin_announcements') return <AdminAnnouncementsPage token={token} />;
          if (activePage === 'admin_documents') return <AdminDocumentsPage token={token} />;
          if (activePage === 'admin_clients') return <AdminClientsPage token={token} />;
          // Admin views aggregate inventory reports across all clients
          if (activePage === 'reports') return <AdminReportsPage token={token} onNavigate={navigateTo} />;
          if (activePage === 'submission_history') return <SubmissionHistoryPage token={token} slug={slug} isAdmin={true} onNavigate={navigateTo} currentUser={user} />;
        }

        // Client pages
        if (activePage === 'home') return <HomePage data={data} announcements={announcements} onNavigate={navigateTo} />;
        if (activePage === 'milestones') return <MilestonesPage data={data} onNavigate={navigateTo} token={token} />;
        if (activePage === 'inventory') return <InventoryPage token={token} slug={slug} />;
        if (activePage === 'reports') return <ReportsPage token={token} slug={slug} onNavigate={navigateTo} />;
        if (activePage === 'submission_history') return <SubmissionHistoryPage token={token} slug={slug} isAdmin={false} onNavigate={navigateTo} currentUser={user} />;
        if (activePage === 'support') return <SupportPage settings={settings} token={token} userData={data?.user} documents={documents} activeTab={activeSubTab} onTabChange={(tab) => navigateTo('support', tab)} onNavigateToFile={navigateToFile} />;
        if (activePage === 'files') return <FilesPage settings={settings} documents={documents} token={token} projects={data?.projects || []} userData={data?.user} highlightServiceReportId={highlightServiceReportId} />;
        
        return null;
      };
      
      return (
        <div className="flex min-h-screen">
          {/* Mobile header */}
          <div className="fixed top-0 left-0 right-0 bg-white border-b z-30 lg:hidden p-4 flex justify-between items-center">
            <button onClick={() => setMobileMenuOpen(true)} className="text-gray-600 hover:text-gray-800">
              {Icons.menu}
            </button>
            <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-8" />
            <div className="w-6"></div>
          </div>
          
          <Sidebar
            activePage={activePage}
            onNavigate={navigateTo}
            user={data?.user || user}
            projects={data?.projects || []}
            isMobileOpen={mobileMenuOpen}
            onClose={() => setMobileMenuOpen(false)}
          />
          
          <main className="flex-1 lg:ml-64 p-4 lg:p-8 mt-16 lg:mt-0 max-w-7xl">
            {/* Signature Required Banner */}
            {!isAdmin && (() => {
              const unsignedCount = (documents || []).filter(d => d.serviceReportId && d.reportStatus === 'signature_needed').length;
              if (unsignedCount === 0) return null;
              return (
                <div className="mb-6 bg-red-50 border border-red-300 rounded-xl p-4 flex items-center gap-4 shadow-sm">
                  <div className="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                    <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                  </div>
                  <div className="flex-1">
                    <p className="font-semibold text-red-800">
                      {unsignedCount} service report{unsignedCount > 1 ? 's' : ''} requires your signature
                    </p>
                    <p className="text-sm text-red-600">Please sign to download your service report{unsignedCount > 1 ? 's' : ''}.</p>
                  </div>
                  <button
                    onClick={() => navigateToFile(null)}
                    className="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors text-sm whitespace-nowrap"
                  >
                    Go to Files
                  </button>
                </div>
              );
            })()}
            {renderPage()}
            
            <footer className="mt-12 text-center text-sm text-gray-500">
              <p>&copy; 2026 Thrive 365 Labs. All rights reserved.</p>
              {isAdmin && (
                <a href="/changelog" className="text-primary hover:underline text-xs mt-1 inline-block">View Changelog</a>
              )}
            </footer>
          </main>
        </div>
      );
    };
    
    const App = () => {
      // Check multiple token sources - portal_token, unified_token, or admin_token from Portal Hub
      const [token, setToken] = useState(() => {
        return localStorage.getItem('portal_token') || localStorage.getItem('unified_token') || localStorage.getItem('admin_token');
      });
      const [user, setUser] = useState(() => {
        try {
          const userData = localStorage.getItem('portal_user') || localStorage.getItem('unified_user') || localStorage.getItem('admin_user');
          return userData ? JSON.parse(userData) : null;
        } catch {
          return null;
        }
      });
      const slug = getSlugFromUrl();
      
      const handleLogin = (newToken, newUser) => {
        setToken(newToken);
        setUser(newUser);
      };
      
      // Handle central /portal login (no slug) - show login page or admin view
      if (!slug) {
        if (!token || !user) {
          return <LoginPage slug={null} onLogin={handleLogin} />;
        }
        // Super Admin, Manager, or users with Client Portal Admin access get the admin portal view directly at /portal
        if (user.role === 'admin' || user.isManager || user.hasClientPortalAdminAccess) {
          return <Portal token={token} user={user} />;
        }
        // Client users logged in from central portal - redirect to their portal
        if (user.slug) {
          window.location.href = `/portal/${user.slug}`;
          return null;
        }
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="text-center">
              <h1 className="text-2xl font-bold text-red-600">Portal Not Found</h1>
              <p className="text-gray-600 mt-2">Invalid portal configuration.</p>
            </div>
          </div>
        );
      }
      
      if (!token || !user) {
        return <LoginPage slug={slug} onLogin={handleLogin} />;
      }
      
      return <Portal token={token} user={user} />;
    };
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
