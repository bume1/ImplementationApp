<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrive 365 Labs Client Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#045E9F',
            accent: '#00205A'
          },
          fontFamily: {
            sans: ['Open Sans', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Open Sans', sans-serif; }
    .sidebar-link { transition: all 0.2s; }
    .sidebar-link:hover { background-color: rgba(4, 94, 159, 0.1); }
    .sidebar-link.active { background-color: #045E9F; color: white; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const API_URL = window.location.origin;
    
    const getSlugFromUrl = () => {
      const path = window.location.pathname;
      const match = path.match(/\/portal\/([^\/]+)/);
      return match ? match[1] : null;
    };
    
    const api = {
      clientLogin: (email, password, slug) =>
        fetch(`${API_URL}/api/auth/client-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, slug })
        }).then(r => r.json()),
      
      getPortalData: (token) =>
        fetch(`${API_URL}/api/client-portal/data`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(r => r.json()),
      
      getPortalSettings: () =>
        fetch(`${API_URL}/api/portal-settings`).then(r => r.json()),
      
      getAnnouncements: () =>
        fetch(`${API_URL}/api/announcements`).then(r => r.json()),
      
      getClientDocuments: (slug) =>
        fetch(`${API_URL}/api/client-documents/${slug}`).then(r => r.json())
    };
    
    const LoginPage = ({ slug, onLogin }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const result = await api.clientLogin(email, password, slug);
          if (result.error) {
            setError(result.error);
          } else {
            localStorage.setItem('portal_token', result.token);
            localStorage.setItem('portal_user', JSON.stringify(result.user));
            // If logged in from central /portal without slug, redirect to user's portal
            if (!slug && result.user.slug) {
              window.location.href = `/portal/${result.user.slug}`;
              return;
            }
            onLogin(result.token, result.user);
          }
        } catch (err) {
          setError('Login failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100">
          <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <div className="text-center mb-6">
              <img 
                src="/thrive365-logo.webp" 
                alt="Thrive 365 Labs" 
                className="h-16 mx-auto mb-4"
              />
              <h1 className="text-2xl font-bold text-accent">Client Portal</h1>
              <p className="text-gray-600 mt-1">Sign in to access your portal</p>
            </div>
            
            <form onSubmit={handleLogin} className="space-y-4">
              {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded-md text-sm">
                  {error}
                </div>
              )}
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  required
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  required
                />
              </div>
              
              <button
                type="submit"
                disabled={loading}
                className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-accent transition-colors disabled:opacity-50"
              >
                {loading ? 'Signing in...' : 'Sign In'}
              </button>
            </form>
            
            <div className="mt-6 text-center text-sm text-gray-500">
              <p>Powered by Thrive365Labs</p>
            </div>
          </div>
        </div>
      );
    };
    
    // SVG icons for consistent branding
    const Icons = {
      home: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>,
      target: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
      package: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>,
      clipboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>,
      chart: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
      chat: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>,
      folder: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
      logout: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
      megaphone: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>,
      activity: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
      warning: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
      calendar: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
      list: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>,
      menu: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>,
      close: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>,
      upload: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,
      download: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
    };
    
    // Additional icons for admin portal
    const AdminIcons = {
      settings: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      users: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
      document: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>,
      back: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
    };
    
    const Sidebar = ({ activePage, onNavigate, user, isMobileOpen, onClose }) => {
      const [inventoryExpanded, setInventoryExpanded] = useState(activePage === 'inventory' || activePage === 'reports' || activePage === 'submission_history');
      const [adminExpanded, setAdminExpanded] = useState(activePage.startsWith('admin_'));
      const isAdmin = user?.role === 'admin';
      
      const mainItems = [
        { id: 'home', label: isAdmin ? 'Admin Dashboard' : 'Home', icon: Icons.home }
      ];
      
      // Show Launch Milestones for clients with assigned projects
      if (user?.assignedProjects?.length > 0 && !isAdmin) {
        mainItems.push({ id: 'milestones', label: 'Launch Milestones', icon: Icons.target });
      }
      
      const bottomItems = isAdmin ? [] : [
        { id: 'support', label: 'Customer Support', icon: Icons.chat },
        { id: 'files', label: 'Files', icon: Icons.folder }
      ];
      
      const handleNavigate = (id) => {
        onNavigate(id);
        if (onClose) onClose();
      };
      
      return (
        <>
          {/* Mobile overlay */}
          {isMobileOpen && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden" onClick={onClose}></div>
          )}
          
          <aside className={`w-64 bg-white border-r min-h-screen fixed left-0 top-0 z-50 transform transition-transform duration-300 ${isMobileOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
            <div className="p-4 border-b flex justify-between items-center">
              {user?.logo ? (
                <img src={user.logo} alt={user.practiceName || 'Practice Logo'} className="h-12 max-w-full object-contain" />
              ) : (
                <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-10" />
              )}
              <button onClick={onClose} className="lg:hidden text-gray-500 hover:text-gray-700">
                {Icons.close}
              </button>
            </div>
            
            <div className="p-4 border-b bg-gray-50">
              <p className="text-sm text-gray-500">Welcome,</p>
              <p className="font-semibold text-accent">{user?.name || 'Client'}</p>
              <p className="text-xs text-gray-500">{user?.practiceName}</p>
            </div>
            
            <nav className="p-2">
              {mainItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => handleNavigate(item.id)}
                  className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                    activePage === item.id ? 'active' : 'text-gray-700'
                  }`}
                >
                  <span className="text-primary">{item.icon}</span>
                  <span className="font-medium">{item.label}</span>
                </button>
              ))}
              
              <div className="mt-1">
                <button
                  onClick={() => setInventoryExpanded(!inventoryExpanded)}
                  className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center justify-between ${
                    (activePage === 'inventory' || activePage === 'reports' || activePage === 'submission_history') ? 'active' : 'text-gray-700'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <span className="text-primary">{Icons.package}</span>
                    <span className="font-medium">Inventory</span>
                  </div>
                  <span className="text-xs">{inventoryExpanded ? '▼' : '▶'}</span>
                </button>
                
                {inventoryExpanded && (
                  <div className="ml-6 mt-1 space-y-1">
                    {!isAdmin && (
                      <button
                        onClick={() => handleNavigate('inventory')}
                        className={`w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-2 ${
                          activePage === 'inventory' ? 'bg-primary/10 text-primary font-medium' : 'text-gray-600 hover:bg-gray-100'
                        }`}
                      >
                        <span className="text-primary">{Icons.clipboard}</span> Weekly Update
                      </button>
                    )}
                    <button
                      onClick={() => handleNavigate('reports')}
                      className={`w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-2 ${
                        activePage === 'reports' ? 'bg-primary/10 text-primary font-medium' : 'text-gray-600 hover:bg-gray-100'
                      }`}
                    >
                      <span className="text-primary">{Icons.chart}</span> {isAdmin ? 'All Clients Report' : 'Reports & Alerts'}
                    </button>
                    <button
                      onClick={() => handleNavigate('submission_history')}
                      className={`w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-2 ${
                        activePage === 'submission_history' ? 'bg-primary/10 text-primary font-medium' : 'text-gray-600 hover:bg-gray-100'
                      }`}
                    >
                      <span className="text-primary">{Icons.list}</span> Submission History
                    </button>
                  </div>
                )}
              </div>
              
              {/* Admin Portal Management Menu */}
              {isAdmin && (
                <div className="mt-4 pt-4 border-t">
                  <p className="px-4 text-xs font-semibold text-gray-400 uppercase mb-2">Portal Management</p>
                  <button
                    onClick={() => handleNavigate('admin_settings')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_settings' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{AdminIcons.settings}</span>
                    <span className="font-medium">Portal Settings</span>
                  </button>
                  <button
                    onClick={() => handleNavigate('admin_announcements')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_announcements' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{Icons.megaphone}</span>
                    <span className="font-medium">Announcements</span>
                  </button>
                  <button
                    onClick={() => handleNavigate('admin_documents')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_documents' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{AdminIcons.document}</span>
                    <span className="font-medium">Client Documents</span>
                  </button>
                  <button
                    onClick={() => handleNavigate('admin_clients')}
                    className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                      activePage === 'admin_clients' ? 'active' : 'text-gray-700'
                    }`}
                  >
                    <span className="text-primary">{AdminIcons.users}</span>
                    <span className="font-medium">Client Users</span>
                  </button>
                </div>
              )}
              
              {bottomItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => handleNavigate(item.id)}
                  className={`w-full text-left px-4 py-3 rounded-lg sidebar-link flex items-center gap-3 ${
                    activePage === item.id ? 'active' : 'text-gray-700'
                  }`}
                >
                  <span className="text-primary">{item.icon}</span>
                  <span className="font-medium">{item.label}</span>
                </button>
              ))}
            </nav>
            
            <div className="absolute bottom-0 left-0 right-0 p-4 border-t">
              <button
                onClick={() => {
                  localStorage.removeItem('portal_token');
                  localStorage.removeItem('portal_user');
                  window.location.reload();
                }}
                className="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2"
              >
                {Icons.logout}
                <span>Sign Out</span>
              </button>
            </div>
          </aside>
        </>
      );
    };
    
    const HomePage = ({ data, announcements, onNavigate }) => {
      return (
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-primary to-accent text-white p-6 rounded-xl">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">Welcome to Your Portal</h1>
                <p className="mt-2 opacity-90">
                  {data?.user?.practiceName || 'Your Practice'}
                </p>
              </div>
              {data?.user?.logo && (
                <img src={data.user.logo} alt={data?.user?.practiceName || 'Practice Logo'} className="h-16 max-w-[200px] object-contain bg-white/20 rounded-lg p-2" />
              )}
            </div>
          </div>
          
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">
                <span className="text-primary">{Icons.megaphone}</span> Announcements
              </h2>
              {announcements && announcements.length > 0 ? (
                <div className="space-y-3 max-h-64 overflow-y-auto">
                  {announcements.map(ann => (
                    <div key={ann.id} className={`p-3 rounded-lg border-l-4 ${
                      ann.type === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                      ann.type === 'success' ? 'border-green-500 bg-green-50' :
                      'border-blue-500 bg-blue-50'
                    }`}>
                      <h3 className="font-semibold text-gray-800">{ann.title}</h3>
                      <p className="text-sm text-gray-600 mt-1">{ann.content}</p>
                      <p className="text-xs text-gray-400 mt-2">
                        {new Date(ann.createdAt).toLocaleDateString()}
                      </p>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-500 text-sm">No announcements at this time.</p>
              )}
            </div>
            
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">
                <span className="text-primary">{Icons.activity}</span> Recent Activity
              </h2>
              {data?.activities && data.activities.length > 0 ? (
                <div className="space-y-2">
                  {data.activities.slice(0, 5).map((act, idx) => {
                    const getIcon = () => {
                      if (act.action === 'inventory_submitted') return { icon: Icons.clipboard, color: 'text-blue-500' };
                      if (act.action === 'hubspot_file_upload') return { icon: Icons.folder, color: 'text-green-500' };
                      if (act.action === 'support_ticket_submitted') return { icon: Icons.chat, color: 'text-purple-500' };
                      if (act.action === 'form_submitted') return { icon: Icons.clipboard, color: 'text-purple-500' };
                      if (act.action === 'phase_completed') return { icon: Icons.target, color: 'text-yellow-500' };
                      if (act.action === 'stage_completed') return { icon: Icons.target, color: 'text-orange-500' };
                      if (act.action === 'task_completed') return { icon: Icons.target, color: 'text-green-500' };
                      return { icon: Icons.activity, color: 'text-gray-500' };
                    };
                    const getLabel = () => {
                      if (act.action === 'inventory_submitted') return `Inventory submitted (${act.details?.itemCount || 0} items)`;
                      if (act.action === 'hubspot_file_upload') return `File uploaded: ${act.details || 'Document'}`;
                      if (act.action === 'support_ticket_submitted') return 'Support ticket submitted';
                      if (act.action === 'form_submitted') return `Form submitted: ${act.formType || 'Unknown'}`;
                      if (act.action === 'phase_completed') return `Phase completed: ${act.details?.phase || ''}`;
                      if (act.action === 'stage_completed') return `Stage completed: ${act.details?.stage || ''}`;
                      if (act.action === 'task_completed') return act.details?.taskTitle || 'Task completed';
                      return act.details || 'Activity recorded';
                    };
                    const { icon, color } = getIcon();
                    return (
                      <div key={idx} className="flex items-start gap-3 text-sm py-2 border-b last:border-0">
                        <span className={color}>{icon}</span>
                        <div>
                          <p className="text-gray-800">{getLabel()}</p>
                          <p className="text-xs text-gray-400">
                            {new Date(act.timestamp).toLocaleDateString()}
                          </p>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p className="text-gray-500 text-sm">No recent activity.</p>
              )}
            </div>
          </div>
          
          <div className="grid md:grid-cols-3 gap-4">
            <button onClick={() => onNavigate('inventory')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center cursor-pointer w-full">
              <div className="flex justify-center mb-2 text-primary">{React.cloneElement(Icons.package, { className: 'w-10 h-10' })}</div>
              <h3 className="font-semibold text-gray-800">Inventory Management</h3>
              <p className="text-sm text-gray-500 mt-1">Submit inventory requests</p>
            </button>
            <button onClick={() => onNavigate('support')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center cursor-pointer w-full">
              <div className="flex justify-center mb-2 text-primary">{React.cloneElement(Icons.chat, { className: 'w-10 h-10' })}</div>
              <h3 className="font-semibold text-gray-800">Customer Support</h3>
              <p className="text-sm text-gray-500 mt-1">Get help from our team</p>
            </button>
            <button onClick={() => onNavigate('files')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center cursor-pointer w-full">
              <div className="flex justify-center mb-2 text-primary">{React.cloneElement(Icons.folder, { className: 'w-10 h-10' })}</div>
              <h3 className="font-semibold text-gray-800">Files</h3>
              <p className="text-sm text-gray-500 mt-1">Upload and view documents</p>
            </button>
          </div>
        </div>
      );
    };
    
    const MilestonesPage = ({ data }) => {
      const project = data?.projects?.[0];
      const allTasks = project?.tasks || [];
      const tasks = allTasks.filter(t => t.showToClient !== false);
      const [viewType, setViewType] = useState('list');
      
      const PHASE_ORDER = ['Phase 0', 'Phase 1', 'Phase 2', 'Phase 3', 'Phase 4'];
      const STANDARD_PHASES = {
        'Phase 0': { name: 'Phase 0: Contract Signature', stages: ['Contract Signature'] },
        'Phase 1': { name: 'Phase 1: Pre-Launch', stages: ['Project Kick Off & Stakeholder Alignment', 'Launch Data & Systems Prep'] },
        'Phase 2': { name: 'Phase 2: Implementation Sprints', stages: ['Sprint 1: Core System Setups', 'Sprint 2: Lab & QUA Pilot Prep', 'Sprint 3: Soft-Pilot'] },
        'Phase 3': { name: 'Phase 3: Go-Live', stages: ['Training/Validation', 'Go-Live'] },
        'Phase 4': { name: 'Phase 4: Post-Launch Optimization', stages: ['KPIs', 'Monitoring & Customer Support'] }
      };
      
      const getPhaseColor = (phase) => {
        const colors = { 'Phase 0': 'border-purple-500', 'Phase 1': 'border-primary', 'Phase 2': 'border-green-500', 'Phase 3': 'border-orange-500', 'Phase 4': 'border-pink-500' };
        return colors[phase] || 'border-gray-500';
      };
      
      const getPhaseGradient = (phase) => {
        const gradients = { 'Phase 0': 'bg-gradient-to-r from-purple-600 to-purple-700', 'Phase 1': 'bg-gradient-to-r from-primary to-accent', 'Phase 2': 'bg-gradient-to-r from-green-600 to-green-700', 'Phase 3': 'bg-gradient-to-r from-orange-600 to-orange-700', 'Phase 4': 'bg-gradient-to-r from-pink-600 to-pink-700' };
        return gradients[phase] || 'bg-gradient-to-r from-gray-600 to-gray-700';
      };
      
      const ensureAllPhasesAndStages = (groupedByPhase) => {
        const result = {};
        PHASE_ORDER.forEach(phase => {
          result[phase] = {};
          const standardStages = STANDARD_PHASES[phase]?.stages || [];
          standardStages.forEach(stage => {
            result[phase][stage] = groupedByPhase[phase]?.[stage] || [];
          });
          if (groupedByPhase[phase]) {
            Object.keys(groupedByPhase[phase]).forEach(stage => {
              if (!result[phase][stage]) result[phase][stage] = groupedByPhase[phase][stage];
            });
          }
        });
        return result;
      };
      
      const completedTasks = tasks.filter(t => t.completed).length;
      const totalTasks = tasks.length;
      const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
      
      const rawGroupedByPhase = tasks.reduce((acc, task) => {
        if (!acc[task.phase]) acc[task.phase] = {};
        const stageKey = task.stage || 'General';
        if (!acc[task.phase][stageKey]) acc[task.phase][stageKey] = [];
        acc[task.phase][stageKey].push(task);
        return acc;
      }, {});
      const groupedByPhase = ensureAllPhasesAndStages(rawGroupedByPhase);
      
      const ListView = () => (
        <div className="space-y-8">
          {PHASE_ORDER.map(phase => (
            <div key={phase} className="space-y-4">
              <div className={`${getPhaseGradient(phase)} p-3 rounded-lg text-white`}>
                <h2 className="text-lg font-bold">{STANDARD_PHASES[phase]?.name || phase}</h2>
                <p className="text-sm opacity-80">
                  {Object.values(groupedByPhase[phase] || {}).flat().filter(t => t.completed).length} of {Object.values(groupedByPhase[phase] || {}).flat().length} complete
                </p>
              </div>
              {Object.entries(groupedByPhase[phase] || {}).map(([stageName, stageTasks]) => {
                const dueDates = stageTasks.filter(t => t.dueDate).map(t => t.dueDate).sort();
                const targetDate = dueDates.length > 0 ? dueDates[dueDates.length - 1] : null;
                return (
                  <div key={stageName} className={`bg-white rounded-lg shadow-sm overflow-hidden border-l-4 ${getPhaseColor(phase)}`}>
                    <div className="bg-gray-50 p-3 border-b flex justify-between items-start">
                      <div>
                        <h3 className="font-semibold text-gray-700">{stageName}</h3>
                        <p className="text-xs text-gray-500">{stageTasks.filter(t => t.completed).length} of {stageTasks.length} complete</p>
                      </div>
                      {targetDate && (
                        <span className="text-xs bg-blue-100 text-primary px-2 py-1 rounded">
                          Target Due Date: {targetDate}
                        </span>
                      )}
                    </div>
                    <div className="divide-y divide-gray-200">
                      {stageTasks.length === 0 ? (
                        <div className="p-4 text-gray-400 text-sm italic">No tasks in this stage</div>
                      ) : stageTasks.map(task => (
                        <div key={task.id} className="p-4">
                          <div className="flex items-start gap-3">
                            <div className="mt-1">
                              {task.completed ? (
                                <div className="w-5 h-5 bg-green-600 rounded-full flex items-center justify-center text-white text-xs">✓</div>
                              ) : (
                                <div className="w-5 h-5 border-2 border-gray-300 rounded-full" />
                              )}
                            </div>
                            <div className="flex-1">
                              <h3 className={`font-medium ${task.completed ? 'text-gray-500 line-through' : 'text-gray-900'}`}>
                                {task.clientName || task.taskTitle}
                              </h3>
                              {(task.ownerDisplayName || task.dateCompleted || task.dueDate) && (
                                <p className="text-sm text-gray-600 mt-1">
                                  {task.ownerDisplayName && <span>Owner: {task.ownerDisplayName}</span>}
                                  {task.ownerDisplayName && (task.dateCompleted || task.dueDate) && <span className="mx-2">•</span>}
                                  {task.dueDate && !task.completed && (
                                    <span className={new Date(task.dueDate) < new Date() ? 'text-red-600' : 'text-blue-600'}>
                                      Due: {new Date(task.dueDate + 'T12:00:00').toLocaleDateString()}
                                    </span>
                                  )}
                                  {task.dueDate && !task.completed && task.dateCompleted && <span className="mx-2">•</span>}
                                  {task.dateCompleted && <span className="text-green-600">Completed: {task.dateCompleted}</span>}
                                </p>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          ))}
        </div>
      );
      
      const TimelineView = () => (
        <div className="bg-white rounded-lg shadow-sm p-6">
          <h2 className="text-2xl font-bold mb-6 text-accent">Project Timeline</h2>
          <div className="space-y-8">
            {PHASE_ORDER.map(phase => {
              const phaseData = groupedByPhase[phase] || {};
              const phaseTasks = Object.values(phaseData).flat();
              const completedCount = phaseTasks.filter(t => t.completed).length;
              return (
                <div key={phase} className={`border-l-4 ${getPhaseColor(phase)} pl-6`}>
                  <div className="mb-4">
                    <h3 className="text-xl font-bold text-gray-900">{STANDARD_PHASES[phase]?.name || phase}</h3>
                    <p className="text-sm text-gray-600">{completedCount} of {phaseTasks.length} complete ({phaseTasks.length > 0 ? Math.round((completedCount / phaseTasks.length) * 100) : 0}%)</p>
                  </div>
                  <div className="space-y-4">
                    {Object.entries(phaseData).map(([stage, stageTasks]) => {
                      const dueDates = stageTasks.filter(t => t.dueDate).map(t => t.dueDate).sort();
                      const targetDate = dueDates.length > 0 ? dueDates[dueDates.length - 1] : null;
                      return (
                        <div key={stage} className="bg-gray-50 rounded-lg p-4">
                          <div className="flex justify-between items-start mb-3">
                            <h4 className="font-semibold text-gray-800">{stage}</h4>
                            {targetDate && <span className="text-xs bg-blue-100 text-primary px-2 py-1 rounded">Target Due Date: {targetDate}</span>}
                          </div>
                          <div className="space-y-2">
                            {stageTasks.map(task => (
                              <div key={task.id} className={`flex items-start gap-3 p-3 rounded-lg ${task.completed ? 'bg-green-50' : 'bg-white'} border border-gray-200`}>
                                <div className={`mt-0.5 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 ${task.completed ? 'bg-green-500 text-white' : 'border-2 border-gray-300'}`}>
                                  {task.completed && <span className="text-xs">✓</span>}
                                </div>
                                <div className="flex-1 min-w-0">
                                  <h5 className={`font-medium ${task.completed ? 'text-gray-500 line-through' : 'text-gray-900'}`}>{task.clientName || task.taskTitle}</h5>
                                  {(task.dateCompleted || task.ownerDisplayName) && (
                                    <p className="mt-1 text-xs text-gray-600">
                                      {task.ownerDisplayName && <span className="text-gray-500">Owner: {task.ownerDisplayName}</span>}
                                      {task.ownerDisplayName && task.dateCompleted && <span className="mx-1">•</span>}
                                      {task.dateCompleted && <span className="text-green-600">Completed: {task.dateCompleted}</span>}
                                    </p>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
      
      const CalendarView = () => {
        const [selectedDate, setSelectedDate] = useState(new Date());
        const getDaysInMonth = (date) => {
          const year = date.getFullYear();
          const month = date.getMonth();
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          return { daysInMonth: lastDay.getDate(), startingDayOfWeek: firstDay.getDay(), year, month };
        };
        const { daysInMonth, startingDayOfWeek, year, month } = getDaysInMonth(selectedDate);
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const getTasksForDay = (day) => {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return tasks.filter(t => t.dueDate === dateStr || t.dateCompleted === dateStr);
        };
        return (
          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-2xl font-bold text-accent">{monthNames[month]} {year}</h2>
              <div className="flex gap-1">
                <button onClick={() => setSelectedDate(new Date(year, month - 1, 1))} className="p-2 hover:bg-gray-100 rounded-lg">←</button>
                <button onClick={() => setSelectedDate(new Date())} className="px-3 py-1 text-sm text-primary hover:underline">Today</button>
                <button onClick={() => setSelectedDate(new Date(year, month + 1, 1))} className="p-2 hover:bg-gray-100 rounded-lg">→</button>
              </div>
            </div>
            <div className="grid grid-cols-7 gap-2 mb-2">
              {dayNames.map(day => (<div key={day} className="text-center text-sm font-semibold text-gray-600 py-2">{day}</div>))}
            </div>
            <div className="grid grid-cols-7 gap-2">
              {[...Array(startingDayOfWeek)].map((_, idx) => (<div key={`empty-${idx}`} className="aspect-square"></div>))}
              {[...Array(daysInMonth)].map((_, idx) => {
                const day = idx + 1;
                const dayTasks = getTasksForDay(day);
                const isToday = new Date().getDate() === day && new Date().getMonth() === month && new Date().getFullYear() === year;
                return (
                  <div key={day} className={`min-h-[80px] border rounded-lg p-2 ${isToday ? 'border-primary bg-blue-50' : 'border-gray-200'}`}>
                    <div className={`text-sm font-semibold mb-1 ${isToday ? 'text-primary' : 'text-gray-700'}`}>{day}</div>
                    <div className="space-y-1">
                      {dayTasks.slice(0, 2).map(task => (
                        <div key={task.id} className={`text-xs px-1 py-0.5 rounded truncate ${task.completed ? 'bg-green-200 text-green-800' : 'bg-blue-100 text-primary'}`} title={task.clientName || task.taskTitle}>
                          {(task.clientName || task.taskTitle).substring(0, 10)}...
                        </div>
                      ))}
                      {dayTasks.length > 2 && <div className="text-xs text-gray-500">+{dayTasks.length - 2} more</div>}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      };
      
      if (!project || tasks.length === 0) {
        return (
          <div className="bg-white p-6 rounded-xl shadow-sm text-center text-gray-500">
            No project milestones available.
          </div>
        );
      }
      
      return (
        <div className="space-y-6">
          <div className="bg-white shadow-sm border-b rounded-xl">
            <div className="px-4 sm:px-6 py-4">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div className="flex items-center gap-4">
                  <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-10" />
                  <div>
                    <h1 className="text-xl font-bold text-accent">{project.name}</h1>
                    <p className="text-sm text-gray-600">{project.clientName}</p>
                  </div>
                </div>
                <div className="flex items-center gap-4">
                  <div className="text-right">
                    <div className="text-2xl font-bold text-primary">{progressPercent}%</div>
                    <div className="text-sm text-gray-500">Complete</div>
                  </div>
                  <div className="w-24 h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div className="h-full bg-primary rounded-full transition-all duration-500" style={{ width: `${progressPercent}%` }} />
                  </div>
                </div>
              </div>
              {project.goLiveDate && (() => {
                const dateStr = project.goLiveDate;
                let d;
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                  d = new Date(dateStr + 'T12:00:00');
                } else if (dateStr.includes('T') && dateStr.endsWith('Z')) {
                  const datePart = dateStr.split('T')[0];
                  d = new Date(datePart + 'T12:00:00');
                } else if (dateStr.includes('T')) {
                  d = new Date(dateStr);
                } else {
                  d = new Date(dateStr);
                }
                return !isNaN(d.getTime()) ? (
                  <div className="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                    <svg className="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span className="text-sm font-medium text-gray-700">Target Go-Live: {d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
                  </div>
                ) : null;
              })()}
            </div>
          </div>
          
          <div className="flex gap-2">
            <button onClick={() => setViewType('list')} className={`px-4 py-2 rounded-md ${viewType === 'list' ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}>List View</button>
            <button onClick={() => setViewType('timeline')} className={`px-4 py-2 rounded-md ${viewType === 'timeline' ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}>Timeline</button>
            <button onClick={() => setViewType('calendar')} className={`px-4 py-2 rounded-md ${viewType === 'calendar' ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}`}>Calendar</button>
          </div>
          
          {viewType === 'list' && <ListView />}
          {viewType === 'timeline' && <TimelineView />}
          {viewType === 'calendar' && <CalendarView />}
        </div>
      );
    };
    
    const InventoryPage = ({ token, slug }) => {
      const [template, setTemplate] = useState([]);
      const [customItems, setCustomItems] = useState([]);
      const [inventoryData, setInventoryData] = useState({});
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [lastSubmitted, setLastSubmitted] = useState(null);
      const [expandedCategories, setExpandedCategories] = useState({});
      const [message, setMessage] = useState('');
      const [showAddItem, setShowAddItem] = useState(false);
      const [newItemCategory, setNewItemCategory] = useState('');
      const [newItemName, setNewItemName] = useState('');

      useEffect(() => { loadInventory(); }, []);

      const loadInventory = async () => {
        try {
          const [templateData, latestData, customData] = await Promise.all([
            fetch(`${API_URL}/api/inventory/template`).then(r => r.json()),
            fetch(`${API_URL}/api/inventory/latest/${slug}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
            fetch(`${API_URL}/api/inventory/custom-items/${slug}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
          ]);
          setTemplate(templateData);
          setCustomItems(customData || []);
          const normalized = {};
          Object.entries(latestData.data || {}).forEach(([key, value]) => {
            if (value.batches) { normalized[key] = value; }
            else { normalized[key] = { batches: [value] }; }
          });
          setInventoryData(normalized);
          setLastSubmitted(latestData.submittedAt);
          const expanded = {};
          templateData.forEach(cat => { expanded[cat.category] = false; });
          expanded['Custom Items'] = false;
          setExpandedCategories(expanded);
        } catch (err) { console.error('Failed to load inventory:', err); }
        finally { setLoading(false); }
      };

      const getBatches = (category, item) => {
        const key = `${category}|${item}`;
        const data = inventoryData[key];
        if (!data || !data.batches || data.batches.length === 0) {
          return [{ lotNumber: '', expiry: '', openQty: '', openDate: '', closedQty: '', notes: '' }];
        }
        return data.batches;
      };

      const updateBatch = (category, item, batchIdx, field, value) => {
        const key = `${category}|${item}`;
        setInventoryData(prev => {
          const current = prev[key] || { batches: [{}] };
          const batches = [...(current.batches || [{}])];
          batches[batchIdx] = { ...(batches[batchIdx] || {}), [field]: value };
          return { ...prev, [key]: { batches } };
        });
      };

      const addBatch = (category, item) => {
        const key = `${category}|${item}`;
        setInventoryData(prev => {
          const current = prev[key] || { batches: [] };
          const batches = [...(current.batches || []), { lotNumber: '', expiry: '', openQty: '', openDate: '', closedQty: '', notes: '' }];
          return { ...prev, [key]: { batches } };
        });
      };

      const removeBatch = (category, item, batchIdx) => {
        const key = `${category}|${item}`;
        setInventoryData(prev => {
          const current = prev[key] || { batches: [] };
          const batches = current.batches.filter((_, i) => i !== batchIdx);
          return { ...prev, [key]: { batches: batches.length ? batches : [{}] } };
        });
      };

      const handleSubmit = async () => {
        setSaving(true);
        setMessage('');
        try {
          const response = await fetch(`${API_URL}/api/inventory/submit`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ slug, data: inventoryData })
          });
          const result = await response.json();
          if (result.success) {
            setMessage('Inventory submitted successfully!');
            setLastSubmitted(new Date().toISOString());
            setTimeout(() => setMessage(''), 5000);
          } else { setMessage('Failed to submit inventory'); }
        } catch (err) { setMessage('Error submitting inventory'); }
        finally { setSaving(false); }
      };

      const addCustomItem = async () => {
        if (!newItemCategory || !newItemName) return;
        try {
          const response = await fetch(`${API_URL}/api/inventory/custom-items/${slug}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ category: newItemCategory, itemName: newItemName })
          });
          const newItem = await response.json();
          setCustomItems(prev => [...prev, newItem]);
          setNewItemCategory('');
          setNewItemName('');
          setShowAddItem(false);
        } catch (err) { console.error('Failed to add custom item:', err); }
      };

      const toggleCategory = (category) => {
        setExpandedCategories(prev => ({ ...prev, [category]: !prev[category] }));
      };

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      const allCategories = [...template];
      const customByCategory = {};
      customItems.forEach(ci => {
        if (!customByCategory[ci.category]) customByCategory[ci.category] = [];
        customByCategory[ci.category].push(ci.itemName);
      });

      const renderItemRows = (category, items, isCustom = false) => {
        return items.map(item => {
          const batches = getBatches(category, item);
          return (
            <React.Fragment key={`${category}|${item}`}>
              {batches.map((batch, bIdx) => (
                <tr key={`${category}|${item}|${bIdx}`} className="hover:bg-gray-50 border-b">
                  <td className="px-3 py-2 font-medium text-gray-800">
                    {bIdx === 0 ? item : ''}
                    {bIdx === 0 && <button onClick={() => addBatch(category, item)} className="ml-2 text-xs text-primary hover:underline">+Lot</button>}
                  </td>
                  <td className="px-1 py-1"><input type="text" value={batch.lotNumber || ''} onChange={(e) => updateBatch(category, item, bIdx, 'lotNumber', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" placeholder="Lot #" /></td>
                  <td className="px-1 py-1"><input type="date" value={batch.expiry || ''} onChange={(e) => updateBatch(category, item, bIdx, 'expiry', e.target.value)} className="w-full px-1 py-1 border rounded text-sm" /></td>
                  <td className="px-1 py-1"><input type="number" value={batch.openQty || ''} onChange={(e) => updateBatch(category, item, bIdx, 'openQty', e.target.value)} className="w-16 px-1 py-1 border rounded text-sm text-center" min="0" /></td>
                  <td className="px-1 py-1"><input type="date" value={batch.openDate || ''} onChange={(e) => updateBatch(category, item, bIdx, 'openDate', e.target.value)} className="w-full px-1 py-1 border rounded text-sm" /></td>
                  <td className="px-1 py-1"><input type="number" value={batch.closedQty || ''} onChange={(e) => updateBatch(category, item, bIdx, 'closedQty', e.target.value)} className="w-16 px-1 py-1 border rounded text-sm text-center" min="0" /></td>
                  <td className="px-1 py-1"><input type="text" value={batch.notes || ''} onChange={(e) => updateBatch(category, item, bIdx, 'notes', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" placeholder="Notes" /></td>
                  <td className="px-1 py-1 text-center">{batches.length > 1 && <button onClick={() => removeBatch(category, item, bIdx)} className="text-red-500 hover:text-red-700 text-xs">x</button>}</td>
                </tr>
              ))}
            </React.Fragment>
          );
        });
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex justify-between items-start flex-wrap gap-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Inventory Management</h1>
                <p className="text-gray-600 mt-1">Update your weekly inventory counts</p>
                {lastSubmitted && <p className="text-sm text-gray-500 mt-2">Last submitted: {new Date(lastSubmitted).toLocaleString()}</p>}
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowAddItem(true)} className="px-4 py-2 border border-primary text-primary rounded-lg font-medium hover:bg-primary hover:text-white transition">+ Add Item</button>
                <button onClick={handleSubmit} disabled={saving} className="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-accent transition disabled:opacity-50">{saving ? 'Saving...' : 'Submit Inventory'}</button>
              </div>
            </div>
            {message && <div className={`mt-4 p-3 rounded-lg ${message.includes('success') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>{message}</div>}
          </div>

          {showAddItem && (
            <div className="bg-white p-6 rounded-xl shadow-sm border-2 border-primary">
              <h3 className="font-bold text-lg mb-4">Add Custom Item</h3>
              <div className="grid md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                  <select value={newItemCategory} onChange={(e) => setNewItemCategory(e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                    <option value="">Select category...</option>
                    {template.map(cat => <option key={cat.category} value={cat.category}>{cat.category}</option>)}
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                  <input type="text" value={newItemName} onChange={(e) => setNewItemName(e.target.value)} className="w-full px-3 py-2 border rounded-lg" placeholder="Enter item name" />
                </div>
                <div className="flex items-end gap-2">
                  <button onClick={addCustomItem} className="px-4 py-2 bg-primary text-white rounded-lg">Add</button>
                  <button onClick={() => setShowAddItem(false)} className="px-4 py-2 border rounded-lg">Cancel</button>
                </div>
              </div>
            </div>
          )}

          {allCategories.map(cat => {
            const standardItems = cat.items;
            const customCatItems = customByCategory[cat.category] || [];
            const allItems = [...standardItems, ...customCatItems];
            return (
              <div key={cat.category} className="bg-white rounded-xl shadow-sm overflow-hidden">
                <button onClick={() => toggleCategory(cat.category)} className="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                  <h2 className="text-lg font-bold text-gray-800">{cat.category} <span className="text-sm font-normal text-gray-500">({allItems.length} items)</span></h2>
                  <span className="text-gray-500">{expandedCategories[cat.category] ? '▼' : '▶'}</span>
                </button>
                {expandedCategories[cat.category] && (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="px-3 py-2 text-left font-medium text-gray-600 w-48">Item</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-24">Lot #</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Expiry</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Open</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Open Date</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Closed</th>
                          <th className="px-1 py-2 text-left font-medium text-gray-600">Notes</th>
                          <th className="w-8"></th>
                        </tr>
                      </thead>
                      <tbody>{renderItemRows(cat.category, allItems)}</tbody>
                    </table>
                  </div>
                )}
              </div>
            );
          })}

          {Object.keys(customByCategory).filter(c => !template.find(t => t.category === c)).length > 0 && (
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <button onClick={() => toggleCategory('Other')} className="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                <h2 className="text-lg font-bold text-gray-800">Other Custom Items</h2>
                <span className="text-gray-500">{expandedCategories['Other'] ? '▼' : '▶'}</span>
              </button>
              {expandedCategories['Other'] && (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50 border-b">
                      <tr>
                        <th className="px-3 py-2 text-left font-medium text-gray-600 w-48">Item</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-24">Lot #</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Expiry</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Open</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-28">Open Date</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600 w-16">Closed</th>
                        <th className="px-1 py-2 text-left font-medium text-gray-600">Notes</th>
                        <th className="w-8"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(customByCategory).filter(([c]) => !template.find(t => t.category === c)).map(([cat, items]) => renderItemRows(cat, items, true))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <button onClick={handleSubmit} disabled={saving} className="px-8 py-3 bg-primary text-white rounded-lg font-medium hover:bg-accent transition disabled:opacity-50">{saving ? 'Saving...' : 'Submit Weekly Inventory'}</button>
          </div>
        </div>
      );
    };

    const ReportsPage = ({ token, slug }) => {
      const [report, setReport] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showGuide, setShowGuide] = useState(false);
      const [selectedItems, setSelectedItems] = useState([]);
      const [itemSearch, setItemSearch] = useState('');
      const [categoryFilter, setCategoryFilter] = useState('All');
      
      const CHART_COLORS = ['#045E9F', '#00205A', '#10B981', '#F59E0B', '#EF4444'];

      useEffect(() => {
        fetch(`${API_URL}/api/inventory/report/${slug}`, { headers: { 'Authorization': `Bearer ${token}` } })
          .then(r => r.json())
          .then(data => { setReport(data); setLoading(false); })
          .catch(err => { console.error(err); setLoading(false); });
      }, []);

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      const { alerts, submissions, usageTrends } = report || {};
      const lowStock = alerts?.lowStock || [];
      const expiring = alerts?.expiringSoon || [];

      const handleDownload = () => {
        window.open(`${API_URL}/api/inventory/export/${slug}?token=${token}`, '_blank');
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex flex-col sm:flex-row justify-between items-start gap-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Inventory Reports</h1>
                <p className="text-gray-600 mt-1">View alerts and usage trends for your inventory</p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={handleDownload} className="bg-primary text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-accent transition-colors flex items-center gap-1">
                  {Icons.download} Download CSV
                </button>
                <button onClick={() => onNavigate('submission_history')} className="border border-primary text-primary px-3 py-2 rounded-lg text-sm font-medium hover:bg-primary/10 transition-colors flex items-center gap-1">
                  {Icons.list} View History
                </button>
                <button onClick={() => setShowGuide(!showGuide)} className="text-primary hover:text-accent text-sm flex items-center gap-1">
                  <span>ℹ️</span> {showGuide ? 'Hide Guide' : 'How to Use'}
                </button>
              </div>
            </div>
          </div>

          {showGuide && (
            <div className="bg-blue-50 border border-blue-200 p-6 rounded-xl">
              <h3 className="text-lg font-bold text-blue-800 mb-4">Understanding Your Inventory Reports</h3>
              <div className="grid md:grid-cols-2 gap-6 text-sm text-gray-700">
                <div>
                  <h4 className="font-semibold text-red-600 mb-2">Low Stock Alerts</h4>
                  <p className="mb-2">Items with a combined quantity (open + closed) of 2 or fewer units are flagged here. These require immediate attention to prevent stockouts.</p>
                  <p className="text-xs text-gray-500">Action: Reorder these items as soon as possible.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-orange-600 mb-2">Expiring Soon</h4>
                  <p className="mb-2">Items with expiration dates within the next 30 days appear here. Use these items first to minimize waste.</p>
                  <p className="text-xs text-gray-500">Action: Prioritize using expiring items; plan replacement orders.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-purple-600 mb-2">Top Consumed Items (Rolling Average)</h4>
                  <p className="mb-2">Shows your highest-consumption items with accurate usage rates calculated across up to 12 submissions:</p>
                  <ul className="list-disc list-inside text-xs space-y-1 mt-1">
                    <li><strong>Total Used:</strong> Sum of all consumption across analyzed periods</li>
                    <li><strong>Avg Weekly:</strong> Average usage per week based on total consumed divided by total days, smoothed across multiple submissions</li>
                    <li><strong>Weeks Left:</strong> Estimated time until depletion at the average rate</li>
                    <li><strong>Periods:</strong> Number of submission intervals used in the calculation</li>
                  </ul>
                  <p className="text-xs text-gray-500 mt-2">More submissions = more accurate predictions. Color codes: Red = 2 weeks or less | Orange = 2-4 weeks | Green = 4+ weeks</p>
                </div>
                <div>
                  <h4 className="font-semibold text-blue-600 mb-2">Item Quantities Over Time</h4>
                  <p className="mb-2">Select individual items to see their quantity trends across submissions. Compare up to 5 items at once to spot patterns.</p>
                  <ul className="list-disc list-inside text-xs space-y-1 mt-1">
                    <li>Use category chips to filter by item type</li>
                    <li>Search to find specific items quickly</li>
                    <li>Color-coded lines show each item's trend</li>
                  </ul>
                  <p className="text-xs text-gray-500 mt-2">Tip: Compare similar items to identify usage patterns.</p>
                </div>
              </div>
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-red-600 mb-4 flex items-center gap-2">
                <span className="text-red-600">{Icons.warning}</span> Low Stock Alerts ({lowStock.length})
              </h2>
              {lowStock.length > 0 ? (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {lowStock.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.category}</p>
                      </div>
                      <span className="text-red-600 font-bold">{item.quantity} left</span>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>All items are well stocked</p>
                </div>
              )}
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-orange-600 mb-4 flex items-center gap-2">
                <span className="text-orange-600">{Icons.calendar}</span> Expiring Soon ({expiring.length})
              </h2>
              {expiring.length > 0 ? (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {expiring.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.category}</p>
                      </div>
                      <div className="text-right">
                        <span className="text-orange-600 font-bold">{item.daysUntilExpiry} days</span>
                        <p className="text-xs text-gray-500">{new Date(item.expiry).toLocaleDateString()}</p>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>No items expiring soon</p>
                </div>
              )}
            </div>
          </div>

          {usageTrends?.consumptionRate?.length > 0 && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-purple-600 mb-4 flex items-center gap-2">
                <span className="text-purple-600">{Icons.chart}</span> Top Consumed Items (Rolling Average)
              </h2>
              <p className="text-xs text-gray-500 mb-3">Average weekly usage calculated across up to 12 submissions for accuracy</p>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b">
                      <th className="text-left py-2 font-medium text-gray-600">Item</th>
                      <th className="text-right py-2 font-medium text-gray-600">Current Stock</th>
                      <th className="text-right py-2 font-medium text-gray-600">Total Used</th>
                      <th className="text-right py-2 font-medium text-gray-600">Avg Weekly</th>
                      <th className="text-right py-2 font-medium text-gray-600">Weeks Left</th>
                    </tr>
                  </thead>
                  <tbody>
                    {usageTrends.consumptionRate.map((item, idx) => (
                      <tr key={idx} className="border-b hover:bg-gray-50">
                        <td className="py-2">
                          <p className="font-medium text-gray-800">{item.itemName}</p>
                          <p className="text-xs text-gray-500">{item.category} {item.dataPoints && `(${item.dataPoints} periods)`}</p>
                        </td>
                        <td className="text-right text-gray-600">{item.currentQty}</td>
                        <td className="text-right text-red-600 font-medium">{item.totalConsumed}</td>
                        <td className="text-right text-gray-600">{item.weeklyRate}/wk</td>
                        <td className="text-right">
                          <span className={`font-medium ${item.weeksRemaining <= 2 ? 'text-red-600' : item.weeksRemaining <= 4 ? 'text-orange-600' : 'text-green-600'}`}>
                            {item.weeksRemaining > 0 ? `${item.weeksRemaining} wks` : 'Empty'}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {usageTrends?.itemTimeSeries?.length > 0 && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-blue-600 mb-4 flex items-center gap-2">
                <span>📈</span> Item Quantities Over Time
              </h2>
              <p className="text-xs text-gray-500 mb-3">Select up to 5 items to compare their quantity trends across submissions</p>
              
              {/* Category filter chips */}
              <div className="flex flex-wrap gap-2 mb-3">
                {['All', ...new Set(usageTrends.itemTimeSeries.map(i => i.category))].map(cat => (
                  <button key={cat} onClick={() => setCategoryFilter(cat)} className={`px-3 py-1 rounded-full text-xs font-medium transition ${categoryFilter === cat ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{cat}</button>
                ))}
              </div>
              
              {/* Item search and selector */}
              <div className="mb-4">
                <input type="text" placeholder="Search items..." value={itemSearch} onChange={e => setItemSearch(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm mb-2" />
                <div className="max-h-32 overflow-y-auto border rounded-lg p-2 bg-gray-50">
                  {usageTrends.itemTimeSeries
                    .filter(item => (categoryFilter === 'All' || item.category === categoryFilter) && item.itemName.toLowerCase().includes(itemSearch.toLowerCase()))
                    .map(item => {
                      const isSelected = selectedItems.includes(item.key);
                      return (
                        <label key={item.key} className={`flex items-center gap-2 p-1 rounded cursor-pointer hover:bg-gray-100 ${isSelected ? 'bg-blue-50' : ''}`}>
                          <input type="checkbox" checked={isSelected} disabled={!isSelected && selectedItems.length >= 5} onChange={() => {
                            if (isSelected) setSelectedItems(selectedItems.filter(k => k !== item.key));
                            else if (selectedItems.length < 5) setSelectedItems([...selectedItems, item.key]);
                          }} className="rounded" />
                          <span className="text-sm text-gray-700">{item.itemName}</span>
                          <span className="text-xs text-gray-400">({item.category})</span>
                        </label>
                      );
                    })}
                </div>
              </div>
              
              {/* Selected items legend */}
              {selectedItems.length > 0 && (
                <div className="flex flex-wrap gap-2 mb-3">
                  {selectedItems.map((key, idx) => {
                    const item = usageTrends.itemTimeSeries.find(i => i.key === key);
                    return (
                      <span key={key} className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs text-white" style={{ backgroundColor: CHART_COLORS[idx % CHART_COLORS.length] }}>
                        {item?.itemName}
                        <button onClick={() => setSelectedItems(selectedItems.filter(k => k !== key))} className="ml-1 hover:opacity-75">×</button>
                      </span>
                    );
                  })}
                </div>
              )}
              
              {/* Line chart */}
              {selectedItems.length > 0 ? (
                <div className="relative h-80 border rounded-lg p-4 bg-gray-50">
                  {(() => {
                    const selectedData = selectedItems.map(key => usageTrends.itemTimeSeries.find(i => i.key === key)).filter(Boolean);
                    const allDates = [...new Set(selectedData.flatMap(item => item.dataPoints.map(dp => dp.date)))].sort();
                    const maxQty = Math.max(...selectedData.flatMap(item => item.dataPoints.map(dp => dp.quantity)), 1);
                    const chartWidth = 300;
                    const chartHeight = 200;
                    
                    return (
                      <svg viewBox={`0 0 ${chartWidth + 50} ${chartHeight + 40}`} className="w-full h-full" preserveAspectRatio="xMidYMid meet">
                        {/* Y-axis labels */}
                        <text x="5" y="20" fontSize="10" fill="#6b7280">{maxQty}</text>
                        <text x="5" y={chartHeight / 2 + 15} fontSize="10" fill="#6b7280">{Math.round(maxQty / 2)}</text>
                        <text x="5" y={chartHeight + 5} fontSize="10" fill="#6b7280">0</text>
                        
                        {/* Grid lines */}
                        {[0, 0.25, 0.5, 0.75, 1].map((pct, idx) => (
                          <line key={idx} x1="35" y1={chartHeight * pct + 10} x2={chartWidth + 35} y2={chartHeight * pct + 10} stroke="#e5e7eb" strokeWidth="1" />
                        ))}
                        
                        {/* Lines for each selected item */}
                        {selectedData.map((item, itemIdx) => {
                          const points = allDates.map((date, dateIdx) => {
                            const dp = item.dataPoints.find(p => p.date === date);
                            const x = 35 + (dateIdx / Math.max(allDates.length - 1, 1)) * chartWidth;
                            const y = 10 + chartHeight - (dp ? (dp.quantity / maxQty) * chartHeight : 0);
                            return `${x},${y}`;
                          }).join(' ');
                          return <polyline key={item.key} points={points} fill="none" stroke={CHART_COLORS[itemIdx % CHART_COLORS.length]} strokeWidth="2" />;
                        })}
                        
                        {/* X-axis date labels */}
                        {allDates.map((date, idx) => (
                          <text key={idx} x={35 + (idx / Math.max(allDates.length - 1, 1)) * chartWidth} y={chartHeight + 25} textAnchor="middle" fontSize="9" fill="#6b7280">
                            {new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                          </text>
                        ))}
                      </svg>
                    );
                  })()}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-400 border rounded-lg bg-gray-50">
                  <p>Select items above to see their quantity trends</p>
                </div>
              )}
            </div>
          )}

          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">
              <span className="text-accent">{Icons.list}</span> Submission History
            </h2>
            {submissions && submissions.length > 0 ? (
              <div className="space-y-2">
                {submissions.slice(0, 10).map((sub, idx) => (
                  <div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p className="font-medium text-gray-800">{new Date(sub.submittedAt).toLocaleDateString()}</p>
                      <p className="text-xs text-gray-500">Submitted by {sub.submittedBy}</p>
                    </div>
                    <span className="text-gray-600">{Object.keys(sub.data || {}).length} items tracked</span>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <p>No submissions yet - submit your first inventory to see trends</p>
              </div>
            )}
          </div>
        </div>
      );
    };
    
    // Admin Aggregate Inventory Report Page
    const AdminReportsPage = ({ token, onNavigate }) => {
      const [report, setReport] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch(`${API_URL}/api/inventory/report-all`, { headers: { 'Authorization': `Bearer ${token}` } })
          .then(r => r.json())
          .then(data => { setReport(data); setLoading(false); })
          .catch(err => { console.error(err); setLoading(false); });
      }, []);

      const handleDownloadAll = () => {
        window.open(`${API_URL}/api/inventory/export-all?token=${token}`, '_blank');
      };

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      const { summary, alerts, clientSummaries, inactiveClients } = report || {};
      const lowStock = alerts?.lowStock || [];
      const expiring = alerts?.expiringSoon || [];

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h1 className="text-2xl font-bold text-accent">All Clients Inventory Report</h1>
              <p className="text-gray-600 mt-1">Aggregated inventory metrics across all client sites</p>
            </div>
            <div className="flex flex-wrap gap-2">
              <button onClick={handleDownloadAll} className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition-colors flex items-center gap-2">
                {Icons.download} Download All CSV
              </button>
              <button onClick={() => onNavigate('submission_history')} className="border border-primary text-primary px-4 py-2 rounded-lg font-medium hover:bg-primary/10 transition-colors flex items-center gap-2">
                {Icons.list} Submission History
              </button>
            </div>
          </div>

          {/* Summary Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-primary">
              <p className="text-gray-500 text-sm">Total Clients</p>
              <p className="text-2xl font-bold text-accent">{summary?.totalClients || 0}</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
              <p className="text-gray-500 text-sm">With Inventory Data</p>
              <p className="text-2xl font-bold text-green-600">{summary?.activeClients || 0}</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
              <p className="text-gray-500 text-sm">Low Stock Alerts</p>
              <p className="text-2xl font-bold text-red-600">{summary?.totalLowStockAlerts || 0}</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
              <p className="text-gray-500 text-sm">Expiring Soon</p>
              <p className="text-2xl font-bold text-orange-600">{summary?.totalExpiringAlerts || 0}</p>
            </div>
          </div>

          {/* Client Summaries Table */}
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-accent mb-4 flex items-center gap-2">
              <span className="text-primary">{Icons.target}</span> Client Inventory Summary
            </h2>
            {clientSummaries && clientSummaries.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b bg-gray-50">
                      <th className="text-left py-3 px-4 font-medium text-gray-600">Client</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Last Update</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Items</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Total Qty</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Low Stock</th>
                      <th className="text-right py-3 px-4 font-medium text-gray-600">Expiring</th>
                    </tr>
                  </thead>
                  <tbody>
                    {clientSummaries.map((client, idx) => (
                      <tr key={idx} className="border-b hover:bg-gray-50">
                        <td className="py-3 px-4 font-medium text-gray-800">{client.clientName}</td>
                        <td className="py-3 px-4 text-right text-gray-600">{new Date(client.lastSubmission).toLocaleDateString()}</td>
                        <td className="py-3 px-4 text-right text-gray-600">{client.totalItems}</td>
                        <td className="py-3 px-4 text-right text-gray-600">{client.totalQuantity}</td>
                        <td className="py-3 px-4 text-right">
                          <span className={client.lowStockCount > 0 ? 'text-red-600 font-medium' : 'text-green-600'}>
                            {client.lowStockCount}
                          </span>
                        </td>
                        <td className="py-3 px-4 text-right">
                          <span className={client.expiringCount > 0 ? 'text-orange-600 font-medium' : 'text-green-600'}>
                            {client.expiringCount}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <p>No client inventory data available yet</p>
              </div>
            )}
          </div>

          {/* Inactive Clients Warning */}
          {inactiveClients && inactiveClients.length > 0 && (
            <div className="bg-yellow-50 border border-yellow-200 p-6 rounded-xl">
              <h2 className="text-lg font-bold text-yellow-700 mb-3 flex items-center gap-2">
                <span className="text-yellow-600">{Icons.warning}</span> Clients Needing Follow-up
              </h2>
              <p className="text-sm text-yellow-700 mb-3">These clients haven't submitted inventory in over 7 days:</p>
              <div className="space-y-2">
                {inactiveClients.map((client, idx) => (
                  <div key={idx} className="flex justify-between items-center p-3 bg-white rounded-lg border border-yellow-200">
                    <span className="font-medium text-gray-800">{client.clientName}</span>
                    <span className="text-yellow-700 text-sm">Last: {new Date(client.lastSubmission).toLocaleDateString()}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* All Low Stock Alerts */}
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-red-600 mb-4 flex items-center gap-2">
                <span className="text-red-600">{Icons.warning}</span> All Low Stock Alerts ({lowStock.length})
              </h2>
              {lowStock.length > 0 ? (
                <div className="space-y-2 max-h-80 overflow-y-auto">
                  {lowStock.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.clientName} - {item.category}</p>
                      </div>
                      <span className="text-red-600 font-bold">{item.quantity} left</span>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>All clients well stocked</p>
                </div>
              )}
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-orange-600 mb-4 flex items-center gap-2">
                <span className="text-orange-600">{Icons.calendar}</span> All Expiring Soon ({expiring.length})
              </h2>
              {expiring.length > 0 ? (
                <div className="space-y-2 max-h-80 overflow-y-auto">
                  {expiring.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                      <div>
                        <p className="font-medium text-gray-800">{item.itemName}</p>
                        <p className="text-xs text-gray-500">{item.clientName} - {item.category}</p>
                      </div>
                      <div className="text-right">
                        <span className="text-orange-600 font-bold">{item.daysUntilExpiry} days</span>
                        <p className="text-xs text-gray-500">{new Date(item.expiry).toLocaleDateString()}</p>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="flex justify-center mb-2 text-green-500">{React.cloneElement(Icons.target, { className: 'w-10 h-10' })}</div>
                  <p>No items expiring soon</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Client Submission History Page - Spreadsheet View
    const SubmissionHistoryPage = ({ token, slug, isAdmin, onNavigate }) => {
      const [submissions, setSubmissions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedClient, setSelectedClient] = useState('');
      const [clientList, setClientList] = useState([]);
      const [expandedRows, setExpandedRows] = useState({});
      
      // Filters
      const [dateFrom, setDateFrom] = useState('');
      const [dateTo, setDateTo] = useState('');
      const [categoryFilter, setCategoryFilter] = useState('');
      const [searchTerm, setSearchTerm] = useState('');
      
      // Flatten all submissions into item-level rows
      const [itemRows, setItemRows] = useState([]);
      const [selectedRows, setSelectedRows] = useState(new Set());

      useEffect(() => {
        if (isAdmin) {
          fetch(`${API_URL}/api/inventory/report-all`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json())
            .then(data => {
              setClientList(data.clientSummaries || []);
              setLoading(false);
            })
            .catch(err => { console.error(err); setLoading(false); });
        } else {
          loadSubmissions(slug);
        }
      }, []);

      useEffect(() => {
        if (isAdmin && selectedClient) {
          loadSubmissions(selectedClient);
        }
      }, [selectedClient]);

      const loadSubmissions = async (clientSlug) => {
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/inventory/submissions/${clientSlug}`, { 
            headers: { 'Authorization': `Bearer ${token}` } 
          });
          const data = await response.json();
          const sorted = data.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
          setSubmissions(sorted);
          
          // Flatten into item rows
          const rows = [];
          sorted.forEach(sub => {
            const submissionDate = new Date(sub.submittedAt);
            Object.entries(sub.data || {}).forEach(([itemName, itemData]) => {
              const batches = Array.isArray(itemData?.batches) ? itemData.batches : [itemData || {}];
              batches.forEach((batch, batchIdx) => {
                rows.push({
                  submissionId: sub.id,
                  submissionDate: submissionDate,
                  submittedBy: sub.submittedBy,
                  itemName: itemName,
                  category: itemData?.category || batch?.category || 'General',
                  lotNumber: batch?.lotNumber || batch?.lot || '',
                  expiry: batch?.expiry || '',
                  openQty: parseInt(batch?.openQty) || 0,
                  closedQty: parseInt(batch?.closedQty) || 0,
                  totalQty: (parseInt(batch?.openQty) || 0) + (parseInt(batch?.closedQty) || 0),
                  notes: batch?.notes || '',
                  batchIndex: batchIdx
                });
              });
            });
          });
          setItemRows(rows);
        } catch (err) {
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      // Get unique categories for filter
      const categories = [...new Set(itemRows.map(r => r.category))].filter(Boolean).sort();

      // Apply filters
      const filteredRows = itemRows.filter(row => {
        if (dateFrom && row.submissionDate < new Date(dateFrom)) return false;
        if (dateTo && row.submissionDate > new Date(dateTo + 'T23:59:59')) return false;
        if (categoryFilter && row.category !== categoryFilter) return false;
        if (searchTerm && !row.itemName.toLowerCase().includes(searchTerm.toLowerCase())) return false;
        return true;
      });

      const toggleSelectAll = () => {
        if (selectedRows.size === filteredRows.length) {
          setSelectedRows(new Set());
        } else {
          setSelectedRows(new Set(filteredRows.map((_, i) => i)));
        }
      };

      const toggleRow = (idx) => {
        const newSelected = new Set(selectedRows);
        if (newSelected.has(idx)) {
          newSelected.delete(idx);
        } else {
          newSelected.add(idx);
        }
        setSelectedRows(newSelected);
      };

      const handleDownloadFiltered = () => {
        const rowsToExport = selectedRows.size > 0 
          ? filteredRows.filter((_, i) => selectedRows.has(i))
          : filteredRows;
        
        if (rowsToExport.length === 0) {
          alert('No data to export');
          return;
        }

        const headers = ['Date', 'Submitted By', 'Item Name', 'Category', 'Lot Number', 'Expiry Date', 'Open Qty', 'Closed Qty', 'Total Qty', 'Notes'];
        const csvContent = [
          headers.join(','),
          ...rowsToExport.map(row => [
            row.submissionDate.toLocaleDateString(),
            `"${row.submittedBy}"`,
            `"${row.itemName}"`,
            `"${row.category}"`,
            `"${row.lotNumber}"`,
            row.expiry ? new Date(row.expiry).toLocaleDateString() : '',
            row.openQty,
            row.closedQty,
            row.totalQty,
            `"${row.notes}"`
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inventory-submissions-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const clearFilters = () => {
        setDateFrom('');
        setDateTo('');
        setCategoryFilter('');
        setSearchTerm('');
        setSelectedRows(new Set());
      };

      if (loading) {
        return (<div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div></div>);
      }

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Submission History</h1>
                <p className="text-gray-600 mt-1">{isAdmin ? 'Detailed inventory submission records from all clients' : 'Detailed view of your inventory submissions'}</p>
              </div>
            </div>
          </div>

          {isAdmin && (
            <div className="bg-white p-4 rounded-xl shadow-sm">
              <label className="block text-sm font-medium text-gray-700 mb-2">Select Client</label>
              <select
                value={selectedClient}
                onChange={(e) => { setSelectedClient(e.target.value); setSelectedRows(new Set()); }}
                className="w-full md:w-64 p-2 border rounded-lg"
              >
                <option value="">Choose a client...</option>
                {clientList.map(c => (
                  <option key={c.slug} value={c.slug}>{c.clientName}</option>
                ))}
              </select>
            </div>
          )}

          {(isAdmin && !selectedClient) ? (
            <div className="bg-white p-6 rounded-xl shadow-sm text-center py-12">
              <div className="flex justify-center mb-4 text-gray-400">{React.cloneElement(Icons.list, { className: 'w-16 h-16' })}</div>
              <p className="text-gray-500">Select a client above to view their submission history</p>
            </div>
          ) : itemRows.length === 0 ? (
            <div className="bg-white p-6 rounded-xl shadow-sm text-center py-12">
              <div className="flex justify-center mb-4 text-gray-400">{React.cloneElement(Icons.list, { className: 'w-16 h-16' })}</div>
              <p className="text-gray-500">No submissions found</p>
            </div>
          ) : (
            <>
              {/* Filters */}
              <div className="bg-white p-4 rounded-xl shadow-sm">
                <div className="flex flex-wrap gap-4 items-end">
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">Search Item</label>
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      placeholder="Search items..."
                      className="border rounded-lg px-3 py-2 text-sm w-48"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">Category</label>
                    <select
                      value={categoryFilter}
                      onChange={(e) => setCategoryFilter(e.target.value)}
                      className="border rounded-lg px-3 py-2 text-sm"
                    >
                      <option value="">All Categories</option>
                      {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">From Date</label>
                    <input
                      type="date"
                      value={dateFrom}
                      onChange={(e) => setDateFrom(e.target.value)}
                      className="border rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">To Date</label>
                    <input
                      type="date"
                      value={dateTo}
                      onChange={(e) => setDateTo(e.target.value)}
                      className="border rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <button
                    onClick={clearFilters}
                    className="text-gray-500 hover:text-gray-700 text-sm underline"
                  >
                    Clear Filters
                  </button>
                </div>
              </div>

              {/* Download Options */}
              <div className="bg-white p-4 rounded-xl shadow-sm flex flex-wrap items-center justify-between gap-4">
                <div className="text-sm text-gray-600">
                  {selectedRows.size > 0 ? (
                    <span className="font-medium text-primary">{selectedRows.size} of {filteredRows.length} rows selected</span>
                  ) : (
                    <span>{filteredRows.length} records found</span>
                  )}
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={handleDownloadFiltered}
                    className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition-colors flex items-center gap-2 text-sm"
                  >
                    {Icons.download} {selectedRows.size > 0 ? `Download Selected (${selectedRows.size})` : 'Download All'}
                  </button>
                </div>
              </div>

              {/* Spreadsheet Table */}
              <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-100 border-b">
                      <tr>
                        <th className="p-3 text-left">
                          <input
                            type="checkbox"
                            checked={selectedRows.size === filteredRows.length && filteredRows.length > 0}
                            onChange={toggleSelectAll}
                            className="rounded"
                          />
                        </th>
                        <th className="p-3 text-left font-semibold text-gray-700">Date</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Item Name</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Category</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Lot #</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Expiry</th>
                        <th className="p-3 text-center font-semibold text-gray-700">Open</th>
                        <th className="p-3 text-center font-semibold text-gray-700">Closed</th>
                        <th className="p-3 text-center font-semibold text-gray-700">Total</th>
                        <th className="p-3 text-left font-semibold text-gray-700">Notes</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {filteredRows.length === 0 ? (
                        <tr>
                          <td colSpan="10" className="p-8 text-center text-gray-500">
                            No records match your filters
                          </td>
                        </tr>
                      ) : (
                        filteredRows.map((row, idx) => (
                          <tr 
                            key={`${row.submissionId}-${row.itemName}-${row.batchIndex}`}
                            className={`hover:bg-gray-50 ${selectedRows.has(idx) ? 'bg-blue-50' : ''}`}
                          >
                            <td className="p-3">
                              <input
                                type="checkbox"
                                checked={selectedRows.has(idx)}
                                onChange={() => toggleRow(idx)}
                                className="rounded"
                              />
                            </td>
                            <td className="p-3 text-gray-600 whitespace-nowrap">
                              {row.submissionDate.toLocaleDateString()}
                            </td>
                            <td className="p-3 font-medium text-gray-800">{row.itemName}</td>
                            <td className="p-3">
                              <span className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">{row.category}</span>
                            </td>
                            <td className="p-3 text-gray-600 font-mono text-xs">{row.lotNumber || '-'}</td>
                            <td className="p-3 text-gray-600 whitespace-nowrap">
                              {row.expiry ? (
                                <span className={new Date(row.expiry) < new Date() ? 'text-red-600' : ''}>
                                  {new Date(row.expiry).toLocaleDateString()}
                                </span>
                              ) : '-'}
                            </td>
                            <td className="p-3 text-center">{row.openQty}</td>
                            <td className="p-3 text-center">{row.closedQty}</td>
                            <td className="p-3 text-center font-semibold">{row.totalQty}</td>
                            <td className="p-3 text-gray-500 text-xs max-w-xs truncate">{row.notes || '-'}</td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
                {filteredRows.length > 50 && (
                  <div className="p-4 bg-gray-50 border-t text-center text-sm text-gray-500">
                    Showing {filteredRows.length} records. Use filters to narrow results or download for full analysis.
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      );
    };

    const SupportPage = ({ settings }) => {
      const supportUrl = settings?.supportUrl || 'https://thrive365labs-49020024.hs-sites.com/support';
      
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent">Customer Support</h1>
            <p className="text-gray-600 mt-1">Get help from our support team</p>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="flex justify-center mb-4 text-primary">{React.cloneElement(Icons.chat, { className: 'w-16 h-16' })}</div>
            <h2 className="text-xl font-semibold text-gray-800 mb-2">Need Assistance?</h2>
            <p className="text-gray-600 mb-6">
              Our support team is ready to help you with any questions or issues.
            </p>
            <a
              href={supportUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-block bg-primary text-white px-8 py-3 rounded-lg font-medium hover:bg-accent transition-colors"
            >
              Open Support Center
            </a>
          </div>
        </div>
      );
    };
    
    const FilesPage = ({ settings, documents: initialDocuments, token, projects, userData }) => {
      const [documents, setDocuments] = useState(initialDocuments || []);
      const [selectedFile, setSelectedFile] = useState(null);
      const [category, setCategory] = useState('');
      const [note, setNote] = useState('');
      const [uploading, setUploading] = useState(false);
      const [uploadMessage, setUploadMessage] = useState(null);
      
      const slug = localStorage.getItem('portal_user') ? JSON.parse(localStorage.getItem('portal_user')).slug : null;
      
      // Check if user has any HubSpot IDs configured for uploads
      const hasHubSpotConfig = userData?.hubspotCompanyId || userData?.hubspotDealId || userData?.hubspotContactId;
      
      const refreshDocuments = async () => {
        if (!slug) return;
        try {
          const response = await fetch(`${API_URL}/api/client-documents/${slug}`);
          const data = await response.json();
          setDocuments(data || []);
        } catch (err) {
          console.error('Failed to refresh documents:', err);
        }
      };
      
      const adminDocs = (documents || []).filter(doc => doc.uploadedBy !== 'client');
      const clientUploads = (documents || []).filter(doc => doc.uploadedBy === 'client');
      
      const groupedAdminDocs = adminDocs.reduce((acc, doc) => {
        const cat = doc.category || 'General';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(doc);
        return acc;
      }, {});
      
      const categories = ['Contracts', 'Onboarding', 'Inserts', 'Certificates of Analysis', 'SOP Templates', 'Other'];
      
      const handleFileUpload = async (e) => {
        e.preventDefault();
        if (!selectedFile) {
          setUploadMessage({ type: 'error', text: 'Please select a file' });
          return;
        }
        
        setUploading(true);
        setUploadMessage(null);
        
        try {
          const formData = new FormData();
          formData.append('file', selectedFile);
          formData.append('category', category);
          formData.append('noteText', note);
          
          const response = await fetch(`${API_URL}/api/client/hubspot/upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
          });
          
          const result = await response.json();
          
          if (response.ok) {
            setUploadMessage({ type: 'success', text: result.message || 'File uploaded successfully!' });
            setSelectedFile(null);
            setNote('');
            setCategory('');
            document.getElementById('clientFileInput').value = '';
            refreshDocuments();
          } else {
            setUploadMessage({ type: 'error', text: result.error || 'Upload failed' });
          }
        } catch (error) {
          setUploadMessage({ type: 'error', text: 'Failed to upload file. Please try again.' });
        } finally {
          setUploading(false);
        }
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent">Files</h1>
            <p className="text-gray-600 mt-1">Access your documents and upload files</p>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span>📥</span> Documents From Thrive 365 Labs
            </h2>
            {adminDocs.length > 0 ? (
              <div className="space-y-4">
                {Object.entries(groupedAdminDocs).map(([cat, docs]) => (
                  <div key={cat}>
                    <h3 className="text-sm font-semibold text-gray-500 uppercase mb-2">{cat}</h3>
                    <div className="space-y-2">
                      {docs.map(doc => (
                        <a
                          key={doc.id}
                          href={doc.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-3 p-3 rounded-lg border hover:bg-gray-50 transition group"
                        >
                          <span className="text-2xl">📄</span>
                          <div className="flex-1">
                            <p className="font-medium text-gray-800 group-hover:text-primary">{doc.title}</p>
                            {doc.description && (
                              <p className="text-sm text-gray-500">{doc.description}</p>
                            )}
                          </div>
                          <span className="text-primary text-sm">Download →</span>
                        </a>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">📂</div>
                <p>No documents from Thrive 365 Labs yet.</p>
              </div>
            )}
          </div>
          
          {clientUploads.length > 0 && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>📤</span> Your Uploaded Files
              </h2>
              <p className="text-sm text-gray-500 mb-4">Files you've uploaded to Thrive 365 Labs</p>
              <div className="space-y-2">
                {clientUploads.map(doc => (
                  <div
                    key={doc.id}
                    className="flex items-center gap-3 p-3 rounded-lg border bg-green-50 border-green-200"
                  >
                    <span className="text-2xl">✅</span>
                    <div className="flex-1">
                      <p className="font-medium text-gray-800">{doc.title}</p>
                      <div className="flex flex-wrap gap-2 text-xs text-gray-500 mt-1">
                        {doc.category && <span className="bg-gray-100 px-2 py-0.5 rounded">{doc.category}</span>}
                        <span>Uploaded {new Date(doc.createdAt).toLocaleDateString()}</span>
                        {doc.projectName && <span>• {doc.projectName}</span>}
                      </div>
                      {doc.description && (
                        <p className="text-sm text-gray-600 mt-1">{doc.description}</p>
                      )}
                    </div>
                    {doc.hubspotFileUrl ? (
                      <a 
                        href={doc.hubspotFileUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-primary text-sm font-medium hover:underline"
                      >
                        View →
                      </a>
                    ) : (
                      <span className="text-green-600 text-sm font-medium">✓ Uploaded</span>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {hasHubSpotConfig && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>📤</span> Upload Files to Thrive 365 Labs
              </h2>
              <p className="text-gray-600 text-sm mb-4">
                Upload documents directly to your account record. Accepted formats: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, GIF, TXT, CSV (max 10MB)
              </p>
              
              {uploadMessage && (
                <div className={`p-3 rounded-lg mb-4 ${uploadMessage.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                  {uploadMessage.text}
                </div>
              )}
              
              <form onSubmit={handleFileUpload} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                  <select
                    value={category}
                    onChange={(e) => setCategory(e.target.value)}
                    className="w-full border rounded-lg p-2"
                  >
                    <option value="">Select category (optional)</option>
                    {categories.map(c => (
                      <option key={c} value={c}>{c}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">File</label>
                  <input
                    id="clientFileInput"
                    type="file"
                    onChange={(e) => setSelectedFile(e.target.files[0])}
                    className="w-full border rounded-lg p-2"
                    accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.txt,.csv"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Note (optional)</label>
                  <textarea
                    value={note}
                    onChange={(e) => setNote(e.target.value)}
                    className="w-full border rounded-lg p-2"
                    rows="2"
                    placeholder="Add a note about this file..."
                  />
                </div>
                
                <button
                  type="submit"
                  disabled={uploading || !selectedFile}
                  className="w-full bg-primary text-white py-2 px-4 rounded-lg font-medium hover:bg-accent transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {uploading ? 'Uploading...' : 'Upload File'}
                </button>
              </form>
            </div>
          )}

          {settings?.filesFormEmbed && (
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>📝</span> Additional Upload Options
              </h2>
              <div dangerouslySetInnerHTML={{ __html: settings.filesFormEmbed }} />
            </div>
          )}
        </div>
      );
    };
    
    // ============== ADMIN PORTAL PAGES ==============
    
    const AdminHomePage = ({ token }) => {
      const [stats, setStats] = useState({ clients: 0, announcements: 0, documents: 0 });
      
      useEffect(() => {
        const loadStats = async () => {
          try {
            const [clientsRes, announcementsRes] = await Promise.all([
              fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
              fetch(`${API_URL}/api/announcements`).then(r => r.json())
            ]);
            setStats({
              clients: Array.isArray(clientsRes) ? clientsRes.filter(u => u.role === 'client').length : 0,
              announcements: Array.isArray(announcementsRes) ? announcementsRes.length : 0
            });
          } catch (err) {
            console.error('Failed to load stats:', err);
          }
        };
        loadStats();
      }, [token]);
      
      return (
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-accent to-primary text-white p-6 md:p-8 rounded-xl">
            <h1 className="text-2xl md:text-3xl font-bold">Admin Portal Dashboard</h1>
            <p className="mt-2 opacity-90">Manage your client portal settings and content</p>
          </div>
          
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-primary">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-500 text-sm">Client Users</p>
                  <p className="text-3xl font-bold text-accent">{stats.clients}</p>
                </div>
                <div className="text-primary opacity-50">{React.cloneElement(AdminIcons.users, { className: 'w-12 h-12' })}</div>
              </div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-500 text-sm">Announcements</p>
                  <p className="text-3xl font-bold text-accent">{stats.announcements}</p>
                </div>
                <div className="text-green-500 opacity-50">{React.cloneElement(Icons.megaphone, { className: 'w-12 h-12' })}</div>
              </div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-500 text-sm">Portal Status</p>
                  <p className="text-lg font-bold text-green-600">Active</p>
                </div>
                <div className="text-orange-500 opacity-50">{React.cloneElement(AdminIcons.settings, { className: 'w-12 h-12' })}</div>
              </div>
            </div>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h2 className="text-lg font-bold text-accent mb-4">Quick Actions</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <a href="/" className="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-primary/10 transition group">
                <span className="text-primary">{AdminIcons.back}</span>
                <span className="font-medium text-gray-700 group-hover:text-primary">Implementation App</span>
              </a>
            </div>
          </div>
        </div>
      );
    };
    
    const AdminSettingsPage = ({ token, settings, onSettingsChange }) => {
      const [formData, setFormData] = useState({
        inventoryFormEmbed: settings?.inventoryFormEmbed || '',
        filesFormEmbed: settings?.filesFormEmbed || '',
        supportUrl: settings?.supportUrl || ''
      });
      const [saving, setSaving] = useState(false);
      const [message, setMessage] = useState('');
      
      const handleSave = async () => {
        setSaving(true);
        setMessage('');
        try {
          const res = await fetch(`${API_URL}/api/portal-settings`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          if (res.ok) {
            setMessage('Settings saved successfully!');
            if (onSettingsChange) onSettingsChange(formData);
          } else {
            const data = await res.json();
            setMessage(data.error || 'Failed to save settings');
          }
        } catch (err) {
          setMessage('Error saving settings');
        } finally {
          setSaving(false);
        }
      };
      
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent mb-2">Portal Settings</h1>
            <p className="text-gray-600">Configure HubSpot embed codes and support settings</p>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm space-y-6">
            {message && (
              <div className={`p-4 rounded-lg ${message.includes('success') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                {message}
              </div>
            )}
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Inventory Form Embed Code (HubSpot)</label>
              <textarea
                value={formData.inventoryFormEmbed}
                onChange={(e) => setFormData({ ...formData, inventoryFormEmbed: e.target.value })}
                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary h-32 font-mono text-sm"
                placeholder="Paste HubSpot embed code here..."
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Files Upload Form Embed Code (HubSpot)</label>
              <textarea
                value={formData.filesFormEmbed}
                onChange={(e) => setFormData({ ...formData, filesFormEmbed: e.target.value })}
                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary h-32 font-mono text-sm"
                placeholder="Paste HubSpot embed code here..."
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Customer Support URL</label>
              <input
                type="url"
                value={formData.supportUrl}
                onChange={(e) => setFormData({ ...formData, supportUrl: e.target.value })}
                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                placeholder="https://support.example.com"
              />
            </div>
            
            <button
              onClick={handleSave}
              disabled={saving}
              className="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-accent transition disabled:opacity-50"
            >
              {saving ? 'Saving...' : 'Save Settings'}
            </button>
          </div>
        </div>
      );
    };
    
    const AdminAnnouncementsPage = ({ token }) => {
      const [announcements, setAnnouncements] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [formData, setFormData] = useState({ title: '', content: '', type: 'info' });
      
      const loadAnnouncements = async () => {
        try {
          const res = await fetch(`${API_URL}/api/announcements`);
          const data = await res.json();
          setAnnouncements(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error('Failed to load announcements:', err);
        } finally {
          setLoading(false);
        }
      };
      
      useEffect(() => { loadAnnouncements(); }, []);
      
      const handleSave = async () => {
        try {
          const method = editingId ? 'PUT' : 'POST';
          const url = editingId ? `${API_URL}/api/announcements/${editingId}` : `${API_URL}/api/announcements`;
          const res = await fetch(url, {
            method,
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          if (res.ok) {
            setShowForm(false);
            setEditingId(null);
            setFormData({ title: '', content: '', type: 'info' });
            loadAnnouncements();
          }
        } catch (err) {
          console.error('Failed to save:', err);
        }
      };
      
      const handleDelete = async (id) => {
        if (!confirm('Delete this announcement?')) return;
        try {
          await fetch(`${API_URL}/api/announcements/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          loadAnnouncements();
        } catch (err) {
          console.error('Failed to delete:', err);
        }
      };
      
      const startEdit = (ann) => {
        setFormData({ title: ann.title, content: ann.content, type: ann.type || 'info' });
        setEditingId(ann.id);
        setShowForm(true);
      };
      
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold text-accent">Announcements Manager</h1>
              <p className="text-gray-600">Create and manage portal announcements</p>
            </div>
            <button
              onClick={() => { setShowForm(true); setEditingId(null); setFormData({ title: '', content: '', type: 'info' }); }}
              className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition flex items-center gap-2"
            >
              <span>+</span> New Announcement
            </button>
          </div>
          
          {showForm && (
            <div className="bg-white p-6 rounded-xl shadow-sm border-2 border-primary/20">
              <h2 className="text-lg font-bold mb-4">{editingId ? 'Edit Announcement' : 'New Announcement'}</h2>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                  <input
                    type="text"
                    value={formData.title}
                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Content</label>
                  <textarea
                    value={formData.content}
                    onChange={(e) => setFormData({ ...formData, content: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary h-24"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                  <select
                    value={formData.type}
                    onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                  >
                    <option value="info">Info (Blue)</option>
                    <option value="success">Success (Green)</option>
                    <option value="warning">Warning (Yellow)</option>
                  </select>
                </div>
                <div className="flex gap-2">
                  <button onClick={handleSave} className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent">
                    {editingId ? 'Update' : 'Create'}
                  </button>
                  <button onClick={() => { setShowForm(false); setEditingId(null); }} className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
          
          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            {loading ? (
              <div className="p-8 text-center text-gray-500">Loading...</div>
            ) : announcements.length === 0 ? (
              <div className="p-8 text-center text-gray-500">No announcements yet</div>
            ) : (
              <div className="divide-y">
                {announcements.map(ann => (
                  <div key={ann.id} className="p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 flex-wrap">
                        <h3 className="font-semibold text-gray-800">{ann.title}</h3>
                        <span className={`px-2 py-0.5 text-xs rounded ${
                          ann.type === 'warning' ? 'bg-yellow-100 text-yellow-700' :
                          ann.type === 'success' ? 'bg-green-100 text-green-700' :
                          'bg-blue-100 text-blue-700'
                        }`}>{ann.type || 'info'}</span>
                      </div>
                      <p className="text-sm text-gray-600 mt-1">{ann.content}</p>
                      <p className="text-xs text-gray-400 mt-1">{new Date(ann.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => startEdit(ann)} className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded">Edit</button>
                      <button onClick={() => handleDelete(ann.id)} className="px-3 py-1 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded">Delete</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };
    
    const AdminDocumentsPage = ({ token }) => {
      const [clients, setClients] = useState([]);
      const [selectedClient, setSelectedClient] = useState('');
      const [documents, setDocuments] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [formData, setFormData] = useState({ title: '', url: '', description: '', category: '' });
      const [uploadFile, setUploadFile] = useState(null);
      const [uploadMode, setUploadMode] = useState('link');
      const [uploading, setUploading] = useState(false);
      
      useEffect(() => {
        const loadClients = async () => {
          try {
            const res = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            setClients(Array.isArray(data) ? data.filter(u => u.role === 'client') : []);
          } catch (err) {
            console.error('Failed to load clients:', err);
          } finally {
            setLoading(false);
          }
        };
        loadClients();
      }, [token]);
      
      useEffect(() => {
        if (selectedClient) {
          const loadDocs = async () => {
            try {
              const res = await fetch(`${API_URL}/api/client-documents/${selectedClient}`);
              const data = await res.json();
              setDocuments(Array.isArray(data) ? data : []);
            } catch (err) {
              console.error('Failed to load docs:', err);
            }
          };
          loadDocs();
        }
      }, [selectedClient]);
      
      const handleAdd = async () => {
        setUploading(true);
        try {
          if (uploadMode === 'file' && uploadFile) {
            const formDataObj = new FormData();
            formDataObj.append('file', uploadFile);
            formDataObj.append('title', formData.title);
            formDataObj.append('description', formData.description);
            formDataObj.append('category', formData.category);
            
            const res = await fetch(`${API_URL}/api/client-documents/${selectedClient}/upload`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` },
              body: formDataObj
            });
            if (res.ok) {
              setShowForm(false);
              setFormData({ title: '', url: '', description: '', category: '' });
              setUploadFile(null);
              setUploadMode('link');
              const data = await fetch(`${API_URL}/api/client-documents/${selectedClient}`).then(r => r.json());
              setDocuments(Array.isArray(data) ? data : []);
            }
          } else {
            const res = await fetch(`${API_URL}/api/client-documents/${selectedClient}`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
            if (res.ok) {
              setShowForm(false);
              setFormData({ title: '', url: '', description: '', category: '' });
              const data = await fetch(`${API_URL}/api/client-documents/${selectedClient}`).then(r => r.json());
              setDocuments(Array.isArray(data) ? data : []);
            }
          }
        } catch (err) {
          console.error('Failed to add doc:', err);
        } finally {
          setUploading(false);
        }
      };
      
      const handleDelete = async (docId) => {
        if (!confirm('Delete this document?')) return;
        try {
          await fetch(`${API_URL}/api/client-documents/${selectedClient}/${docId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await fetch(`${API_URL}/api/client-documents/${selectedClient}`).then(r => r.json());
          setDocuments(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error('Failed to delete doc:', err);
        }
      };
      
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent mb-2">Client Documents</h1>
            <p className="text-gray-600">Manage documents for each client portal</p>
          </div>
          
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <label className="block text-sm font-medium text-gray-700 mb-2">Select Client</label>
            <select
              value={selectedClient}
              onChange={(e) => setSelectedClient(e.target.value)}
              className="w-full md:w-1/2 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
            >
              <option value="">-- Select a client --</option>
              {clients.map(c => (
                <option key={c.id} value={c.slug}>{c.practiceName || c.name} ({c.email})</option>
              ))}
            </select>
          </div>
          
          {selectedClient && (
            <>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h2 className="text-lg font-semibold text-gray-800">Documents for {clients.find(c => c.slug === selectedClient)?.practiceName || selectedClient}</h2>
                <button
                  onClick={() => setShowForm(true)}
                  className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent transition"
                >
                  + Add Document
                </button>
              </div>
              
              {showForm && (
                <div className="bg-white p-6 rounded-xl shadow-sm border-2 border-primary/20">
                  <h3 className="text-lg font-bold mb-4">Add Document</h3>
                  
                  <div className="flex gap-4 mb-4">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="uploadMode"
                        checked={uploadMode === 'link'}
                        onChange={() => setUploadMode('link')}
                        className="text-primary"
                      />
                      <span className="text-sm font-medium">Cloud Link</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="uploadMode"
                        checked={uploadMode === 'file'}
                        onChange={() => setUploadMode('file')}
                        className="text-primary"
                      />
                      <span className="text-sm font-medium">Upload File</span>
                    </label>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                      <input
                        type="text"
                        value={formData.title}
                        onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                      />
                    </div>
                    
                    {uploadMode === 'link' ? (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">URL</label>
                        <input
                          type="url"
                          value={formData.url}
                          onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                          placeholder="https://..."
                        />
                      </div>
                    ) : (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">File</label>
                        <input
                          type="file"
                          onChange={(e) => setUploadFile(e.target.files[0])}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                          accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.txt,.csv"
                        />
                        <p className="text-xs text-gray-500 mt-1">PDF, DOC, DOCX, XLS, XLSX, PNG, JPG, GIF, TXT, CSV (max 10MB)</p>
                      </div>
                    )}
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                      <select
                        value={formData.category}
                        onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                      >
                        <option value="">Select a category...</option>
                        <option value="Contracts">Contracts</option>
                        <option value="Onboarding">Onboarding</option>
                        <option value="Inserts">Inserts</option>
                        <option value="Certificates of Analysis">Certificates of Analysis</option>
                        <option value="SOP Templates">SOP Templates</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                      <input
                        type="text"
                        value={formData.description}
                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                      />
                    </div>
                  </div>
                  <div className="flex gap-2 mt-4">
                    <button 
                      onClick={handleAdd} 
                      disabled={uploading}
                      className="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-accent disabled:opacity-50"
                    >
                      {uploading ? 'Adding...' : 'Add'}
                    </button>
                    <button onClick={() => { setShowForm(false); setUploadFile(null); setUploadMode('link'); }} className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                  </div>
                </div>
              )}
              
              <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                {documents.length === 0 ? (
                  <div className="p-8 text-center text-gray-500">No documents for this client</div>
                ) : (
                  <div className="divide-y">
                    {documents.map(doc => (
                      <div key={doc.id} className={`p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4 ${doc.uploadedBy === 'client' ? 'bg-green-50 border-l-4 border-green-500' : ''}`}>
                        <div className="flex-1">
                          <div className="flex items-center gap-2 flex-wrap">
                            <h3 className="font-semibold text-gray-800">{doc.title}</h3>
                            {doc.uploadedBy === 'client' && (
                              <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-medium">Client Upload</span>
                            )}
                            {doc.hubspotFileId && (
                              <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded">HubSpot</span>
                            )}
                          </div>
                          {doc.category && <span className="text-xs bg-gray-100 px-2 py-0.5 rounded mr-2">{doc.category}</span>}
                          {doc.uploadedBy === 'client' && doc.uploadedByName && (
                            <span className="text-xs text-gray-500">Uploaded by {doc.uploadedByName} on {new Date(doc.createdAt).toLocaleDateString()}</span>
                          )}
                          {doc.description && <p className="text-sm text-gray-500 mt-1">{doc.description}</p>}
                          {doc.url && <a href={doc.url} target="_blank" rel="noopener noreferrer" className="text-sm text-primary hover:underline block mt-1">{doc.url}</a>}
                          {doc.projectName && <p className="text-xs text-gray-400 mt-1">Project: {doc.projectName}</p>}
                        </div>
                        <button onClick={() => handleDelete(doc.id)} className="px-3 py-1 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded">Delete</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      );
    };
    
    const AdminClientsPage = ({ token }) => {
      const [clients, setClients] = useState([]);
      const [loading, setLoading] = useState(true);
      
      useEffect(() => {
        const loadClients = async () => {
          try {
            const res = await fetch(`${API_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            setClients(Array.isArray(data) ? data.filter(u => u.role === 'client') : []);
          } catch (err) {
            console.error('Failed to load clients:', err);
          } finally {
            setLoading(false);
          }
        };
        loadClients();
      }, [token]);
      
      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent mb-2">Client Users</h1>
            <p className="text-gray-600">View client portal users (manage in Implementation App)</p>
          </div>
          
          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            {loading ? (
              <div className="p-8 text-center text-gray-500">Loading...</div>
            ) : clients.length === 0 ? (
              <div className="p-8 text-center text-gray-500">No client users found</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Practice</th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Portal URL</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {clients.map(c => (
                      <tr key={c.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm text-gray-800">{c.name}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{c.email}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{c.practiceName || '-'}</td>
                        <td className="px-4 py-3 text-sm">
                          {c.slug ? (
                            <a href={`/portal/${c.slug}`} target="_blank" rel="noopener noreferrer" className="text-primary hover:underline">
                              /portal/{c.slug}
                            </a>
                          ) : '-'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
          
          <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-700">
            <p><strong>Note:</strong> To add or edit client users, use the <a href="/" className="underline">Implementation App</a>.</p>
          </div>
        </div>
      );
    };
    
    
    const Portal = ({ token, user }) => {
      const [activePage, setActivePage] = useState('home');
      const [data, setData] = useState(null);
      const [settings, setSettings] = useState(null);
      const [announcements, setAnnouncements] = useState([]);
      const [documents, setDocuments] = useState([]);
      const [loading, setLoading] = useState(true);
      const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
      
      const urlSlug = getSlugFromUrl();
      const isAdmin = user?.role === 'admin';
      // Use user's slug if available, fallback to URL slug
      const slug = user?.slug || urlSlug;
      
      useEffect(() => {
        const loadData = async () => {
          try {
            // Admin doesn't need portal data for their own view
            if (isAdmin) {
              const portalSettings = await api.getPortalSettings();
              setSettings(portalSettings);
              setData({ user });
              setLoading(false);
              return;
            }
            const [portalData, portalSettings, announcementsData, docsData] = await Promise.all([
              api.getPortalData(token),
              api.getPortalSettings(),
              api.getAnnouncements(),
              api.getClientDocuments(slug)
            ]);
            setData(portalData);
            setSettings(portalSettings);
            setAnnouncements(announcementsData);
            setDocuments(docsData);
          } catch (err) {
            console.error('Failed to load portal data:', err);
          } finally {
            setLoading(false);
          }
        };
        loadData();
      }, [token, slug, isAdmin]);
      
      const handleSettingsChange = (newSettings) => {
        setSettings({ ...settings, ...newSettings });
      };
      
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
              <p className="mt-4 text-gray-600">Loading your portal...</p>
            </div>
          </div>
        );
      }
      
      const renderPage = () => {
        // Admin pages
        if (isAdmin) {
          if (activePage === 'home') return <AdminHomePage token={token} />;
          if (activePage === 'admin_settings') return <AdminSettingsPage token={token} settings={settings} onSettingsChange={handleSettingsChange} />;
          if (activePage === 'admin_announcements') return <AdminAnnouncementsPage token={token} />;
          if (activePage === 'admin_documents') return <AdminDocumentsPage token={token} />;
          if (activePage === 'admin_clients') return <AdminClientsPage token={token} />;
          // Admin views aggregate inventory reports across all clients
          if (activePage === 'reports') return <AdminReportsPage token={token} onNavigate={setActivePage} />;
          if (activePage === 'submission_history') return <SubmissionHistoryPage token={token} slug={slug} isAdmin={true} onNavigate={setActivePage} />;
        }
        
        // Client pages
        if (activePage === 'home') return <HomePage data={data} announcements={announcements} onNavigate={setActivePage} />;
        if (activePage === 'milestones') return <MilestonesPage data={data} />;
        if (activePage === 'inventory') return <InventoryPage token={token} slug={slug} />;
        if (activePage === 'reports') return <ReportsPage token={token} slug={slug} onNavigate={setActivePage} />;
        if (activePage === 'submission_history') return <SubmissionHistoryPage token={token} slug={slug} isAdmin={false} onNavigate={setActivePage} />;
        if (activePage === 'support') return <SupportPage settings={settings} />;
        if (activePage === 'files') return <FilesPage settings={settings} documents={documents} token={token} projects={data?.projects || []} userData={data?.user} />;
        
        return null;
      };
      
      return (
        <div className="flex min-h-screen">
          {/* Mobile header */}
          <div className="fixed top-0 left-0 right-0 bg-white border-b z-30 lg:hidden p-4 flex justify-between items-center">
            <button onClick={() => setMobileMenuOpen(true)} className="text-gray-600 hover:text-gray-800">
              {Icons.menu}
            </button>
            <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-8" />
            <div className="w-6"></div>
          </div>
          
          <Sidebar 
            activePage={activePage} 
            onNavigate={setActivePage} 
            user={data?.user || user}
            isMobileOpen={mobileMenuOpen}
            onClose={() => setMobileMenuOpen(false)}
          />
          
          <main className="flex-1 lg:ml-64 p-4 lg:p-8 mt-16 lg:mt-0 max-w-7xl">
            {renderPage()}
            
            <footer className="mt-12 text-center text-sm text-gray-500">
              <p>Powered by Thrive365Labs | Developed by Bianca G. C. Ume, MD, MBA, MS</p>
            </footer>
          </main>
        </div>
      );
    };
    
    const App = () => {
      const [token, setToken] = useState(localStorage.getItem('portal_token'));
      const [user, setUser] = useState(() => {
        const saved = localStorage.getItem('portal_user');
        return saved ? JSON.parse(saved) : null;
      });
      const slug = getSlugFromUrl();
      
      const handleLogin = (newToken, newUser) => {
        setToken(newToken);
        setUser(newUser);
      };
      
      // Handle central /portal login (no slug) - show login page
      if (!slug) {
        if (!token || !user) {
          return <LoginPage slug={null} onLogin={handleLogin} />;
        }
        // User logged in from central portal but has no slug in URL - redirect
        if (user.slug) {
          window.location.href = `/portal/${user.slug}`;
          return null;
        }
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="text-center">
              <h1 className="text-2xl font-bold text-red-600">Portal Not Found</h1>
              <p className="text-gray-600 mt-2">Invalid portal configuration.</p>
            </div>
          </div>
        );
      }
      
      if (!token || !user) {
        return <LoginPage slug={slug} onLogin={handleLogin} />;
      }
      
      return <Portal token={token} user={user} />;
    };
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
