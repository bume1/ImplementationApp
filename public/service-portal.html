<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrive 365 Labs Service Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#045E9F', 600: '#0353a4', 700: '#00205A', 800: '#001d51', 900: '#001233' },
            accent: '#00205A',
            surface: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7' },
            success: { 50: '#ecfdf5', 500: '#10b981', 600: '#059669' },
            warning: { 50: '#fffbeb', 500: '#f59e0b', 600: '#d97706' },
            danger: { 50: '#fef2f2', 500: '#ef4444', 600: '#dc2626' }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%); min-height: 100vh; }
    .sidebar-link { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0.75rem; }
    .sidebar-link:hover { background: linear-gradient(135deg, rgba(4, 94, 159, 0.08) 0%, rgba(4, 94, 159, 0.12) 100%); }
    .sidebar-link.active { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); color: white; box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.4); }
    .signature-pad { border: 2px dashed #e4e4e7; background: #fafafa; min-height: 100px; cursor: crosshair; border-radius: 0.75rem; transition: all 0.2s; }
    .signature-pad:hover { border-color: #045E9F; }
    .signature-pad.signed { border-style: solid; border-color: #045E9F; background: white; }
    .card-modern { background: white; border-radius: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.04); }
    .card-modern:hover { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); transition: all 0.2s; }
    .btn-primary:hover { background: linear-gradient(135deg, #0353a4 0%, #00205A 100%); box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.5); transform: translateY(-1px); }
    .input-modern { border: 1.5px solid #e4e4e7; border-radius: 0.75rem; transition: all 0.2s; background: white; }
    .input-modern:focus { border-color: #045E9F; box-shadow: 0 0 0 3px rgba(4, 94, 159, 0.1); outline: none; }
    .gradient-header { background: linear-gradient(135deg, #045E9F 0%, #00205A 100%); }
    .glass-card { backdrop-filter: blur(10px); background: rgba(255,255,255,0.95); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .stat-card { background: linear-gradient(135deg, white 0%, #f8fafc 100%); border-left: 4px solid; transition: all 0.3s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const API_URL = window.location.origin;

    // Helper function to handle fetch responses
    const handleResponse = async (response) => {
      if (!response.ok) {
        try {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error ${response.status}`);
        } catch (e) {
          if (e.message.includes('HTTP error')) throw e;
          throw new Error(`HTTP error ${response.status}`);
        }
      }
      return response.json();
    };

    const api = {
      serviceLogin: (email, password) =>
        fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }).then(handleResponse).then(result => {
          // Verify user has service portal access
          if (result.user && result.user.role !== 'admin' && !result.user.hasServicePortalAccess && result.user.role !== 'vendor') {
            return { error: 'Access denied. You do not have Service Portal access.' };
          }
          return result;
        }).catch(err => ({ error: err.message || 'Network error' })),

      getServicePortalData: (token) =>
        fetch(`${API_URL}/api/service-portal/data`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getClients: (token) =>
        fetch(`${API_URL}/api/service-portal/clients`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      submitServiceReport: (token, reportData) =>
        fetch(`${API_URL}/api/service-reports`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getServiceReports: (token, filters = {}) => {
        const params = new URLSearchParams(filters);
        return fetch(`${API_URL}/api/service-reports?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }));
      },

      getServiceReport: (token, reportId) =>
        fetch(`${API_URL}/api/service-reports/${reportId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }))
    };

    // Modern Heroicons v2 with consistent 1.75 stroke weight
    const Icons = {
      home: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>,
      clipboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/></svg>,
      search: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>,
      folder: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/></svg>,
      logout: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"/></svg>,
      menu: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>,
      close: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>,
      plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>,
      document: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>,
      eye: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      wrench: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z"/></svg>,
      check: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>,
      beaker: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>,
      chartBar: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
    };

    // Login Page Component
    const LoginPage = ({ onLogin }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const result = await api.serviceLogin(email, password);
          if (result.error) {
            setError(result.error);
          } else {
            localStorage.setItem('service_token', result.token);
            localStorage.setItem('service_user', JSON.stringify(result.user));
            onLogin(result.token, result.user);
          }
        } catch (err) {
          setError('Login failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4 relative">
          {/* Decorative background elements */}
          <div className="absolute inset-0 overflow-hidden pointer-events-none">
            <div className="absolute -top-40 -right-40 w-80 h-80 rounded-full opacity-20" style={{background: 'radial-gradient(circle, #045E9F 0%, transparent 70%)'}}></div>
            <div className="absolute -bottom-40 -left-40 w-96 h-96 rounded-full opacity-10" style={{background: 'radial-gradient(circle, #00205A 0%, transparent 70%)'}}></div>
          </div>

          <div className="glass-card p-8 rounded-2xl shadow-xl w-full max-w-md animate-fade-in relative border border-white/50">
            <div className="text-center mb-8">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-12 mx-auto mb-4" />
              <h1 className="text-xl font-semibold text-gray-900">Service Portal</h1>
              <p className="text-gray-500 mt-1 text-sm">Field Service Engineers & Clinical Application Specialists</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-5">
              {error && (
                <div className="flex items-center gap-3 bg-danger-50 text-danger-600 p-4 rounded-xl text-sm border border-red-100">
                  <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                  <span>{error}</span>
                </div>
              )}

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                  placeholder="you@thrive365labs.com"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                  placeholder="Enter your password"
                  required
                />
              </div>

              <button
                type="submit"
                disabled={loading}
                className="btn-primary w-full text-white py-3.5 rounded-xl font-semibold text-sm disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {loading ? (
                  <>
                    <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                    <span>Signing in...</span>
                  </>
                ) : 'Sign In'}
              </button>
            </form>

            <div className="mt-8 pt-6 border-t border-gray-100 text-center">
              <p className="text-xs text-gray-400">Precision Diagnostics Platform</p>
            </div>
          </div>
        </div>
      );
    };

    // Sidebar Component
    const Sidebar = ({ activePage, onNavigate, user, isMobileOpen, onClose }) => {
      const menuItems = [
        { id: 'home', label: 'Dashboard', icon: Icons.home },
        { id: 'new_report', label: 'New Service Report', icon: Icons.plus },
        { id: 'reports', label: 'Service Reports', icon: Icons.folder }
      ];

      const handleNavigate = (id) => {
        onNavigate(id);
        if (onClose) onClose();
      };

      return (
        <>
          {isMobileOpen && (
            <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 lg:hidden" onClick={onClose}></div>
          )}

          <aside className={`w-72 bg-white/95 backdrop-blur-sm border-r border-gray-100 min-h-screen fixed left-0 top-0 z-50 transform transition-all duration-300 ease-out ${isMobileOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'} lg:translate-x-0 lg:shadow-none`}>
            {/* Header */}
            <div className="p-5 border-b border-gray-100 flex justify-between items-center">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-9" />
              <button onClick={onClose} className="lg:hidden p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition">
                {Icons.close}
              </button>
            </div>

            {/* Profile Card */}
            <div className="mx-4 mt-4 p-4 rounded-xl bg-gradient-to-br from-primary-500/10 to-primary-700/5 border border-primary-100">
              <div className="flex items-center gap-3">
                <div className="w-11 h-11 rounded-xl gradient-header flex items-center justify-center text-white text-sm font-bold shadow-md">
                  {(user?.name || 'T').charAt(0).toUpperCase()}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="font-semibold text-gray-900 truncate">{user?.name || 'Technician'}</p>
                  <p className="text-xs text-primary-600 font-medium">
                    {user?.role === 'admin' ? 'Administrator' : 'Service Technician'}
                  </p>
                </div>
              </div>
            </div>

            {/* Navigation */}
            <nav className="p-3 mt-2">
              <p className="px-3 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Menu</p>
              {menuItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => handleNavigate(item.id)}
                  className={`w-full text-left px-4 py-3 mb-1 sidebar-link flex items-center gap-3 ${
                    activePage === item.id ? 'active' : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  <span className={activePage === item.id ? 'text-white' : 'text-primary-500'}>{item.icon}</span>
                  <span className="font-medium text-sm">{item.label}</span>
                </button>
              ))}
            </nav>

            {/* Footer */}
            <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 bg-white/80">
              <button
                onClick={() => {
                  localStorage.removeItem('service_token');
                  localStorage.removeItem('service_user');
                  window.location.reload();
                }}
                className="w-full text-left px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-xl flex items-center gap-3 transition font-medium text-sm"
              >
                {Icons.logout}
                <span>Sign Out</span>
              </button>
            </div>
          </aside>
        </>
      );
    };

    // Dashboard Home Page
    const HomePage = ({ user, onNavigate, recentReports }) => {
      return (
        <div className="space-y-6 animate-fade-in">
          {/* Dynamic Banner Header */}
          <div className="relative rounded-2xl overflow-hidden shadow-lg" style={{minHeight: '200px'}}>
            <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-service.jpg)'}}></div>
            <div className="absolute inset-0 bg-gradient-to-r from-primary-700/90 via-primary-600/70 to-transparent"></div>
            <div className="relative p-8 flex items-center min-h-[200px]">
              <div className="text-white">
                <p className="text-primary-100 text-sm font-medium mb-1 opacity-90">Welcome back,</p>
                <h1 className="text-3xl font-bold drop-shadow-sm">{user?.name || 'Technician'}</h1>
                <p className="mt-2 text-white/80 text-sm max-w-md">Service Portal Dashboard - Submit and track field service reports</p>
              </div>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="grid md:grid-cols-3 gap-5">
            <button
              onClick={() => onNavigate('new_report')}
              className="card-modern p-6 text-left group hover:border-primary-200 transition-all"
            >
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-105 transition-transform">
                {React.cloneElement(Icons.plus, { className: 'w-7 h-7' })}
              </div>
              <h3 className="font-semibold text-gray-900">New Service Report</h3>
              <p className="text-sm text-gray-500 mt-1">Submit a new service report</p>
            </button>
            <button
              onClick={() => onNavigate('reports')}
              className="card-modern p-6 text-left group hover:border-purple-200 transition-all"
            >
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-105 transition-transform">
                {React.cloneElement(Icons.folder, { className: 'w-7 h-7' })}
              </div>
              <h3 className="font-semibold text-gray-900">Service Reports</h3>
              <p className="text-sm text-gray-500 mt-1">View and search past reports</p>
            </button>
            <div className="stat-card card-modern p-6 border-l-primary-500">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-500 font-medium">My Reports</p>
                  <p className="text-3xl font-bold text-primary-500 mt-1">{recentReports?.length || 0}</p>
                </div>
                <div className="w-14 h-14 rounded-xl bg-primary-50 flex items-center justify-center text-primary-500">
                  {React.cloneElement(Icons.document, { className: 'w-7 h-7' })}
                </div>
              </div>
            </div>
          </div>

          {/* Recent Reports */}
          <div className="card-modern p-6">
            <div className="flex items-center justify-between mb-5">
              <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                <span className="w-8 h-8 rounded-lg bg-primary-50 flex items-center justify-center text-primary-500">{Icons.clipboard}</span>
                Recent Service Reports
              </h2>
              {recentReports && recentReports.length > 0 && (
                <button onClick={() => onNavigate('reports')} className="text-sm text-primary-500 hover:text-primary-600 font-medium">
                  View All
                </button>
              )}
            </div>
            {recentReports && recentReports.length > 0 ? (
              <div className="space-y-3">
                {recentReports.slice(0, 5).map((report, idx) => (
                  <div key={report.id || idx} className="flex justify-between items-center p-4 bg-gray-50 rounded-xl border-l-4 border-primary-500 hover:bg-gray-100 transition">
                    <div>
                      <p className="font-semibold text-gray-900">{report.clientName || report.clientFacilityName}</p>
                      <p className="text-sm text-gray-600">{report.serviceType}</p>
                      <p className="text-xs text-gray-400 mt-1">
                        {new Date(report.serviceDate || report.serviceCompletionDate || report.createdAt).toLocaleDateString()}
                      </p>
                    </div>
                    <span className="text-xs bg-success-50 text-success-600 px-3 py-1.5 rounded-full font-medium">
                      Completed
                    </span>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8">
                <div className="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-3">
                  {React.cloneElement(Icons.folder, { className: 'w-8 h-8 text-gray-400' })}
                </div>
                <p className="text-gray-500">No recent service reports</p>
                <button onClick={() => onNavigate('new_report')} className="mt-3 text-sm text-primary-500 hover:text-primary-600 font-medium">
                  Create your first report
                </button>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Signature Pad Component
    const SignaturePad = ({ onSave, label, initialValue }) => {
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [hasSignature, setHasSignature] = useState(!!initialValue);

      useEffect(() => {
        if (initialValue && canvasRef.current) {
          const ctx = canvasRef.current.getContext('2d');
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
          };
          img.src = initialValue;
        }
      }, [initialValue]);

      const startDrawing = (e) => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;

        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
      };

      const draw = (e) => {
        if (!isDrawing) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;

        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        ctx.lineTo(x, y);
        ctx.stroke();
      };

      const stopDrawing = () => {
        if (isDrawing) {
          setIsDrawing(false);
          setHasSignature(true);
          if (onSave) {
            onSave(canvasRef.current.toDataURL());
          }
        }
      };

      const clearSignature = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        setHasSignature(false);
        if (onSave) {
          onSave('');
        }
      };

      return (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">{label}</label>
          <canvas
            ref={canvasRef}
            width={400}
            height={100}
            className={`signature-pad w-full rounded-lg ${hasSignature ? 'signed' : ''}`}
            onMouseDown={startDrawing}
            onMouseMove={draw}
            onMouseUp={stopDrawing}
            onMouseLeave={stopDrawing}
            onTouchStart={startDrawing}
            onTouchMove={draw}
            onTouchEnd={stopDrawing}
          />
          <button
            type="button"
            onClick={clearSignature}
            className="mt-2 text-sm text-red-600 hover:text-red-800"
          >
            Clear Signature
          </button>
        </div>
      );
    };

    // New Service Report Form
    const NewReportPage = ({ token, user, onSuccess, clients }) => {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState(false);
      const [hasDraft, setHasDraft] = useState(false);
      const [draftSaved, setDraftSaved] = useState(false);

      const getInitialFormData = () => {
        const defaultData = {
          // Client Information
          clientFacilityName: '',
          customerName: '',
          serviceProviderName: user?.name || '',
          address: '',
          serviceCompletionDate: new Date().toISOString().split('T')[0],
          analyzerModel: '',
          analyzerSerialNumber: '',
          hubspotTicketNumber: '',
          hubspotCompanyId: '',

          // Service Performed
          serviceType: '',
          descriptionOfWork: '',
          materialsUsed: '',
          solution: '',
          outstandingIssues: '',

          // Validation-specific fields
          validationSegments: '',
          recommendations: '',

          // Signatures
          customerSignature: '',
          customerSignatureDate: '',
          technicianSignature: '',
          technicianSignatureDate: new Date().toISOString().split('T')[0]
        };

        try {
          const savedDraft = localStorage.getItem('service_report_draft');
          if (savedDraft) {
            const parsed = JSON.parse(savedDraft);
            return { ...defaultData, ...parsed, serviceProviderName: user?.name || parsed.serviceProviderName };
          }
        } catch (e) {
          console.error('Error loading draft:', e);
        }
        return defaultData;
      };

      const [formData, setFormData] = useState(getInitialFormData);

      // Check if draft exists on mount
      useEffect(() => {
        const savedDraft = localStorage.getItem('service_report_draft');
        setHasDraft(!!savedDraft);
      }, []);

      const isValidationType = formData.serviceType === 'Validations';

      const updateField = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      // Save draft to localStorage
      const saveDraft = () => {
        try {
          // Don't save signatures in draft (too large)
          const draftData = { ...formData };
          delete draftData.customerSignature;
          delete draftData.technicianSignature;
          localStorage.setItem('service_report_draft', JSON.stringify(draftData));
          setHasDraft(true);
          setDraftSaved(true);
          setTimeout(() => setDraftSaved(false), 2000);
        } catch (e) {
          console.error('Error saving draft:', e);
        }
      };

      // Clear draft from localStorage
      const clearDraft = () => {
        localStorage.removeItem('service_report_draft');
        setHasDraft(false);
        setFormData({
          clientFacilityName: '',
          customerName: '',
          serviceProviderName: user?.name || '',
          address: '',
          serviceCompletionDate: new Date().toISOString().split('T')[0],
          analyzerModel: '',
          analyzerSerialNumber: '',
          hubspotTicketNumber: '',
          hubspotCompanyId: '',
          serviceType: '',
          descriptionOfWork: '',
          materialsUsed: '',
          solution: '',
          outstandingIssues: '',
          validationSegments: '',
          recommendations: '',
          customerSignature: '',
          customerSignatureDate: '',
          technicianSignature: '',
          technicianSignatureDate: new Date().toISOString().split('T')[0]
        });
      };

      const handleClientSelect = (clientName) => {
        const client = clients?.find(c => c.name === clientName || c.clientName === clientName);
        if (client) {
          setFormData(prev => ({
            ...prev,
            clientFacilityName: client.name || client.clientName || '',
            address: client.address || '',
            hubspotCompanyId: client.hubspotCompanyId || ''
          }));
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        // Validate required fields
        const isValidation = formData.serviceType === 'Validations';
        if (!formData.clientFacilityName || !formData.serviceType) {
          setError('Please fill in all required fields');
          setLoading(false);
          return;
        }
        if (isValidation && !formData.validationSegments) {
          setError('Please fill in the validation segments');
          setLoading(false);
          return;
        }
        if (!isValidation && !formData.descriptionOfWork) {
          setError('Please fill in the description of work');
          setLoading(false);
          return;
        }

        if (!formData.technicianSignature) {
          setError('Technician signature is required');
          setLoading(false);
          return;
        }

        try {
          const result = await api.submitServiceReport(token, {
            ...formData,
            technicianId: user?.id,
            technicianName: user?.name
          });

          if (result.error) {
            setError(result.error);
          } else {
            // Clear draft on successful submission
            localStorage.removeItem('service_report_draft');
            setHasDraft(false);
            setSuccess(true);
            setTimeout(() => {
              if (onSuccess) onSuccess();
            }, 2000);
          }
        } catch (err) {
          setError('Failed to submit report. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      if (success) {
        return (
          <div className="bg-white p-8 rounded-xl shadow-sm text-center">
            <div className="flex justify-center mb-4 text-green-500">
              {React.cloneElement(Icons.check, { className: 'w-16 h-16' })}
            </div>
            <h2 className="text-2xl font-bold text-accent mb-2">Report Submitted!</h2>
            <p className="text-gray-600">Your service report has been submitted successfully.</p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {hasDraft && (
            <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg flex items-center gap-2">
              <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span className="text-sm">You have a saved draft. Your previous form data has been restored.</span>
            </div>
          )}

          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Service Report</h1>
                <p className="text-gray-600 mt-1">THRIVE 365 LABS - SERVICE REPORT</p>
              </div>
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-12" />
            </div>
          </div>

          <form onSubmit={handleSubmit} className="space-y-6">
            {error && (
              <div className="bg-red-50 text-red-600 p-4 rounded-lg">
                {error}
              </div>
            )}

            {/* Client Information Section */}
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 pb-2 border-b">CLIENT INFORMATION</h2>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client/Facility Name *</label>
                  <select
                    value={formData.clientFacilityName}
                    onChange={(e) => {
                      updateField('clientFacilityName', e.target.value);
                      handleClientSelect(e.target.value);
                    }}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    required
                  >
                    <option value="">Select a client...</option>
                    {clients?.map((client, idx) => (
                      <option key={idx} value={client.name || client.clientName}>
                        {client.name || client.clientName}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                  <input
                    type="text"
                    value={formData.customerName}
                    onChange={(e) => updateField('customerName', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Provider Name</label>
                  <input
                    type="text"
                    value={formData.serviceProviderName}
                    onChange={(e) => updateField('serviceProviderName', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-gray-50"
                    readOnly
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                  <input
                    type="text"
                    value={formData.address}
                    onChange={(e) => updateField('address', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Completion Date *</label>
                  <input
                    type="date"
                    value={formData.serviceCompletionDate}
                    onChange={(e) => updateField('serviceCompletionDate', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Model</label>
                  <input
                    type="text"
                    value={formData.analyzerModel}
                    onChange={(e) => updateField('analyzerModel', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="e.g., DZLite C270"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Serial Number (S/N)</label>
                  <input
                    type="text"
                    value={formData.analyzerSerialNumber}
                    onChange={(e) => updateField('analyzerSerialNumber', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="e.g., 601744124"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">HubSpot Ticket #</label>
                  <input
                    type="text"
                    value={formData.hubspotTicketNumber}
                    onChange={(e) => updateField('hubspotTicketNumber', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="Enter HubSpot ticket number"
                  />
                </div>
              </div>
            </div>

            {/* Service Performed Section */}
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 pb-2 border-b">SERVICE PERFORMED</h2>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Type *</label>
                  <select
                    value={formData.serviceType}
                    onChange={(e) => updateField('serviceType', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    required
                  >
                    <option value="">Select service type...</option>
                    <option value="Analyzer Hardware">Analyzer Hardware</option>
                    <option value="Inventory">Inventory</option>
                    <option value="LIS/EMR">LIS/EMR</option>
                    <option value="Billing & Fees">Billing & Fees</option>
                    <option value="Compliance">Compliance</option>
                    <option value="Training">Training</option>
                    <option value="Validations">Validations</option>
                  </select>
                </div>

                {isValidationType ? (
                  <>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Validation Segments *</label>
                      <textarea
                        value={formData.validationSegments}
                        onChange={(e) => updateField('validationSegments', e.target.value)}
                        rows={6}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="List all validation segments performed (e.g., accuracy, precision, linearity, reportable range, reference range, carryover, etc.)..."
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Materials Used</label>
                      <textarea
                        value={formData.materialsUsed}
                        onChange={(e) => updateField('materialsUsed', e.target.value)}
                        rows={2}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="e.g., QC materials, calibrators, patient samples..."
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Recommendations</label>
                      <textarea
                        value={formData.recommendations}
                        onChange={(e) => updateField('recommendations', e.target.value)}
                        rows={3}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="List any recommendations for the client..."
                      />
                    </div>
                  </>
                ) : (
                  <>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Description of Work Performed *</label>
                      <textarea
                        value={formData.descriptionOfWork}
                        onChange={(e) => updateField('descriptionOfWork', e.target.value)}
                        rows={5}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Describe the work performed in detail..."
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Materials Used</label>
                      <textarea
                        value={formData.materialsUsed}
                        onChange={(e) => updateField('materialsUsed', e.target.value)}
                        rows={2}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="e.g., Hydra-DI, DZLite, plumbers tape/tubing"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Solution</label>
                      <textarea
                        value={formData.solution}
                        onChange={(e) => updateField('solution', e.target.value)}
                        rows={3}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Describe the solution implemented..."
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Final Recommendations</label>
                      <textarea
                        value={formData.outstandingIssues}
                        onChange={(e) => updateField('outstandingIssues', e.target.value)}
                        rows={3}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="List any final recommendations for the client..."
                      />
                    </div>
                  </>
                )}
              </div>
            </div>

            {/* Signatures Section */}
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 pb-2 border-b">SIGNATURES</h2>

              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <SignaturePad
                    label="Customer Signature"
                    onSave={(data) => updateField('customerSignature', data)}
                    initialValue={formData.customerSignature}
                  />
                  <div className="mt-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input
                      type="date"
                      value={formData.customerSignatureDate}
                      onChange={(e) => updateField('customerSignatureDate', e.target.value)}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    />
                  </div>
                </div>

                <div>
                  <SignaturePad
                    label="Technician Signature *"
                    onSave={(data) => updateField('technicianSignature', data)}
                    initialValue={formData.technicianSignature}
                  />
                  <div className="mt-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input
                      type="date"
                      value={formData.technicianSignatureDate}
                      onChange={(e) => updateField('technicianSignatureDate', e.target.value)}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Draft and Submit Buttons */}
            <div className="flex justify-between items-center gap-4">
              <div className="flex items-center gap-3">
                <button
                  type="button"
                  onClick={saveDraft}
                  className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors text-sm"
                >
                  {draftSaved ? 'âœ“ Draft Saved' : 'Save Draft'}
                </button>
                {hasDraft && (
                  <button
                    type="button"
                    onClick={clearDraft}
                    className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium transition-colors text-sm"
                  >
                    Clear Draft
                  </button>
                )}
              </div>
              <button
                type="submit"
                disabled={loading}
                className="px-8 py-3 bg-primary text-white rounded-lg font-medium hover:bg-accent transition-colors disabled:opacity-50"
              >
                {loading ? 'Submitting...' : 'Submit Service Report'}
              </button>
            </div>
          </form>
        </div>
      );
    };

    // Service Reports Repository Page
    const ReportsPage = ({ token, onViewReport }) => {
      const [reports, setReports] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [clientFilter, setClientFilter] = useState('');
      const [dateFrom, setDateFrom] = useState('');
      const [dateTo, setDateTo] = useState('');
      const [clients, setClients] = useState([]);

      useEffect(() => {
        loadReports();
        loadClients();
      }, []);

      const loadClients = async () => {
        const result = await api.getClients(token);
        if (!result.error) {
          setClients(result);
        }
      };

      const loadReports = async () => {
        setLoading(true);
        const filters = {};
        if (clientFilter) filters.client = clientFilter;
        if (dateFrom) filters.dateFrom = dateFrom;
        if (dateTo) filters.dateTo = dateTo;
        if (searchTerm) filters.search = searchTerm;

        const result = await api.getServiceReports(token, filters);
        if (!result.error) {
          setReports(result);
        }
        setLoading(false);
      };

      const handleSearch = (e) => {
        e.preventDefault();
        loadReports();
      };

      const filteredReports = reports.filter(report => {
        if (searchTerm && !report.clientFacilityName?.toLowerCase().includes(searchTerm.toLowerCase()) &&
            !report.serviceType?.toLowerCase().includes(searchTerm.toLowerCase()) &&
            !report.hubspotTicketNumber?.toLowerCase().includes(searchTerm.toLowerCase())) {
          return false;
        }
        return true;
      });

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent mb-4">Service Reports Repository</h1>

            <form onSubmit={handleSearch} className="space-y-4">
              <div className="grid md:grid-cols-4 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Search</label>
                  <div className="relative">
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      placeholder="Search by client, service type, ticket..."
                      className="w-full px-4 py-2 pl-10 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    />
                    <span className="absolute left-3 top-2.5 text-gray-400">{Icons.search}</span>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client</label>
                  <select
                    value={clientFilter}
                    onChange={(e) => setClientFilter(e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  >
                    <option value="">All Clients</option>
                    {clients.map((client, idx) => (
                      <option key={idx} value={client.name || client.clientName}>
                        {client.name || client.clientName}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                  <input
                    type="date"
                    value={dateFrom}
                    onChange={(e) => setDateFrom(e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                  <input
                    type="date"
                    value={dateTo}
                    onChange={(e) => setDateTo(e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>
              </div>

              <div className="flex justify-end">
                <button
                  type="submit"
                  className="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-accent transition-colors"
                >
                  Search Reports
                </button>
              </div>
            </form>
          </div>

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            {loading ? (
              <div className="flex items-center justify-center py-12">
                <div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
              </div>
            ) : filteredReports.length > 0 ? (
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Service Type</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Technician</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ticket #</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredReports.map((report, idx) => (
                    <tr key={report.id || idx} className="hover:bg-gray-50">
                      <td className="px-6 py-4 text-sm text-gray-900">
                        {new Date(report.serviceCompletionDate || report.createdAt).toLocaleDateString()}
                      </td>
                      <td className="px-6 py-4">
                        <div className="text-sm font-medium text-gray-900">{report.clientFacilityName}</div>
                        <div className="text-xs text-gray-500">{report.address}</div>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">{report.serviceType}</td>
                      <td className="px-6 py-4 text-sm text-gray-900">{report.serviceProviderName || report.technicianName}</td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        {report.hubspotTicketNumber || '-'}
                      </td>
                      <td className="px-6 py-4">
                        <button
                          onClick={() => onViewReport(report)}
                          className="text-primary hover:text-accent flex items-center gap-1"
                        >
                          {Icons.eye}
                          <span className="text-sm">View</span>
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <div className="text-center py-12 text-gray-500">
                <div className="flex justify-center mb-4">{React.cloneElement(Icons.folder, { className: 'w-12 h-12 text-gray-300' })}</div>
                <p>No service reports found</p>
                <p className="text-sm">Try adjusting your search criteria</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    // View Report Page
    const ViewReportPage = ({ report, onBack }) => {
      return (
        <div className="space-y-6">
          <div className="flex items-center gap-4">
            <button
              onClick={onBack}
              className="flex items-center gap-2 text-primary hover:text-accent"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Back to Reports
            </button>
          </div>

          <div className="card-modern overflow-hidden">
            {/* Dynamic Banner Header */}
            <div className="relative" style={{minHeight: '140px'}}>
              <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-service.jpg)'}}></div>
              <div className="absolute inset-0 bg-gradient-to-r from-primary-700/90 via-primary-600/80 to-primary-500/60"></div>
              <div className="relative p-6 flex items-center justify-between min-h-[140px]">
                <div className="text-white">
                  <h1 className="text-2xl font-bold drop-shadow-sm">THRIVE 365 LABS - SERVICE REPORT</h1>
                  <p className="mt-1 text-white/80 text-sm">Report ID: {report.id}</p>
                </div>
                <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-12 bg-white/20 backdrop-blur-sm rounded-xl p-2" />
              </div>
            </div>

            {/* Client Information */}
            <div className="p-6 border-b">
              <h2 className="text-lg font-bold text-accent mb-4">CLIENT INFORMATION</h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-gray-500">Client/Facility Name</p>
                  <p className="font-medium">{report.clientFacilityName}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Customer Name</p>
                  <p className="font-medium">{report.customerName || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Service Provider Name</p>
                  <p className="font-medium">{report.serviceProviderName}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Address</p>
                  <p className="font-medium">{report.address || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Service Completion Date</p>
                  <p className="font-medium">{report.serviceCompletionDate}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Analyzer Model</p>
                  <p className="font-medium">{report.analyzerModel || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Analyzer Serial Number (S/N)</p>
                  <p className="font-medium">{report.analyzerSerialNumber || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">HubSpot Ticket #</p>
                  <p className="font-medium">{report.hubspotTicketNumber || '-'}</p>
                </div>
              </div>
            </div>

            {/* Service Performed */}
            <div className="p-6 border-b">
              <h2 className="text-lg font-bold text-accent mb-4">SERVICE PERFORMED</h2>
              <div className="space-y-4">
                <div>
                  <p className="text-sm text-gray-500">Service Type</p>
                  <p className="font-medium">{report.serviceType}</p>
                </div>
                {report.serviceType === 'Validations' ? (
                  <>
                    <div>
                      <p className="text-sm text-gray-500">Validation Segments</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.validationSegments || '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Materials Used</p>
                      <p className="font-medium">{report.materialsUsed || '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Recommendations</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.recommendations || '-'}</p>
                    </div>
                  </>
                ) : (
                  <>
                    <div>
                      <p className="text-sm text-gray-500">Description of Work Performed</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.descriptionOfWork}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Materials Used</p>
                      <p className="font-medium">{report.materialsUsed || '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Solution</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.solution || '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Final Recommendations</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.outstandingIssues || '-'}</p>
                    </div>
                  </>
                )}
              </div>
            </div>

            {/* Signatures */}
            <div className="p-6">
              <h2 className="text-lg font-bold text-accent mb-4">SIGNATURES</h2>
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <p className="text-sm text-gray-500 mb-2">Customer Signature</p>
                  {report.customerSignature ? (
                    <div className="border rounded-lg p-2 bg-gray-50">
                      <img src={report.customerSignature} alt="Customer Signature" className="max-h-24" />
                    </div>
                  ) : (
                    <p className="text-gray-400 italic">No signature</p>
                  )}
                  <p className="text-sm text-gray-500 mt-2">Date: {report.customerSignatureDate || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500 mb-2">Technician Signature</p>
                  {report.technicianSignature ? (
                    <div className="border rounded-lg p-2 bg-gray-50">
                      <img src={report.technicianSignature} alt="Technician Signature" className="max-h-24" />
                    </div>
                  ) : (
                    <p className="text-gray-400 italic">No signature</p>
                  )}
                  <p className="text-sm text-gray-500 mt-2">Date: {report.technicianSignatureDate || '-'}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      // Check multiple token sources - service_token, unified_token, or admin_token
      const [token, setToken] = useState(() => {
        return localStorage.getItem('service_token') || localStorage.getItem('unified_token') || localStorage.getItem('admin_token');
      });
      const [user, setUser] = useState(() => {
        try {
          const userData = localStorage.getItem('service_user') || localStorage.getItem('unified_user') || localStorage.getItem('admin_user');
          return userData ? JSON.parse(userData) : null;
        } catch {
          return null;
        }
      });
      const [activePage, setActivePage] = useState('home');
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
      const [data, setData] = useState(null);
      const [clients, setClients] = useState([]);
      const [viewingReport, setViewingReport] = useState(null);

      useEffect(() => {
        if (token) {
          loadData();
        }
      }, [token]);

      const loadData = async () => {
        const [portalData, clientsData] = await Promise.all([
          api.getServicePortalData(token),
          api.getClients(token)
        ]);

        if (portalData.error === 'Invalid token' || portalData.error?.includes('unauthorized')) {
          handleLogout();
          return;
        }

        if (!portalData.error) {
          setData(portalData);
        }

        if (!clientsData.error) {
          setClients(clientsData);
        }
      };

      const handleLogin = (newToken, newUser) => {
        setToken(newToken);
        setUser(newUser);
      };

      const handleLogout = () => {
        localStorage.removeItem('service_token');
        localStorage.removeItem('service_user');
        setToken(null);
        setUser(null);
      };

      const handleViewReport = (report) => {
        setViewingReport(report);
        setActivePage('view_report');
      };

      if (!token || !user) {
        return <LoginPage onLogin={handleLogin} />;
      }

      const renderPage = () => {
        if (viewingReport && activePage === 'view_report') {
          return (
            <ViewReportPage
              report={viewingReport}
              onBack={() => {
                setViewingReport(null);
                setActivePage('reports');
              }}
            />
          );
        }

        switch (activePage) {
          case 'home':
            return <HomePage user={user} onNavigate={setActivePage} recentReports={data?.recentReports || []} />;
          case 'new_report':
            return (
              <NewReportPage
                token={token}
                user={user}
                clients={clients}
                onSuccess={() => {
                  loadData();
                  setActivePage('reports');
                }}
              />
            );
          case 'reports':
            return <ReportsPage token={token} onViewReport={handleViewReport} />;
          default:
            return <HomePage user={user} onNavigate={setActivePage} recentReports={data?.recentReports || []} />;
        }
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <Sidebar
            activePage={activePage}
            onNavigate={setActivePage}
            user={user}
            isMobileOpen={isMobileMenuOpen}
            onClose={() => setIsMobileMenuOpen(false)}
          />

          {/* Mobile header */}
          <div className="lg:hidden bg-white border-b p-4 flex items-center justify-between sticky top-0 z-30">
            <button onClick={() => setIsMobileMenuOpen(true)} className="text-gray-600">
              {Icons.menu}
            </button>
            <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-8" />
            <div className="w-6"></div>
          </div>

          <main className="lg:ml-72 p-4 lg:p-8">
            {renderPage()}
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
