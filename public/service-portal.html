<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrive 365 Labs Service Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#045E9F', 600: '#0353a4', 700: '#00205A', 800: '#001d51', 900: '#001233' },
            accent: '#00205A',
            surface: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7' },
            success: { 50: '#ecfdf5', 500: '#10b981', 600: '#059669' },
            warning: { 50: '#fffbeb', 500: '#f59e0b', 600: '#d97706' },
            danger: { 50: '#fef2f2', 500: '#ef4444', 600: '#dc2626' }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%); min-height: 100vh; }
    .sidebar-link { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0.75rem; }
    .sidebar-link:hover { background: linear-gradient(135deg, rgba(4, 94, 159, 0.08) 0%, rgba(4, 94, 159, 0.12) 100%); }
    .sidebar-link.active { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); color: white; box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.4); }
    .signature-pad { border: 2px dashed #e4e4e7; background: #fafafa; min-height: 100px; cursor: crosshair; border-radius: 0.75rem; transition: all 0.2s; }
    .signature-pad:hover { border-color: #045E9F; }
    .signature-pad.signed { border-style: solid; border-color: #045E9F; background: white; }
    .card-modern { background: white; border-radius: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.04); }
    .card-modern:hover { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(135deg, #045E9F 0%, #0353a4 100%); transition: all 0.2s; }
    .btn-primary:hover { background: linear-gradient(135deg, #0353a4 0%, #00205A 100%); box-shadow: 0 4px 14px -3px rgba(4, 94, 159, 0.5); transform: translateY(-1px); }
    .input-modern { border: 1.5px solid #e4e4e7; border-radius: 0.75rem; transition: all 0.2s; background: white; }
    .input-modern:focus { border-color: #045E9F; box-shadow: 0 0 0 3px rgba(4, 94, 159, 0.1); outline: none; }
    .gradient-header { background: linear-gradient(135deg, #045E9F 0%, #00205A 100%); }
    .glass-card { backdrop-filter: blur(10px); background: rgba(255,255,255,0.95); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .stat-card { background: linear-gradient(135deg, white 0%, #f8fafc 100%); border-left: 4px solid; transition: all 0.3s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const API_URL = window.location.origin;

    // Helper: append auth token to upload URLs for img/a tags (since /uploads requires auth)
    const getAuthUrl = (url) => {
      if (!url) return url;
      // External URLs (Google Drive, etc.) don't need auth tokens
      if (url.startsWith('http://') || url.startsWith('https://')) return url;
      const token = localStorage.getItem('service_token') || localStorage.getItem('token') || localStorage.getItem('unified_token');
      if (!token) return url;
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}token=${token}`;
    };

    // Get best image display URL for a photo (Google Drive or local)
    const getPhotoSrc = (photo) => {
      if (photo.driveFileId) return `https://lh3.googleusercontent.com/d/${photo.driveFileId}`;
      return getAuthUrl(photo.url);
    };

    // Get download URL for an attachment
    const getDownloadUrl = (item) => {
      if (item.webContentLink) return item.webContentLink;
      if (item.webViewLink) return item.webViewLink;
      return getAuthUrl(item.url);
    };

    // Helper function to handle fetch responses
    const handleResponse = async (response) => {
      if (!response.ok) {
        // Auto-redirect to login on auth failure (expired/invalid token)
        if (response.status === 401 || response.status === 403) {
          try {
            const errData = await response.clone().json();
            if (errData.error === 'Invalid token' || errData.error === 'User not found' || response.status === 401) {
              localStorage.removeItem('service_token');
              localStorage.removeItem('service_user');
              localStorage.removeItem('unified_token');
              localStorage.removeItem('unified_user');
              window.location.href = '/';
              throw new Error('Session expired. Redirecting to login...');
            }
          } catch (redirectErr) {
            if (redirectErr.message.includes('Session expired')) throw redirectErr;
          }
        }
        try {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error ${response.status}`);
        } catch (e) {
          if (e.message.includes('HTTP error') || e.message.includes('Session expired')) throw e;
          throw new Error(`HTTP error ${response.status}`);
        }
      }
      return response.json();
    };

    const api = {
      serviceLogin: (email, password) =>
        fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }).then(handleResponse).then(result => {
          // Verify user has service portal access (super admin, vendor, or explicit access - NOT managers)
          if (result.user && result.user.role !== 'admin' && !result.user.hasServicePortalAccess && result.user.role !== 'vendor') {
            return { error: 'Access denied. You do not have Service Portal access.' };
          }
          return result;
        }).catch(err => ({ error: err.message || 'Network error' })),

      getServicePortalData: (token) =>
        fetch(`${API_URL}/api/service-portal/data`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getClients: (token) =>
        fetch(`${API_URL}/api/service-portal/clients`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      submitServiceReport: (token, reportData) =>
        fetch(`${API_URL}/api/service-reports`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getServiceReports: (token, filters = {}) => {
        const params = new URLSearchParams(filters);
        return fetch(`${API_URL}/api/service-reports?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }));
      },

      getServiceReport: (token, reportId) =>
        fetch(`${API_URL}/api/service-reports/${reportId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getAssignedReports: (token) => {
        console.log('ðŸŒ API CALL: GET /api/service-reports/assigned');
        return fetch(`${API_URL}/api/service-reports/assigned`, {
          headers: { 'Authorization': `Bearer ${token}` }
        })
          .then(response => {
            console.log('ðŸ“¥ Response status:', response.status, response.statusText);
            return handleResponse(response);
          })
          .then(data => {
            console.log('âœ… Assigned reports response:', data);
            return data;
          })
          .catch(err => {
            console.error('âŒ API Error:', err);
            return { error: err.message || 'Network error' };
          });
      },

      completeAssignedReport: (token, reportId, reportData) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/complete`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      // Assignment APIs (for admins and managers)
      getTechnicians: (token) =>
        fetch(`${API_URL}/api/service-portal/technicians`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      assignServiceReport: (token, reportData) =>
        fetch(`${API_URL}/api/service-reports/assign`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      uploadServiceReportPhotos: (token, reportId, files) => {
        const formData = new FormData();
        files.forEach(file => formData.append('photos', file));
        return fetch(`${API_URL}/api/service-reports/${reportId}/photos`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }));
      },

      uploadServiceReportFiles: (token, reportId, files) => {
        const formData = new FormData();
        files.forEach(file => formData.append('files', file));
        return fetch(`${API_URL}/api/service-reports/${reportId}/files`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }));
      },

      uploadTechnicianPhotos: (token, reportId, files) => {
        const formData = new FormData();
        files.forEach(file => formData.append('photos', file));
        return fetch(`${API_URL}/api/service-reports/${reportId}/technician-photos`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }));
      },

      uploadTechnicianFiles: (token, reportId, files) => {
        const formData = new FormData();
        files.forEach(file => formData.append('files', file));
        return fetch(`${API_URL}/api/service-reports/${reportId}/technician-files`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }));
      },

      // Vendor management APIs
      createVendor: (token, vendorData) =>
        fetch(`${API_URL}/api/users`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...vendorData, role: 'vendor' })
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      updateServiceReport: (token, reportId, reportData) =>
        fetch(`${API_URL}/api/service-reports/${reportId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      deleteServiceReportPhoto: (token, reportId, photoId) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/photos/${photoId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      deleteServiceReportFile: (token, reportId, fileId) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/files/${fileId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getAllClients: (token) =>
        fetch(`${API_URL}/api/clients`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      // Multi-day validation APIs
      startValidation: (token, reportData) =>
        fetch(`${API_URL}/api/service-reports/start-validation`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      addValidationSegment: (token, reportId, segmentData) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/segment`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(segmentData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      completeValidation: (token, reportId, completionData) =>
        fetch(`${API_URL}/api/service-reports/${reportId}/complete-validation`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(completionData)
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' })),

      getActiveValidations: (token) =>
        fetch(`${API_URL}/api/service-reports/active-validations`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(handleResponse).catch(err => ({ error: err.message || 'Network error' }))
    };

    // Modern Heroicons v2 with consistent 1.75 stroke weight
    const Icons = {
      home: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>,
      clipboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/></svg>,
      search: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>,
      folder: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/></svg>,
      logout: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"/></svg>,
      menu: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>,
      close: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>,
      plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>,
      document: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>,
      eye: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      wrench: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z"/></svg>,
      check: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>,
      beaker: <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>,
      chartBar: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>,
      users: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>,
      trash: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>,
      userPlus: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/></svg>,
      assign: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"/></svg>,
      photo: <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
    };

    // Login Page Component
    const LoginPage = ({ onLogin }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const result = await api.serviceLogin(email, password);
          if (result.error) {
            setError(result.error);
          } else {
            localStorage.setItem('service_token', result.token);
            localStorage.setItem('service_user', JSON.stringify(result.user));
            onLogin(result.token, result.user);
          }
        } catch (err) {
          setError('Login failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4 relative">
          {/* Decorative background elements */}
          <div className="absolute inset-0 overflow-hidden pointer-events-none">
            <div className="absolute -top-40 -right-40 w-80 h-80 rounded-full opacity-20" style={{background: 'radial-gradient(circle, #045E9F 0%, transparent 70%)'}}></div>
            <div className="absolute -bottom-40 -left-40 w-96 h-96 rounded-full opacity-10" style={{background: 'radial-gradient(circle, #00205A 0%, transparent 70%)'}}></div>
          </div>

          <div className="glass-card p-8 rounded-2xl shadow-xl w-full max-w-md animate-fade-in relative border border-white/50">
            <div className="text-center mb-8">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-12 mx-auto mb-4" />
              <h1 className="text-xl font-semibold text-gray-900">Service Portal</h1>
              <p className="text-gray-500 mt-1 text-sm">Field Service Engineers & Clinical Application Specialists</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-5">
              {error && (
                <div className="flex items-center gap-3 bg-danger-50 text-danger-600 p-4 rounded-xl text-sm border border-red-100">
                  <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                  <span>{error}</span>
                </div>
              )}

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                  placeholder="you@thrive365labs.com"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="input-modern w-full px-4 py-3 text-gray-900 placeholder-gray-400"
                  placeholder="Enter your password"
                  required
                />
              </div>

              <button
                type="submit"
                disabled={loading}
                className="btn-primary w-full text-white py-3.5 rounded-xl font-semibold text-sm disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {loading ? (
                  <>
                    <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                    <span>Signing in...</span>
                  </>
                ) : 'Sign In'}
              </button>
            </form>

            <div className="mt-8 pt-6 border-t border-gray-100 text-center">
              <p className="text-xs text-gray-400">Precision Diagnostics Platform</p>
            </div>
          </div>
        </div>
      );
    };

    // Sidebar Component
    const Sidebar = ({ activePage, onNavigate, user, isMobileOpen, onClose }) => {
      // Check if user can assign reports (super admin or manager with service portal access)
      const canAssignReports = user?.role === 'admin' || (user?.isManager && user?.hasServicePortalAccess);

      // Debug logging
      console.log('Sidebar user data:', { role: user?.role, isManager: user?.isManager, hasServicePortalAccess: user?.hasServicePortalAccess, canAssignReports });

      // Admins and managers don't submit reports - they view and assign them
      const isAdminOrManager = user?.role === 'admin' || user?.isManager;

      const baseMenuItems = [
        { id: 'home', label: 'Dashboard', icon: Icons.home },
        ...(!isAdminOrManager ? [{ id: 'new_report', label: 'New Service Report', icon: Icons.plus }] : []),
        { id: 'reports', label: 'Service Reports', icon: Icons.folder }
      ];

      // Build menu items based on user role
      let menuItems = [...baseMenuItems];

      // Add Assign Report option for admins and managers (those who can assign to others)
      if (canAssignReports) {
        menuItems.push({ id: 'assign_report', label: 'Assign Report', icon: Icons.assign });
      }

      const handleNavigate = (id) => {
        onNavigate(id);
        if (onClose) onClose();
      };

      return (
        <>
          {isMobileOpen && (
            <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 lg:hidden" onClick={onClose}></div>
          )}

          <aside className={`w-72 bg-white/95 backdrop-blur-sm border-r border-gray-100 min-h-screen fixed left-0 top-0 z-50 transform transition-all duration-300 ease-out ${isMobileOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'} lg:translate-x-0 lg:shadow-none`}>
            {/* Header */}
            <div className="p-5 border-b border-gray-100 flex justify-between items-center">
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-9" />
              <button onClick={onClose} className="lg:hidden p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition">
                {Icons.close}
              </button>
            </div>

            {/* Profile Card */}
            <div className="mx-4 mt-4 p-4 rounded-xl bg-gradient-to-br from-primary-500/10 to-primary-700/5 border border-primary-100">
              <div className="flex items-center gap-3">
                <div className="w-11 h-11 rounded-xl gradient-header flex items-center justify-center text-white text-sm font-bold shadow-md">
                  {(user?.name || 'T').charAt(0).toUpperCase()}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="font-semibold text-gray-900 truncate">{user?.name || 'Technician'}</p>
                  <p className="text-xs text-primary-600 font-medium">
                    {user?.role === 'admin' ? 'Super Admin' :
                     user?.isManager ? 'Manager' :
                     user?.role === 'vendor' ? 'Vendor' : 'Service Technician'}
                  </p>
                </div>
              </div>
            </div>

            {/* Navigation */}
            <nav className="p-3 mt-2">
              <p className="px-3 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Menu</p>
              {menuItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => handleNavigate(item.id)}
                  className={`w-full text-left px-4 py-3 mb-1 sidebar-link flex items-center gap-3 ${
                    activePage === item.id ? 'active' : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  <span className={activePage === item.id ? 'text-white' : 'text-primary-500'}>{item.icon}</span>
                  <span className="font-medium text-sm">{item.label}</span>
                </button>
              ))}
            </nav>

            {/* Footer */}
            <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 bg-white/80 space-y-2">
              <button
                onClick={() => { window.location.href = '/'; }}
                className="w-full text-left px-4 py-2.5 text-gray-600 hover:text-primary-600 hover:bg-primary-50 rounded-xl flex items-center gap-3 transition font-medium text-sm"
              >
                {Icons.home}
                <span>Portal Hub</span>
              </button>
              <button
                onClick={() => {
                  localStorage.removeItem('service_token');
                  localStorage.removeItem('service_user');
                  localStorage.removeItem('unified_token');
                  localStorage.removeItem('unified_user');
                  localStorage.removeItem('token');
                  localStorage.removeItem('user');
                  localStorage.removeItem('admin_token');
                  localStorage.removeItem('admin_user');
                  localStorage.removeItem('portal_token');
                  localStorage.removeItem('portal_user');
                  window.location.href = '/';
                }}
                className="w-full text-left px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-xl flex items-center gap-3 transition font-medium text-sm"
              >
                {Icons.logout}
                <span>Sign Out</span>
              </button>
            </div>
          </aside>
        </>
      );
    };

    // Dashboard Home Page
    const HomePage = ({ user, onNavigate, recentReports, assignedReports = [], onEditAssignment, activeValidations = [], onContinueValidation, isAdminView, allReportsCount, openCount, closedCount }) => {
      const [recentSort, setRecentSort] = useState('date_desc');
      const [recentTypeFilter, setRecentTypeFilter] = useState('');
      const [assignedSort, setAssignedSort] = useState('date_desc');

      const recentServiceTypes = [...new Set((recentReports || []).map(r => r.serviceType).filter(Boolean))];
      const sortedRecent = [...(recentReports || [])]
        .filter(r => !recentTypeFilter || r.serviceType === recentTypeFilter)
        .sort((a, b) => {
          const dateA = new Date(a.serviceDate || a.serviceCompletionDate || a.createdAt);
          const dateB = new Date(b.serviceDate || b.serviceCompletionDate || b.createdAt);
          if (recentSort === 'date_desc') return dateB - dateA;
          if (recentSort === 'date_asc') return dateA - dateB;
          if (recentSort === 'client_asc') return (a.clientName || a.clientFacilityName || '').localeCompare(b.clientName || b.clientFacilityName || '');
          if (recentSort === 'client_desc') return (b.clientName || b.clientFacilityName || '').localeCompare(a.clientName || a.clientFacilityName || '');
          if (recentSort === 'type_asc') return (a.serviceType || '').localeCompare(b.serviceType || '');
          return dateB - dateA;
        });

      const sortedAssigned = [...assignedReports].sort((a, b) => {
        const dateA = new Date(a.serviceCompletionDate || a.assignedAt || a.createdAt);
        const dateB = new Date(b.serviceCompletionDate || b.assignedAt || b.createdAt);
        if (assignedSort === 'date_desc') return dateB - dateA;
        if (assignedSort === 'date_asc') return dateA - dateB;
        if (assignedSort === 'client_asc') return (a.clientFacilityName || '').localeCompare(b.clientFacilityName || '');
        if (assignedSort === 'type_asc') return (a.serviceType || '').localeCompare(b.serviceType || '');
        return dateB - dateA;
      });

      return (
        <div className="space-y-6 animate-fade-in">
          {/* Dynamic Banner Header */}
          <div className="relative rounded-2xl overflow-hidden shadow-lg" style={{minHeight: '200px'}}>
            <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-service.jpg)'}}></div>
            <div className="absolute inset-0 bg-gradient-to-r from-primary-700/90 via-primary-600/70 to-transparent"></div>
            <div className="relative p-8 flex items-center min-h-[200px]">
              <div className="text-white">
                <p className="text-primary-100 text-sm font-medium mb-1 opacity-90">Welcome back,</p>
                <h1 className="text-3xl font-bold drop-shadow-sm">{user?.name || 'Technician'}</h1>
                <p className="mt-2 text-white/80 text-sm max-w-md">Service Portal Dashboard - Submit and track field service reports</p>
              </div>
            </div>
          </div>

          {/* Assigned Service Visits Section */}
          {assignedReports.length > 0 && (
            <div className="card-modern p-6 border-l-4 border-red-500 bg-red-50/30">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/></svg>
                  </div>
                  <div>
                    <h2 className="text-lg font-bold text-gray-900">Assigned Service Visits</h2>
                    <p className="text-sm text-gray-600">You have {assignedReports.length} pending service visit{assignedReports.length > 1 ? 's' : ''} to complete</p>
                  </div>
                </div>
                {assignedReports.length > 1 && (
                  <select value={assignedSort} onChange={e => setAssignedSort(e.target.value)} className="text-xs border rounded-lg px-2 py-1.5 text-gray-600 focus:ring-1 focus:ring-primary">
                    <option value="date_desc">Newest First</option>
                    <option value="date_asc">Oldest First</option>
                    <option value="client_asc">Client A-Z</option>
                    <option value="type_asc">Service Type</option>
                  </select>
                )}
              </div>
              <div className="space-y-3">
                {sortedAssigned.map(report => (
                  <div key={report.id} className="bg-white rounded-xl p-4 border border-red-100 hover:border-red-200 transition">
                    <div className="flex items-center justify-between flex-wrap gap-3">
                      <div className="flex-1">
                        <p className="font-semibold text-gray-900">{report.clientFacilityName}</p>
                        <div className="flex flex-wrap items-center gap-2 mt-1 text-sm text-gray-600">
                          {report.serviceType && <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{report.serviceType}</span>}
                          {report.serviceCompletionDate && <span>Due: {new Date(report.serviceCompletionDate).toLocaleDateString()}</span>}
                        </div>
                        {report.managerNotes && (
                          <p className="text-xs text-gray-500 mt-2 line-clamp-1">Note: {report.managerNotes}</p>
                        )}
                        <p className="text-xs text-gray-400 mt-1">Assigned by {report.assignedByName} on {new Date(report.assignedAt).toLocaleDateString()}</p>
                      </div>
                      <button
                        onClick={() => onEditAssignment(report)}
                        className="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition text-sm flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg>
                        Complete Report
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Active Validations Section */}
          <div className={`card-modern p-6 border-l-4 ${activeValidations.length > 0 ? 'border-blue-500 bg-blue-50/30' : 'border-gray-300 bg-gray-50/30'}`}>
            <div className="flex items-center gap-3 mb-4">
              <div className={`w-10 h-10 rounded-full flex items-center justify-center ${activeValidations.length > 0 ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-400'}`}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>
              </div>
              <div>
                <h2 className="text-lg font-bold text-gray-900">Active Validations</h2>
                <p className="text-sm text-gray-600">
                  {activeValidations.length > 0
                    ? `You have ${activeValidations.length} in-progress validation${activeValidations.length > 1 ? 's' : ''}`
                    : 'No active multi-day validations'}
                </p>
              </div>
            </div>
            {activeValidations.length > 0 ? (
              <div className="space-y-3">
                {activeValidations.map(v => {
                  const segments = Array.isArray(v.validationSegments) ? v.validationSegments : [];
                  const daysLogged = segments.length;
                  const expectedDays = v.expectedDays;
                  const progressPercent = expectedDays ? Math.min(100, Math.round((daysLogged / expectedDays) * 100)) : null;
                  const startDate = v.validationStartDate || segments[0]?.date;
                  return (
                    <div key={v.id} className="bg-white rounded-xl p-4 border border-blue-100 hover:border-blue-200 transition">
                      <div className="flex items-center justify-between flex-wrap gap-3">
                        <div className="flex-1">
                          <p className="font-semibold text-gray-900">{v.clientFacilityName}</p>
                          <p className="text-sm text-gray-600">{v.analyzerModel || 'Biolis AU480'} {v.analyzerSerialNumber ? `Â· ${v.analyzerSerialNumber}` : ''}</p>
                          <div className="flex items-center gap-2 mt-2">
                            <div className="flex gap-0.5">
                              {segments.map((s, i) => (
                                <div key={i} className="w-2.5 h-2.5 rounded-full bg-green-500" title={`Day ${s.day}`}></div>
                              ))}
                              <div className="w-2.5 h-2.5 rounded-full bg-gray-200 border border-blue-400 animate-pulse" title="Next day"></div>
                            </div>
                            <span className="text-xs text-gray-500">{daysLogged} day{daysLogged !== 1 ? 's' : ''} logged</span>
                            {startDate && <span className="text-xs text-gray-400">Â· Started {new Date(startDate + 'T12:00:00').toLocaleDateString()}</span>}
                          </div>
                          {expectedDays && progressPercent !== null && (
                            <div className="mt-2 w-full max-w-xs">
                              <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                <div className={`h-full rounded-full transition-all duration-500 ${progressPercent >= 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${progressPercent}%` }} />
                              </div>
                              <p className="text-xs text-gray-400 mt-0.5">{daysLogged} of {expectedDays} days Â· {progressPercent}%</p>
                            </div>
                          )}
                        </div>
                        <button
                          onClick={() => onContinueValidation(v)}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition text-sm flex items-center gap-2"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                          Add Day {daysLogged + 1}
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-4">
                <p className="text-sm text-gray-500">Start a multi-day validation from the New Service Report form by selecting "Validations" and setting a date range spanning multiple days.</p>
              </div>
            )}
          </div>

          {/* Quick Actions */}
          <div className={`grid ${user?.role === 'admin' || user?.isManager ? 'md:grid-cols-2' : 'md:grid-cols-3'} gap-5`}>
            {/* New Service Report - only for vendors/technicians, not admins/managers */}
            {user?.role !== 'admin' && !user?.isManager && (
              <button
                onClick={() => onNavigate('new_report')}
                className="card-modern p-6 text-left group hover:border-primary-200 transition-all"
              >
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-105 transition-transform">
                  {React.cloneElement(Icons.plus, { className: 'w-7 h-7' })}
                </div>
                <h3 className="font-semibold text-gray-900">New Service Report</h3>
                <p className="text-sm text-gray-500 mt-1">Submit a new service report</p>
              </button>
            )}
            <button
              onClick={() => onNavigate('reports')}
              className="card-modern p-6 text-left group hover:border-purple-200 transition-all"
            >
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-105 transition-transform">
                {React.cloneElement(Icons.folder, { className: 'w-7 h-7' })}
              </div>
              <h3 className="font-semibold text-gray-900">Service Reports</h3>
              <p className="text-sm text-gray-500 mt-1">View and search past reports</p>
            </button>

            {/* Admin/Manager View: All Reports card with open/closed breakdown */}
            {isAdminView ? (
              <button
                onClick={() => onNavigate('reports')}
                className="stat-card card-modern p-6 border-l-primary-500 text-left cursor-pointer hover:shadow-md transition-shadow w-full"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-500 font-medium">All Reports</p>
                    <p className="text-3xl font-bold text-primary-500 mt-1">{allReportsCount || 0}</p>
                    <div className="flex gap-3 mt-1 text-xs text-gray-500">
                      <span className="text-amber-600">{openCount || 0} open</span>
                      <span className="text-green-600">{closedCount || 0} closed</span>
                    </div>
                  </div>
                  <div className="w-14 h-14 rounded-xl bg-primary-50 flex items-center justify-center text-primary-500">
                    {React.cloneElement(Icons.document, { className: 'w-7 h-7' })}
                  </div>
                </div>
              </button>
            ) : (
              /* Technician/Vendor View: My Reports card showing submitted count */
              <button
                onClick={() => onNavigate('reports')}
                className="stat-card card-modern p-6 border-l-primary-500 text-left cursor-pointer hover:shadow-md transition-shadow w-full"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-500 font-medium">My Reports</p>
                    <p className="text-3xl font-bold text-primary-500 mt-1">{recentReports?.length || 0}</p>
                    <p className="text-xs text-gray-500 mt-1">{recentReports?.length || 0} submitted</p>
                  </div>
                  <div className="w-14 h-14 rounded-xl bg-primary-50 flex items-center justify-center text-primary-500">
                    {React.cloneElement(Icons.document, { className: 'w-7 h-7' })}
                  </div>
                </div>
              </button>
            )}
          </div>

          {/* Recent Reports */}
          <div className="card-modern p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                <span className="w-8 h-8 rounded-lg bg-primary-50 flex items-center justify-center text-primary-500">{Icons.clipboard}</span>
                Recent Service Reports
              </h2>
              {recentReports && recentReports.length > 0 && (
                <button onClick={() => onNavigate('reports')} className="text-sm text-primary-500 hover:text-primary-600 font-medium">
                  View All
                </button>
              )}
            </div>
            {recentReports && recentReports.length > 0 && (
              <div className="flex flex-wrap items-center gap-2 mb-4">
                <select value={recentSort} onChange={e => setRecentSort(e.target.value)} className="text-xs border rounded-lg px-2 py-1.5 text-gray-600 focus:ring-1 focus:ring-primary">
                  <option value="date_desc">Newest First</option>
                  <option value="date_asc">Oldest First</option>
                  <option value="client_asc">Client A-Z</option>
                  <option value="client_desc">Client Z-A</option>
                  <option value="type_asc">Service Type</option>
                </select>
                {recentServiceTypes.length > 1 && (
                  <select value={recentTypeFilter} onChange={e => setRecentTypeFilter(e.target.value)} className="text-xs border rounded-lg px-2 py-1.5 text-gray-600 focus:ring-1 focus:ring-primary">
                    <option value="">All Types</option>
                    {recentServiceTypes.map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                )}
              </div>
            )}
            {sortedRecent.length > 0 ? (
              <div className="space-y-3">
                {sortedRecent.slice(0, 5).map((report, idx) => (
                  <div key={report.id || idx} className="flex justify-between items-center p-4 bg-gray-50 rounded-xl border-l-4 border-primary-500 hover:bg-gray-100 transition">
                    <div>
                      <p className="font-semibold text-gray-900">{report.clientName || report.clientFacilityName}</p>
                      <p className="text-sm text-gray-600">{report.serviceType}</p>
                      <p className="text-xs text-gray-400 mt-1">
                        {new Date(report.serviceDate || report.serviceCompletionDate || report.createdAt).toLocaleDateString()}
                      </p>
                    </div>
                    <span className={`text-xs px-3 py-1.5 rounded-full font-medium ${
                      report.status === 'assigned'
                        ? 'bg-warning-50 text-warning-600'
                        : report.status === 'validation_in_progress'
                          ? 'bg-blue-50 text-blue-600'
                          : report.status === 'signature_needed'
                            ? 'bg-orange-50 text-orange-600'
                            : 'bg-success-50 text-success-600'
                    }`}>
                      {report.status === 'assigned' ? 'Pending' : report.status === 'validation_in_progress' ? 'Validation In Progress' : report.status === 'signature_needed' ? 'Signature Needed' : 'Complete'}
                    </span>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8">
                <div className="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-3">
                  {React.cloneElement(Icons.folder, { className: 'w-8 h-8 text-gray-400' })}
                </div>
                <p className="text-gray-500">{recentTypeFilter ? 'No reports match this filter' : 'No recent service reports'}</p>
                {!recentTypeFilter && (
                  <button onClick={() => onNavigate('new_report')} className="mt-3 text-sm text-primary-500 hover:text-primary-600 font-medium">
                    Create your first report
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };

    // Signature Pad Component
    const SignaturePad = ({ onSave, label, initialValue }) => {
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [hasSignature, setHasSignature] = useState(!!initialValue);
      const hasDrawnRef = useRef(false);

      useEffect(() => {
        if (initialValue && canvasRef.current) {
          const ctx = canvasRef.current.getContext('2d');
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
          };
          img.src = initialValue;
          hasDrawnRef.current = true;
        }
      }, [initialValue]);

      const startDrawing = (e) => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;

        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
      };

      const draw = (e) => {
        if (!isDrawing) return;
        hasDrawnRef.current = true;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;

        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        ctx.lineTo(x, y);
        ctx.stroke();
      };

      const stopDrawing = () => {
        if (isDrawing) {
          setIsDrawing(false);
          // Only save if user actually drew something (not just clicked/tapped)
          if (hasDrawnRef.current) {
            setHasSignature(true);
            if (onSave) {
              onSave(canvasRef.current.toDataURL());
            }
          }
        }
      };

      const clearSignature = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        setHasSignature(false);
        hasDrawnRef.current = false;
        if (onSave) {
          onSave(null);
        }
      };

      return (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">{label}</label>
          <canvas
            ref={canvasRef}
            width={400}
            height={100}
            className={`signature-pad w-full rounded-lg ${hasSignature ? 'signed' : ''}`}
            onMouseDown={startDrawing}
            onMouseMove={draw}
            onMouseUp={stopDrawing}
            onMouseLeave={stopDrawing}
            onTouchStart={startDrawing}
            onTouchMove={draw}
            onTouchEnd={stopDrawing}
          />
          <button
            type="button"
            onClick={clearSignature}
            className="mt-2 text-sm text-red-600 hover:text-red-800"
          >
            Clear Signature
          </button>
        </div>
      );
    };

    // New Service Report Form
    const NewReportPage = ({ token, user, onSuccess, clients }) => {
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState(false);
      const [hasDraft, setHasDraft] = useState(false);
      const [draftSaved, setDraftSaved] = useState(false);

      const getInitialFormData = () => {
        const defaultData = {
          // Client Information
          clientFacilityName: '',
          customerName: '',
          serviceProviderName: user?.name || '',
          address: '',
          serviceCompletionDate: new Date().toISOString().split('T')[0],
          analyzerModel: '',
          analyzerSerialNumber: '',
          hubspotTicketNumber: '',
          hubspotCompanyId: '',

          // Service Performed
          serviceType: '',
          descriptionOfWork: '',
          materialsUsed: '',
          solution: '',
          outstandingIssues: '',

          // Validation-specific fields
          validationSegments: '',
          recommendations: '',
          analyzersValidated: [{ model: '', serialNumber: '', status: 'Passed' }],
          validationStartDate: new Date().toISOString().split('T')[0],
          validationEndDate: new Date().toISOString().split('T')[0],
          trainingProvided: '',
          testProcedures: '',
          validationResults: '',
          validationReportFile: null,
          validationReportFileName: '',

          // Signatures
          customerSignature: '',
          customerSignatureDate: '',
          customerFirstName: '',
          customerLastName: '',
          technicianSignature: '',
          technicianSignatureDate: new Date().toISOString().split('T')[0],
          technicianFirstName: user?.name?.split(' ')[0] || '',
          technicianLastName: user?.name?.split(' ').slice(1).join(' ') || ''
        };

        try {
          const savedDraft = localStorage.getItem('service_report_draft');
          if (savedDraft) {
            const parsed = JSON.parse(savedDraft);
            return { ...defaultData, ...parsed, serviceProviderName: user?.name || parsed.serviceProviderName };
          }
        } catch (e) {
          console.error('Error loading draft:', e);
        }
        return defaultData;
      };

      const [formData, setFormData] = useState(getInitialFormData);

      // Check if draft exists on mount
      useEffect(() => {
        const savedDraft = localStorage.getItem('service_report_draft');
        setHasDraft(!!savedDraft);
      }, []);

      const isValidationType = formData.serviceType === 'Validations';

      const updateField = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      // Save draft to localStorage
      const saveDraft = () => {
        try {
          // Don't save signatures in draft (too large)
          const draftData = { ...formData };
          delete draftData.customerSignature;
          delete draftData.technicianSignature;
          localStorage.setItem('service_report_draft', JSON.stringify(draftData));
          setHasDraft(true);
          setDraftSaved(true);
          setTimeout(() => setDraftSaved(false), 2000);
        } catch (e) {
          console.error('Error saving draft:', e);
        }
      };

      // Clear draft from localStorage
      const clearDraft = () => {
        localStorage.removeItem('service_report_draft');
        setHasDraft(false);
        setFormData({
          clientFacilityName: '',
          customerName: '',
          serviceProviderName: user?.name || '',
          address: '',
          serviceCompletionDate: new Date().toISOString().split('T')[0],
          analyzerModel: '',
          analyzerSerialNumber: '',
          hubspotTicketNumber: '',
          hubspotCompanyId: '',
          serviceType: '',
          descriptionOfWork: '',
          materialsUsed: '',
          solution: '',
          outstandingIssues: '',
          validationSegments: '',
          recommendations: '',
          analyzersValidated: [{ model: '', serialNumber: '', status: 'Passed' }],
          validationStartDate: new Date().toISOString().split('T')[0],
          validationEndDate: new Date().toISOString().split('T')[0],
          trainingProvided: '',
          testProcedures: '',
          validationResults: '',
          validationReportFile: null,
          validationReportFileName: '',
          customerSignature: '',
          customerSignatureDate: '',
          customerFirstName: '',
          customerLastName: '',
          technicianSignature: '',
          technicianSignatureDate: new Date().toISOString().split('T')[0],
          technicianFirstName: user?.name?.split(' ')[0] || '',
          technicianLastName: user?.name?.split(' ').slice(1).join(' ') || ''
        });
      };

      // Calculate days on-site from start and end dates
      const calculateDaysOnSite = () => {
        if (formData.validationStartDate && formData.validationEndDate) {
          const start = new Date(formData.validationStartDate);
          const end = new Date(formData.validationEndDate);
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
          return diffDays;
        }
        return 1;
      };

      // Add analyzer to the list
      const addAnalyzer = () => {
        setFormData(prev => ({
          ...prev,
          analyzersValidated: [...prev.analyzersValidated, { model: '', serialNumber: '', status: 'Passed' }]
        }));
      };

      // Update analyzer in the list
      const updateAnalyzer = (index, field, value) => {
        setFormData(prev => {
          const updated = [...prev.analyzersValidated];
          updated[index] = { ...updated[index], [field]: value };
          return { ...prev, analyzersValidated: updated };
        });
      };

      // Remove analyzer from the list
      const removeAnalyzer = (index) => {
        if (formData.analyzersValidated.length > 1) {
          setFormData(prev => ({
            ...prev,
            analyzersValidated: prev.analyzersValidated.filter((_, i) => i !== index)
          }));
        }
      };

      // Handle validation report file upload
      const handleValidationFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setFormData(prev => ({
              ...prev,
              validationReportFile: reader.result,
              validationReportFileName: file.name
            }));
          };
          reader.readAsDataURL(file);
        }
      };

      const handleClientSelect = (clientName) => {
        const client = clients?.find(c => c.name === clientName || c.clientName === clientName);
        if (client) {
          setFormData(prev => ({
            ...prev,
            clientFacilityName: client.name || client.clientName || '',
            address: client.address || '',
            hubspotCompanyId: client.hubspotCompanyId || ''
          }));
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        // Validate required fields
        const isValidation = formData.serviceType === 'Validations';
        if (!formData.clientFacilityName || !formData.serviceType) {
          setError('Please fill in all required fields');
          setLoading(false);
          return;
        }
        if (isValidation && !formData.validationResults) {
          setError('Please fill in the validation results');
          setLoading(false);
          return;
        }
        if (isValidation && !formData.testProcedures) {
          setError('Please fill in the test procedures');
          setLoading(false);
          return;
        }
        if (!isValidation && !formData.descriptionOfWork) {
          setError('Please fill in the description of work');
          setLoading(false);
          return;
        }

        if (!formData.technicianSignature) {
          setError('Technician signature is required');
          setLoading(false);
          return;
        }

        try {
          const result = await api.submitServiceReport(token, {
            ...formData,
            technicianId: user?.id,
            technicianName: user?.name
          });

          if (result.error) {
            setError(result.error);
          } else {
            // Clear draft on successful submission
            localStorage.removeItem('service_report_draft');
            setHasDraft(false);
            setSuccess(true);
            setTimeout(() => {
              if (onSuccess) onSuccess();
            }, 2000);
          }
        } catch (err) {
          setError('Failed to submit report. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      // Multi-day validation state
      const [showMultiDayForm, setShowMultiDayForm] = useState(false);
      const [multiDayForm, setMultiDayForm] = useState({
        firstDayDate: new Date().toISOString().split('T')[0],
        firstDayTests: '',
        firstDayResults: '',
        firstDayObservations: '',
        expectedDays: ''
      });

      const daysOnSite = calculateDaysOnSite();
      const isMultiDay = isValidationType && daysOnSite > 1;

      const handleStartMultiDay = async () => {
        if (!formData.clientFacilityName || !formData.testProcedures) {
          setError('Client facility and test procedures are required');
          return;
        }
        if (!multiDayForm.firstDayTests.trim()) {
          setError('Day 1 tests performed is required');
          return;
        }
        setLoading(true);
        setError('');

        try {
          const result = await api.startValidation(token, {
            ...formData,
            ...multiDayForm,
            expectedDays: multiDayForm.expectedDays ? parseInt(multiDayForm.expectedDays) : daysOnSite > 1 ? daysOnSite : null,
            technicianId: user?.id,
            technicianName: user?.name
          });

          if (result.error) {
            setError(result.error);
          } else {
            localStorage.removeItem('service_report_draft');
            setHasDraft(false);
            setSuccess(true);
            setTimeout(() => {
              if (onSuccess) onSuccess();
            }, 2000);
          }
        } catch (err) {
          setError('Failed to start validation. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      if (success) {
        return (
          <div className="bg-white p-8 rounded-xl shadow-sm text-center">
            <div className="flex justify-center mb-4 text-green-500">
              {React.cloneElement(Icons.check, { className: 'w-16 h-16' })}
            </div>
            <h2 className="text-2xl font-bold text-accent mb-2">{showMultiDayForm ? 'Multi-Day Validation Started!' : 'Report Submitted!'}</h2>
            <p className="text-gray-600">{showMultiDayForm ? 'Day 1 has been logged. Continue logging daily from your dashboard.' : 'Your service report has been submitted successfully.'}</p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {hasDraft && (
            <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg flex items-center gap-2">
              <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span className="text-sm">You have a saved draft. Your previous form data has been restored.</span>
            </div>
          )}

          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-2xl font-bold text-accent">Service Report</h1>
                <p className="text-gray-600 mt-1">THRIVE 365 LABS - SERVICE REPORT</p>
              </div>
              <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-12" />
            </div>
          </div>

          <form onSubmit={handleSubmit} className="space-y-6">
            {error && (
              <div className="bg-red-50 text-red-600 p-4 rounded-lg">
                {error}
              </div>
            )}

            {/* Client Information Section */}
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 pb-2 border-b">CLIENT INFORMATION</h2>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client/Facility Name *</label>
                  <select
                    value={formData.clientFacilityName}
                    onChange={(e) => {
                      updateField('clientFacilityName', e.target.value);
                      handleClientSelect(e.target.value);
                    }}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    required
                  >
                    <option value="">Select a client...</option>
                    {clients?.map((client, idx) => (
                      <option key={idx} value={client.name || client.clientName}>
                        {client.name || client.clientName}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                  <input
                    type="text"
                    value={formData.customerName}
                    onChange={(e) => updateField('customerName', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Provider Name</label>
                  <input
                    type="text"
                    value={formData.serviceProviderName}
                    onChange={(e) => updateField('serviceProviderName', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-gray-50"
                    readOnly
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                  <input
                    type="text"
                    value={formData.address}
                    onChange={(e) => updateField('address', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Completion Date *</label>
                  <input
                    type="date"
                    value={formData.serviceCompletionDate}
                    onChange={(e) => updateField('serviceCompletionDate', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Model</label>
                  <input
                    type="text"
                    value={formData.analyzerModel}
                    onChange={(e) => updateField('analyzerModel', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="e.g., DZLite C270"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Serial Number (S/N)</label>
                  <input
                    type="text"
                    value={formData.analyzerSerialNumber}
                    onChange={(e) => updateField('analyzerSerialNumber', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="e.g., 601744124"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">HubSpot Ticket #</label>
                  <input
                    type="text"
                    value={formData.hubspotTicketNumber}
                    onChange={(e) => updateField('hubspotTicketNumber', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="Enter HubSpot ticket number"
                  />
                </div>
              </div>
            </div>

            {/* Service Performed Section */}
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 pb-2 border-b">SERVICE PERFORMED</h2>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Type *</label>
                  <select
                    value={formData.serviceType}
                    onChange={(e) => updateField('serviceType', e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    required
                  >
                    <option value="">Select service type...</option>
                    <option value="Analyzer Hardware">Analyzer Hardware</option>
                    <option value="Inventory">Inventory</option>
                    <option value="LIS/EMR">LIS/EMR</option>
                    <option value="Compliance">Compliance</option>
                    <option value="Training">Training</option>
                    <option value="Validations">Validations</option>
                  </select>
                </div>

                {isValidationType ? (
                  <>
                    {/* Date Range and Days On-Site */}
                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
                        <input
                          type="date"
                          value={formData.validationStartDate}
                          onChange={(e) => updateField('validationStartDate', e.target.value)}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">End Date *</label>
                        <input
                          type="date"
                          value={formData.validationEndDate}
                          onChange={(e) => updateField('validationEndDate', e.target.value)}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Days On-Site</label>
                        <input
                          type="text"
                          value={calculateDaysOnSite()}
                          className="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-700"
                          readOnly
                        />
                      </div>
                    </div>

                    {/* Analyzers Validated */}
                    <div className="border rounded-lg p-4 bg-gray-50">
                      <div className="flex justify-between items-center mb-3">
                        <label className="text-sm font-semibold text-gray-700">Analyzers Validated</label>
                        <button
                          type="button"
                          onClick={addAnalyzer}
                          className="text-sm text-primary hover:text-accent font-medium"
                        >
                          + Add Analyzer
                        </button>
                      </div>
                      <div className="space-y-3">
                        {formData.analyzersValidated.map((analyzer, idx) => (
                          <div key={idx} className="grid grid-cols-12 gap-2 items-end">
                            <div className="col-span-4">
                              {idx === 0 && <label className="block text-xs text-gray-500 mb-1">Model</label>}
                              <input
                                type="text"
                                value={analyzer.model}
                                onChange={(e) => updateAnalyzer(idx, 'model', e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm"
                                placeholder="Analyzer model"
                              />
                            </div>
                            <div className="col-span-4">
                              {idx === 0 && <label className="block text-xs text-gray-500 mb-1">Serial Number</label>}
                              <input
                                type="text"
                                value={analyzer.serialNumber}
                                onChange={(e) => updateAnalyzer(idx, 'serialNumber', e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm"
                                placeholder="S/N"
                              />
                            </div>
                            <div className="col-span-3">
                              {idx === 0 && <label className="block text-xs text-gray-500 mb-1">Status</label>}
                              <select
                                value={analyzer.status}
                                onChange={(e) => updateAnalyzer(idx, 'status', e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm"
                              >
                                <option value="Passed">Passed</option>
                                <option value="Failed">Failed</option>
                                <option value="Pending">Pending</option>
                              </select>
                            </div>
                            <div className="col-span-1">
                              {formData.analyzersValidated.length > 1 && (
                                <button
                                  type="button"
                                  onClick={() => removeAnalyzer(idx)}
                                  className="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                                  title="Remove"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                                  </svg>
                                </button>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Test Procedures */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Test Procedures *</label>
                      <textarea
                        value={formData.testProcedures}
                        onChange={(e) => updateField('testProcedures', e.target.value)}
                        rows={4}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Describe the test procedures used during validation (e.g., precision, accuracy, linearity, reportable range, reference interval verification)..."
                        required
                      />
                    </div>

                    {/* Training Provided */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Training Provided</label>
                      <textarea
                        value={formData.trainingProvided}
                        onChange={(e) => updateField('trainingProvided', e.target.value)}
                        rows={3}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Describe training activities, topics covered, and personnel trained..."
                      />
                    </div>

                    {/* Validation Results */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Validation Results *</label>
                      <textarea
                        value={formData.validationResults}
                        onChange={(e) => updateField('validationResults', e.target.value)}
                        rows={4}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Summary of validation tests performed and results..."
                        required
                      />
                    </div>

                    {/* Validation Report File Upload */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Validation Report File</label>
                      <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-primary transition-colors">
                        <input
                          type="file"
                          id="validationReportFile"
                          onChange={handleValidationFileChange}
                          className="hidden"
                          accept=".pdf,.doc,.docx,.xls,.xlsx"
                        />
                        {formData.validationReportFileName ? (
                          <div className="flex items-center justify-center gap-2">
                            <svg className="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span className="text-sm text-gray-700">{formData.validationReportFileName}</span>
                            <button
                              type="button"
                              onClick={() => {
                                updateField('validationReportFile', null);
                                updateField('validationReportFileName', '');
                              }}
                              className="text-red-500 hover:text-red-700 text-sm ml-2"
                            >
                              Remove
                            </button>
                          </div>
                        ) : (
                          <label htmlFor="validationReportFile" className="cursor-pointer">
                            <svg className="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <span className="text-sm text-gray-500">Click to upload validation report (PDF, DOC, XLS)</span>
                          </label>
                        )}
                      </div>
                    </div>

                    {/* Recommendations */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Recommendations</label>
                      <textarea
                        value={formData.recommendations}
                        onChange={(e) => updateField('recommendations', e.target.value)}
                        rows={3}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="List any recommendations for the client..."
                      />
                    </div>
                  </>
                ) : (
                  <>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Description of Work Performed *</label>
                      <textarea
                        value={formData.descriptionOfWork}
                        onChange={(e) => updateField('descriptionOfWork', e.target.value)}
                        rows={5}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Describe the work performed in detail..."
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Materials Used</label>
                      <textarea
                        value={formData.materialsUsed}
                        onChange={(e) => updateField('materialsUsed', e.target.value)}
                        rows={2}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="e.g., Hydra-DI, DZLite, plumbers tape/tubing"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Solution</label>
                      <textarea
                        value={formData.solution}
                        onChange={(e) => updateField('solution', e.target.value)}
                        rows={3}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Describe the solution implemented..."
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Final Recommendations</label>
                      <textarea
                        value={formData.outstandingIssues}
                        onChange={(e) => updateField('outstandingIssues', e.target.value)}
                        rows={3}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="List any final recommendations for the client..."
                      />
                    </div>
                  </>
                )}
              </div>
            </div>

            {/* Signatures Section */}
            <div className="bg-white p-6 rounded-xl shadow-sm">
              <h2 className="text-lg font-bold text-accent mb-4 pb-2 border-b">SIGNATURES</h2>

              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <SignaturePad
                    label="Customer Signature"
                    onSave={(data) => updateField('customerSignature', data)}
                    initialValue={formData.customerSignature}
                  />
                  <div className="grid grid-cols-2 gap-3 mt-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                      <input
                        type="text"
                        value={formData.customerFirstName}
                        onChange={(e) => updateField('customerFirstName', e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="First name"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                      <input
                        type="text"
                        value={formData.customerLastName}
                        onChange={(e) => updateField('customerLastName', e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Last name"
                      />
                    </div>
                  </div>
                  <div className="mt-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input
                      type="date"
                      value={formData.customerSignatureDate}
                      onChange={(e) => updateField('customerSignatureDate', e.target.value)}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    />
                  </div>
                </div>

                <div>
                  <SignaturePad
                    label="Technician Signature *"
                    onSave={(data) => updateField('technicianSignature', data)}
                    initialValue={formData.technicianSignature}
                  />
                  <div className="grid grid-cols-2 gap-3 mt-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                      <input
                        type="text"
                        value={formData.technicianFirstName}
                        onChange={(e) => updateField('technicianFirstName', e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="First name"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                      <input
                        type="text"
                        value={formData.technicianLastName}
                        onChange={(e) => updateField('technicianLastName', e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                        placeholder="Last name"
                      />
                    </div>
                  </div>
                  <div className="mt-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input
                      type="date"
                      value={formData.technicianSignatureDate}
                      onChange={(e) => updateField('technicianSignatureDate', e.target.value)}
                      className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Multi-day validation info banner */}
            {isMultiDay && !showMultiDayForm && (
              <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <svg className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>
                  <div>
                    <p className="font-semibold text-blue-800">Multi-day validation detected ({daysOnSite} days)</p>
                    <p className="text-sm text-blue-600 mt-1">You can submit as a single report now, or start a multi-day validation to log each day's data separately.</p>
                    <button
                      type="button"
                      onClick={() => setShowMultiDayForm(true)}
                      className="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition"
                    >
                      Start Multi-Day Validation
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Multi-day Day 1 form */}
            {showMultiDayForm && (
              <div className="bg-white p-6 rounded-xl shadow-sm border-2 border-blue-200">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <div className="w-7 h-7 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">1</div>
                    <h3 className="text-lg font-bold text-gray-900">Day 1 â€” Start Validation</h3>
                  </div>
                  <button type="button" onClick={() => setShowMultiDayForm(false)} className="text-sm text-gray-500 hover:text-gray-700">Cancel multi-day</button>
                </div>
                <p className="text-sm text-gray-600 mb-4">Log Day 1 data below. You'll add subsequent days from your dashboard.</p>

                <div className="space-y-4">
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Day 1 Date</label>
                      <input type="date" value={multiDayForm.firstDayDate} onChange={(e) => setMultiDayForm(prev => ({ ...prev, firstDayDate: e.target.value }))} className="w-full px-3 py-2 border rounded-lg text-sm" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Expected Total Days</label>
                      <input type="number" min="2" max="30" value={multiDayForm.expectedDays} onChange={(e) => setMultiDayForm(prev => ({ ...prev, expectedDays: e.target.value }))} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder={daysOnSite > 1 ? `${daysOnSite} (from date range)` : 'e.g. 5'} />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Tests Performed *</label>
                    <textarea value={multiDayForm.firstDayTests} onChange={(e) => setMultiDayForm(prev => ({ ...prev, firstDayTests: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Initial calibration, baseline QC runs..." />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Results / Readings</label>
                    <textarea value={multiDayForm.firstDayResults} onChange={(e) => setMultiDayForm(prev => ({ ...prev, firstDayResults: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Na: 140Â±2, K: 4.1Â±0.3..." />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Observations / Notes</label>
                    <textarea value={multiDayForm.firstDayObservations} onChange={(e) => setMultiDayForm(prev => ({ ...prev, firstDayObservations: e.target.value }))} rows="2" className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Reagent carousel loaded, ISE module initialized..." />
                  </div>
                </div>
              </div>
            )}

            {/* Draft and Submit Buttons */}
            <div className="flex justify-between items-center gap-4">
              <div className="flex items-center gap-3">
                <button
                  type="button"
                  onClick={saveDraft}
                  className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors text-sm"
                >
                  {draftSaved ? 'âœ“ Draft Saved' : 'Save Draft'}
                </button>
                {hasDraft && (
                  <button
                    type="button"
                    onClick={clearDraft}
                    className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium transition-colors text-sm"
                  >
                    Clear Draft
                  </button>
                )}
              </div>
              <div className="flex items-center gap-3">
                {showMultiDayForm ? (
                  <button
                    type="button"
                    onClick={handleStartMultiDay}
                    disabled={loading}
                    className="px-8 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2"
                  >
                    {loading ? (
                      <><svg className="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Starting...</>
                    ) : (
                      <><svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082"/></svg> Start Multi-Day Validation</>
                    )}
                  </button>
                ) : (
                  <button
                    type="submit"
                    disabled={loading}
                    className="px-8 py-3 bg-primary text-white rounded-lg font-medium hover:bg-accent transition-colors disabled:opacity-50"
                  >
                    {loading ? 'Submitting...' : 'Submit Service Report'}
                  </button>
                )}
              </div>
            </div>
          </form>
        </div>
      );
    };

    // Service Reports Repository Page
    const ReportsPage = ({ token, onViewReport, onEditReport, currentUser }) => {
      const [reports, setReports] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [clientFilter, setClientFilter] = useState('');
      const [dateFrom, setDateFrom] = useState('');
      const [dateTo, setDateTo] = useState('');
      const [clients, setClients] = useState([]);
      const [selectedReports, setSelectedReports] = useState(new Set());
      const [deleting, setDeleting] = useState(false);
      const [sortBy, setSortBy] = useState('date_desc');
      const [statusFilter, setStatusFilter] = useState('');

      // Super Admins can delete any, Service Technicians can delete their own
      const isSuperAdmin = currentUser?.role === 'admin';
      const isServiceTechnician = currentUser?.role === 'vendor' || currentUser?.hasServicePortalAccess;
      const canDeleteAny = isSuperAdmin || isServiceTechnician;

      // Check if current user can delete a specific report
      const canDeleteReport = (report) => {
        if (isSuperAdmin) return true;
        if (isServiceTechnician && report.technicianId === currentUser?.id) return true;
        return false;
      };

      useEffect(() => {
        loadReports();
        loadClients();
      }, []);

      const loadClients = async () => {
        const result = await api.getClients(token);
        if (!result.error) {
          setClients(result);
        }
      };

      const loadReports = async () => {
        setLoading(true);
        const filters = {};
        if (clientFilter) filters.client = clientFilter;
        if (dateFrom) filters.dateFrom = dateFrom;
        if (dateTo) filters.dateTo = dateTo;
        if (searchTerm) filters.search = searchTerm;

        const result = await api.getServiceReports(token, filters);
        if (!result.error) {
          setReports(result);
        }
        setLoading(false);
      };

      const handleSearch = (e) => {
        e.preventDefault();
        loadReports();
      };

      // Filter reports based on search term and status
      const filteredReports = reports.filter(report => {
        if (searchTerm && !report.clientFacilityName?.toLowerCase().includes(searchTerm.toLowerCase()) &&
            !report.serviceType?.toLowerCase().includes(searchTerm.toLowerCase()) &&
            !report.hubspotTicketNumber?.toLowerCase().includes(searchTerm.toLowerCase())) {
          return false;
        }
        if (statusFilter && report.status !== statusFilter) return false;
        return true;
      }).sort((a, b) => {
        const dateA = new Date(a.serviceCompletionDate || a.createdAt);
        const dateB = new Date(b.serviceCompletionDate || b.createdAt);
        if (sortBy === 'date_desc') return dateB - dateA;
        if (sortBy === 'date_asc') return dateA - dateB;
        if (sortBy === 'client_asc') return (a.clientFacilityName || '').localeCompare(b.clientFacilityName || '');
        if (sortBy === 'client_desc') return (b.clientFacilityName || '').localeCompare(a.clientFacilityName || '');
        if (sortBy === 'type_asc') return (a.serviceType || '').localeCompare(b.serviceType || '');
        if (sortBy === 'tech_asc') return (a.technicianName || a.serviceProviderName || '').localeCompare(b.technicianName || b.serviceProviderName || '');
        return dateB - dateA;
      });

      // Get reports that current user can delete
      const deletableReports = filteredReports.filter(r => canDeleteReport(r));

      const toggleSelectAll = () => {
        if (selectedReports.size === deletableReports.length && deletableReports.length > 0) {
          setSelectedReports(new Set());
        } else {
          setSelectedReports(new Set(deletableReports.map(r => r.id)));
        }
      };

      const toggleSelect = (reportId) => {
        const newSelected = new Set(selectedReports);
        if (newSelected.has(reportId)) {
          newSelected.delete(reportId);
        } else {
          newSelected.add(reportId);
        }
        setSelectedReports(newSelected);
      };

      const handleDeleteSelected = async () => {
        if (!canDeleteAny) return;

        const selectedIds = [...selectedReports];
        if (selectedIds.length === 0) {
          alert('No reports selected');
          return;
        }

        const confirmMessage = `Are you sure you want to delete ${selectedIds.length} service report(s)? This action cannot be undone.`;
        if (!confirm(confirmMessage)) return;

        setDeleting(true);
        try {
          const response = await fetch(`${API_URL}/api/service-reports`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reportIds: selectedIds })
          });

          const data = await response.json();

          if (response.ok) {
            alert(`Successfully deleted ${data.deletedCount} report(s)`);
            setSelectedReports(new Set());
            loadReports();
          } else {
            alert(data.error || 'Failed to delete reports');
          }
        } catch (error) {
          console.error('Delete error:', error);
          alert('Failed to delete reports');
        } finally {
          setDeleting(false);
        }
      };

      return (
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <h1 className="text-2xl font-bold text-accent mb-4">Service Reports Repository</h1>

            <form onSubmit={handleSearch} className="space-y-4">
              <div className="grid md:grid-cols-4 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Search</label>
                  <div className="relative">
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      placeholder="Search by client, service type, ticket..."
                      className="w-full px-4 py-2 pl-10 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    />
                    <span className="absolute left-3 top-2.5 text-gray-400">{Icons.search}</span>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client</label>
                  <select
                    value={clientFilter}
                    onChange={(e) => setClientFilter(e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  >
                    <option value="">All Clients</option>
                    {clients.map((client, idx) => (
                      <option key={idx} value={client.name || client.clientName}>
                        {client.name || client.clientName}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                  <input
                    type="date"
                    value={dateFrom}
                    onChange={(e) => setDateFrom(e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                  <input
                    type="date"
                    value={dateTo}
                    onChange={(e) => setDateTo(e.target.value)}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>
              </div>

              <div className="flex flex-wrap items-center justify-between gap-4">
                <div className="flex flex-wrap items-center gap-3">
                  <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">Sort By</label>
                    <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-primary">
                      <option value="date_desc">Date (Newest)</option>
                      <option value="date_asc">Date (Oldest)</option>
                      <option value="client_asc">Client A-Z</option>
                      <option value="client_desc">Client Z-A</option>
                      <option value="type_asc">Service Type</option>
                      <option value="tech_asc">Technician</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">Status</label>
                    <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-primary">
                      <option value="">All Statuses</option>
                      <option value="submitted">Complete</option>
                      <option value="assigned">Pending</option>
                      <option value="validation_in_progress">Validation In Progress</option>
                      <option value="signature_needed">Signature Needed</option>
                    </select>
                  </div>
                </div>
                <button
                  type="submit"
                  className="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-accent transition-colors"
                >
                  Search Reports
                </button>
              </div>
            </form>
          </div>

          {/* Selection Info & Delete Button (Super Admin and Service Technicians) */}
          {canDeleteAny && deletableReports.length > 0 && (
            <div className="bg-white p-4 rounded-xl shadow-sm flex flex-wrap items-center justify-between gap-4">
              <div className="text-sm text-gray-600">
                {selectedReports.size > 0 ? (
                  <span className="font-medium text-primary">{selectedReports.size} of {deletableReports.length} deletable reports selected</span>
                ) : (
                  <span>{filteredReports.length} reports found ({deletableReports.length} deletable)</span>
                )}
              </div>
              {selectedReports.size > 0 && (
                <button
                  onClick={handleDeleteSelected}
                  disabled={deleting}
                  className="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center gap-2 text-sm disabled:opacity-50"
                >
                  {deleting ? (
                    <><div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div> Deleting...</>
                  ) : (
                    <>{Icons.trash} Delete Selected ({selectedReports.size})</>
                  )}
                </button>
              )}
            </div>
          )}

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            {loading ? (
              <div className="flex items-center justify-center py-12">
                <div className="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
              </div>
            ) : filteredReports.length > 0 ? (
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    {canDeleteAny && deletableReports.length > 0 && (
                      <th className="px-4 py-3 text-left">
                        <input
                          type="checkbox"
                          checked={selectedReports.size === deletableReports.length && deletableReports.length > 0}
                          onChange={toggleSelectAll}
                          className="rounded"
                        />
                      </th>
                    )}
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Service Type</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Technician</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ticket #</th>
                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredReports.map((report, idx) => (
                    <tr key={report.id || idx} className={`hover:bg-gray-50 ${selectedReports.has(report.id) ? 'bg-blue-50' : ''}`}>
                      {canDeleteAny && deletableReports.length > 0 && (
                        <td className="px-4 py-4">
                          {canDeleteReport(report) ? (
                            <input
                              type="checkbox"
                              checked={selectedReports.has(report.id)}
                              onChange={() => toggleSelect(report.id)}
                              className="rounded"
                            />
                          ) : (
                            <span className="text-gray-300">-</span>
                          )}
                        </td>
                      )}
                      <td className="px-6 py-4">
                        <span className={`px-2 py-1 rounded text-xs font-medium ${
                          report.status === 'assigned' ? 'bg-yellow-100 text-yellow-700' :
                          report.status === 'validation_in_progress' ? 'bg-blue-100 text-blue-700' :
                          report.status === 'signature_needed' ? 'bg-orange-100 text-orange-700' :
                          'bg-green-100 text-green-700'
                        }`}>
                          {report.status === 'assigned' ? 'Pending' : report.status === 'validation_in_progress' ? 'In Progress' : report.status === 'signature_needed' ? 'Signature Needed' : 'Complete'}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        {new Date(report.serviceCompletionDate || report.createdAt).toLocaleDateString()}
                      </td>
                      <td className="px-6 py-4">
                        <div className="text-sm font-medium text-gray-900">{report.clientFacilityName}</div>
                        <div className="text-xs text-gray-500">{report.address}</div>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">{report.serviceType}</td>
                      <td className="px-6 py-4 text-sm text-gray-900">{report.serviceProviderName || report.technicianName}</td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        {report.hubspotTicketNumber || '-'}
                      </td>
                      <td className="px-6 py-4">
                        <div className="flex items-center gap-3">
                          <button
                            onClick={() => onViewReport(report)}
                            className="text-primary hover:text-accent flex items-center gap-1"
                          >
                            {Icons.eye}
                            <span className="text-sm">View</span>
                          </button>
                          {onEditReport && currentUser && (currentUser.role === 'admin' || currentUser.isManager) && (
                            <button
                              onClick={() => onEditReport(report)}
                              className="text-amber-600 hover:text-amber-800 flex items-center gap-1"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                              <span className="text-sm">Edit</span>
                            </button>
                          )}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              const tkn = localStorage.getItem('service_token') || localStorage.getItem('token') || localStorage.getItem('unified_token');
                              fetch(`${API_URL}/api/service-reports/${report.id}/pdf`, {
                                headers: { 'Authorization': `Bearer ${tkn}` }
                              })
                              .then(resp => {
                                if (!resp.ok) throw new Error('Download failed');
                                return resp.blob();
                              })
                              .then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `Service_Report_${(report.clientFacilityName || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                a.remove();
                              })
                              .catch(err => alert('Failed to download PDF: ' + err.message));
                            }}
                            className="text-gray-500 hover:text-primary flex items-center gap-1"
                            title="Download PDF"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            <span className="text-sm">PDF</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <div className="text-center py-12 text-gray-500">
                <div className="flex justify-center mb-4">{React.cloneElement(Icons.folder, { className: 'w-12 h-12 text-gray-300' })}</div>
                <p>No service reports found</p>
                <p className="text-sm">Try adjusting your search criteria</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    // View Report Page
    const ViewReportPage = ({ report, onBack, onEdit, user }) => {
      const token = localStorage.getItem('service_token') || localStorage.getItem('token') || localStorage.getItem('unified_token');

      // Check if user can edit this report (admin or manager)
      const canEdit = user && (
        user.role === 'admin' ||
        user.isManager
      );

      const handleDownloadPDF = () => {
        fetch(`${API_URL}/api/service-reports/${report.id}/pdf`, {
          headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(resp => {
          if (!resp.ok) throw new Error('Download failed');
          return resp.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Service_Report_${(report.clientFacilityName || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
        })
        .catch(err => alert('Failed to download PDF: ' + err.message));
      };

      return (
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <button
              onClick={onBack}
              className="flex items-center gap-2 text-primary hover:text-accent"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Back to Reports
            </button>
            <div className="flex items-center gap-3">
              {canEdit && onEdit && (
                <button
                  onClick={() => onEdit(report)}
                  className="flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition font-medium text-sm shadow-sm"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                  Edit Report
                </button>
              )}
            <button
              onClick={handleDownloadPDF}
              className="flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition font-medium text-sm shadow-sm"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
              Download PDF
            </button>
            </div>
          </div>

          <div className="card-modern overflow-hidden">
            {/* Dynamic Banner Header */}
            <div className="relative" style={{minHeight: '140px'}}>
              <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-service.jpg)'}}></div>
              <div className="absolute inset-0 bg-gradient-to-r from-primary-700/90 via-primary-600/80 to-primary-500/60"></div>
              <div className="relative p-6 flex items-center justify-between min-h-[140px]">
                <div className="text-white">
                  <h1 className="text-2xl font-bold drop-shadow-sm">THRIVE 365 LABS - SERVICE REPORT</h1>
                  <p className="mt-1 text-white/80 text-sm">Report ID: {report.id}</p>
                </div>
                <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-14 bg-white rounded-xl p-2 shadow-md" />
              </div>
            </div>

            {/* Client Information */}
            <div className="p-6 border-b">
              <h2 className="text-lg font-bold text-accent mb-4">CLIENT INFORMATION</h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-gray-500">Client/Facility Name</p>
                  <p className="font-medium">{report.clientFacilityName}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Customer Name</p>
                  <p className="font-medium">{report.customerName || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Service Provider Name</p>
                  <p className="font-medium">{report.serviceProviderName}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Address</p>
                  <p className="font-medium">{report.address || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Service Completion Date</p>
                  <p className="font-medium">{report.serviceCompletionDate}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Analyzer Model</p>
                  <p className="font-medium">{report.analyzerModel || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Analyzer Serial Number (S/N)</p>
                  <p className="font-medium">{report.analyzerSerialNumber || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">HubSpot Ticket #</p>
                  <p className="font-medium">{report.hubspotTicketNumber || '-'}</p>
                </div>
              </div>
            </div>

            {/* Service Performed */}
            <div className="p-6 border-b">
              <h2 className="text-lg font-bold text-accent mb-4">SERVICE PERFORMED</h2>
              <div className="space-y-4">
                <div>
                  <p className="text-sm text-gray-500">Service Type</p>
                  <p className="font-medium">{report.serviceType}</p>
                </div>
                {report.serviceType === 'Validations' ? (
                  <>
                    {/* Date Range */}
                    <div className="grid md:grid-cols-3 gap-4">
                      <div>
                        <p className="text-sm text-gray-500">Start Date</p>
                        <p className="font-medium">{report.validationStartDate || '-'}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-500">End Date</p>
                        <p className="font-medium">{report.validationEndDate || '-'}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-500">Days On-Site</p>
                        <p className="font-medium">
                          {report.validationStartDate && report.validationEndDate
                            ? Math.ceil(Math.abs(new Date(report.validationEndDate) - new Date(report.validationStartDate)) / (1000 * 60 * 60 * 24)) + 1
                            : '-'}
                        </p>
                      </div>
                    </div>

                    {/* Analyzers Validated */}
                    {report.analyzersValidated && report.analyzersValidated.length > 0 && (
                      <div>
                        <p className="text-sm text-gray-500 mb-2">Analyzers Validated</p>
                        <div className="bg-gray-50 rounded-lg overflow-hidden">
                          <table className="w-full text-sm">
                            <thead className="bg-gray-100">
                              <tr>
                                <th className="px-3 py-2 text-left font-medium text-gray-600">Model</th>
                                <th className="px-3 py-2 text-left font-medium text-gray-600">Serial Number</th>
                                <th className="px-3 py-2 text-left font-medium text-gray-600">Status</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                              {report.analyzersValidated.map((analyzer, idx) => (
                                <tr key={idx}>
                                  <td className="px-3 py-2">{analyzer.model || '-'}</td>
                                  <td className="px-3 py-2">{analyzer.serialNumber || '-'}</td>
                                  <td className="px-3 py-2">
                                    <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                      analyzer.status === 'Passed' ? 'bg-green-100 text-green-700' :
                                      analyzer.status === 'Failed' ? 'bg-red-100 text-red-700' :
                                      'bg-yellow-100 text-yellow-700'
                                    }`}>
                                      {analyzer.status}
                                    </span>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}

                    {/* Test Procedures */}
                    <div>
                      <p className="text-sm text-gray-500">Test Procedures</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.testProcedures || '-'}</p>
                    </div>

                    {/* Training Provided */}
                    <div>
                      <p className="text-sm text-gray-500">Training Provided</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.trainingProvided || '-'}</p>
                    </div>

                    {/* Validation Results */}
                    <div>
                      <p className="text-sm text-gray-500">Validation Results</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.validationResults || '-'}</p>
                    </div>

                    {/* Validation Report File */}
                    {report.validationReportFileName && (
                      <div>
                        <p className="text-sm text-gray-500">Validation Report File</p>
                        <div className="flex items-center gap-2 mt-1">
                          <svg className="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          {report.validationReportFile ? (
                            <a href={report.validationReportFile} download={report.validationReportFileName} className="text-primary hover:underline font-medium">
                              {report.validationReportFileName}
                            </a>
                          ) : (
                            <span className="font-medium">{report.validationReportFileName}</span>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Recommendations */}
                    <div>
                      <p className="text-sm text-gray-500">Recommendations</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.recommendations || '-'}</p>
                    </div>
                  </>
                ) : (
                  <>
                    <div>
                      <p className="text-sm text-gray-500">Description of Work Performed</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.descriptionOfWork}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Materials Used</p>
                      <p className="font-medium">{report.materialsUsed || '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Solution</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.solution || '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Final Recommendations</p>
                      <p className="font-medium whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{report.outstandingIssues || '-'}</p>
                    </div>
                  </>
                )}
              </div>
            </div>

            {/* Assignment Info - if this was an assigned report */}
            {report.assignedById && (
              <div className="p-6 border-b bg-blue-50/30">
                <h2 className="text-lg font-bold text-accent mb-4">ASSIGNMENT DETAILS</h2>
                <div className="grid md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <p className="text-sm text-gray-500">Assigned By</p>
                    <p className="font-medium">{report.assignedByName || '-'}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">Assigned On</p>
                    <p className="font-medium">{report.assignedAt ? new Date(report.assignedAt).toLocaleDateString() : '-'}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">Assigned To</p>
                    <p className="font-medium">{report.assignedToName || '-'}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">Status</p>
                    <p className="font-medium">
                      <span className={`px-2 py-1 rounded text-xs font-medium ${
                        report.status === 'assigned' ? 'bg-yellow-100 text-yellow-700' :
                        report.status === 'signature_needed' ? 'bg-orange-100 text-orange-700' :
                        report.status === 'submitted' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                      }`}>
                        {report.status === 'assigned' ? 'Pending' : report.status === 'signature_needed' ? 'Signature Needed' : report.status === 'submitted' ? 'Complete' : report.status}
                      </span>
                    </p>
                  </div>
                </div>

                {/* Manager Notes */}
                {report.managerNotes && (
                  <div className="mt-4 p-4 bg-blue-100/50 border border-blue-200 rounded-lg">
                    <h3 className="font-semibold text-blue-800 mb-2 text-sm">Manager Notes</h3>
                    <p className="text-sm text-blue-900 whitespace-pre-wrap">{report.managerNotes}</p>
                  </div>
                )}
              </div>
            )}

            {/* Reference Photos & Files */}
            {((report.photos && report.photos.length > 0) || (report.clientFiles && report.clientFiles.length > 0)) && (
              <div className="p-6 border-b">
                <h2 className="text-lg font-bold text-accent mb-4">ATTACHMENTS</h2>

                {/* Photos */}
                {report.photos && report.photos.length > 0 && (
                  <div className="mb-4">
                    <p className="text-sm text-gray-500 mb-2">Reference Photos</p>
                    <div className="flex flex-wrap gap-3">
                      {report.photos.map((photo, idx) => (
                        <div key={photo.id || idx} className="group">
                          {photo.url || photo.driveFileId ? (
                            <React.Fragment>
                              <a href={photo.webViewLink || getDownloadUrl(photo)} target="_blank" rel="noopener noreferrer" className="block">
                                <img src={getPhotoSrc(photo)} alt={photo.name || 'Reference photo'} className="w-24 h-24 object-cover rounded-lg border border-gray-200 group-hover:border-primary-500 transition shadow-sm" />
                              </a>
                              {photo.name && <p className="text-xs text-gray-500 mt-1 truncate w-24">{photo.name}</p>}
                              <a href={getDownloadUrl(photo)} download={photo.name} className="text-xs text-primary hover:text-accent mt-1 flex items-center gap-1">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Download
                              </a>
                            </React.Fragment>
                          ) : (
                            <div className="w-24 h-24 flex items-center justify-center rounded-lg border border-red-200 bg-red-50">
                              <p className="text-xs text-red-400 text-center px-1">File unavailable</p>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Files */}
                {report.clientFiles && report.clientFiles.length > 0 && (
                  <div>
                    <p className="text-sm text-gray-500 mb-2">Client Files</p>
                    <div className="space-y-2">
                      {report.clientFiles.map((file, idx) => (
                        <a key={file.id || idx} href={getDownloadUrl(file)} download={file.name} target="_blank" rel="noopener noreferrer"
                          className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border hover:bg-gray-100 hover:border-primary-300 transition">
                          <div className="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="font-medium text-gray-900 truncate">{file.name}</p>
                            {file.uploadedAt && <p className="text-xs text-gray-500">Uploaded {new Date(file.uploadedAt).toLocaleDateString()}</p>}
                          </div>
                          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                        </a>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Technician Attachments */}
            {((report.technicianPhotos && report.technicianPhotos.length > 0) || (report.technicianFiles && report.technicianFiles.length > 0)) && (
              <div className="p-6 border-b">
                <h2 className="text-lg font-bold text-accent mb-4">TECHNICIAN ATTACHMENTS</h2>

                {/* Technician Photos */}
                {report.technicianPhotos && report.technicianPhotos.length > 0 && (
                  <div className="mb-4">
                    <p className="text-sm text-gray-500 mb-2">Technician Photos</p>
                    <div className="flex flex-wrap gap-3">
                      {report.technicianPhotos.map((photo, idx) => (
                        <div key={photo.id || idx} className="group">
                          {photo.url || photo.driveFileId ? (
                            <React.Fragment>
                              <a href={photo.webViewLink || getDownloadUrl(photo)} target="_blank" rel="noopener noreferrer" className="block">
                                <img src={getPhotoSrc(photo)} alt={photo.name || 'Technician photo'} className="w-24 h-24 object-cover rounded-lg border border-gray-200 group-hover:border-primary-500 transition shadow-sm" />
                              </a>
                              {photo.name && <p className="text-xs text-gray-500 mt-1 truncate w-24">{photo.name}</p>}
                              <a href={getDownloadUrl(photo)} download={photo.name} className="text-xs text-primary hover:text-accent mt-1 flex items-center gap-1">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Download
                              </a>
                            </React.Fragment>
                          ) : (
                            <div className="w-24 h-24 flex items-center justify-center rounded-lg border border-red-200 bg-red-50">
                              <p className="text-xs text-red-400 text-center px-1">File unavailable</p>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Technician Files */}
                {report.technicianFiles && report.technicianFiles.length > 0 && (
                  <div>
                    <p className="text-sm text-gray-500 mb-2">Technician Files</p>
                    <div className="space-y-2">
                      {report.technicianFiles.map((file, idx) => (
                        <a key={file.id || idx} href={getDownloadUrl(file)} download={file.name} target="_blank" rel="noopener noreferrer"
                          className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border hover:bg-gray-100 hover:border-primary-300 transition">
                          <div className="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="font-medium text-gray-900 truncate">{file.name}</p>
                            {file.uploadedAt && <p className="text-xs text-gray-500">Uploaded {new Date(file.uploadedAt).toLocaleDateString()}</p>}
                          </div>
                          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                        </a>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Signatures */}
            <div className="p-6">
              <h2 className="text-lg font-bold text-accent mb-4">SIGNATURES</h2>
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <p className="text-sm text-gray-500 mb-2">Customer Signature</p>
                  {report.customerSignature ? (
                    <div className="border rounded-lg p-2 bg-gray-50">
                      <img src={report.customerSignature} alt="Customer Signature" className="max-h-24" />
                    </div>
                  ) : (
                    <p className="text-gray-400 italic">No signature</p>
                  )}
                  {(report.customerFirstName || report.customerLastName) && (
                    <p className="text-sm text-gray-700 mt-2 font-medium">{report.customerFirstName} {report.customerLastName}</p>
                  )}
                  <p className="text-sm text-gray-500 mt-1">Date: {report.customerSignatureDate || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500 mb-2">Technician Signature</p>
                  {report.technicianSignature ? (
                    <div className="border rounded-lg p-2 bg-gray-50">
                      <img src={report.technicianSignature} alt="Technician Signature" className="max-h-24" />
                    </div>
                  ) : (
                    <p className="text-gray-400 italic">No signature</p>
                  )}
                  {(report.technicianFirstName || report.technicianLastName) && (
                    <p className="text-sm text-gray-700 mt-2 font-medium">{report.technicianFirstName} {report.technicianLastName}</p>
                  )}
                  <p className="text-sm text-gray-500 mt-1">Date: {report.technicianSignatureDate || '-'}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Edit Report Page - allows admins/managers to edit submitted reports
    const EditReportPage = ({ token, user, report, onSuccess, onCancel }) => {
      const [saving, setSaving] = useState(false);
      const [uploadingPhotos, setUploadingPhotos] = useState(false);
      const [uploadingFiles, setUploadingFiles] = useState(false);
      const [photos, setPhotos] = useState(report.photos || []);
      const [clientFiles, setClientFiles] = useState(report.clientFiles || []);

      const [formData, setFormData] = useState({
        clientFacilityName: report.clientFacilityName || '',
        customerName: report.customerName || '',
        serviceProviderName: report.serviceProviderName || '',
        address: report.address || '',
        serviceCompletionDate: report.serviceCompletionDate || '',
        analyzerModel: report.analyzerModel || '',
        analyzerSerialNumber: report.analyzerSerialNumber || '',
        serviceType: report.serviceType || '',
        descriptionOfWork: report.descriptionOfWork || '',
        materialsUsed: report.materialsUsed || '',
        solution: report.solution || '',
        outstandingIssues: report.outstandingIssues || '',
        recommendations: report.recommendations || '',
        validationResults: report.validationResults || '',
        validationStartDate: report.validationStartDate || '',
        validationEndDate: report.validationEndDate || '',
        trainingProvided: report.trainingProvided || '',
        testProcedures: report.testProcedures || '',
        customerFirstName: report.customerFirstName || '',
        customerLastName: report.customerLastName || '',
        technicianFirstName: report.technicianFirstName || '',
        technicianLastName: report.technicianLastName || '',
        customerSignatureDate: report.customerSignatureDate || '',
        technicianSignatureDate: report.technicianSignatureDate || ''
      });

      const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));

      const handleSave = async () => {
        setSaving(true);
        try {
          const result = await api.updateServiceReport(token, report.id, formData);
          if (result.error) {
            alert('Error saving: ' + result.error);
          } else {
            alert('Report updated successfully!');
            onSuccess();
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
        setSaving(false);
      };

      const handleUploadPhotos = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        setUploadingPhotos(true);
        try {
          const result = await api.uploadServiceReportPhotos(token, report.id, files);
          if (result.error) {
            alert('Upload error: ' + result.error);
          } else {
            setPhotos(result.photos || []);
          }
        } catch (err) {
          alert('Upload failed: ' + err.message);
        }
        setUploadingPhotos(false);
        e.target.value = '';
      };

      const handleDeletePhoto = async (photoId) => {
        if (!confirm('Delete this photo?')) return;
        const result = await api.deleteServiceReportPhoto(token, report.id, photoId);
        if (result.error) {
          alert('Delete error: ' + result.error);
        } else {
          setPhotos(prev => prev.filter(p => p.id !== photoId));
        }
      };

      const handleUploadFiles = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        setUploadingFiles(true);
        try {
          const result = await api.uploadServiceReportFiles(token, report.id, files);
          if (result.error) {
            alert('Upload error: ' + result.error);
          } else {
            setClientFiles(result.clientFiles || []);
          }
        } catch (err) {
          alert('Upload failed: ' + err.message);
        }
        setUploadingFiles(false);
        e.target.value = '';
      };

      const handleDeleteFile = async (fileId) => {
        if (!confirm('Delete this file?')) return;
        const result = await api.deleteServiceReportFile(token, report.id, fileId);
        if (result.error) {
          alert('Delete error: ' + result.error);
        } else {
          setClientFiles(prev => prev.filter(f => f.id !== fileId));
        }
      };

      const serviceTypes = ['Analyzer Hardware', 'Inventory', 'LIS/EMR', 'Compliance', 'Training', 'Validations'];
      const isValidation = formData.serviceType === 'Validations';

      return (
        <div className="space-y-6 animate-fade-in">
          {/* Header */}
          <div className="flex items-center justify-between">
            <button onClick={onCancel} className="flex items-center gap-2 text-primary hover:text-accent">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
              Cancel
            </button>
            <h2 className="text-lg font-bold text-gray-900">Edit Service Report</h2>
            <button onClick={handleSave} disabled={saving} className="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 font-medium text-sm shadow-sm">
              {saving ? 'Saving...' : 'Save Changes'}
            </button>
          </div>

          <div className="card-modern p-6 space-y-6">
            {/* Client Information */}
            <div>
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">1</span>
                Client Information
              </h3>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client Facility Name</label>
                  <input type="text" value={formData.clientFacilityName} onChange={e => handleChange('clientFacilityName', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                  <input type="text" value={formData.customerName} onChange={e => handleChange('customerName', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Provider</label>
                  <input type="text" value={formData.serviceProviderName} onChange={e => handleChange('serviceProviderName', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                  <input type="text" value={formData.address} onChange={e => handleChange('address', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Model</label>
                  <input type="text" value={formData.analyzerModel} onChange={e => handleChange('analyzerModel', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                  <input type="text" value={formData.analyzerSerialNumber} onChange={e => handleChange('analyzerSerialNumber', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Completion Date</label>
                  <input type="date" value={formData.serviceCompletionDate} onChange={e => handleChange('serviceCompletionDate', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Type</label>
                  <select value={formData.serviceType} onChange={e => handleChange('serviceType', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm">
                    <option value="">Select type...</option>
                    {serviceTypes.map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                </div>
              </div>
            </div>

            {/* Service Details */}
            <div>
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">2</span>
                Service Details
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Description of Work</label>
                  <textarea value={formData.descriptionOfWork} onChange={e => handleChange('descriptionOfWork', e.target.value)} rows={4} className="w-full border rounded-lg px-3 py-2 text-sm" />
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Materials Used</label>
                    <textarea value={formData.materialsUsed} onChange={e => handleChange('materialsUsed', e.target.value)} rows={3} className="w-full border rounded-lg px-3 py-2 text-sm" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Solution</label>
                    <textarea value={formData.solution} onChange={e => handleChange('solution', e.target.value)} rows={3} className="w-full border rounded-lg px-3 py-2 text-sm" />
                  </div>
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Outstanding Issues</label>
                    <textarea value={formData.outstandingIssues} onChange={e => handleChange('outstandingIssues', e.target.value)} rows={3} className="w-full border rounded-lg px-3 py-2 text-sm" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Recommendations</label>
                    <textarea value={formData.recommendations} onChange={e => handleChange('recommendations', e.target.value)} rows={3} className="w-full border rounded-lg px-3 py-2 text-sm" />
                  </div>
                </div>
              </div>
            </div>

            {/* Validation Fields (conditional) */}
            {isValidation && (
              <div>
                <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <span className="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 text-sm">V</span>
                  Validation Details
                </h3>
                <div className="space-y-4">
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Validation Start Date</label>
                      <input type="date" value={formData.validationStartDate} onChange={e => handleChange('validationStartDate', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Validation End Date</label>
                      <input type="date" value={formData.validationEndDate} onChange={e => handleChange('validationEndDate', e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Validation Results</label>
                    <textarea value={formData.validationResults} onChange={e => handleChange('validationResults', e.target.value)} rows={3} className="w-full border rounded-lg px-3 py-2 text-sm" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Training Provided</label>
                    <textarea value={formData.trainingProvided} onChange={e => handleChange('trainingProvided', e.target.value)} rows={3} className="w-full border rounded-lg px-3 py-2 text-sm" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Test Procedures</label>
                    <textarea value={formData.testProcedures} onChange={e => handleChange('testProcedures', e.target.value)} rows={3} className="w-full border rounded-lg px-3 py-2 text-sm" />
                  </div>
                </div>
              </div>
            )}

            {/* Signer Names */}
            <div>
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">3</span>
                Signature Names
              </h3>
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <p className="text-sm font-medium text-gray-600 mb-2">Customer</p>
                  <div className="grid grid-cols-2 gap-3">
                    <input type="text" placeholder="First name" value={formData.customerFirstName} onChange={e => handleChange('customerFirstName', e.target.value)} className="border rounded-lg px-3 py-2 text-sm" />
                    <input type="text" placeholder="Last name" value={formData.customerLastName} onChange={e => handleChange('customerLastName', e.target.value)} className="border rounded-lg px-3 py-2 text-sm" />
                  </div>
                </div>
                <div>
                  <p className="text-sm font-medium text-gray-600 mb-2">Technician</p>
                  <div className="grid grid-cols-2 gap-3">
                    <input type="text" placeholder="First name" value={formData.technicianFirstName} onChange={e => handleChange('technicianFirstName', e.target.value)} className="border rounded-lg px-3 py-2 text-sm" />
                    <input type="text" placeholder="Last name" value={formData.technicianLastName} onChange={e => handleChange('technicianLastName', e.target.value)} className="border rounded-lg px-3 py-2 text-sm" />
                  </div>
                </div>
              </div>
            </div>

            {/* Photos */}
            <div>
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">4</span>
                Reference Photos
              </h3>
              <div className="flex flex-wrap gap-3 mb-4">
                {photos.map((photo, idx) => (
                  <div key={photo.id || idx} className="relative group">
                    {photo.url || photo.driveFileId ? (
                      <img src={getPhotoSrc(photo)} alt={photo.name || 'Photo'} className="w-24 h-24 object-cover rounded-lg border" />
                    ) : (
                      <div className="w-24 h-24 flex items-center justify-center rounded-lg border border-red-200 bg-red-50">
                        <p className="text-xs text-red-400 text-center px-1">Unavailable</p>
                      </div>
                    )}
                    <button onClick={() => handleDeletePhoto(photo.id)} className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow-sm" title="Delete photo">X</button>
                    {photo.name && <p className="text-xs text-gray-500 mt-1 truncate w-24">{photo.name}</p>}
                  </div>
                ))}
                {photos.length === 0 && <p className="text-sm text-gray-400 italic">No photos attached</p>}
              </div>
              <label className="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 cursor-pointer transition text-sm font-medium">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                {uploadingPhotos ? 'Uploading...' : 'Add Photos'}
                <input type="file" multiple accept="image/*" onChange={handleUploadPhotos} className="hidden" disabled={uploadingPhotos} />
              </label>
            </div>

            {/* Client Files */}
            <div>
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">5</span>
                Client Files
              </h3>
              <div className="space-y-2 mb-4">
                {clientFiles.map((file, idx) => (
                  <div key={file.id || idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                    <div className="flex items-center gap-3 min-w-0">
                      <svg className="w-5 h-5 text-primary-600 flex-shrink-0" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                      <span className="text-sm font-medium text-gray-900 truncate">{file.name}</span>
                    </div>
                    <button onClick={() => handleDeleteFile(file.id)} className="text-red-500 hover:text-red-700 text-sm font-medium flex-shrink-0 ml-2">Delete</button>
                  </div>
                ))}
                {clientFiles.length === 0 && <p className="text-sm text-gray-400 italic">No files attached</p>}
              </div>
              <label className="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 cursor-pointer transition text-sm font-medium">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                {uploadingFiles ? 'Uploading...' : 'Add Files'}
                <input type="file" multiple onChange={handleUploadFiles} className="hidden" disabled={uploadingFiles} />
              </label>
            </div>
          </div>

          {/* Bottom Save Button */}
          <div className="flex justify-end gap-3">
            <button onClick={onCancel} className="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-sm">Cancel</button>
            <button onClick={handleSave} disabled={saving} className="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 font-medium text-sm shadow-sm">
              {saving ? 'Saving...' : 'Save Changes'}
            </button>
          </div>
        </div>
      );
    };

    // Assigned Reports Page - Shows reports assigned to the current vendor/technician
    const AssignedReportsPage = ({ assignedReports, onEditAssignment, onBack }) => {
      return (
        <div className="space-y-6 animate-fade-in">
          {/* Header */}
          <div className="relative rounded-2xl overflow-hidden shadow-lg" style={{minHeight: '140px'}}>
            <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: 'url(/banners/banner-service.jpg)'}}></div>
            <div className="absolute inset-0 bg-gradient-to-r from-red-700/90 via-red-600/70 to-transparent"></div>
            <div className="relative p-6 flex items-center min-h-[140px]">
              <div className="text-white">
                <h1 className="text-2xl font-bold drop-shadow-sm">Assigned Service Reports</h1>
                <p className="mt-1 text-white/80 text-sm">Complete your assigned service visits</p>
              </div>
            </div>
          </div>

          {/* Summary Stats */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="card-modern p-5 border-l-4 border-red-500">
              <p className="text-sm text-gray-500">Pending</p>
              <p className="text-2xl font-bold text-red-600">{assignedReports.length}</p>
            </div>
          </div>

          {/* Assigned Reports List */}
          <div className="card-modern">
            <div className="p-6 border-b">
              <h2 className="text-lg font-bold text-gray-900">Your Assigned Service Visits</h2>
              <p className="text-sm text-gray-500 mt-1">Click on a report to complete and submit</p>
            </div>

            {assignedReports.length > 0 ? (
              <div className="divide-y">
                {assignedReports.map(report => (
                  <div key={report.id} className="p-6 hover:bg-gray-50 transition">
                    <div className="flex items-center justify-between flex-wrap gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/></svg>
                          </div>
                          <div>
                            <h3 className="font-semibold text-gray-900">{report.clientFacilityName}</h3>
                            <p className="text-sm text-gray-500">{report.customerName || 'No customer name'}</p>
                          </div>
                        </div>

                        <div className="mt-3 flex flex-wrap items-center gap-2">
                          {report.serviceType && (
                            <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">
                              {report.serviceType}
                            </span>
                          )}
                          {report.serviceCompletionDate && (
                            <span className="text-xs text-gray-500">
                              Due: {new Date(report.serviceCompletionDate).toLocaleDateString()}
                            </span>
                          )}
                          <span className="px-2 py-1 bg-warning-50 text-warning-600 rounded text-xs font-medium">
                            Pending
                          </span>
                        </div>

                        {report.managerNotes && (
                          <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <p className="text-xs font-medium text-blue-800 mb-1">Manager Notes:</p>
                            <p className="text-sm text-blue-900">{report.managerNotes}</p>
                          </div>
                        )}

                        <div className="mt-2 text-xs text-gray-400">
                          Assigned by {report.assignedByName} on {new Date(report.assignedAt).toLocaleDateString()}
                        </div>

                        {/* Show photos/files count if any */}
                        <div className="mt-2 flex items-center gap-4 text-xs text-gray-500">
                          {report.photos && report.photos.length > 0 && (
                            <span className="flex items-center gap-1">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
                              {report.photos.length} photo{report.photos.length > 1 ? 's' : ''}
                            </span>
                          )}
                          {report.clientFiles && report.clientFiles.length > 0 && (
                            <span className="flex items-center gap-1">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                              {report.clientFiles.length} file{report.clientFiles.length > 1 ? 's' : ''}
                            </span>
                          )}
                        </div>
                      </div>

                      <button
                        onClick={() => onEditAssignment(report)}
                        className="px-5 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg>
                        Complete Report
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>
                </div>
                <h3 className="text-lg font-semibold text-gray-900">All caught up!</h3>
                <p className="text-gray-500 mt-1">You have no pending service visits to complete.</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Complete Assignment Page - For technicians to complete assigned service reports
    const CompleteAssignmentPage = ({ token, user, assignment, onSuccess, onCancel }) => {
      const [formData, setFormData] = useState({
        descriptionOfWork: '',
        materialsUsed: '',
        solution: '',
        outstandingIssues: '',
        validationResults: '',
        validationStartDate: '',
        validationEndDate: '',
        trainingProvided: '',
        testProcedures: '',
        recommendations: '',
        analyzersValidated: [],
        serviceCompletionDate: assignment.serviceCompletionDate || new Date().toISOString().split('T')[0],
        analyzerSerialNumber: assignment.analyzerSerialNumber || ''
      });
      const [customerSignature, setCustomerSignature] = useState(null);
      const [technicianSignature, setTechnicianSignature] = useState(null);
      const [customerFirstName, setCustomerFirstName] = useState('');
      const [customerLastName, setCustomerLastName] = useState('');
      const [technicianFirstName, setTechnicianFirstName] = useState(user?.name?.split(' ')[0] || '');
      const [technicianLastName, setTechnicianLastName] = useState(user?.name?.split(' ').slice(1).join(' ') || '');
      const [submitting, setSubmitting] = useState(false);

      // Technician file upload state
      const [techPhotos, setTechPhotos] = useState([]);
      const [techFiles, setTechFiles] = useState([]);
      const [techPhotoPreviewUrls, setTechPhotoPreviewUrls] = useState([]);
      const [techFileNames, setTechFileNames] = useState([]);
      const techPhotoInputRef = useRef(null);
      const techFileInputRef = useRef(null);

      const serviceTypes = ['Analyzer Hardware', 'Inventory', 'LIS/EMR', 'Compliance', 'Training', 'Validations'];
      const isValidation = assignment.serviceType === 'Validations';

      const handleTechPhotoSelect = (e) => {
        const selectedFiles = Array.from(e.target.files);
        setTechPhotos(prev => [...prev, ...selectedFiles]);
        const newUrls = selectedFiles.map(file => URL.createObjectURL(file));
        setTechPhotoPreviewUrls(prev => [...prev, ...newUrls]);
      };

      const handleTechFileSelect = (e) => {
        const selectedFiles = Array.from(e.target.files);
        setTechFiles(prev => [...prev, ...selectedFiles]);
        setTechFileNames(prev => [...prev, ...selectedFiles.map(f => f.name)]);
      };

      const removeTechPhoto = (idx) => {
        URL.revokeObjectURL(techPhotoPreviewUrls[idx]);
        setTechPhotos(prev => prev.filter((_, i) => i !== idx));
        setTechPhotoPreviewUrls(prev => prev.filter((_, i) => i !== idx));
      };

      const removeTechFile = (idx) => {
        setTechFiles(prev => prev.filter((_, i) => i !== idx));
        setTechFileNames(prev => prev.filter((_, i) => i !== idx));
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.descriptionOfWork) {
          alert('Please fill in the description of work');
          return;
        }
        setSubmitting(true);
        try {
          const reportData = {
            ...formData,
            customerSignature,
            customerSignatureDate: customerSignature ? new Date().toISOString().split('T')[0] : null,
            customerFirstName,
            customerLastName,
            technicianSignature,
            technicianSignatureDate: technicianSignature ? new Date().toISOString().split('T')[0] : null,
            technicianFirstName,
            technicianLastName
          };

          // Upload technician photos if any
          if (techPhotos.length > 0) {
            const photoResult = await api.uploadTechnicianPhotos(token, assignment.id, techPhotos);
            if (photoResult.error) {
              console.error('Photo upload error:', photoResult.error);
            }
          }

          // Upload technician files if any
          if (techFiles.length > 0) {
            const fileResult = await api.uploadTechnicianFiles(token, assignment.id, techFiles);
            if (fileResult.error) {
              console.error('File upload error:', fileResult.error);
            }
          }

          const result = await api.completeAssignedReport(token, assignment.id, reportData);
          if (result.error) {
            alert('Error: ' + result.error);
          } else {
            alert('Service report submitted successfully!');
            onSuccess();
          }
        } catch (err) {
          alert('Error submitting report: ' + err.message);
        }
        setSubmitting(false);
      };

      return (
        <div className="space-y-6 animate-fade-in">
          {/* Header */}
          <div className="flex items-center justify-between">
            <button onClick={onCancel} className="flex items-center gap-2 text-gray-600 hover:text-primary-500">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
              Back
            </button>
          </div>

          <div className="card-modern overflow-hidden">
            <div className="bg-gradient-to-r from-red-600 to-red-700 text-white p-6">
              <div className="flex items-center gap-3 mb-2">
                <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/></svg>
                </div>
                <div>
                  <h1 className="text-2xl font-bold">Complete Service Report</h1>
                  <p className="opacity-90">Assigned by {assignment.assignedByName}</p>
                </div>
              </div>
            </div>

            {/* Pre-filled Assignment Info (Read-only) */}
            <div className="p-6 bg-gray-50 border-b">
              <h2 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">1</span>
                Assignment Details (Read-only)
              </h2>
              <div className="grid md:grid-cols-2 gap-4 text-sm">
                <div><span className="text-gray-500">Client:</span> <span className="font-medium">{assignment.clientFacilityName}</span></div>
                <div><span className="text-gray-500">Customer:</span> <span className="font-medium">{assignment.customerName || '-'}</span></div>
                <div><span className="text-gray-500">Address:</span> <span className="font-medium">{assignment.address || '-'}</span></div>
                <div><span className="text-gray-500">Service Type:</span> <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">{assignment.serviceType || '-'}</span></div>
                <div><span className="text-gray-500">Analyzer:</span> <span className="font-medium">{assignment.analyzerModel || '-'} {assignment.analyzerSerialNumber ? `(S/N: ${assignment.analyzerSerialNumber})` : ''}</span></div>
                <div><span className="text-gray-500">Ticket #:</span> <span className="font-medium">{assignment.hubspotTicketNumber || '-'}</span></div>
              </div>

              {/* Manager Notes */}
              {assignment.managerNotes && (
                <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <h3 className="font-semibold text-blue-800 mb-2 text-sm">Manager Notes</h3>
                  <p className="text-sm text-blue-900 whitespace-pre-wrap">{assignment.managerNotes}</p>
                </div>
              )}

              {/* Photos */}
              {assignment.photos && assignment.photos.length > 0 && (
                <div className="mt-4">
                  <h3 className="font-semibold text-gray-700 mb-2 text-sm">Reference Photos</h3>
                  <div className="flex flex-wrap gap-3">
                    {assignment.photos.map((photo, idx) => (
                      <div key={photo.id || idx} className="inline-block">
                        {photo.url || photo.driveFileId ? (
                          <React.Fragment>
                            <a href={photo.webViewLink || getDownloadUrl(photo)} target="_blank" rel="noopener noreferrer" className="block">
                              <img src={getPhotoSrc(photo)} alt={photo.name} className="w-20 h-20 object-cover rounded-lg border hover:opacity-80 transition" />
                            </a>
                            <a href={getDownloadUrl(photo)} download={photo.name} className="text-xs text-primary hover:text-accent mt-1 flex items-center gap-1">
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                              Download
                            </a>
                          </React.Fragment>
                        ) : (
                          <div className="w-20 h-20 flex items-center justify-center rounded-lg border border-red-200 bg-red-50">
                            <p className="text-xs text-red-400 text-center px-1">Unavailable</p>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Client Files */}
              {assignment.clientFiles && assignment.clientFiles.length > 0 && (
                <div className="mt-4">
                  <h3 className="font-semibold text-gray-700 mb-2 text-sm">Client Files</h3>
                  <div className="space-y-2">
                    {assignment.clientFiles.map((file, idx) => (
                      <a key={file.id || idx} href={getDownloadUrl(file)} download={file.name} target="_blank" rel="noopener noreferrer"
                        className="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50 transition text-sm">
                        {Icons.folder}
                        <span className="text-primary-500 hover:underline">{file.name}</span>
                      </a>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Technician Form */}
            <form onSubmit={handleSubmit} className="p-6 space-y-6">
              <h2 className="font-bold text-gray-900 flex items-center gap-2">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">2</span>
                Your Service Details
              </h2>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Date *</label>
                  <input type="date" value={formData.serviceCompletionDate} onChange={(e) => setFormData({...formData, serviceCompletionDate: e.target.value})}
                    className="input-modern w-full px-4 py-3" required />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Serial Number (S/N)</label>
                  <input type="text" value={formData.analyzerSerialNumber} onChange={(e) => setFormData({...formData, analyzerSerialNumber: e.target.value})}
                    className="input-modern w-full px-4 py-3" placeholder="e.g., 601744124" />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Description of Work Performed *</label>
                <textarea value={formData.descriptionOfWork} onChange={(e) => setFormData({...formData, descriptionOfWork: e.target.value})}
                  rows={4} className="input-modern w-full px-4 py-3" placeholder="Describe the work performed during this service visit..." required />
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Materials Used</label>
                  <textarea value={formData.materialsUsed} onChange={(e) => setFormData({...formData, materialsUsed: e.target.value})}
                    rows={3} className="input-modern w-full px-4 py-3" placeholder="List materials, parts, or supplies used..." />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Solution Provided</label>
                  <textarea value={formData.solution} onChange={(e) => setFormData({...formData, solution: e.target.value})}
                    rows={3} className="input-modern w-full px-4 py-3" placeholder="Describe the solution or fix implemented..." />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Outstanding Issues / Recommendations</label>
                <textarea value={formData.outstandingIssues} onChange={(e) => setFormData({...formData, outstandingIssues: e.target.value})}
                  rows={3} className="input-modern w-full px-4 py-3" placeholder="Note any issues that need follow-up or recommendations for the client..." />
              </div>

              {/* Validation-specific fields */}
              {isValidation && (
                <div className="border-t pt-6">
                  <h3 className="font-semibold text-gray-900 mb-4">Validation Details</h3>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Validation Start Date</label>
                      <input type="date" value={formData.validationStartDate} onChange={(e) => setFormData({...formData, validationStartDate: e.target.value})}
                        className="input-modern w-full px-4 py-3" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Validation End Date</label>
                      <input type="date" value={formData.validationEndDate} onChange={(e) => setFormData({...formData, validationEndDate: e.target.value})}
                        className="input-modern w-full px-4 py-3" />
                    </div>
                  </div>
                  <div className="mt-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Test Procedures *</label>
                    <textarea value={formData.testProcedures} onChange={(e) => setFormData({...formData, testProcedures: e.target.value})}
                      rows={3} className="input-modern w-full px-4 py-3" placeholder="Describe the test procedures used (e.g., precision, accuracy, linearity, reportable range, reference interval verification)..." required />
                  </div>
                  <div className="mt-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Training Provided</label>
                    <textarea value={formData.trainingProvided} onChange={(e) => setFormData({...formData, trainingProvided: e.target.value})}
                      rows={2} className="input-modern w-full px-4 py-3" placeholder="Describe any training provided to staff..." />
                  </div>
                  <div className="mt-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Validation Results *</label>
                    <textarea value={formData.validationResults} onChange={(e) => setFormData({...formData, validationResults: e.target.value})}
                      rows={3} className="input-modern w-full px-4 py-3" placeholder="Describe validation results..." required />
                  </div>
                </div>
              )}

              {/* Attachments - Photos & Files */}
              <div className="border-t pt-6">
                <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-1">
                  <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">3</span>
                  Attachments
                </h2>
                <p className="text-sm text-gray-500 mb-4 ml-8">Upload photos or files from the service visit</p>

                <div className="grid md:grid-cols-2 gap-6">
                  {/* Photos */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                    <input
                      ref={techPhotoInputRef}
                      type="file"
                      accept="image/*"
                      multiple
                      onChange={handleTechPhotoSelect}
                      className="hidden"
                    />
                    <button
                      type="button"
                      onClick={() => techPhotoInputRef.current?.click()}
                      className="w-full border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-primary-400 hover:bg-primary-50/50 transition cursor-pointer"
                    >
                      <svg className="w-8 h-8 mx-auto text-gray-400 mb-1" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/></svg>
                      <p className="text-sm text-gray-500">Click to add photos</p>
                    </button>
                    {techPhotoPreviewUrls.length > 0 && (
                      <div className="flex flex-wrap gap-2 mt-3">
                        {techPhotoPreviewUrls.map((url, idx) => (
                          <div key={idx} className="relative group">
                            <img src={url} alt={`Photo ${idx + 1}`} className="w-16 h-16 object-cover rounded-lg border" />
                            <button type="button" onClick={() => removeTechPhoto(idx)}
                              className="absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                              &times;
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Files */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Files</label>
                    <input
                      ref={techFileInputRef}
                      type="file"
                      multiple
                      onChange={handleTechFileSelect}
                      className="hidden"
                    />
                    <button
                      type="button"
                      onClick={() => techFileInputRef.current?.click()}
                      className="w-full border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-primary-400 hover:bg-primary-50/50 transition cursor-pointer"
                    >
                      <svg className="w-8 h-8 mx-auto text-gray-400 mb-1" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                      <p className="text-sm text-gray-500">Click to add files</p>
                    </button>
                    {techFileNames.length > 0 && (
                      <div className="space-y-1.5 mt-3">
                        {techFileNames.map((name, idx) => (
                          <div key={idx} className="flex items-center gap-2 p-2 bg-gray-50 rounded-lg border text-sm group">
                            <svg className="w-4 h-4 text-primary-500 flex-shrink-0" fill="none" stroke="currentColor" strokeWidth="1.75" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                            <span className="flex-1 truncate text-gray-700">{name}</span>
                            <button type="button" onClick={() => removeTechFile(idx)}
                              className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Signatures */}
              <div className="border-t pt-6">
                <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-4">
                  <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">4</span>
                  Signatures
                </h2>
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <SignaturePad label="Customer Signature" onSave={setCustomerSignature} />
                    <div className="grid grid-cols-2 gap-3 mt-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" value={customerFirstName} onChange={(e) => setCustomerFirstName(e.target.value)}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="First name" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" value={customerLastName} onChange={(e) => setCustomerLastName(e.target.value)}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Last name" />
                      </div>
                    </div>
                  </div>
                  <div>
                    <SignaturePad label="Technician Signature" onSave={setTechnicianSignature} />
                    <div className="grid grid-cols-2 gap-3 mt-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" value={technicianFirstName} onChange={(e) => setTechnicianFirstName(e.target.value)}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="First name" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" value={technicianLastName} onChange={(e) => setTechnicianLastName(e.target.value)}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Last name" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div className="flex justify-end gap-3 pt-4 border-t">
                <button type="button" onClick={onCancel} className="px-6 py-3 border rounded-xl hover:bg-gray-50 font-medium">Cancel</button>
                <button type="submit" disabled={submitting} className="btn-primary px-8 py-3 text-white rounded-xl font-medium disabled:opacity-50">
                  {submitting ? 'Submitting...' : 'Submit Service Report'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Assign Report Page Component (for admins and managers)
    const AssignReportPage = ({ token, user, clients, onSuccess }) => {
      const [technicians, setTechnicians] = useState([]);
      const [allClients, setAllClients] = useState([]);
      const [loading, setLoading] = useState(true);
      const [submitting, setSubmitting] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');

      // Form state
      const [formData, setFormData] = useState({
        assignedToId: '', clientFacilityName: '', customerName: '', address: '',
        serviceType: '', analyzerModel: '', analyzerSerialNumber: '',
        hubspotTicketNumber: '', serviceCompletionDate: '', managerNotes: ''
      });

      // File upload state
      const [photos, setPhotos] = useState([]);
      const [files, setFiles] = useState([]);
      const [photoPreviewUrls, setPhotoPreviewUrls] = useState([]);
      const [fileNames, setFileNames] = useState([]);
      const photoInputRef = useRef(null);
      const fileInputRef = useRef(null);

      // Add Vendor Modal state
      const [showVendorModal, setShowVendorModal] = useState(false);
      const [vendorFormData, setVendorFormData] = useState({ name: '', email: '', password: '', assignedClients: [] });
      const [vendorSaving, setVendorSaving] = useState(false);
      const [vendorError, setVendorError] = useState('');

      // HubSpot Import state
      const [hubspotTicketId, setHubspotTicketId] = useState('');
      const [importing, setImporting] = useState(false);
      const [importError, setImportError] = useState('');
      const [importSuccess, setImportSuccess] = useState('');

      const serviceTypes = ['Analyzer Hardware', 'Inventory', 'LIS/EMR', 'Compliance', 'Training', 'Validations'];

      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        setLoading(true);
        const [techData, clientData] = await Promise.all([
          api.getTechnicians(token),
          api.getAllClients(token)
        ]);
        if (!techData.error) setTechnicians(techData);
        if (!clientData.error) setAllClients(clientData);
        setLoading(false);
      };

      const handleClientSelect = (clientName) => {
        const client = (clients.length > 0 ? clients : allClients).find(c => (c.name || c.clientName) === clientName);
        if (client) {
          setFormData(prev => ({
            ...prev,
            clientFacilityName: client.name || client.clientName || '',
            address: client.address || '',
            hubspotCompanyId: client.hubspotCompanyId || ''
          }));
        }
      };

      const handlePhotoSelect = (e) => {
        const selectedFiles = Array.from(e.target.files);
        setPhotos(prev => [...prev, ...selectedFiles]);
        const newUrls = selectedFiles.map(file => URL.createObjectURL(file));
        setPhotoPreviewUrls(prev => [...prev, ...newUrls]);
      };

      const handleFileSelect = (e) => {
        const selectedFiles = Array.from(e.target.files);
        setFiles(prev => [...prev, ...selectedFiles]);
        setFileNames(prev => [...prev, ...selectedFiles.map(f => f.name)]);
      };

      const removePhoto = (idx) => {
        URL.revokeObjectURL(photoPreviewUrls[idx]);
        setPhotos(prev => prev.filter((_, i) => i !== idx));
        setPhotoPreviewUrls(prev => prev.filter((_, i) => i !== idx));
      };

      const removeFile = (idx) => {
        setFiles(prev => prev.filter((_, i) => i !== idx));
        setFileNames(prev => prev.filter((_, i) => i !== idx));
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.assignedToId || !formData.clientFacilityName) {
          setError('Please select a technician/vendor and a client');
          return;
        }

        setSubmitting(true);
        setError('');

        try {
          const result = await api.assignServiceReport(token, formData);
          if (result.error) {
            setError(result.error);
            setSubmitting(false);
            return;
          }

          // Upload photos if any
          if (photos.length > 0) {
            await api.uploadServiceReportPhotos(token, result.id, photos);
          }

          // Upload files if any
          if (files.length > 0) {
            await api.uploadServiceReportFiles(token, result.id, files);
          }

          setSuccess('Report assigned successfully!');
          // Reset form
          setFormData({
            assignedToId: '', clientFacilityName: '', customerName: '', address: '',
            serviceType: '', analyzerModel: '', analyzerSerialNumber: '',
            hubspotTicketNumber: '', serviceCompletionDate: '', managerNotes: ''
          });
          setPhotos([]);
          setFiles([]);
          setPhotoPreviewUrls([]);
          setFileNames([]);

          setTimeout(() => {
            setSuccess('');
            if (onSuccess) onSuccess();
          }, 2000);
        } catch (err) {
          setError('Failed to assign report. Please try again.');
        } finally {
          setSubmitting(false);
        }
      };

      const handleCreateVendor = async (e) => {
        e.preventDefault();
        if (!vendorFormData.name || !vendorFormData.email || !vendorFormData.password) {
          setVendorError('Please fill in all required fields');
          return;
        }

        setVendorSaving(true);
        setVendorError('');

        try {
          const result = await api.createVendor(token, vendorFormData);
          if (result.error) {
            setVendorError(result.error);
            setVendorSaving(false);
            return;
          }

          // Refresh technicians list
          const techData = await api.getTechnicians(token);
          if (!techData.error) setTechnicians(techData);

          // Close modal and reset form
          setShowVendorModal(false);
          setVendorFormData({ name: '', email: '', password: '', assignedClients: [] });
          setSuccess('Vendor created successfully!');
          setTimeout(() => setSuccess(''), 3000);
        } catch (err) {
          setVendorError('Failed to create vendor. Please try again.');
        } finally {
          setVendorSaving(false);
        }
      };

      const handleImportFromHubSpot = async () => {
        if (!hubspotTicketId.trim()) {
          setImportError('Please enter a HubSpot ticket ID');
          return;
        }

        setImporting(true);
        setImportError('');
        setImportSuccess('');

        try {
          const response = await fetch(`/api/hubspot/ticket/${hubspotTicketId.trim()}/map-to-service-report`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();

          if (!response.ok || data.error) {
            setImportError(data.error || data.details || 'Failed to fetch ticket from HubSpot');
            setImporting(false);
            return;
          }

          // Populate form with mapped data
          setFormData({
            assignedToId: data.assignedToId || '',
            clientFacilityName: data.clientFacilityName || '',
            customerName: data.customerName || '',
            address: formData.address, // Keep existing if not provided
            serviceType: data.serviceType || '',
            analyzerModel: formData.analyzerModel, // Keep existing
            analyzerSerialNumber: data.analyzerSerialNumber || '',
            hubspotTicketNumber: data.hubspotTicketNumber || '',
            serviceCompletionDate: data.serviceCompletionDate || '',
            managerNotes: data.managerNotes || ''
          });

          // If company is found, trigger client select to auto-fill address
          if (data.clientFacilityName) {
            handleClientSelect(data.clientFacilityName);
          }

          setImportSuccess('Ticket data imported successfully!');

          if (data.hubspotOwnerNotMatched) {
            setImportError('Warning: HubSpot ticket owner could not be matched to an internal user. Please manually select an assignee.');
          }

          // Clear success message after 5 seconds
          setTimeout(() => setImportSuccess(''), 5000);
        } catch (err) {
          setImportError('Failed to import ticket. Please check the ticket ID and try again.');
          console.error('Import error:', err);
        } finally {
          setImporting(false);
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center py-12">
            <div className="text-center">
              <svg className="animate-spin w-8 h-8 text-primary-500 mx-auto mb-3" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
              </svg>
              <p className="text-gray-500">Loading...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="space-y-6 animate-fade-in">
          {/* Header */}
          <div className="card-modern p-6">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white shadow-lg">
                {Icons.assign}
              </div>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">Assign Service Report</h1>
                <p className="text-gray-500">Pre-populate details and assign a service visit to a technician or vendor</p>
              </div>
            </div>
          </div>

          {/* Success/Error Messages */}
          {success && (
            <div className="bg-success-50 text-success-600 px-4 py-3 rounded-xl flex items-center gap-2">
              {Icons.check}
              <span>{success}</span>
            </div>
          )}
          {error && (
            <div className="bg-danger-50 text-danger-600 px-4 py-3 rounded-xl flex items-center gap-2">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
              <span>{error}</span>
            </div>
          )}

          {/* HubSpot Import Section */}
          <div className="card-modern p-6 bg-gradient-to-r from-orange-50 to-yellow-50 border-l-4 border-orange-500">
            <div className="flex items-start gap-3 mb-4">
              <div className="w-10 h-10 rounded-xl bg-orange-500 flex items-center justify-center text-white flex-shrink-0">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-gray-900 mb-1">Import from HubSpot Ticket</h3>
                <p className="text-sm text-gray-600 mb-4">Auto-populate this form by importing data from a HubSpot ticket</p>

                {importSuccess && (
                  <div className="bg-success-50 text-success-600 px-3 py-2 rounded-lg flex items-center gap-2 mb-3 text-sm">
                    {Icons.check}
                    <span>{importSuccess}</span>
                  </div>
                )}
                {importError && (
                  <div className="bg-danger-50 text-danger-600 px-3 py-2 rounded-lg flex items-center gap-2 mb-3 text-sm">
                    <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span>{importError}</span>
                  </div>
                )}

                <div className="flex flex-col sm:flex-row gap-3">
                  <div className="flex-1">
                    <input
                      type="text"
                      value={hubspotTicketId}
                      onChange={(e) => setHubspotTicketId(e.target.value)}
                      placeholder="Enter HubSpot Ticket ID (e.g., 12345678)"
                      className="input-modern w-full px-4 py-3"
                      disabled={importing}
                    />
                  </div>
                  <button
                    type="button"
                    onClick={handleImportFromHubSpot}
                    disabled={importing || !hubspotTicketId.trim()}
                    className="px-6 py-3 bg-orange-500 text-white rounded-xl font-medium hover:bg-orange-600 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                  >
                    {importing ? (
                      <>
                        <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                        </svg>
                        <span>Importing...</span>
                      </>
                    ) : (
                      <>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        <span>Import Ticket</span>
                      </>
                    )}
                  </button>
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  The ticket ID can be found in the HubSpot ticket URL or ticket details
                </p>
              </div>
            </div>
          </div>

          <form onSubmit={handleSubmit} className="space-y-6">
            {/* Assignment Section */}
            <div className="card-modern p-6 border-l-4 border-blue-500">
              <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-4">
                <span className="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-sm">1</span>
                Assignment
              </h2>
              <div className="flex flex-col sm:flex-row gap-4 sm:items-end">
                <div className="flex-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Assign To *</label>
                  <select
                    value={formData.assignedToId}
                    onChange={(e) => setFormData({...formData, assignedToId: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                    required
                  >
                    <option value="">Select a technician or vendor...</option>
                    {technicians.map(tech => (
                      <option key={tech.id} value={tech.id}>
                        {tech.name} {tech.role === 'vendor' ? '(Vendor)' : ''}
                      </option>
                    ))}
                  </select>
                </div>
                <button
                  type="button"
                  onClick={() => setShowVendorModal(true)}
                  className="px-4 py-3 bg-orange-500 text-white rounded-xl font-medium hover:bg-orange-600 transition flex items-center justify-center gap-2 whitespace-nowrap w-full sm:w-auto"
                >
                  {Icons.userPlus}
                  Add New Vendor
                </button>
              </div>
            </div>

            {/* Client Information Section */}
            <div className="card-modern p-6">
              <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-4">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">2</span>
                Client Information
              </h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client/Facility Name *</label>
                  <select
                    value={formData.clientFacilityName}
                    onChange={(e) => handleClientSelect(e.target.value)}
                    className="input-modern w-full px-4 py-3"
                    required
                  >
                    <option value="">Select a client...</option>
                    {(clients.length > 0 ? clients : allClients).map((client, idx) => (
                      <option key={idx} value={client.name || client.clientName}>
                        {client.name || client.clientName}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                  <input
                    type="text"
                    value={formData.customerName}
                    onChange={(e) => setFormData({...formData, customerName: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                    placeholder="Contact name"
                  />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                  <input
                    type="text"
                    value={formData.address}
                    onChange={(e) => setFormData({...formData, address: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                    placeholder="Service address"
                  />
                </div>
              </div>
            </div>

            {/* Service Details Section */}
            <div className="card-modern p-6">
              <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-4">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">3</span>
                Service Details
              </h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service Type</label>
                  <select
                    value={formData.serviceType}
                    onChange={(e) => setFormData({...formData, serviceType: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                  >
                    <option value="">Select service type...</option>
                    {serviceTypes.map(type => (
                      <option key={type} value={type}>{type}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Target Completion Date</label>
                  <input
                    type="date"
                    value={formData.serviceCompletionDate}
                    onChange={(e) => setFormData({...formData, serviceCompletionDate: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Model</label>
                  <input
                    type="text"
                    value={formData.analyzerModel}
                    onChange={(e) => setFormData({...formData, analyzerModel: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                    placeholder="e.g., DZLite C270"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Analyzer Serial Number</label>
                  <input
                    type="text"
                    value={formData.analyzerSerialNumber}
                    onChange={(e) => setFormData({...formData, analyzerSerialNumber: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                    placeholder="e.g., 601744124"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">HubSpot Ticket #</label>
                  <input
                    type="text"
                    value={formData.hubspotTicketNumber}
                    onChange={(e) => setFormData({...formData, hubspotTicketNumber: e.target.value})}
                    className="input-modern w-full px-4 py-3"
                    placeholder="Enter ticket number"
                  />
                </div>
              </div>
            </div>

            {/* Manager Notes Section */}
            <div className="card-modern p-6 border-l-4 border-yellow-500">
              <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-4">
                <span className="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 text-sm">4</span>
                Manager Notes
              </h2>
              <textarea
                value={formData.managerNotes}
                onChange={(e) => setFormData({...formData, managerNotes: e.target.value})}
                rows={4}
                className="input-modern w-full px-4 py-3"
                placeholder="Add instructions or notes for the technician..."
              />
            </div>

            {/* Reference Photos Section */}
            <div className="card-modern p-6">
              <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-4">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">5</span>
                Reference Photos
              </h2>
              <p className="text-sm text-gray-500 mb-3">Upload photos for technician reference (equipment photos, location details, etc.)</p>
              <input
                type="file"
                ref={photoInputRef}
                onChange={handlePhotoSelect}
                accept="image/*"
                multiple
                className="hidden"
              />
              <button
                type="button"
                onClick={() => photoInputRef.current?.click()}
                className="px-4 py-2 border-2 border-dashed border-gray-300 rounded-xl hover:border-primary-500 text-gray-600 hover:text-primary-600 transition flex items-center gap-2"
              >
                {Icons.photo} Add Photos
              </button>
              {photoPreviewUrls.length > 0 && (
                <div className="flex flex-wrap gap-3 mt-4">
                  {photoPreviewUrls.map((url, idx) => (
                    <div key={idx} className="relative">
                      <img src={url} alt={`Preview ${idx + 1}`} className="w-24 h-24 object-cover rounded-xl border" />
                      <button
                        type="button"
                        onClick={() => removePhoto(idx)}
                        className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600"
                      >
                        Ã—
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Client Files Section */}
            <div className="card-modern p-6">
              <h2 className="font-bold text-gray-900 flex items-center gap-2 mb-4">
                <span className="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 text-sm">6</span>
                Client Files
              </h2>
              <p className="text-sm text-gray-500 mb-3">Upload relevant documents (service manuals, previous reports, etc.)</p>
              <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileSelect}
                multiple
                className="hidden"
              />
              <button
                type="button"
                onClick={() => fileInputRef.current?.click()}
                className="px-4 py-2 border-2 border-dashed border-gray-300 rounded-xl hover:border-primary-500 text-gray-600 hover:text-primary-600 transition flex items-center gap-2"
              >
                {Icons.folder} Add Files
              </button>
              {fileNames.length > 0 && (
                <div className="space-y-2 mt-4">
                  {fileNames.map((name, idx) => (
                    <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                      <span className="text-sm text-gray-700 flex items-center gap-2">
                        {Icons.document} {name}
                      </span>
                      <button
                        type="button"
                        onClick={() => removeFile(idx)}
                        className="text-red-500 hover:text-red-700 text-sm font-medium"
                      >
                        Remove
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Submit Buttons */}
            <div className="flex justify-end gap-4">
              <button
                type="button"
                onClick={() => {
                  setFormData({
                    assignedToId: '', clientFacilityName: '', customerName: '', address: '',
                    serviceType: '', analyzerModel: '', analyzerSerialNumber: '',
                    hubspotTicketNumber: '', serviceCompletionDate: '', managerNotes: ''
                  });
                  setPhotos([]);
                  setFiles([]);
                  setPhotoPreviewUrls([]);
                  setFileNames([]);
                }}
                className="px-6 py-3 border rounded-xl hover:bg-gray-50 font-medium"
              >
                Clear Form
              </button>
              <button
                type="submit"
                disabled={submitting}
                className="btn-primary px-8 py-3 text-white rounded-xl font-medium disabled:opacity-50 flex items-center gap-2"
              >
                {submitting ? (
                  <>
                    <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                    Assigning...
                  </>
                ) : 'Assign Report'}
              </button>
            </div>
          </form>

          {/* Add Vendor Modal */}
          {showVendorModal && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto animate-fade-in">
                <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-2xl">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center text-orange-600">
                      {Icons.userPlus}
                    </div>
                    <h3 className="text-xl font-bold text-gray-900">Add New Vendor</h3>
                  </div>
                  <button onClick={() => { setShowVendorModal(false); setVendorError(''); }} className="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-lg transition">
                    {Icons.close}
                  </button>
                </div>
                <form onSubmit={handleCreateVendor} className="p-6 space-y-4">
                  {vendorError && (
                    <div className="bg-danger-50 text-danger-600 px-4 py-3 rounded-xl text-sm">
                      {vendorError}
                    </div>
                  )}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                    <input
                      type="text"
                      value={vendorFormData.name}
                      onChange={(e) => setVendorFormData({...vendorFormData, name: e.target.value})}
                      className="input-modern w-full px-4 py-3"
                      placeholder="Vendor name"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input
                      type="email"
                      value={vendorFormData.email}
                      onChange={(e) => setVendorFormData({...vendorFormData, email: e.target.value})}
                      className="input-modern w-full px-4 py-3"
                      placeholder="vendor@example.com"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <input
                      type="password"
                      value={vendorFormData.password}
                      onChange={(e) => setVendorFormData({...vendorFormData, password: e.target.value})}
                      className="input-modern w-full px-4 py-3"
                      placeholder="Create a password"
                      required
                    />
                  </div>
                  <div className="flex gap-3 pt-4">
                    <button
                      type="button"
                      onClick={() => { setShowVendorModal(false); setVendorError(''); }}
                      className="flex-1 px-4 py-3 border rounded-xl hover:bg-gray-50 font-medium"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      disabled={vendorSaving}
                      className="flex-1 px-4 py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 font-medium disabled:opacity-50 flex items-center justify-center gap-2"
                    >
                      {vendorSaving ? (
                        <>
                          <svg className="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                          Creating...
                        </>
                      ) : 'Create Vendor'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Continue Validation Page - Multi-day validation daily segment form
    const ContinueValidationPage = ({ token, user, validation, onSuccess, onBack }) => {
      const [loading, setLoading] = useState(false);
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState('');
      const [expandedDays, setExpandedDays] = useState(new Set());
      const [showCompletionForm, setShowCompletionForm] = useState(false);
      const [editingExpectedDays, setEditingExpectedDays] = useState(false);
      const [expectedDaysInput, setExpectedDaysInput] = useState(validation?.expectedDays || '');

      const segments = Array.isArray(validation?.validationSegments) ? validation.validationSegments : [];
      const nextDay = segments.length + 1;

      // New day form state
      const [dayForm, setDayForm] = useState({
        testsPerformed: '',
        results: '',
        observations: '',
        date: new Date().toISOString().split('T')[0]
      });

      // Completion form state
      const [completionForm, setCompletionForm] = useState({
        validationResults: '',
        trainingProvided: '',
        recommendations: '',
        technicianSignature: '',
        technicianSignatureDate: new Date().toISOString().split('T')[0],
        technicianFirstName: user?.name?.split(' ')[0] || '',
        technicianLastName: user?.name?.split(' ').slice(1).join(' ') || '',
        customerSignature: '',
        customerSignatureDate: '',
        customerFirstName: '',
        customerLastName: ''
      });

      const toggleDay = (day) => {
        const next = new Set(expandedDays);
        if (next.has(day)) next.delete(day); else next.add(day);
        setExpandedDays(next);
      };

      // Progress bar calculation
      const expectedDays = validation?.expectedDays;
      const daysLogged = segments.length;
      const progressPercent = expectedDays ? Math.min(100, Math.round((daysLogged / expectedDays) * 100)) : null;

      const handleSaveDay = async () => {
        if (!dayForm.testsPerformed.trim()) {
          setError('Tests performed is required');
          return;
        }
        setSaving(true);
        setError('');

        const result = await api.addValidationSegment(token, validation.id, {
          day: nextDay,
          date: dayForm.date,
          testsPerformed: dayForm.testsPerformed,
          results: dayForm.results,
          observations: dayForm.observations,
          status: 'complete',
          expectedDays: expectedDaysInput ? parseInt(expectedDaysInput) : validation?.expectedDays
        });

        if (result.error) {
          setError(result.error);
          setSaving(false);
        } else {
          if (onSuccess) onSuccess(result);
        }
      };

      const handleUpdateExpectedDays = async () => {
        const val = expectedDaysInput ? parseInt(expectedDaysInput) : null;
        // Save the expected days update via a no-op segment update (update last segment)
        if (segments.length > 0) {
          const lastSeg = segments[segments.length - 1];
          await api.addValidationSegment(token, validation.id, {
            day: lastSeg.day,
            date: lastSeg.date,
            testsPerformed: lastSeg.testsPerformed,
            results: lastSeg.results,
            observations: lastSeg.observations,
            status: lastSeg.status,
            expectedDays: val
          });
        }
        setEditingExpectedDays(false);
        if (onSuccess) onSuccess();
      };

      const handleCompleteValidation = async () => {
        if (!completionForm.validationResults.trim()) {
          setError('Overall validation results are required');
          return;
        }
        if (!completionForm.technicianSignature) {
          setError('Technician signature is required');
          return;
        }
        setSaving(true);
        setError('');

        const result = await api.completeValidation(token, validation.id, completionForm);
        if (result.error) {
          setError(result.error);
          setSaving(false);
        } else {
          if (onSuccess) onSuccess(result);
        }
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        try {
          const d = new Date(dateStr + 'T12:00:00');
          return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        } catch { return dateStr; }
      };

      return (
        <div className="space-y-6 animate-fade-in">
          {/* Header */}
          <div className="flex items-center gap-3">
            <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg transition">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
            </button>
            <div>
              <h1 className="text-2xl font-bold text-accent">Validation: {validation?.clientFacilityName}</h1>
              <p className="text-sm text-gray-600">
                {validation?.analyzerModel || 'Biolis AU480'} {validation?.analyzerSerialNumber ? `(${validation.analyzerSerialNumber})` : ''}
                {validation?.validationStartDate && ` Â· Started ${formatDate(validation.validationStartDate)}`}
              </p>
            </div>
          </div>

          {/* Progress Bar with Expected Days */}
          <div className="card-modern p-5">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>
                </div>
                <div>
                  <p className="font-semibold text-gray-900">{daysLogged} day{daysLogged !== 1 ? 's' : ''} logged</p>
                  {expectedDays && !editingExpectedDays && (
                    <p className="text-sm text-gray-500">
                      {daysLogged} of {expectedDays} expected days
                      <button onClick={() => setEditingExpectedDays(true)} className="ml-2 text-blue-500 hover:text-blue-700 text-xs">(edit)</button>
                    </p>
                  )}
                  {!expectedDays && !editingExpectedDays && (
                    <p className="text-sm text-gray-500">
                      Flexible duration
                      <button onClick={() => setEditingExpectedDays(true)} className="ml-2 text-blue-500 hover:text-blue-700 text-xs">(set expected days)</button>
                    </p>
                  )}
                </div>
              </div>
              <div className="flex gap-1">
                {segments.map((s, i) => (
                  <div key={i} className="w-3 h-3 rounded-full bg-green-500" title={`Day ${s.day}`}></div>
                ))}
                <div className="w-3 h-3 rounded-full bg-gray-200 border-2 border-blue-400 animate-pulse" title="Next day"></div>
              </div>
            </div>

            {/* Edit expected days inline */}
            {editingExpectedDays && (
              <div className="flex items-center gap-2 mt-2 p-3 bg-blue-50 rounded-lg">
                <label className="text-sm text-gray-700">Expected total days:</label>
                <input
                  type="number"
                  min="1"
                  max="30"
                  value={expectedDaysInput}
                  onChange={(e) => setExpectedDaysInput(e.target.value)}
                  className="w-20 px-2 py-1 border rounded text-sm"
                  placeholder="e.g. 5"
                />
                <button onClick={handleUpdateExpectedDays} className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Save</button>
                <button onClick={() => setEditingExpectedDays(false)} className="px-3 py-1 text-gray-600 text-sm hover:text-gray-800">Cancel</button>
              </div>
            )}

            {/* Progress bar (only shown when expectedDays is set) */}
            {expectedDays && progressPercent !== null && (
              <div className="mt-3">
                <div className="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                  <div
                    className={`h-full rounded-full transition-all duration-500 ${progressPercent >= 100 ? 'bg-green-500' : 'bg-blue-500'}`}
                    style={{ width: `${progressPercent}%` }}
                  />
                </div>
                <p className="text-xs text-gray-500 mt-1 text-right">{progressPercent}%</p>
              </div>
            )}
          </div>

          {/* Daily Log */}
          <div className="card-modern p-6">
            <h2 className="text-lg font-bold text-gray-900 mb-4">Daily Validation Log</h2>

            {/* Completed days */}
            <div className="space-y-3 mb-4">
              {segments.map((seg) => (
                <div key={seg.day} className="border rounded-xl overflow-hidden">
                  <button
                    onClick={() => toggleDay(seg.day)}
                    className="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition"
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs">âœ“</div>
                      <span className="font-medium text-gray-900">Day {seg.day} â€” {formatDate(seg.date)}</span>
                    </div>
                    <svg className={`w-5 h-5 text-gray-400 transition-transform ${expandedDays.has(seg.day) ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                  </button>
                  {expandedDays.has(seg.day) && (
                    <div className="px-4 pb-4 space-y-2 border-t bg-gray-50">
                      <div className="pt-3">
                        <p className="text-xs font-medium text-gray-500 uppercase">Tests Performed</p>
                        <p className="text-sm text-gray-800 mt-1">{seg.testsPerformed}</p>
                      </div>
                      {seg.results && (
                        <div>
                          <p className="text-xs font-medium text-gray-500 uppercase">Results / Readings</p>
                          <p className="text-sm text-gray-800 mt-1">{seg.results}</p>
                        </div>
                      )}
                      {seg.observations && (
                        <div>
                          <p className="text-xs font-medium text-gray-500 uppercase">Observations / Notes</p>
                          <p className="text-sm text-gray-800 mt-1">{seg.observations}</p>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              ))}
            </div>

            {/* New day form */}
            {!showCompletionForm && (
              <div className="border-2 border-blue-200 rounded-xl p-5 bg-blue-50/30">
                <div className="flex items-center gap-2 mb-4">
                  <div className="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold">{nextDay}</div>
                  <h3 className="font-semibold text-gray-900">Day {nextDay}</h3>
                  <span className="text-xs text-blue-600 bg-blue-100 px-2 py-0.5 rounded">Current</span>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input
                      type="date"
                      value={dayForm.date}
                      onChange={(e) => setDayForm(prev => ({ ...prev, date: e.target.value }))}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Tests Performed *</label>
                    <textarea
                      value={dayForm.testsPerformed}
                      onChange={(e) => setDayForm(prev => ({ ...prev, testsPerformed: e.target.value }))}
                      rows="3"
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                      placeholder="Calibration verification, QC testing, patient sample runs..."
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Results / Readings</label>
                    <textarea
                      value={dayForm.results}
                      onChange={(e) => setDayForm(prev => ({ ...prev, results: e.target.value }))}
                      rows="3"
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                      placeholder="Na: 140Â±2, K: 4.1Â±0.3, Cl: 101Â±2..."
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Observations / Notes</label>
                    <textarea
                      value={dayForm.observations}
                      onChange={(e) => setDayForm(prev => ({ ...prev, observations: e.target.value }))}
                      rows="2"
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                      placeholder="Any observations, issues, or notes for this day..."
                    />
                  </div>

                  {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">{error}</div>}

                  <div className="flex gap-3 pt-2">
                    <button
                      onClick={handleSaveDay}
                      disabled={saving}
                      className="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center gap-2"
                    >
                      {saving ? (
                        <><svg className="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Saving...</>
                      ) : `Save Day ${nextDay}`}
                    </button>
                    {segments.length > 0 && (
                      <button
                        onClick={() => setShowCompletionForm(true)}
                        className="px-4 py-2.5 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Complete Validation
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Completion form */}
            {showCompletionForm && (
              <div className="border-2 border-green-200 rounded-xl p-5 bg-green-50/30">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <h3 className="text-lg font-bold text-gray-900">Complete Validation</h3>
                  </div>
                  <button onClick={() => setShowCompletionForm(false)} className="text-sm text-gray-500 hover:text-gray-700">
                    â† Back to daily log
                  </button>
                </div>

                <p className="text-sm text-gray-600 mb-4">All {segments.length} days logged. Provide the overall summary and signatures below.</p>

                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Overall Validation Results *</label>
                    <textarea
                      value={completionForm.validationResults}
                      onChange={(e) => setCompletionForm(prev => ({ ...prev, validationResults: e.target.value }))}
                      rows="4"
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                      placeholder="All analytes within acceptable tolerance ranges..."
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Training Provided</label>
                    <textarea
                      value={completionForm.trainingProvided}
                      onChange={(e) => setCompletionForm(prev => ({ ...prev, trainingProvided: e.target.value }))}
                      rows="3"
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                      placeholder="Trained staff on daily maintenance, QC procedures..."
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Recommendations</label>
                    <textarea
                      value={completionForm.recommendations}
                      onChange={(e) => setCompletionForm(prev => ({ ...prev, recommendations: e.target.value }))}
                      rows="3"
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                      placeholder="Schedule 6-month follow-up calibration..."
                    />
                  </div>

                  {/* Signatures */}
                  <div className="border-t pt-4 mt-4">
                    <h4 className="font-semibold text-gray-900 mb-3">Signatures</h4>
                    <div className="grid md:grid-cols-2 gap-4">
                      <SignaturePad
                        label="Technician Signature *"
                        onSave={(sig) => setCompletionForm(prev => ({ ...prev, technicianSignature: sig }))}
                      />
                      <SignaturePad
                        label="Customer Signature (optional - can sign in portal)"
                        onSave={(sig) => setCompletionForm(prev => ({ ...prev, customerSignature: sig, customerSignatureDate: sig ? new Date().toISOString().split('T')[0] : '' }))}
                      />
                    </div>
                    {completionForm.customerSignature && (
                      <div className="grid md:grid-cols-2 gap-4 mt-3">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Customer First Name</label>
                          <input type="text" value={completionForm.customerFirstName} onChange={(e) => setCompletionForm(prev => ({ ...prev, customerFirstName: e.target.value }))} className="w-full px-3 py-2 border rounded-lg text-sm" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Customer Last Name</label>
                          <input type="text" value={completionForm.customerLastName} onChange={(e) => setCompletionForm(prev => ({ ...prev, customerLastName: e.target.value }))} className="w-full px-3 py-2 border rounded-lg text-sm" />
                        </div>
                      </div>
                    )}
                  </div>

                  {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">{error}</div>}

                  <div className="flex gap-3 pt-2">
                    <button
                      onClick={() => setShowCompletionForm(false)}
                      className="px-4 py-2.5 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleCompleteValidation}
                      disabled={saving}
                      className="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 disabled:opacity-50 flex items-center justify-center gap-2"
                    >
                      {saving ? (
                        <><svg className="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Completing...</>
                      ) : 'Complete Validation â†’ Send for Client Signature'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      // Check multiple token sources - service_token, unified_token, or admin_token
      const [token, setToken] = useState(() => {
        return localStorage.getItem('service_token') || localStorage.getItem('unified_token') || localStorage.getItem('admin_token');
      });
      const [user, setUser] = useState(() => {
        try {
          const userData = localStorage.getItem('service_user') || localStorage.getItem('unified_user') || localStorage.getItem('admin_user');
          return userData ? JSON.parse(userData) : null;
        } catch {
          return null;
        }
      });
      const [activePage, setActivePage] = useState('home');
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
      const [data, setData] = useState(null);
      const [clients, setClients] = useState([]);
      const [viewingReport, setViewingReport] = useState(null);
      const [editingReport, setEditingReport] = useState(null);
      const [assignedReports, setAssignedReports] = useState([]);
      const [editingAssignment, setEditingAssignment] = useState(null);
      const [activeValidations, setActiveValidations] = useState([]);
      const [continueValidation, setContinueValidation] = useState(null);

      useEffect(() => {
        if (token) {
          loadData();
        }
      }, [token]);

      // Handle browser back/forward cache (bfcache) - re-validate auth when page is restored
      useEffect(() => {
        const handlePageShow = (event) => {
          // Check if page was restored from bfcache
          if (event.persisted) {
            // Re-check localStorage for valid tokens
            const storedToken = localStorage.getItem('service_token') || localStorage.getItem('unified_token') || localStorage.getItem('admin_token');
            const storedUserData = localStorage.getItem('service_user') || localStorage.getItem('unified_user') || localStorage.getItem('admin_user');

            if (!storedToken || !storedUserData) {
              // Tokens were cleared (user logged out), update React state
              setToken(null);
              setUser(null);
            }
          }
        };

        window.addEventListener('pageshow', handlePageShow);
        return () => window.removeEventListener('pageshow', handlePageShow);
      }, []);

      const loadData = async () => {
        console.log('ðŸ”„ LOADING DATA - User:', user?.name, 'Role:', user?.role, 'ID:', user?.id);

        const [portalData, clientsData, assignedData, validationsData] = await Promise.all([
          api.getServicePortalData(token),
          api.getClients(token),
          api.getAssignedReports(token),
          api.getActiveValidations(token)
        ]);

        console.log('ðŸ“Š API RESPONSES:');
        console.log('  - Portal Data:', portalData?.error || 'OK');
        console.log('  - Clients:', clientsData?.error || `${clientsData?.length || 0} clients`);
        console.log('  - Assigned Reports:', assignedData?.error || `${assignedData?.length || 0} reports`);
        console.log('  - Active Validations:', validationsData?.error || `${validationsData?.length || 0} validations`);

        if (assignedData && !assignedData.error) {
          console.log('ðŸ“‹ ASSIGNED REPORTS DETAIL:', JSON.stringify(assignedData, null, 2));
        }

        if (portalData.error === 'Invalid token' || portalData.error?.includes('unauthorized')) {
          handleLogout();
          return;
        }

        if (!portalData.error) {
          setData(portalData);
        }

        if (!clientsData.error) {
          setClients(clientsData);
        }

        if (!assignedData.error && Array.isArray(assignedData)) {
          console.log('âœ… Setting assignedReports state to:', assignedData.length, 'reports');
          setAssignedReports(assignedData);
        } else {
          console.log('âŒ Not setting assignedReports - Error or not array:', assignedData);
        }

        if (!validationsData.error && Array.isArray(validationsData)) {
          setActiveValidations(validationsData);
        }
      };

      const handleLogin = (newToken, newUser) => {
        setToken(newToken);
        setUser(newUser);
      };

      const handleLogout = () => {
        // Clear all portal token keys to prevent stale sessions
        localStorage.removeItem('service_token');
        localStorage.removeItem('service_user');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('unified_token');
        localStorage.removeItem('unified_user');
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        localStorage.removeItem('portal_token');
        localStorage.removeItem('portal_user');
        setToken(null);
        setUser(null);
      };

      const handleViewReport = (report) => {
        setViewingReport(report);
        setActivePage('view_report');
      };

      const handleEditReport = (report) => {
        setEditingReport(report);
        setViewingReport(null);
        setActivePage('edit_report');
      };

      const handleEditAssignment = (assignment) => {
        setEditingAssignment(assignment);
        setActivePage('complete_assignment');
      };

      const handleContinueValidation = (validation) => {
        setContinueValidation(validation);
        setActivePage('continue_validation');
      };

      if (!token || !user) {
        return <LoginPage onLogin={handleLogin} />;
      }

      const renderPage = () => {
        if (continueValidation && activePage === 'continue_validation') {
          return (
            <ContinueValidationPage
              token={token}
              user={user}
              validation={continueValidation}
              onSuccess={(updatedReport) => {
                setContinueValidation(null);
                loadData();
                setActivePage('home');
              }}
              onBack={() => {
                setContinueValidation(null);
                setActivePage('home');
              }}
            />
          );
        }

        if (editingReport && activePage === 'edit_report') {
          return (
            <EditReportPage
              token={token}
              user={user}
              report={editingReport}
              onSuccess={() => {
                setEditingReport(null);
                loadData();
                setActivePage('reports');
              }}
              onCancel={() => {
                setEditingReport(null);
                setActivePage('reports');
              }}
            />
          );
        }

        if (viewingReport && activePage === 'view_report') {
          return (
            <ViewReportPage
              report={viewingReport}
              user={user}
              onEdit={handleEditReport}
              onBack={() => {
                setViewingReport(null);
                setActivePage('reports');
              }}
            />
          );
        }

        if (editingAssignment && activePage === 'complete_assignment') {
          return (
            <CompleteAssignmentPage
              token={token}
              user={user}
              assignment={editingAssignment}
              onSuccess={() => {
                setEditingAssignment(null);
                loadData();
                setActivePage('home');
              }}
              onCancel={() => {
                setEditingAssignment(null);
                setActivePage('home');
              }}
            />
          );
        }

        switch (activePage) {
          case 'home':
            return <HomePage user={user} onNavigate={setActivePage} recentReports={data?.recentReports || []} assignedReports={assignedReports} onEditAssignment={handleEditAssignment} activeValidations={activeValidations} onContinueValidation={handleContinueValidation} isAdminView={data?.isAdminView} allReportsCount={data?.allReportsCount} openCount={data?.openCount} closedCount={data?.closedCount} />;
          case 'new_report':
            return (
              <NewReportPage
                token={token}
                user={user}
                clients={clients}
                onSuccess={() => {
                  loadData();
                  setActivePage('reports');
                }}
              />
            );
          case 'reports':
            return <ReportsPage token={token} onViewReport={handleViewReport} onEditReport={handleEditReport} currentUser={user} />;
          case 'assigned_reports':
            return (
              <AssignedReportsPage
                assignedReports={assignedReports}
                onEditAssignment={handleEditAssignment}
                onBack={() => setActivePage('home')}
              />
            );
          case 'assign_report':
            // Only show for admins and managers
            if (user?.role === 'admin' || (user?.isManager && user?.hasServicePortalAccess)) {
              return (
                <AssignReportPage
                  token={token}
                  user={user}
                  clients={clients}
                  onSuccess={() => {
                    loadData();
                    setActivePage('home');
                  }}
                />
              );
            }
            return <HomePage user={user} onNavigate={setActivePage} recentReports={data?.recentReports || []} assignedReports={assignedReports} onEditAssignment={handleEditAssignment} activeValidations={activeValidations} onContinueValidation={handleContinueValidation} isAdminView={data?.isAdminView} allReportsCount={data?.allReportsCount} openCount={data?.openCount} closedCount={data?.closedCount} />;
          default:
            return <HomePage user={user} onNavigate={setActivePage} recentReports={data?.recentReports || []} assignedReports={assignedReports} onEditAssignment={handleEditAssignment} activeValidations={activeValidations} onContinueValidation={handleContinueValidation} isAdminView={data?.isAdminView} allReportsCount={data?.allReportsCount} openCount={data?.openCount} closedCount={data?.closedCount} />;
        }
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <Sidebar
            activePage={activePage}
            onNavigate={setActivePage}
            user={user}
            isMobileOpen={isMobileMenuOpen}
            onClose={() => setIsMobileMenuOpen(false)}
          />

          {/* Mobile header */}
          <div className="lg:hidden bg-white border-b p-4 flex items-center justify-between sticky top-0 z-30">
            <button onClick={() => setIsMobileMenuOpen(true)} className="text-gray-600">
              {Icons.menu}
            </button>
            <img src="/thrive365-logo.webp" alt="Thrive 365 Labs" className="h-8" />
            <div className="w-6"></div>
          </div>

          <main className="lg:ml-72 p-4 lg:p-8">
            {/* Assignment Notification Banner */}
            {assignedReports.length > 0 && activePage !== 'complete_assignment' && (
              <div className="bg-red-600 text-white px-4 py-3 rounded-xl mb-6 shadow-lg animate-fade-in">
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/></svg>
                    </div>
                    <div>
                      <p className="font-semibold">You have {assignedReports.length} assigned service visit{assignedReports.length > 1 ? 's' : ''}</p>
                      <p className="text-sm opacity-90">Click to review and complete the service report</p>
                    </div>
                  </div>
                  <div className="flex gap-2 flex-wrap">
                    {assignedReports.slice(0, 2).map(report => (
                      <button
                        key={report.id}
                        onClick={() => handleEditAssignment(report)}
                        className="px-4 py-2 bg-white text-red-600 rounded-lg font-medium hover:bg-red-50 transition text-sm"
                      >
                        {report.clientFacilityName}
                      </button>
                    ))}
                    {assignedReports.length > 2 && (
                      <span className="px-3 py-2 bg-white/20 rounded-lg text-sm">+{assignedReports.length - 2} more</span>
                    )}
                  </div>
                </div>
              </div>
            )}
            {renderPage()}
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
